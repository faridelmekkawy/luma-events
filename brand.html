<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Luma Events — Brand Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#f3f4f6;
      --panel:#ffffff;
      --panel-soft:#f9fafb;
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#2563eb;
      --accent-soft:#dbeafe;
      --accent-strong:#1d4ed8;
      --radius:16px;
      --shadow:0 18px 40px rgba(15,23,42,.12);
      --danger:#ef4444;
      --ok:#16a34a;
      --pending:#facc15;
      --suspended:#dc2626;
      --active:#16a34a;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      font-family:"Montserrat",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--ink);
    }

    /* AUTH WRAPPER */
    .auth-wrapper{
      width:100%;
      max-width:460px;
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(148,163,184,3);
      padding:18px;
      margin:40px auto;
    }
    .auth-header{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
    }
    .auth-logo{
      width:38px;height:38px;border-radius:999px;
      background:linear-gradient(135deg,#2563eb,#a855f7);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;font-size:18px;
      overflow:hidden;
      background-size:cover;
      background-position:center;
    }
    .auth-title{font-size:17px;font-weight:700;}
    .auth-subtitle{font-size:11px;color:var(--muted);margin-top:2px;}
    .event-chip{
      font-size:10px;
      color:var(--muted);
      margin-top:2px;
    }

    .auth-tabs{
      display:flex;gap:6px;margin:10px 0 12px;
    }
    .auth-tab{
      flex:1;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--panel-soft);
      color:var(--muted);
      font-size:12px;
      cursor:pointer;
      text-align:center;
    }
    .auth-tab.active{
      background:var(--accent-soft);
      border-color:var(--accent-soft);
      color:var(--accent-strong);
      font-weight:600;
    }
    .auth-alert{
      padding:8px 10px;
      border-radius:10px;
      font-size:11px;
      margin-bottom:10px;
    }
    .auth-alert-error{background:#fef2f2;color:#b91c1c;border:1px solid #fecaca;}
    .auth-alert-info{background:#eff6ff;color:#1d4ed8;border:1px solid #bfdbfe;}

    .field{margin-bottom:10px;}
    .field-label{font-size:11px;margin-bottom:4px;color:#4b5563;}
    .field-input,.field-select,textarea.field-input{
      width:100%;padding:8px;border-radius:9px;
      border:1px solid var(--border);background:#f9fafb;font-size:12px;
    }
    .field-input:focus,.field-select:focus,textarea.field-input:focus{
      outline:none;border-color:var(--accent);box-shadow:0 0 0 1px var(--accent-soft);
    }
    .field-hint{font-size:10px;color:var(--muted);margin-top:3px;}

    .btn{
      border:none;border-radius:999px;
      padding:8px 12px;font-size:12px;font-weight:600;
      cursor:pointer;display:inline-flex;align-items:center;justify-content:center;
      gap:6px;
    }
    .btn-primary{background:var(--accent);color:#fff;}
    .btn-primary:hover{background:var(--accent-strong);}
    .btn-ghost{
      background:transparent;color:var(--accent-strong);
      border:1px solid var(--accent-soft);
    }
    .btn-ghost:hover{background:var(--accent-soft);}
    .btn-danger{background:var(--danger);color:#fff;}
    .btn-danger:hover{background:#b91c1c;}

    .auth-footer{text-align:center;margin-top:8px;font-size:10px;color:var(--muted);}

    /* APP LAYOUT */
    .app-shell{
      display:none;
      height:100vh;width:100%;
    }
    .sidebar{
      width:220px;background:var(--panel);
      border-right:1px solid var(--border);
      display:flex;flex-direction:column;
      padding:20px 12px;
    }
    .sidebar-brand{
      display:flex;align-items:center;gap:10px;margin-bottom:18px;
    }
    .sidebar-logo{
      width:36px;height:36px;border-radius:999px;
      background:linear-gradient(135deg,#2563eb,#a855f7);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;
      overflow:hidden;
      background-size:cover;
      background-position:center;
    }
    .sidebar-brand-name{font-size:15px;font-weight:700;}
    .sidebar-nav{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:12px;
      flex:1;
    }
    .nav-item{
      padding:10px 10px;
      border-radius:12px;
      cursor:pointer;
      color:#111827;
      font-size:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border:1px solid transparent;
    }
    .nav-item:hover{background:var(--panel-soft);}
    .nav-item.active{background:var(--accent-soft);color:var(--accent-strong);font-weight:600;}
    .nav-item.logout{
      margin-top:auto;
      background:#fee2e2;
      color:#b91c1c;
      border:1px solid #fecaca;
    }
    .nav-item.logout:hover{background:#fecaca;}

    .main{
      display:flex;flex-direction:column;flex:1;min-width:0;
    }
    .topbar{
      height:70px;background:var(--panel);
      border-bottom:1px solid var(--border);
      padding:12px 18px;
      display:flex;justify-content:space-between;align-items:center;
    }
    .topbar-title{font-size:16px;font-weight:700;}
    .topbar-sub{font-size:11px;color:var(--muted);}

    .content-area{flex:1;padding:20px;overflow-y:auto;background:var(--bg);}

    .page{display:none;}
    .page.active{display:block;}
    .page-header{
      display:flex;justify-content:space-between;
      align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:10px;
    }
    .page-title{font-size:18px;font-weight:700;}
    .page-sub{font-size:12px;color:var(--muted);}
    .page-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}

    /* Shopify integration */
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      font-size:12px;border:1px solid var(--border);
      background:var(--panel-soft); color:var(--muted);
    }
    .badge.ok{ background: rgba(22,163,74,.12); border-color: rgba(22,163,74,.25); color: #16a34a; }
    .badge.warn{ background: rgba(250,204,21,.14); border-color: rgba(250,204,21,.30); color:#b45309; }

    .shopify-toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px;}
    .shopify-grid{display:grid;gap:10px;margin-top:12px;}
    .shopify-item{
      display:flex;gap:10px;align-items:flex-start;
      padding:10px;border:1px solid var(--border);border-radius:12px;background:var(--panel);
    }
    .shopify-thumb{
      width:44px;height:44px;border-radius:10px;
      background:var(--panel-soft) center/cover no-repeat;
      border:1px solid var(--border);flex:0 0 auto;
    }
    .shopify-meta{flex:1;min-width:0}
    .shopify-title{font-weight:600;font-size:13px;color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .shopify-sub{font-size:12px;color:var(--muted);margin-top:2px}
    .shopify-variants{
      margin-top:8px;padding-top:8px;border-top:1px dashed var(--border);
      display:grid;gap:6px;
    }
    .shopify-variant-row{
      display:flex;gap:8px;align-items:center;justify-content:space-between;
      font-size:12px;color:var(--muted);
    }
    .shopify-variant-left{display:flex;gap:8px;align-items:center;min-width:0}
    .shopify-variant-name{color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px}
    .shopify-pill{
      font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid var(--border);background:var(--panel-soft);
    }

    .toolbar{
      display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;align-items:center;
      font-size:12px;
    }
    .toolbar input,
    .toolbar select{
      padding:6px 9px;border-radius:9px;
      border:1px solid var(--border);background:#fff;font-size:12px;
    }

    .cards-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:12px;margin-bottom:22px;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:18px;
      box-shadow:var(--shadow);
    }
    .card-title{font-size:13px;color:var(--muted);margin-bottom:4px;}
    .card-number{font-size:20px;font-weight:700;}
    .card-note{font-size:11px;color:var(--muted);margin-top:6px;}

    .card-disabled{
      opacity:.6;
      pointer-events:none;
    }

    .table-wrapper{
      background:#fff;border-radius:12px;border:1px solid var(--border);
      overflow-x:auto;
    }
    table{width:100%;border-collapse:collapse;font-size:12px;}
    thead{background:var(--panel-soft);}
    th,td{padding:9px 10px;border-bottom:1px solid var(--border);text-align:left;}
    th{
      font-size:11px;text-transform:uppercase;color:var(--muted);
      letter-spacing:.04em;
    }
    tbody tr:hover{background:#f9fafb;}
    .table-empty{text-align:center;padding:20px;font-size:12px;color:var(--muted);}

    .pill{
      padding:4px 9px;border-radius:999px;
      font-size:11px;font-weight:600;display:inline-flex;align-items:center;
      border:1px solid var(--border);
    }
    .pill.ok{background:#dcfce7;color:#166534;border-color:#bbf7d0;}
    .pill.warn{background:#fef9c3;color:#854d0e;border-color:#fde68a;}
    .pill.bad{background:#fee2e2;color:#991b1b;border-color:#fecaca;}

    .mini-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:12px;
    }

    /* MODAL */
    .modal-backdrop{
      position:fixed;inset:0;
      background:rgba(15,23,42,.5);
      display:none;
      align-items:center;justify-content:center;
      z-index:50;
      padding:14px;
    }
    .modal{
      width:100%;
      max-width:520px;
      background:var(--panel);
      border-radius:16px;
      border:1px solid rgba(148,163,184,.4);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modal-body{padding:16px;}
    .modal-title{font-size:15px;font-weight:700;}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:14px;}

    /* STATUS BANNER */
    .status-banner{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow:var(--shadow);
      margin-bottom:14px;
      display:flex;gap:10px;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;
    }
    .status-left{display:flex;flex-direction:column;gap:6px;}
    .status-title{font-size:13px;font-weight:700;}
    .status-sub{font-size:12px;color:var(--muted);max-width:520px;}
    .muted{color:var(--muted);}

    /* SETTINGS */
    .settings-row{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px;
    }
    .settings-row .field{flex:1;min-width:220px;}
  </style>
</head>
<body>

  <!-- AUTH -->
  <div id="authView" class="auth-wrapper">
    <div class="auth-header">
      <div class="auth-logo" id="authBrandLogo">L</div>
      <div>
        <div class="auth-title">Brand Dashboard</div>
        <div class="auth-subtitle">Log in with your brand owner account.</div>
        <div class="event-chip" id="authEventChip"></div>
      </div>
    </div>

    <div class="auth-tabs">
      <div id="tab-login" class="auth-tab active">Login</div>
      <div id="tab-register" class="auth-tab">Register</div>
    </div>

    <div id="authAlert" class="auth-alert auth-alert-info" style="display:none;"></div>

    <!-- LOGIN -->
    <div id="loginForm">
      <div class="field">
        <div class="field-label">Email</div>
        <input id="loginEmail" class="field-input" type="email" placeholder="you@brand.com"/>
      </div>
      <div class="field">
        <div class="field-label">Password</div>
        <input id="loginPass" class="field-input" type="password" placeholder="••••••••"/>
      </div>
      <button id="btnLogin" class="btn btn-primary" style="width:100%;">Login</button>
    </div>

    <!-- REGISTER -->
    <div id="registerForm" style="display:none;">
      <div class="field">
        <div class="field-label">Brand name</div>
        <input id="regBrandName" class="field-input" placeholder="Your brand name"/>
      </div>
      <div class="field">
        <div class="field-label">Email</div>
        <input id="regEmail" class="field-input" type="email" placeholder="you@brand.com"/>
      </div>
      <div class="field">
        <div class="field-label">Password</div>
        <input id="regPass" class="field-input" type="password" placeholder="••••••••"/>
      </div>
      <div class="field">
        <div class="field-label">Phone (optional)</div>
        <input id="regPhone" class="field-input" placeholder="+20 01x xxx xxxx"/>
      </div>
      <button id="btnRegister" class="btn btn-primary" style="width:100%;">Create account</button>
      <div class="auth-footer">After registration, your brand may need approval by the event owner.</div>
    </div>
  </div>

  <!-- APP -->
  <div id="appShell" class="app-shell">
    <aside class="sidebar">
      <div class="sidebar-brand">
        <div class="sidebar-logo" id="brandLogo">L</div>
        <div>
          <div class="sidebar-brand-name" id="brandName">Brand</div>
          <div class="muted" style="font-size:11px;" id="brandStatusText">Status: pending</div>
        </div>
      </div>

      <div class="sidebar-nav">
        <div class="nav-item active" data-page="overview"><span>Overview</span><span>›</span></div>
        <div class="nav-item" data-page="products"><span>Products</span><span>›</span></div>
        <div class="nav-item" data-page="staff"><span>Staff</span><span>›</span></div>
        <div class="nav-item" data-page="orders"><span>Orders</span><span>›</span></div>
        <div class="nav-item" data-page="customers"><span>Customers</span><span>›</span></div>
        <div class="nav-item" data-page="settings"><span>Settings</span><span>›</span></div>

        <div class="nav-item logout" id="btnLogout"><span>Logout</span><span>⎋</span></div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div>
          <div class="topbar-title" id="topbarTitle">Brand Dashboard</div>
          <div class="topbar-sub" id="topbarSub">Manage your booth operations.</div>
        </div>
        <div class="muted" style="font-size:11px;" id="eventInfo"></div>
      </div>

      <div class="content-area">

        <!-- OVERVIEW -->
        <section id="page-overview" class="page active">
          <div id="statusBanner" class="status-banner" style="display:none;">
            <div class="status-left">
              <div class="status-title" id="statusBannerTitle">Status</div>
              <div class="status-sub" id="statusBannerSub"></div>
            </div>
            <div id="statusBannerActions"></div>
          </div>

          <div class="cards-grid">
            <div class="card">
              <div class="card-title">Today's Revenue</div>
              <div id="kpiRevenueToday" class="card-number">0</div>
              <div class="card-note">Sum of orders for today.</div>
            </div>
            <div class="card">
              <div class="card-title">Orders Today</div>
              <div id="kpiOrdersToday" class="card-number">0</div>
              <div class="card-note">Number of orders placed today.</div>
            </div>
            <div class="card">
              <div class="card-title">Average Order Value</div>
              <div id="kpiAOV" class="card-number">0</div>
              <div class="card-note">Total revenue / total orders.</div>
            </div>
            <div class="card">
              <div class="card-title">Low Stock Items</div>
              <div id="kpiLowStock" class="card-number">0</div>
              <div class="card-note">Products below your low-stock threshold.</div>
            </div>
          </div>

          <div class="mini-grid">
            <div class="card">
              <div class="card-title">Top Products (Today)</div>
              <div class="card-note">Best sellers based on today's orders.</div>
              <div style="margin-top:10px;" class="table-wrapper" id="topProductsWrapper"></div>
            </div>
            <div class="card">
              <div class="card-title">Recent Orders</div>
              <div class="card-note">Latest orders placed for your brand.</div>
              <div style="margin-top:10px;" class="table-wrapper" id="recentOrdersWrapper"></div>
            </div>
          </div>
        </section>

        <!-- PRODUCTS -->
        <section id="page-products" class="page">
          <div class="page-header">
            <div>
              <div class="page-title" style="font-size:16px;">Products</div>
              <div class="page-sub">
                Manage your products for this event. Images, prices, stock, and simple variants.
              </div>
            </div>
            <div class="page-actions" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
              <button id="btn-shopify-connect" class="btn btn-ghost">Connect Shopify</button>
              <button id="btn-shopify-import" class="btn btn-primary">Import from Shopify</button>
              <button id="btn-shopify-disconnect" class="btn btn-danger">Disconnect</button>
              <button id="btn-add-product" class="btn btn-ghost">Add product</button>
            </div>
          </div>

          <div style="margin-top:-6px;margin-bottom:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <span id="shopify-status" class="badge">Shopify: Not connected</span>
            <span id="shopify-store" class="muted" style="font-size:12px;"></span>
          </div>

          <div class="toolbar">
            <input id="products-search" type="text" placeholder="Search products by name or SKU"/>
            <select id="products-sort">
              <option value="name-asc">Sort by name (A–Z)</option>
              <option value="name-desc">Sort by name (Z–A)</option>
              <option value="price-asc">Price (low → high)</option>
              <option value="price-desc">Price (high → low)</option>
              <option value="stock-asc">Stock (low → high)</option>
              <option value="stock-desc">Stock (high → low)</option>
            </select>
          </div>

          <div class="table-wrapper" id="products-table-wrapper">
            <!-- Filled by JS -->
          </div>

          <div id="lowStockPanel">
            <div id="lowStockPanelTitle">Low stock alerts</div>
            <div id="lowStockList"></div>
          </div>
        </section>

        <!-- STAFF & POS USERS -->
        <section id="page-staff" class="page">
          <div class="page-header">
            <div>
              <div class="page-title" style="font-size:16px;">Staff & POS Users</div>
              <div class="page-sub">
                Create and manage cashier users who can log in to the POS for this event.
              </div>
            </div>
            <div class="page-actions">
              <button id="btn-add-staff" class="btn btn-primary">Add POS user</button>
            </div>
          </div>

          <div class="card">
            <div class="card-title">How POS users work</div>
            <div class="card-note" style="margin-top:4px;">
              Each POS user gets a username and PIN. They log in to the POS page and can only see orders for your brand.
            </div>
          </div>

          <div class="toolbar" style="margin-top:12px;">
            <input id="staff-search" type="text" placeholder="Search staff by name or username"/>
          </div>

          <div class="table-wrapper" id="staff-table-wrapper">
            <!-- Filled by JS -->
          </div>
        </section>

        <!-- CUSTOMERS -->
        <section id="page-customers" class="page">
          <div class="page-header">
            <div>
              <div class="page-title" style="font-size:16px;">Customers</div>
              <div class="page-sub">
                Customers are calculated from your orders. Totals & spend are based on all historical orders.
              </div>
            </div>
          </div>

          <div class="cards-grid">
            <div class="card">
              <div class="card-title">Total Customers</div>
              <div id="customers-total" class="card-number">0</div>
              <div class="card-note">Distinct customers detected from your orders.</div>
            </div>
            <div class="card">
              <div class="card-title">Average Spend / Customer</div>
              <div id="customers-avg-spend" class="card-number">0</div>
              <div class="card-note">Total revenue divided by unique customers.</div>
            </div>
          </div>

          <div class="toolbar">
            <input id="customers-search" type="text" placeholder="Search by name, phone, or email"/>
            <select id="customers-sort">
              <option value="spend-desc">Sort by spend (high → low)</option>
              <option value="spend-asc">Spend (low → high)</option>
              <option value="orders-desc">Orders (high → low)</option>
              <option value="orders-asc">Orders (low → high)</option>
              <option value="name-asc">Name (A–Z)</option>
              <option value="name-desc">Name (Z–A)</option>
            </select>
          </div>

          <div class="table-wrapper" id="customers-table-wrapper">
            <!-- Filled by JS -->
          </div>
        </section>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Luma Events — Brand Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#f3f4f6;
      --panel:#ffffff;
      --panel-soft:#f9fafb;
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#2563eb;
      --accent-soft:#dbeafe;
      --accent-strong:#1d4ed8;
      --radius:16px;
      --shadow:0 18px 40px rgba(15,23,42,.12);
      --danger:#ef4444;
      --ok:#16a34a;
      --pending:#facc15;
      --suspended:#dc2626;
      --active:#16a34a;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      font-family:"Montserrat",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--ink);
    }

    /* AUTH WRAPPER */
    .auth-wrapper{
      width:100%;
      max-width:460px;
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(148,163,184,3);
      padding:18px;
      margin:40px auto;
    }
    .auth-header{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
    }
    .auth-logo{
      width:38px;height:38px;border-radius:999px;
      background:linear-gradient(135deg,#2563eb,#a855f7);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;font-size:18px;
      overflow:hidden;
      background-size:cover;
      background-position:center;
    }
    .auth-title{font-size:17px;font-weight:700;}
    .auth-subtitle{font-size:11px;color:var(--muted);margin-top:2px;}
    .event-chip{
      font-size:10px;
      color:var(--muted);
      margin-top:2px;
    }

    .auth-tabs{
      display:flex;gap:6px;margin:10px 0 12px;
    }
    .auth-tab{
      flex:1;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--panel-soft);
      color:var(--muted);
      font-size:12px;
      cursor:pointer;
      text-align:center;
    }
    .auth-tab.active{
      background:var(--accent-soft);
      border-color:var(--accent-soft);
      color:var(--accent-strong);
      font-weight:600;
    }
    .auth-alert{
      padding:8px 10px;
      border-radius:10px;
      font-size:11px;
      margin-bottom:10px;
    }
    .auth-alert-error{background:#fef2f2;color:#b91c1c;border:1px solid #fecaca;}
    .auth-alert-info{background:#eff6ff;color:#1d4ed8;border:1px solid #bfdbfe;}

    .field{margin-bottom:10px;}
    .field-label{font-size:11px;margin-bottom:4px;color:#4b5563;}
    .field-input,.field-select,textarea.field-input{
      width:100%;padding:8px;border-radius:9px;
      border:1px solid var(--border);background:#f9fafb;font-size:12px;
    }
    .field-input:focus,.field-select:focus,textarea.field-input:focus{
      outline:none;border-color:var(--accent);box-shadow:0 0 0 1px var(--accent-soft);
    }
    .field-hint{font-size:10px;color:var(--muted);margin-top:3px;}

    .btn{
      border:none;border-radius:999px;
      padding:8px 12px;font-size:12px;font-weight:600;
      cursor:pointer;display:inline-flex;align-items:center;justify-content:center;
      gap:6px;
    }
    .btn-primary{background:var(--accent);color:#fff;}
    .btn-primary:hover{background:var(--accent-strong);}
    .btn-ghost{
      background:transparent;color:var(--accent-strong);
      border:1px solid var(--accent-soft);
    }
    .btn-ghost:hover{background:var(--accent-soft);}
    .btn-danger{background:var(--danger);color:#fff;}
    .btn-danger:hover{background:#b91c1c;}

    .auth-footer{text-align:center;margin-top:8px;font-size:10px;color:var(--muted);}

    /* APP LAYOUT */
    .app-shell{
      display:none;
      height:100vh;width:100%;
    }
    .sidebar{
      width:220px;background:var(--panel);
      border-right:1px solid var(--border);
      display:flex;flex-direction:column;
      padding:20px 12px;
    }
    .sidebar-brand{
      display:flex;align-items:center;gap:10px;margin-bottom:18px;
    }
    .sidebar-logo{
      width:36px;height:36px;border-radius:999px;
      background:linear-gradient(135deg,#2563eb,#a855f7);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;
      overflow:hidden;
      background-size:cover;
      background-position:center;
    }
    .sidebar-brand-name{font-size:15px;font-weight:700;}
    .sidebar-nav{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:12px;
      flex:1;
    }
    .nav-item{
      padding:10px 10px;
      border-radius:12px;
      cursor:pointer;
      color:#111827;
      font-size:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border:1px solid transparent;
    }
    .nav-item:hover{background:var(--panel-soft);}
    .nav-item.active{background:var(--accent-soft);color:var(--accent-strong);font-weight:600;}
    .nav-item.logout{
      margin-top:auto;
      background:#fee2e2;
      color:#b91c1c;
      border:1px solid #fecaca;
    }
    .nav-item.logout:hover{background:#fecaca;}

    .main{
      display:flex;flex-direction:column;flex:1;min-width:0;
    }
    .topbar{
      height:70px;background:var(--panel);
      border-bottom:1px solid var(--border);
      padding:12px 18px;
      display:flex;justify-content:space-between;align-items:center;
    }
    .topbar-title{font-size:16px;font-weight:700;}
    .topbar-sub{font-size:11px;color:var(--muted);}

    .content-area{flex:1;padding:20px;overflow-y:auto;background:var(--bg);}

    .page{display:none;}
    .page.active{display:block;}
    .page-header{
      display:flex;justify-content:space-between;
      align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:10px;
    }
    .page-title{font-size:18px;font-weight:700;}
    .page-sub{font-size:12px;color:var(--muted);}
    .page-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}

    /* Shopify integration */
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      font-size:12px;border:1px solid var(--border);
      background:var(--panel-soft); color:var(--muted);
    }
    .badge.ok{ background: rgba(22,163,74,.12); border-color: rgba(22,163,74,.25); color: #16a34a; }
    .badge.warn{ background: rgba(250,204,21,.14); border-color: rgba(250,204,21,.30); color:#b45309; }

    .shopify-toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px;}
    .shopify-grid{display:grid;gap:10px;margin-top:12px;}
    .shopify-item{
      display:flex;gap:10px;align-items:flex-start;
      padding:10px;border:1px solid var(--border);border-radius:12px;background:var(--panel);
    }
    .shopify-thumb{
      width:44px;height:44px;border-radius:10px;
      background:var(--panel-soft) center/cover no-repeat;
      border:1px solid var(--border);flex:0 0 auto;
    }
    .shopify-meta{flex:1;min-width:0}
    .shopify-title{font-weight:600;font-size:13px;color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .shopify-sub{font-size:12px;color:var(--muted);margin-top:2px}
    .shopify-variants{
      margin-top:8px;padding-top:8px;border-top:1px dashed var(--border);
      display:grid;gap:6px;
    }
    .shopify-variant-row{
      display:flex;gap:8px;align-items:center;justify-content:space-between;
      font-size:12px;color:var(--muted);
    }
    .shopify-variant-left{display:flex;gap:8px;align-items:center;min-width:0}
    .shopify-variant-name{color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px}
    .shopify-pill{
      font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid var(--border);background:var(--panel-soft);
    }

    .toolbar{
      display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;align-items:center;
      font-size:12px;
    }
    .toolbar input,
    .toolbar select{
      padding:6px 9px;border-radius:9px;
      border:1px solid var(--border);background:#fff;font-size:12px;
    }

    .cards-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:12px;margin-bottom:22px;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:18px;
      box-shadow:var(--shadow);
    }
    .card-title{font-size:13px;color:var(--muted);margin-bottom:4px;}
    .card-number{font-size:20px;font-weight:700;}
    .card-note{font-size:11px;color:var(--muted);margin-top:6px;}

    .card-disabled{
      opacity:.6;
      pointer-events:none;
    }

    .table-wrapper{
      background:#fff;border-radius:12px;border:1px solid var(--border);
      overflow-x:auto;
    }
    table{width:100%;border-collapse:collapse;font-size:12px;}
    thead{background:var(--panel-soft);}
    th,td{padding:9px 10px;border-bottom:1px solid var(--border);text-align:left;}
    th{
      font-size:11px;text-transform:uppercase;color:var(--muted);
      letter-spacing:.04em;
    }
    tbody tr:hover{background:#f9fafb;}
    .table-empty{text-align:center;padding:20px;font-size:12px;color:var(--muted);}

    .pill{
      padding:4px 9px;border-radius:999px;
      font-size:11px;font-weight:600;display:inline-flex;align-items:center;
      border:1px solid var(--border);
    }
    .pill.ok{background:#dcfce7;color:#166534;border-color:#bbf7d0;}
    .pill.warn{background:#fef9c3;color:#854d0e;border-color:#fde68a;}
    .pill.bad{background:#fee2e2;color:#991b1b;border-color:#fecaca;}

    .mini-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:12px;
    }

    /* MODAL */
    .modal-backdrop{
      position:fixed;inset:0;
      background:rgba(15,23,42,.5);
      display:none;
      align-items:center;justify-content:center;
      z-index:50;
      padding:14px;
    }
    .modal{
      width:100%;
      max-width:520px;
      background:var(--panel);
      border-radius:16px;
      border:1px solid rgba(148,163,184,.4);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modal-body{padding:16px;}
    .modal-title{font-size:15px;font-weight:700;}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:14px;}

    /* STATUS BANNER */
    .status-banner{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow:var(--shadow);
      margin-bottom:14px;
      display:flex;gap:10px;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;
    }
    .status-left{display:flex;flex-direction:column;gap:6px;}
    .status-title{font-size:13px;font-weight:700;}
    .status-sub{font-size:12px;color:var(--muted);max-width:520px;}
    .muted{color:var(--muted);}

    /* SETTINGS */
    .settings-row{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px;
    }
    .settings-row .field{flex:1;min-width:220px;}
  </style>
</head>
<body>

  <!-- AUTH -->
  <div id="authView" class="auth-wrapper">
    <div class="auth-header">
      <div class="auth-logo" id="authBrandLogo">L</div>
      <div>
        <div class="auth-title">Brand Dashboard</div>
        <div class="auth-subtitle">Log in with your brand owner account.</div>
        <div class="event-chip" id="authEventChip"></div>
      </div>
    </div>

    <div class="auth-tabs">
      <div id="tab-login" class="auth-tab active">Login</div>
      <div id="tab-register" class="auth-tab">Register</div>
    </div>

    <div id="authAlert" class="auth-alert auth-alert-info" style="display:none;"></div>

    <!-- LOGIN -->
    <div id="loginForm">
      <div class="field">
        <div class="field-label">Email</div>
        <input id="loginEmail" class="field-input" type="email" placeholder="you@brand.com"/>
      </div>
      <div class="field">
        <div class="field-label">Password</div>
        <input id="loginPass" class="field-input" type="password" placeholder="••••••••"/>
      </div>
      <button id="btnLogin" class="btn btn-primary" style="width:100%;">Login</button>
    </div>

    <!-- REGISTER -->
    <div id="registerForm" style="display:none;">
      <div class="field">
        <div class="field-label">Brand name</div>
        <input id="regBrandName" class="field-input" placeholder="Your brand name"/>
      </div>
      <div class="field">
        <div class="field-label">Email</div>
        <input id="regEmail" class="field-input" type="email" placeholder="you@brand.com"/>
      </div>
      <div class="field">
        <div class="field-label">Password</div>
        <input id="regPass" class="field-input" type="password" placeholder="••••••••"/>
      </div>
      <div class="field">
        <div class="field-label">Phone (optional)</div>
        <input id="regPhone" class="field-input" placeholder="+20 01x xxx xxxx"/>
      </div>
      <button id="btnRegister" class="btn btn-primary" style="width:100%;">Create account</button>
      <div class="auth-footer">After registration, your brand may need approval by the event owner.</div>
    </div>
  </div>

  <!-- APP -->
  <div id="appShell" class="app-shell">
    <aside class="sidebar">
      <div class="sidebar-brand">
        <div class="sidebar-logo" id="brandLogo">L</div>
        <div>
          <div class="sidebar-brand-name" id="brandName">Brand</div>
          <div class="muted" style="font-size:11px;" id="brandStatusText">Status: pending</div>
        </div>
      </div>

      <div class="sidebar-nav">
        <div class="nav-item active" data-page="overview"><span>Overview</span><span>›</span></div>
        <div class="nav-item" data-page="products"><span>Products</span><span>›</span></div>
        <div class="nav-item" data-page="staff"><span>Staff</span><span>›</span></div>
        <div class="nav-item" data-page="orders"><span>Orders</span><span>›</span></div>
        <div class="nav-item" data-page="customers"><span>Customers</span><span>›</span></div>
        <div class="nav-item" data-page="settings"><span>Settings</span><span>›</span></div>

        <div class="nav-item logout" id="btnLogout"><span>Logout</span><span>⎋</span></div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div>
          <div class="topbar-title" id="topbarTitle">Brand Dashboard</div>
          <div class="topbar-sub" id="topbarSub">Manage your booth operations.</div>
        </div>
        <div class="muted" style="font-size:11px;" id="eventInfo"></div>
      </div>

      <div class="content-area">

        <!-- OVERVIEW -->
        <section id="page-overview" class="page active">
          <div id="statusBanner" class="status-banner" style="display:none;">
            <div class="status-left">
              <div class="status-title" id="statusBannerTitle">Status</div>
              <div class="status-sub" id="statusBannerSub"></div>
            </div>
            <div id="statusBannerActions"></div>
          </div>

          <div class="cards-grid">
            <div class="card">
              <div class="card-title">Today's Revenue</div>
              <div id="kpiRevenueToday" class="card-number">0</div>
              <div class="card-note">Sum of orders for today.</div>
            </div>
            <div class="card">
              <div class="card-title">Orders Today</div>
              <div id="kpiOrdersToday" class="card-number">0</div>
              <div class="card-note">Number of orders placed today.</div>
            </div>
            <div class="card">
              <div class="card-title">Average Order Value</div>
              <div id="kpiAOV" class="card-number">0</div>
              <div class="card-note">Total revenue / total orders.</div>
            </div>
            <div class="card">
              <div class="card-title">Low Stock Items</div>
              <div id="kpiLowStock" class="card-number">0</div>
              <div class="card-note">Products below your low-stock threshold.</div>
            </div>
          </div>

          <div class="mini-grid">
            <div class="card">
              <div class="card-title">Top Products (Today)</div>
              <div class="card-note">Best sellers based on today's orders.</div>
              <div style="margin-top:10px;" class="table-wrapper" id="topProductsWrapper"></div>
            </div>
            <div class="card">
              <div class="card-title">Recent Orders</div>
              <div class="card-note">Latest orders placed for your brand.</div>
              <div style="margin-top:10px;" class="table-wrapper" id="recentOrdersWrapper"></div>
            </div>
          </div>
        </section>

        <!-- PRODUCTS -->
        <section id="page-products" class="page">
          <div class="page-header">
            <div>
              <div class="page-title" style="font-size:16px;">Products</div>
              <div class="page-sub">
                Manage your products for this event. Images, prices, stock, and simple variants.
              </div>
            </div>
            <div class="page-actions" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
              <button id="btn-shopify-connect" class="btn btn-ghost">Connect Shopify</button>
              <button id="btn-shopify-import" class="btn btn-primary">Import from Shopify</button>
              <button id="btn-shopify-disconnect" class="btn btn-danger">Disconnect</button>
              <button id="btn-add-product" class="btn btn-ghost">Add product</button>
            </div>
          </div>

          <div style="margin-top:-6px;margin-bottom:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <span id="shopify-status" class="badge">Shopify: Not connected</span>
            <span id="shopify-store" class="muted" style="font-size:12px;"></span>
          </div>

          <div class="toolbar">
            <input id="products-search" type="text" placeholder="Search products by name or SKU"/>
            <select id="products-sort">
              <option value="name-asc">Sort by name (A–Z)</option>
              <option value="name-desc">Sort by name (Z–A)</option>
              <option value="price-asc">Price (low → high)</option>
              <option value="price-desc">Price (high → low)</option>
              <option value="stock-asc">Stock (low → high)</option>
              <option value="stock-desc">Stock (high → low)</option>
            </select>
          </div>

          <div class="table-wrapper" id="products-table-wrapper">
            <!-- Filled by JS -->
          </div>

          <div id="lowStockPanel">
            <div id="lowStockPanelTitle">Low stock alerts</div>
            <div id="lowStockList"></div>
          </div>
        </section>

        <!-- STAFF & POS USERS -->
        <section id="page-staff" class="page">
          <div class="page-header">
            <div>
              <div class="page-title" style="font-size:16px;">Staff & POS Users</div>
              <div class="page-sub">
                Create and manage cashier users who can log in to the POS for this event.
              </div>
            </div>
            <div class="page-actions">
              <button id="btn-add-staff" class="btn btn-primary">Add POS user</button>
            </div>
          </div>

          <div class="card">
            <div class="card-title">How POS users work</div>
            <div class="card-note" style="margin-top:4px;">
              Each POS user gets a username and PIN. They log in to the POS page and can only see orders for your brand.
            </div>
          </div>

          <div class="toolbar" style="margin-top:12px;">
            <input id="staff-search" type="text" placeholder="Search staff by name or username"/>
          </div>

          <div class="table-wrapper" id="staff-table-wrapper">
            <!-- Filled by JS -->
          </div>
        </section>

        <!-- CUSTOMERS -->
        <section id="page-customers" class="page">
          <div class="page-header">
            <div>
              <div class="page-title" style="font-size:16px;">Customers</div>
              <div class="page-sub">
                Customers are calculated from your orders. Totals & spend are based on all historical orders.
              </div>
            </div>
          </div>

          <div class="cards-grid">
            <div class="card">
              <div class="card-title">Total Customers</div>
              <div id="customers-total" class="card-number">0</div>
              <div class="card-note">Distinct customers detected from your orders.</div>
            </div>
            <div class="card">
              <div class="card-title">Average Spend / Customer</div>
              <div id="customers-avg-spend" class="card-number">0</div>
              <div class="card-note">Total revenue divided by unique customers.</div>
            </div>
          </div>

          <div class="toolbar">
            <input id="customers-search" type="text" placeholder="Search by name, phone, or email"/>
            <select id="customers-sort">
              <option value="spend-desc">Sort by spend (high → low)</option>
              <option value="spend-asc">Spend (low → high)</option>
              <option value="orders-desc">Orders (high → low)</option>
              <option value="orders-asc">Orders (low → high)</option>
              <option value="name-asc">Name (A–Z)</option>
              <option value="name-desc">Name (Z–A)</option>
            </select>
          </div>

          <div class="table-wrapper" id="customers-table-wrapper">
            <!-- Filled by JS -->
          </div>
        </section>
    /***********************
     * Shopify: Import modal (search + select all + variant selection)
     ***********************/
    function openShopifyImportModal(productsList){
      openModal(`
        <div class="modal-title">Import from Shopify</div>
        <div class="field-hint" style="margin-top:6px;">
          Select products (optionally specific variants). Inventory is Shopify → Luma only. Sales & receipts stay in Luma.
        </div>

        <div class="shopify-toolbar">
          <input id="shopify-search" class="field-input" placeholder="Search Shopify products..." style="flex:1;min-width:220px;"/>
          <button id="shopify-select-all" class="btn btn-ghost" type="button">Select all</button>
          <button id="shopify-clear" class="btn btn-ghost" type="button">Clear</button>
        </div>

        <div id="shopify-list" class="shopify-grid"></div>

        <div class="modal-actions" style="margin-top:14px;">
          <button type="button" class="btn btn-ghost" onclick="closeModal()">Cancel</button>
          <button type="button" id="shopify-import-confirm" class="btn btn-primary">Import selected</button>
        </div>
      `);

      const listEl   = qs("#shopify-list");
      const searchEl = qs("#shopify-search");
      const btnAll   = qs("#shopify-select-all");
      const btnClr   = qs("#shopify-clear");
      const btnGo    = qs("#shopify-import-confirm");

      // selectedProductsMap[productId] = { all:true } OR { all:false, variants:Set(variantId) }
      const selectedProductsMap = new Map();

      function isSelectedProduct(pid){
        return selectedProductsMap.has(String(pid));
      }
      function setSelectProductAll(pid, on){
        const k = String(pid);
        if (on) selectedProductsMap.set(k, { all:true, variants:new Set() });
        else selectedProductsMap.delete(k);
      }
      function setSelectVariant(pid, vid, on){
        const k = String(pid);
        if (!selectedProductsMap.has(k)) selectedProductsMap.set(k, { all:false, variants:new Set() });
        const entry = selectedProductsMap.get(k);
        entry.all = false;
        if (on) entry.variants.add(String(vid));
        else entry.variants.delete(String(vid));
        if (!entry.all && entry.variants.size === 0) selectedProductsMap.delete(k);
      }

      function render(){
        const q = (searchEl.value || "").toLowerCase().trim();
        const filtered = !q
          ? productsList
          : productsList.filter(p => (p.title || "").toLowerCase().includes(q));

        if (!filtered.length){
          listEl.innerHTML = `<div class="table-empty">No matching products.</div>`;
          return;
        }

        listEl.innerHTML = filtered.map(p => {
          const pid = String(p.id);
          const checked = isSelectedProduct(pid) ? "checked" : "";
          const imgStyle = p.image ? `style="background-image:url('${p.image}')"` : "";
          const variants = Array.isArray(p.variants) ? p.variants : [];
          const entry = selectedProductsMap.get(pid);
          const modeLabel = entry?.all ? "All variants" : (entry ? `${entry.variants.size} variant(s)` : "Not selected");

          const variantsHtml = variants.length ? `
            <div class="shopify-variants">
              ${variants.map(v => {
                const vChecked = entry?.all
                  ? "checked"
                  : (entry?.variants?.has(String(v.id)) ? "checked" : "");
                const vPrice = v.price != null ? `${escapeHtml(String(v.price))}` : "-";
                const vSku = v.sku ? escapeHtml(v.sku) : "-";
                return `
                  <label class="shopify-variant-row">
                    <span class="shopify-variant-left">
                      <input type="checkbox" class="shopify-variant-cb" data-pid="${pid}" data-vid="${v.id}" ${vChecked}/>
                      <span class="shopify-variant-name">${escapeHtml(v.title || "Variant")}</span>
                      <span class="shopify-pill">SKU: ${vSku}</span>
                    </span>
                    <span class="shopify-pill">Price: ${vPrice}</span>
                  </label>
                `;
              }).join("")}
              <div style="font-size:11px;color:var(--muted);margin-top:4px;">
                Tip: Check product to import all variants. Or select specific variants only.
              </div>
            </div>
          ` : ``;

          return `
            <div class="shopify-item">
              <input type="checkbox" class="shopify-prod-cb" data-pid="${pid}" ${checked} style="margin-top:4px;"/>
              <div class="shopify-thumb" ${imgStyle}></div>
              <div class="shopify-meta">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                  <div class="shopify-title">${escapeHtml(p.title || "Untitled")}</div>
                  <span class="shopify-pill">${escapeHtml(modeLabel)}</span>
                </div>
                <div class="shopify-sub">
                  Variants: ${Number(p.variantsCount || variants.length || 0)} · Status: ${escapeHtml(p.status || "-")}
                </div>
                ${variantsHtml}
              </div>
            </div>
          `;
        }).join("");

        // product checkbox = import all variants
        qsa(".shopify-prod-cb", listEl).forEach(cb => {
          cb.addEventListener("change", () => {
            const pid = cb.getAttribute("data-pid");
            setSelectProductAll(pid, cb.checked);
            render();
          });
        });

        // variant checkbox = import specific variants
        qsa(".shopify-variant-cb", listEl).forEach(cb => {
          cb.addEventListener("change", () => {
            const pid = cb.getAttribute("data-pid");
            const vid = cb.getAttribute("data-vid");
            setSelectVariant(pid, vid, cb.checked);
            render();
          });
        });
      }

      searchEl.addEventListener("input", render);

      btnAll.addEventListener("click", () => {
        const q = (searchEl.value || "").toLowerCase().trim();
        const filtered = !q ? productsList : productsList.filter(p => (p.title || "").toLowerCase().includes(q));
        filtered.forEach(p => setSelectProductAll(p.id, true));
        render();
      });

      btnClr.addEventListener("click", () => {
        selectedProductsMap.clear();
        render();
      });

      btnGo.addEventListener("click", async () => {
        try{
          if (selectedProductsMap.size === 0) return alert("Select at least 1 product.");

          btnGo.disabled = true;
          btnGo.textContent = "Importing…";

          // Build payload expected by backend; variantIds optional
          const selectedProducts = [];
          for (const [pid, entry] of selectedProductsMap.entries()){
            if (entry.all){
              selectedProducts.push({ productId: Number(pid) });
            } else {
              selectedProducts.push({ productId: Number(pid), variantIds: Array.from(entry.variants).map(Number) });
            }
          }

          const result = await shopifyImportSelected(selectedProducts);

          await loadProducts();
          closeModal();
          alert(`Imported ${result.importedProducts || selectedProducts.length} product(s) successfully.`);
        } catch(err){
          console.error(err);
          alert(err.message || "Import failed.");
        } finally{
          btnGo.disabled = false;
          btnGo.textContent = "Import selected";
        }
      });

      render();
    }

    /***********************
     * Shopify: UI status
     ***********************/
    function setShopifyStatus(connected, shop=null, extra=""){
      shopifyConnected = !!connected;
      shopifyShop = shop || null;

      if (!shopifyStatusEl) return;

      if (connected){
        shopifyStatusEl.textContent = "Shopify: Connected";
        shopifyStatusEl.classList.add("ok");
        shopifyStatusEl.classList.remove("warn");
        if (shopifyStoreEl){
          shopifyStoreEl.textContent = shop ? `Store: ${shop}${extra ? " · "+extra : ""}` : (extra || "");
        }
      } else {
        shopifyStatusEl.textContent = "Shopify: Not connected";
        shopifyStatusEl.classList.remove("ok");
        shopifyStatusEl.classList.remove("warn");
        if (shopifyStoreEl) shopifyStoreEl.textContent = "";
      }
    }

    async function refreshShopifyStatus(){
      // If redirected from OAuth, mark as connected quickly
      if (urlParam("shopify") === "connected") {
        setShopifyStatus(true, null, "");
        const u = new URL(window.location.href);
        u.searchParams.delete("shopify");
        window.history.replaceState({}, "", u.toString());
      }

      // Prefer Firestore truth if stored on brand doc
      try{
        if (brandDoc?.shopify?.connected){
          setShopifyStatus(true, brandDoc.shopify.shop || null, "");
          return;
        }
      } catch {}

      // Live check via list endpoint
      try{
        const out = await shopifyListProducts();
        const shop = out.shop || null;
        setShopifyStatus(true, shop, `${out.count || 0} products`);
      } catch {
        setShopifyStatus(false);
      }
    }

    /***********************
     * Status gating
     ***********************/
    function applyBrandStatusGate(){
      // pending/rejected/suspended => disable actions
      const blocked = (brandStatus === "pending" || brandStatus === "rejected" || brandStatus === "suspended");

      // show banner
      statusBanner.style.display = "flex";
      statusBannerActions.innerHTML = "";

      if (brandStatus === "active"){
        statusBannerTitle.textContent = "Active";
        statusBannerSub.textContent = "Your brand is active. You can manage products, staff, and see orders.";
        statusBanner.style.borderColor = "rgba(22,163,74,.25)";
      } else if (brandStatus === "pending"){
        statusBannerTitle.textContent = "Pending approval";
        statusBannerSub.textContent = "Your brand is pending approval by the event owner. You can view the dashboard but most actions are disabled.";
        statusBanner.style.borderColor = "rgba(250,204,21,.35)";
      } else if (brandStatus === "rejected"){
        statusBannerTitle.textContent = "Rejected";
        statusBannerSub.textContent = "Your brand was rejected. Contact the event owner for details.";
        statusBanner.style.borderColor = "rgba(239,68,68,.35)";
      } else if (brandStatus === "suspended"){
        statusBannerTitle.textContent = "Suspended";
        statusBannerSub.textContent = "Your brand is suspended. Contact the event owner to re-enable access.";
        statusBanner.style.borderColor = "rgba(239,68,68,.35)";
      }

      // disable certain buttons when blocked
      const disableIds = [
        "btn-add-product","btn-add-staff","btn-save-settings",
        "btn-shopify-connect","btn-shopify-import","btn-shopify-disconnect",
        "btn-shopify-connect-settings","btn-shopify-disconnect-settings"
      ];
      disableIds.forEach(id=>{
        const el = qs("#"+id);
        if (!el) return;
        el.disabled = blocked;
        el.style.opacity = blocked ? "0.55" : "1";
        el.style.pointerEvents = blocked ? "none" : "auto";
      });

      // disable nav items except overview/settings if you want:
      // (keeping navigation enabled is fine; only actions are blocked)
    }

    /***********************
     * LISTENERS: Tabs
     ***********************/
    tabLogin.addEventListener("click", ()=>{
      tabLogin.classList.add("active");
      tabRegister.classList.remove("active");
      loginForm.style.display = "block";
      registerForm.style.display = "none";
      hideAuthAlert();
    });
    tabRegister.addEventListener("click", ()=>{
      tabRegister.classList.add("active");
      tabLogin.classList.remove("active");
      loginForm.style.display = "none";
      registerForm.style.display = "block";
      hideAuthAlert();
    });

    /***********************
     * LISTENERS: Nav
     ***********************/
    navItems.forEach(item=>{
      item.addEventListener("click", ()=>{
        const key = item.dataset.page;
        if (!key) return;
        setActivePage(key);
        if (key === "products") loadProducts();
        if (key === "staff") loadStaff();
        if (key === "orders") loadOrders();
        if (key === "customers") loadCustomers();
        if (key === "overview") loadOverview();
        if (key === "settings") loadSettings();
      });
    });

    /***********************
     * Shopify buttons: Connect / Import / Disconnect
     ***********************/
    function startShopifyConnect(){
      if (!brandId) return alert("Login first.");
      window.location.href = `${SHOPIFY_N8N_BASE}/shopify/auth/start?brandId=${encodeURIComponent(brandId)}`;
    }

    async function doShopifyDisconnect(){
      if (!confirm("Disconnect Shopify for this brand?")) return;
      try{
        await shopifyDisconnect();
        // update Firestore brand doc to mark disconnected
        try{
          await updateDoc(doc(db, "brands", brandId), {
            shopify: { connected:false, shop:null, disconnectedAt: serverTimestamp() }
          });
        } catch {}
        brandDoc = (await getDoc(doc(db,"brands",brandId))).data() || brandDoc;
        setShopifyStatus(false);
        alert("Shopify disconnected.");
      } catch(err){
        console.error(err);
        alert(err.message || "Disconnect failed.");
      }
    }

    btnShopifyConnect?.addEventListener("click", startShopifyConnect);
    btnShopifyConnectSettings?.addEventListener("click", startShopifyConnect);

    btnShopifyImport?.addEventListener("click", async ()=>{
      try{
        const out = await shopifyListProducts();
        // if backend returns shop, store it
        if (out.shop){
          try{
            await updateDoc(doc(db,"brands",brandId), {
              shopify: { connected:true, shop: out.shop, updatedAt: serverTimestamp() }
            });
          } catch {}
        }
        setShopifyStatus(true, out.shop || shopifyShop, `${out.count || 0} products`);
        openShopifyImportModal(out.products || []);
      } catch(err){
        console.error(err);
        alert("Shopify not connected yet. Click “Connect Shopify” first.");
      }
    });

    btnShopifyDisconnect?.addEventListener("click", doShopifyDisconnect);
    btnShopifyDisconnectSettings?.addEventListener("click", doShopifyDisconnect);

    /***********************
     * Products filters
     ***********************/
    productsSearch?.addEventListener("input", ()=>renderProductsTable());
    productsSort?.addEventListener("change", ()=>renderProductsTable());

    staffSearch?.addEventListener("input", ()=>renderStaffTable());
    ordersSearch?.addEventListener("input", ()=>renderOrdersTable());
    ordersSort?.addEventListener("change", ()=>renderOrdersTable());
    ordersDate?.addEventListener("change", ()=>renderOrdersTable());

    customersSearch?.addEventListener("input", ()=>renderCustomersTable());
    customersSort?.addEventListener("change", ()=>renderCustomersTable());

    /***********************
     * Logout
     ***********************/
    btnLogout.addEventListener("click", async ()=>{
      await signOut(auth);
    });

    /***********************
     * Auth: Login/Register
     ***********************/
    btnLogin.addEventListener("click", async ()=>{
      hideAuthAlert();
      const email = loginEmail.value.trim();
      const pass = loginPass.value;
      if(!email || !pass) return showAuthAlert("Please enter email and password.", "error");
      try{
        await signInWithEmailAndPassword(auth, email, pass);
      }catch(err){
        console.error(err);
        showAuthAlert(err.message || "Login failed", "error");
      }
    });

    btnRegister.addEventListener("click", async ()=>{
      hideAuthAlert();
      const bname = regBrandName.value.trim();
      const email = regEmail.value.trim();
      const pass = regPass.value;
      const phone = regPhone.value.trim() || null;

      if(!bname || !email || !pass) return showAuthAlert("Please fill all required fields.", "error");
      try{
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(cred.user, { displayName: bname });

        // create brand doc (pending by default)
        const newBrandRef = doc(collection(db, "brands"));
        await setDoc(newBrandRef, {
          name: bname,
          ownerUid: cred.user.uid,
          status: "pending",
          phone: phone,
          createdAt: serverTimestamp(),
          shopify: { connected:false, shop:null }
        });

        // store brandId somewhere user-linked
        await setDoc(doc(db, "userBrands", cred.user.uid), {
          brandId: newBrandRef.id,
          createdAt: serverTimestamp()
        });

        showAuthAlert("Account created. Your brand is pending approval.", "info");
      } catch(err){
        console.error(err);
        showAuthAlert(err.message || "Registration failed", "error");
      }
    });
    /***********************
     * AUTH STATE + BOOTSTRAP
     ***********************/
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        uid = null;
        brandId = null;
        brandDoc = null;
        brandStatus = "pending";
        authView.style.display = "block";
        appShell.style.display = "none";
        return;
      }

      uid = user.uid;

      // Resolve brandId from userBrands/{uid}
      try{
        const ubSnap = await getDoc(doc(db, "userBrands", uid));
        if(!ubSnap.exists()){
          showAuthAlert("No brand linked to this user. Please register again or contact admin.", "error");
          await signOut(auth);
          return;
        }
        brandId = ubSnap.data().brandId;
      } catch(err){
        console.error(err);
        showAuthAlert("Failed to load brand link.", "error");
        await signOut(auth);
        return;
      }

      // eventId from URL param or fallback (optional)
      const u = new URL(window.location.href);
      currentEventId = u.searchParams.get("eventId") || null;

      // Load brand doc
      await reloadBrand();

      // Show app
      authView.style.display = "none";
      appShell.style.display = "flex";

      // Fill top/side
      brandNameEl.textContent = brandDoc?.name || "Brand";
      topbarSub.textContent = "Manage your booth operations.";
      eventInfo.textContent = currentEventId ? `Event: ${currentEventId}` : "Event: (not set)";
      brandStatusText.textContent = `Status: ${brandStatus}`;

      // Logo render (if exists)
      const logoUrl = brandDoc?.logoUrl || null;
      if(logoUrl){
        brandLogo.style.backgroundImage = `url('${logoUrl}')`;
        brandLogo.textContent = "";
        qs("#authBrandLogo").style.backgroundImage = `url('${logoUrl}')`;
        qs("#authBrandLogo").textContent = "";
      }

      // Apply gate & shopify status
      applyBrandStatusGate();
      await refreshShopifyStatus();

      // Load initial page
      setActivePage("overview");
      await loadOverview();
    });

    async function reloadBrand(){
      const bSnap = await getDoc(doc(db, "brands", brandId));
      if(!bSnap.exists()){
        showAuthAlert("Brand record missing. Contact admin.", "error");
        await signOut(auth);
        return;
      }
      brandDoc = bSnap.data();
      brandStatus = brandDoc?.status || "pending";
      brandStatusText.textContent = `Status: ${brandStatus}`;
      // shopify stored
      shopifyConnected = !!brandDoc?.shopify?.connected;
      shopifyShop = brandDoc?.shopify?.shop || null;
    }

    /***********************
     * MONEY / DATE HELPERS
     ***********************/
    function money(v){
      const n = Number(v||0);
      return n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
    }
    function dayKey(d=new Date()){
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    /***********************
     * LOAD: PRODUCTS
     * path: brands/{brandId}/products
     ***********************/
    async function loadProducts(){
      if(!brandId) return;
      const colRef = collection(db, "brands", brandId, "products");
      const snap = await getDocs(colRef);
      products = snap.docs.map(d=>({ id:d.id, ...d.data() }));

      renderProductsTable();
      renderLowStock();
      updateLowStockKpi();
    }

    function getFilteredSortedProducts(){
      const q = (productsSearch.value||"").toLowerCase().trim();
      let rows = products.slice();

      if(q){
        rows = rows.filter(p=>{
          const name = String(p.name||"").toLowerCase();
          const sku  = String(p.sku||"").toLowerCase();
          return name.includes(q) || sku.includes(q);
        });
      }

      const sort = productsSort.value;
      const by = (a,b)=> (a>b?1:a<b?-1:0);

      rows.sort((a,b)=>{
        const pa = Number(a.price||0), pb = Number(b.price||0);
        const sa = Number(a.stock||0), sb = Number(b.stock||0);
        const na = String(a.name||"").toLowerCase();
        const nb = String(b.name||"").toLowerCase();
        if(sort==="name-asc") return by(na,nb);
        if(sort==="name-desc") return by(nb,na);
        if(sort==="price-asc") return pa-pb;
        if(sort==="price-desc") return pb-pa;
        if(sort==="stock-asc") return sa-sb;
        if(sort==="stock-desc") return sb-sa;
        return 0;
      });

      return rows;
    }

    function renderProductsTable(){
      const rows = getFilteredSortedProducts();

      if(!rows.length){
        productsTableWrapper.innerHTML = `<div class="table-empty">No products yet.</div>`;
        return;
      }

      productsTableWrapper.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Image</th>
              <th>Name</th>
              <th>SKU</th>
              <th>Price</th>
              <th>Stock</th>
              <th>Source</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(p=>{
              const img = p.imageUrl ? `<div style="width:34px;height:34px;border-radius:10px;border:1px solid var(--border);background:center/cover no-repeat;background-image:url('${p.imageUrl}')"></div>` : `<div style="width:34px;height:34px;border-radius:10px;border:1px solid var(--border);background:var(--panel-soft);display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:11px;">No</div>`;
              const source = p.shopifyProductId ? `<span class="pill ok">Shopify</span>` : `<span class="pill warn">Manual</span>`;
              return `
                <tr>
                  <td>${img}</td>
                  <td>${escapeHtml(p.name||"")}</td>
                  <td>${escapeHtml(p.sku||"-")}</td>
                  <td>${money(p.price||0)}</td>
                  <td>${Number(p.stock||0)}</td>
                  <td>${source}</td>
                  <td style="text-align:right;">
                    <button class="btn btn-ghost" data-edit-prod="${p.id}">Edit</button>
                  </td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      `;

      qsa("[data-edit-prod]").forEach(btn=>{
        btn.addEventListener("click", ()=>openEditProduct(btn.getAttribute("data-edit-prod")));
      });
    }

    function renderLowStock(){
      const threshold = Number(brandDoc?.lowStockThreshold ?? settingsLowStock.value ?? 5);
      const lows = products.filter(p=>Number(p.stock||0) <= threshold);

      const panel = qs("#lowStockPanel");
      const list  = qs("#lowStockList");
      const title = qs("#lowStockPanelTitle");

      if(!lows.length){
        panel.style.display="none";
        return;
      }
      panel.style.display="block";
      title.textContent = `Low stock alerts (≤ ${threshold})`;
      list.innerHTML = lows.map(p=>`
        <div style="display:flex;justify-content:space-between;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);">
          <div>
            <div style="font-weight:600;font-size:12px;">${escapeHtml(p.name||"")}</div>
            <div class="muted" style="font-size:11px;">SKU: ${escapeHtml(p.sku||"-")}</div>
          </div>
          <div class="pill bad">${Number(p.stock||0)}</div>
        </div>
      `).join("");
    }

    function updateLowStockKpi(){
      const threshold = Number(brandDoc?.lowStockThreshold ?? 5);
      const lows = products.filter(p=>Number(p.stock||0) <= threshold);
      kpiLowStock.textContent = String(lows.length);
    }

    /***********************
     * PRODUCTS: Add/Edit (Manual)
     ***********************/
    btnAddProduct?.addEventListener("click", ()=>openAddProduct());

    function openAddProduct(){
      openModal(`
        <div class="modal-title">Add product</div>

        <div class="field" style="margin-top:10px;">
          <div class="field-label">Name</div>
          <input id="p-name" class="field-input" placeholder="Product name"/>
        </div>
        <div class="field">
          <div class="field-label">SKU</div>
          <input id="p-sku" class="field-input" placeholder="Optional SKU"/>
        </div>
        <div class="field">
          <div class="field-label">Price</div>
          <input id="p-price" class="field-input" type="number" step="0.01" placeholder="0.00"/>
        </div>
        <div class="field">
          <div class="field-label">Stock</div>
          <input id="p-stock" class="field-input" type="number" step="1" placeholder="0"/>
        </div>
        <div class="field">
          <div class="field-label">Image</div>
          <input id="p-img" class="field-input" type="file" accept="image/*"/>
        </div>

        <div class="modal-actions">
          <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
          <button id="p-save" class="btn btn-primary">Save</button>
        </div>
      `);

      qs("#p-save").addEventListener("click", async ()=>{
        try{
          const name = qs("#p-name").value.trim();
          const sku  = qs("#p-sku").value.trim() || null;
          const price = Number(qs("#p-price").value||0);
          const stock = Number(qs("#p-stock").value||0);
          const file = qs("#p-img").files?.[0] || null;

          if(!name) return alert("Name required.");

          let imageUrl = null;
          if(file){
            const path = `brands/${brandId}/products/${Date.now()}_${file.name}`;
            const r = sRef(storage, path);
            await uploadBytes(r, file);
            imageUrl = await getDownloadURL(r);
          }

          await addDoc(collection(db,"brands",brandId,"products"),{
            name, sku, price, stock,
            imageUrl,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
            eventId: currentEventId || null
          });

          closeModal();
          await loadProducts();
        } catch(err){
          console.error(err);
          alert(err.message || "Save failed.");
        }
      });
    }

    function openEditProduct(prodId){
      const p = products.find(x=>x.id===prodId);
      if(!p) return;

      openModal(`
        <div class="modal-title">Edit product</div>

        <div class="field" style="margin-top:10px;">
          <div class="field-label">Name</div>
          <input id="p-name" class="field-input" value="${escapeHtml(p.name||"")}"/>
        </div>
        <div class="field">
          <div class="field-label">SKU</div>
          <input id="p-sku" class="field-input" value="${escapeHtml(p.sku||"")}"/>
        </div>
        <div class="field">
          <div class="field-label">Price</div>
          <input id="p-price" class="field-input" type="number" step="0.01" value="${Number(p.price||0)}"/>
        </div>
        <div class="field">
          <div class="field-label">Stock</div>
          <input id="p-stock" class="field-input" type="number" step="1" value="${Number(p.stock||0)}"/>
        </div>
        <div class="field">
          <div class="field-label">Replace image</div>
          <input id="p-img" class="field-input" type="file" accept="image/*"/>
          <div class="field-hint">Leave empty to keep existing image.</div>
        </div>

        <div class="modal-actions">
          <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
          <button id="p-save" class="btn btn-primary">Save</button>
        </div>
      `);

      qs("#p-save").addEventListener("click", async ()=>{
        try{
          const name = qs("#p-name").value.trim();
          const sku  = qs("#p-sku").value.trim() || null;
          const price = Number(qs("#p-price").value||0);
          const stock = Number(qs("#p-stock").value||0);
          const file = qs("#p-img").files?.[0] || null;

          if(!name) return alert("Name required.");

          let imageUrl = p.imageUrl || null;
          if(file){
            const path = `brands/${brandId}/products/${prodId}_${Date.now()}_${file.name}`;
            const r = sRef(storage, path);
            await uploadBytes(r, file);
            imageUrl = await getDownloadURL(r);
          }

          await updateDoc(doc(db,"brands",brandId,"products",prodId),{
            name, sku, price, stock, imageUrl,
            updatedAt: serverTimestamp()
          });

          closeModal();
          await loadProducts();
        } catch(err){
          console.error(err);
          alert(err.message || "Update failed.");
        }
      });
    }

    /***********************
     * LOAD: STAFF (brands/{brandId}/staff)
     ***********************/
    async function loadStaff(){
      if(!brandId) return;
      const snap = await getDocs(collection(db,"brands",brandId,"staff"));
      staff = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      renderStaffTable();
    }

    function renderStaffTable(){
      const q = (staffSearch.value||"").toLowerCase().trim();
      let rows = staff.slice();
      if(q){
        rows = rows.filter(s=>{
          return String(s.name||"").toLowerCase().includes(q) ||
                 String(s.username||"").toLowerCase().includes(q);
        });
      }

      if(!rows.length){
        staffTableWrapper.innerHTML = `<div class="table-empty">No staff yet.</div>`;
        return;
      }

      staffTableWrapper.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Username</th>
              <th>Role</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(s=>`
              <tr>
                <td>${escapeHtml(s.name||"")}</td>
                <td>${escapeHtml(s.username||"-")}</td>
                <td>${escapeHtml(s.role||"cashier")}</td>
                <td>${s.active===false ? `<span class="pill bad">Inactive</span>` : `<span class="pill ok">Active</span>`}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    btnAddStaff?.addEventListener("click", ()=>{
      openModal(`
        <div class="modal-title">Add POS user</div>

        <div class="field" style="margin-top:10px;">
          <div class="field-label">Name</div>
          <input id="s-name" class="field-input" placeholder="Cashier name"/>
        </div>
        <div class="field">
          <div class="field-label">Username</div>
          <input id="s-user" class="field-input" placeholder="e.g. cashier1"/>
        </div>
        <div class="field">
          <div class="field-label">PIN</div>
          <input id="s-pin" class="field-input" placeholder="4-6 digits"/>
          <div class="field-hint">Used for POS login (you can implement your POS login check against this).</div>
        </div>

        <div class="modal-actions">
          <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
          <button id="s-save" class="btn btn-primary">Save</button>
        </div>
      `);

      qs("#s-save").addEventListener("click", async ()=>{
        const name = qs("#s-name").value.trim();
        const username = qs("#s-user").value.trim();
        const pin = qs("#s-pin").value.trim();
        if(!name || !username || !pin) return alert("Fill all fields.");
        await addDoc(collection(db,"brands",brandId,"staff"),{
          name, username, pin,
          role:"cashier",
          active:true,
          eventId: currentEventId || null,
          createdAt: serverTimestamp()
        });
        closeModal();
        await loadStaff();
      });
    });

    /***********************
     * LOAD: ORDERS (brands/{brandId}/orders)
     ***********************/
    async function loadOrders(){
      if(!brandId) return;
      const snap = await getDocs(collection(db,"brands",brandId,"orders"));
      orders = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      renderOrdersTable();
    }

    function renderOrdersTable(){
      const q = (ordersSearch.value||"").toLowerCase().trim();
      let rows = orders.slice();

      // date filter (basic)
      const df = ordersDate.value;
      const now = new Date();
      const today = dayKey(now);
      const y = new Date(now); y.setDate(now.getDate()-1);
      const yesterday = dayKey(y);

      rows = rows.filter(o=>{
        const ts = o.createdAt?.toDate ? o.createdAt.toDate() : null;
        const dkey = ts ? dayKey(ts) : null;
        if(df==="today" && dkey!==today) return false;
        if(df==="yesterday" && dkey!==yesterday) return false;
        // this_week quick filter
        if(df==="this_week" && ts){
          const wd = now.getDay(); // 0 sun
          const start = new Date(now); start.setDate(now.getDate() - wd);
          if(ts < start) return false;
        }
        return true;
      });

      if(q){
        rows = rows.filter(o=>{
          return String(o.id||"").toLowerCase().includes(q) ||
                 String(o.customerName||"").toLowerCase().includes(q) ||
                 String(o.customerPhone||"").toLowerCase().includes(q) ||
                 String(o.cashierName||"").toLowerCase().includes(q);
        });
      }

      const sort = ordersSort.value;
      rows.sort((a,b)=>{
        const ta = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
        const tb = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
        const sa = Number(a.total||0);
        const sb = Number(b.total||0);
        if(sort==="time-desc") return tb-ta;
        if(sort==="time-asc") return ta-tb;
        if(sort==="total-desc") return sb-sa;
        if(sort==="total-asc") return sa-sb;
        return 0;
      });

      if(!rows.length){
        ordersTableWrapper.innerHTML = `<div class="table-empty">No orders yet.</div>`;
        return;
      }

      ordersTableWrapper.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>Order ID</th>
              <th>Customer</th>
              <th>Cashier</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(o=>{
              const ts = o.createdAt?.toDate ? o.createdAt.toDate() : null;
              const t = ts ? ts.toLocaleString() : "-";
              const cust = (o.customerName || o.customerPhone || o.customerEmail) ? `${escapeHtml(o.customerName||"-")} <span class="muted" style="font-size:11px;">${escapeHtml(o.customerPhone||o.customerEmail||"")}</span>` : `<span class="muted">Walk-in</span>`;
              return `
                <tr>
                  <td>${escapeHtml(t)}</td>
                  <td>${escapeHtml(o.id || "")}</td>
                  <td>${cust}</td>
                  <td>${escapeHtml(o.cashierName || "-")}</td>
                  <td>${money(o.total||0)}</td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      `;
    }

    /***********************
     * LOAD: CUSTOMERS (derived from orders)
     ***********************/
    async function loadCustomers(){
      // ensure orders loaded
      if(!orders.length) await loadOrders();

      const map = new Map(); // key => agg
      orders.forEach(o=>{
        const key = (o.customerPhone || o.customerEmail || o.customerName || "").trim().toLowerCase();
        if(!key) return;
        const prev = map.get(key) || {
          name: o.customerName || "",
          phone: o.customerPhone || "",
          email: o.customerEmail || "",
          orders: 0,
          spend: 0
        };
        prev.orders += 1;
        prev.spend += Number(o.total||0);
        if(!prev.name && o.customerName) prev.name = o.customerName;
        if(!prev.phone && o.customerPhone) prev.phone = o.customerPhone;
        if(!prev.email && o.customerEmail) prev.email = o.customerEmail;
        map.set(key, prev);
      });

      customers = Array.from(map.values());
      customersTotal.textContent = String(customers.length);
      const totalSpend = customers.reduce((a,c)=>a+Number(c.spend||0),0);
      customersAvgSpend.textContent = customers.length ? money(totalSpend/customers.length) : "0";

      renderCustomersTable();
    }

    function renderCustomersTable(){
      const q = (customersSearch.value||"").toLowerCase().trim();
      let rows = customers.slice();
      if(q){
        rows = rows.filter(c=>{
          return String(c.name||"").toLowerCase().includes(q) ||
                 String(c.phone||"").toLowerCase().includes(q) ||
                 String(c.email||"").toLowerCase().includes(q);
        });
      }

      const sort = customersSort.value;
      rows.sort((a,b)=>{
        const sa = Number(a.spend||0), sb = Number(b.spend||0);
        const oa = Number(a.orders||0), ob = Number(b.orders||0);
        const na = String(a.name||"").toLowerCase(), nb = String(b.name||"").toLowerCase();
        if(sort==="spend-desc") return sb-sa;
        if(sort==="spend-asc") return sa-sb;
        if(sort==="orders-desc") return ob-oa;
        if(sort==="orders-asc") return oa-ob;
        if(sort==="name-asc") return na.localeCompare(nb);
        if(sort==="name-desc") return nb.localeCompare(na);
        return 0;
      });

      if(!rows.length){
        customersTableWrapper.innerHTML = `<div class="table-empty">No customers yet.</div>`;
        return;
      }

      customersTableWrapper.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Phone</th>
              <th>Email</th>
              <th>Orders</th>
              <th>Spend</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(c=>`
              <tr>
                <td>${escapeHtml(c.name||"-")}</td>
                <td>${escapeHtml(c.phone||"-")}</td>
                <td>${escapeHtml(c.email||"-")}</td>
                <td>${Number(c.orders||0)}</td>
                <td>${money(c.spend||0)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    /***********************
     * LOAD: SETTINGS
     ***********************/
    async function loadSettings(){
      await reloadBrand();
      settingsBrandName.value = brandDoc?.name || "";
      settingsLowStock.value = brandDoc?.lowStockThreshold ?? 5;
      settingsPhone.value = brandDoc?.phone || "";
      // keep status current
      brandNameEl.textContent = brandDoc?.name || "Brand";
      applyBrandStatusGate();
      await refreshShopifyStatus();
    }

    btnSaveSettings?.addEventListener("click", async ()=>{
      try{
        const name = settingsBrandName.value.trim();
        const low = Number(settingsLowStock.value || 5);
        const phone = settingsPhone.value.trim() || null;

        if(!name) return alert("Brand name required.");

        let logoUrl = brandDoc?.logoUrl || null;
        const file = settingsLogoFile.files?.[0] || null;
        if(file){
          const path = `brands/${brandId}/logo_${Date.now()}_${file.name}`;
          const r = sRef(storage, path);
          await uploadBytes(r, file);
          logoUrl = await getDownloadURL(r);
        }

        await updateDoc(doc(db,"brands",brandId),{
          name,
          phone,
          lowStockThreshold: low,
          logoUrl,
          updatedAt: serverTimestamp()
        });

        await reloadBrand();

        // reflect logo
        if(logoUrl){
          brandLogo.style.backgroundImage = `url('${logoUrl}')`;
          brandLogo.textContent = "";
        }
        brandNameEl.textContent = brandDoc?.name || "Brand";
        alert("Settings saved.");
        // refresh low stock panel if needed
        renderLowStock();
        updateLowStockKpi();
      } catch(err){
        console.error(err);
        alert(err.message || "Save failed.");
      }
    });

    /***********************
     * LOAD: OVERVIEW KPIs
     ***********************/
    async function loadOverview(){
      // ensure we have latest brand + products + orders
      await reloadBrand();
      await loadProducts();
      await loadOrders();

      // Today KPIs
      const today = dayKey(new Date());
      const todays = orders.filter(o=>{
        const ts = o.createdAt?.toDate ? o.createdAt.toDate() : null;
        return ts ? dayKey(ts) === today : false;
      });

      const revenue = todays.reduce((a,o)=>a+Number(o.total||0),0);
      const count = todays.length;
      const aov = count ? revenue / count : 0;

      kpiRevenueToday.textContent = money(revenue);
      kpiOrdersToday.textContent = String(count);
      kpiAOV.textContent = money(aov);

      // Top products (if your orders store items as array)
      const itemMap = new Map(); // name => qty+sales
      todays.forEach(o=>{
        const items = Array.isArray(o.items) ? o.items : [];
        items.forEach(it=>{
          const key = it.name || it.title || it.sku || "Item";
          const prev = itemMap.get(key) || { name:key, qty:0, sales:0 };
          prev.qty += Number(it.qty||it.quantity||1);
          prev.sales += Number(it.total||0) || (Number(it.price||0) * Number(it.qty||it.quantity||1));
          itemMap.set(key, prev);
        });
      });
      const top = Array.from(itemMap.values()).sort((a,b)=>b.sales-a.sales).slice(0,6);

      topProductsWrapper.innerHTML = top.length ? `
        <table>
          <thead><tr><th>Product</th><th>Qty</th><th>Sales</th></tr></thead>
          <tbody>
            ${top.map(t=>`
              <tr>
                <td>${escapeHtml(t.name)}</td>
                <td>${t.qty}</td>
                <td>${money(t.sales)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      ` : `<div class="table-empty">No sales yet today.</div>`;

      // Recent orders
      const recent = orders
        .slice()
        .sort((a,b)=> (b.createdAt?.toMillis?.()||0) - (a.createdAt?.toMillis?.()||0))
        .slice(0,6);

      recentOrdersWrapper.innerHTML = recent.length ? `
        <table>
          <thead><tr><th>Time</th><th>Customer</th><th>Total</th></tr></thead>
          <tbody>
            ${recent.map(o=>{
              const ts = o.createdAt?.toDate ? o.createdAt.toDate() : null;
              const t = ts ? ts.toLocaleString() : "-";
              const cust = o.customerName || o.customerPhone || o.customerEmail || "Walk-in";
              return `
                <tr>
                  <td>${escapeHtml(t)}</td>
                  <td>${escapeHtml(String(cust))}</td>
                  <td>${money(o.total||0)}</td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      ` : `<div class="table-empty">No orders yet.</div>`;

      // Keep shopify status fresh
      await refreshShopifyStatus();
      applyBrandStatusGate();
    }

  </script>
</body>
</html>
