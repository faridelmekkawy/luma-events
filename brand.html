<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Luma Events OS — Brand Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#f3f4f6;
      --panel:#ffffff;
      --panel-soft:#f9fafb;
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#2563eb;
      --accent-soft:#dbeafe;
      --accent-strong:#1d4ed8;
      --radius:16px;
      --shadow:0 18px 40px rgba(15,23,42,.12);
      --danger:#ef4444;
      --ok:#16a34a;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      font-family:"Montserrat",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--ink);
    }

    .app-shell{
      display:flex;
      height:100vh;
      width:100%;
    }

    /* SIDEBAR */
    .sidebar{
      width:230px;
      background:var(--panel);
      border-right:1px solid var(--border);
      display:flex;
      flex-direction:column;
      padding:18px 12px;
    }
    .sidebar-brand{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:18px;
    }
    .sidebar-logo{
      width:38px;height:38px;border-radius:999px;
      background:linear-gradient(135deg,#2563eb,#a855f7);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;font-size:18px;
      overflow:hidden;
      background-size:cover;
      background-position:center;
    }
    .sidebar-brand-name{font-size:15px;font-weight:700;}
    .sidebar-event{
      font-size:10px;
      color:var(--muted);
      margin-top:2px;
    }
    .sidebar-nav{
      display:flex;flex-direction:column;gap:6px;margin-top:10px;flex:1;
    }
    .nav-item{
      padding:9px 12px;border-radius:10px;
      cursor:pointer;font-size:13px;
      border:none;background:transparent;text-align:left;color:var(--ink);
    }
    .nav-item:hover{background:var(--panel-soft);}
    .nav-item.active{
      background:var(--accent-soft);
      color:var(--accent-strong);
      font-weight:600;
    }
    .nav-item.logout{
      margin-top:auto;
      background:#fee2e2;
      color:#b91c1c;
      border:1px solid #fecaca;
    }
    .nav-item.logout:hover{background:#fecaca;}

    /* TOPBAR */
    .topbar{
      height:70px;background:var(--panel);
      border-bottom:1px solid var(--border);
      padding:12px 18px;
      display:flex;justify-content:space-between;align-items:center;
    }
    .topbar-title{font-size:16px;font-weight:700;}
    .topbar-sub{font-size:11px;color:var(--muted);}
    .topbar-right{display:flex;align-items:center;gap:10px;font-size:11px;color:var(--muted);}

    .badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:10px;
      border-radius:999px;
      padding:3px 8px;
      border:1px solid rgba(148,163,184,.5);
      background:var(--panel-soft);
    }

    /* CONTENT */
    .content-area{flex:1;padding:16px 20px;overflow-y:auto;background:var(--bg);}
    .page{display:none;}
    .page.active{display:block;}

    .page-header{
      display:flex;justify-content:space-between;
      align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:10px;
    }
    .page-title{font-size:18px;font-weight:700;}
    .page-sub{font-size:12px;color:var(--muted);}
    .page-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}

    .cards-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:12px;margin-bottom:18px;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      box-shadow:var(--shadow);
    }
    .card-title{font-size:13px;color:var(--muted);margin-bottom:4px;}
    .card-number{font-size:20px;font-weight:700;}
    .card-note{font-size:11px;color:var(--muted);margin-top:6px;}

    .toolbar{
      display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;align-items:center;
      font-size:12px;
    }
    .toolbar input,
    .toolbar select{
      padding:6px 9px;border-radius:9px;
      border:1px solid var(--border);background:#fff;font-size:12px;
    }

    .table-wrapper{
      background:#fff;border-radius:12px;border:1px solid var(--border);
      overflow-x:auto;
    }
    table{width:100%;border-collapse:collapse;font-size:12px;}
    thead{background:var(--panel-soft);}
    th,td{padding:9px 10px;border-bottom:1px solid var(--border);text-align:left;}
    th{
      font-size:11px;text-transform:uppercase;color:var(--muted);
      letter-spacing:.04em;
    }
    tbody tr:hover{background:#f9fafb;}
    .table-empty{text-align:center;padding:20px;font-size:12px;color:var(--muted);}

    .status-banner{
      border-radius:12px;
      padding:10px 12px;
      font-size:12px;
      margin-bottom:12px;
      display:none;
    }
    .status-banner.pending{
      background:#fffbeb;
      border:1px solid #fef3c7;
      color:#92400e;
    }
    .status-banner.suspended{
      background:#fef2f2;
      border:1px solid #fee2e2;
      color:#b91c1c;
    }
    .status-banner.rejected{
      background:#fee2e2;
      border:1px solid #fecaca;
      color:#7f1d1d;
    }
    .status-title{font-weight:600;margin-bottom:2px;font-size:13px;}
    .status-body{font-size:12px;}

    .blocked-overlay{
      display:none;
      align-items:center;
      justify-content:center;
      min-height:calc(100vh - 70px);
    }

    .btn{
      border:none;border-radius:999px;
      padding:7px 12px;font-size:12px;font-weight:600;
      cursor:pointer;display:inline-flex;align-items:center;justify-content:center;
      gap:6px;
    }
    .btn-primary{background:var(--accent);color:#fff;}
    .btn-primary:hover{background:var(--accent-strong);}
    .btn-ghost{
      background:transparent;color:var(--accent-strong);
      border:1px solid var(--accent-soft);
    }
    .btn-ghost:hover{background:var(--accent-soft);}
    .btn-danger{background:var(--danger);color:#fff;}
    .btn-danger:hover{background:#b91c1c;}
    .btn-sm{padding:5px 9px;font-size:11px;}

    .settings-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(270px,1fr));
      gap:16px;margin-top:14px;
    }
    .settings-card{
      background:var(--panel);
      border-radius:14px;
      border:1px solid var(--border);
      padding:14px 16px;
    }
    .settings-title{font-size:14px;font-weight:600;margin-bottom:8px;}

    .field{margin-bottom:10px;}
    .field-label{font-size:11px;margin-bottom:4px;color:#4b5563;}
    .field-input,.field-select,textarea.field-input{
      width:100%;padding:8px;border-radius:9px;
      border:1px solid var(--border);background:#f9fafb;font-size:12px;
    }
    .field-input:focus,.field-select:focus,textarea.field-input:focus{
      outline:none;border-color:var(--accent);box-shadow:0 0 0 1px var(--accent-soft);
    }
    .field-hint{font-size:10px;color:var(--muted);margin-top:3px;}

    .product-img-thumb{
      width:32px;height:32px;border-radius:8px;
      background:#e5e7eb;
      background-size:cover;
      background-position:center;
      display:inline-block;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      font-size:10px;
      border-radius:999px;
      background:#e5e7eb;
      color:#374151;
    }
    .chip-green{
      background:#dcfce7;
      color:#166534;
    }
    .chip-red{
      background:#fee2e2;
      color:#b91c1c;
    }

    .variant-pill{
      display:inline-flex;
      align-items:center;
      padding:2px 7px;
      border-radius:999px;
      font-size:10px;
      background:#eef2ff;
      color:#4338ca;
      margin:1px 3px 1px 0;
    }

    /* MODAL */
    #modal-container{
      position:fixed;inset:0;
      display:none;justify-content:center;align-items:center;
      background:rgba(0,0,0,.35);z-index:9999;
    }
    .modal{
      background:var(--panel);
      width:100%;max-width:520px;
      border-radius:16px;
      padding:18px;
      box-shadow:var(--shadow);
      animation:fadeIn .2s ease;
      max-height:90vh;
      overflow-y:auto;
    }
    .modal-title{font-size:16px;font-weight:700;margin-bottom:12px;}
    .modal-section-title{font-size:13px;font-weight:600;margin:10px 0 6px;}
    .modal-actions{margin-top:14px;display:flex;justify-content:flex-end;gap:8px;}

    .variants-container{
      border-radius:10px;
      border:1px dashed var(--border);
      padding:8px;
      background:#f9fafb;
      margin-bottom:8px;
    }
    .variant-row{
      display:flex;gap:6px;margin-bottom:6px;
    }
    .variant-row input{flex:1;}
    .variant-row small{font-size:10px;color:var(--muted);}

    @keyframes fadeIn{
      from{transform:scale(.96);opacity:0;}
      to{transform:scale(1);opacity:1;}
    }

    @media(max-width:768px){
      .app-shell{flex-direction:column;}
      .sidebar{width:100%;flex-direction:row;overflow-x:auto;height:auto;}
      .sidebar-nav{flex-direction:row;}
      .topbar{flex-direction:column;align-items:flex-start;gap:8px;height:auto;}
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-brand">
        <div id="sidebar-brand-logo" class="sidebar-logo">B</div>
        <div>
          <div id="sidebar-brand-name" class="sidebar-brand-name">Brand</div>
          <div id="sidebar-event-label" class="sidebar-event"></div>
        </div>
      </div>
      <nav class="sidebar-nav">
        <button class="nav-item active" data-page="page-dashboard">Overview</button>
        <button class="nav-item" data-page="page-products">Products</button>
        <button class="nav-item" data-page="page-staff">Staff &amp; POS Users</button>
        <button class="nav-item" data-page="page-orders">Orders</button>
        <button class="nav-item" data-page="page-customers">Customers</button>
        <button class="nav-item" data-page="page-settings">Settings</button>
        <button class="nav-item" data-page="page-help">Help &amp; How-To</button>
      </nav>
      <button id="btn-logout" class="nav-item logout">Logout</button>
    </aside>

    <!-- MAIN -->
    <div style="flex:1;display:flex;flex-direction:column;">
      <header class="topbar">
        <div>
          <div id="topbar-title" class="topbar-title">Brand Dashboard</div>
          <div id="topbar-subtitle" class="topbar-sub">Loading event…</div>
        </div>
        <div class="topbar-right">
          <span id="status-pill" class="badge">Status: …</span>
        </div>
      </header>

      <main class="content-area">
        <!-- STATUS BANNER & BLOCKED VIEW -->
        <div id="status-banner" class="status-banner">
          <div class="status-title"></div>
          <div class="status-body"></div>
        </div>

        <div id="blocked-view" class="blocked-overlay">
          <div class="card" style="max-width:460px;text-align:center;">
            <div style="font-size:18px;font-weight:700;margin-bottom:6px;">Access blocked</div>
            <p id="blocked-message" style="font-size:13px;color:var(--muted);margin-bottom:14px;">
              Your application was rejected for this event. Please contact the organizer.
            </p>
            <button id="blocked-logout" class="btn btn-ghost">Sign out</button>
          </div>
        </div>

        <!-- DASHBOARD -->
        <section id="page-dashboard" class="page active">
          <div class="cards-grid analytics-section">
            <div class="card">
              <div class="card-title">Sales Today</div>
              <div id="dash-sales-today" class="card-number">0</div>
              <div class="card-note">Net of returns (all orders for this brand).</div>
            </div>
            <div class="card">
              <div class="card-title">Sales Orders Today</div>
              <div id="dash-orders-today" class="card-number">0</div>
              <div class="card-note">Number of sales orders.</div>
            </div>
            <div class="card">
              <div class="card-title">Return Orders Today</div>
              <div id="dash-orders-returns-today" class="card-number">0</div>
              <div class="card-note">Number of return orders.</div>
            </div>
            <div class="card">
              <div class="card-title">Total Products</div>
              <div id="dash-products-count" class="card-number">0</div>
              <div class="card-note">Active products for this brand.</div>
            </div>
          </div>

          <div class="cards-grid">
            <!-- EVENT CARD -->
            <div class="card">
              <div class="card-title">Current Event</div>
              <div id="event-card-name" class="card-number" style="font-size:14px;line-height:20px;"></div>
              <div id="event-card-meta" class="card-note"></div>
            </div>

            <!-- POS CARD -->
            <div id="pos-card" class="card">
              <div class="card-title">POS Access</div>
              <div style="font-size:13px;margin-bottom:6px;">Use this link for your cashiers:</div>
              <div style="font-size:11px;background:#f9fafb;border-radius:10px;border:1px dashed var(--border);padding:8px;word-break:break-all;">
                <span id="pos-link-text">https://luma-events.vercel.app/pos.html</span>
              </div>
              <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
                <button id="btn-copy-pos" class="btn btn-ghost btn-sm">Copy POS link</button>
                <span id="pos-status-note" style="font-size:11px;color:var(--muted);">Cashiers log in with username &amp; PIN.</span>
              </div>
            </div>
          </div>

          <div class="page-header" style="margin-top:6px;">
            <div>
              <div class="page-title" style="font-size:15px;">Recent Orders</div>
              <div class="page-sub">Last 10 orders for this brand.</div>
            </div>
          </div>
          <div id="table-recent-orders" class="table-wrapper analytics-section"></div>
        </section>

        <!-- PRODUCTS -->
        <section id="page-products" class="page">
          <div class="page-header">
            <div>
              <div class="page-title">Products</div>
              <div class="page-sub">Manage products, variants and images.</div>
            </div>
            <div class="page-actions">
              <button id="btn-add-product" class="btn btn-primary">Add Product</button>
            </div>
          </div>

          <div class="toolbar">
            <input id="search-products" placeholder="Search products by name or SKU"/>
            <select id="sort-products">
              <option value="name-asc">Name A → Z</option>
              <option value="name-desc">Name Z → A</option>
              <option value="price-desc">Price high → low</option>
              <option value="price-asc">Price low → high</option>
            </select>
          </div>

          <div id="products-table" class="table-wrapper"></div>
        </section>

        <!-- STAFF -->
        <section id="page-staff" class="page">
          <div class="page-header">
            <div>
              <div class="page-title">Staff &amp; POS Users</div>
              <div class="page-sub">Create usernames &amp; PINs for your cashiers.</div>
            </div>
            <div class="page-actions">
              <button id="btn-add-staff" class="btn btn-primary">Add Staff User</button>
            </div>
          </div>

          <div class="toolbar">
            <input id="search-staff" placeholder="Search staff by username or name"/>
            <select id="sort-staff">
              <option value="username-asc">Username A → Z</option>
              <option value="username-desc">Username Z → A</option>
              <option value="role">By role</option>
              <option value="active-first">Active first</option>
            </select>
          </div>

          <div id="staff-table" class="table-wrapper"></div>
        </section>

        <!-- ORDERS -->
        <section id="page-orders" class="page">
          <div class="page-header">
            <div>
              <div class="page-title">Orders</div>
              <div class="page-sub">Track purchases and returns during the event.</div>
            </div>
          </div>

          <div class="toolbar">
            <input id="search-orders" placeholder="Search orders by ID or customer name"/>
            <select id="sort-orders">
              <option value="date-desc">Newest first</option>
              <option value="date-asc">Oldest first</option>
              <option value="total-desc">Total high → low</option>
              <option value="total-asc">Total low → high</option>
            </select>
          </div>

          <div id="orders-table" class="table-wrapper analytics-section"></div>
        </section>

        <!-- CUSTOMERS -->
        <section id="page-customers" class="page">
          <div class="page-header">
            <div>
              <div class="page-title">Customers</div>
              <div class="page-sub">Customer database &amp; purchase history for this brand.</div>
            </div>
          </div>

          <div id="customers-analytics" class="cards-grid analytics-section" style="margin-top:4px;"></div>

          <div class="toolbar">
            <input id="search-customers" placeholder="Search by name, phone or email"/>
            <select id="sort-customers">
              <option value="name-asc">Name A → Z</option>
              <option value="name-desc">Name Z → A</option>
              <option value="total-desc">Total spent high → low</option>
              <option value="orders-desc">Most orders</option>
            </select>
          </div>

          <div id="customers-table" class="table-wrapper analytics-section"></div>
        </section>

        <!-- SETTINGS -->
        <section id="page-settings" class="page">
          <div class="page-header">
            <div>
              <div class="page-title">Settings</div>
              <div class="page-sub">Brand details &amp; financial configuration for this event.</div>
            </div>
          </div>

          <div class="settings-grid">
            <div class="settings-card">
              <div class="settings-title">Brand Information</div>
              <div class="field">
                <div class="field-label">Brand Name</div>
                <input id="set-brand-name" class="field-input"/>
              </div>
              <div class="field">
                <div class="field-label">Country</div>
                <input id="set-brand-country" class="field-input"/>
              </div>
              <div class="field">
                <div class="field-label">Brand Logo</div>
                <input id="set-brand-logo" class="field-input" type="file" accept="image/*"/>
                <div class="field-hint">
                  Stored as <code>brands/&lt;brandId&gt;/branding/logo</code>.
                </div>
              </div>
              <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px;">
                <button id="btn-save-brand-settings" class="btn btn-primary">Save</button>
              </div>
            </div>

            <div class="settings-card">
              <div class="settings-title">Financial Settings</div>
              <div class="field">
                <div class="field-label">VAT %</div>
                <input id="set-vat" class="field-input" type="number"/>
              </div>
              <div class="field">
                <div class="field-label">Service Fee %</div>
                <input id="set-service-fee" class="field-input" type="number"/>
              </div>
              <button id="btn-save-financial-settings" class="btn btn-primary">Save</button>
            </div>
          </div>
        </section>

        <!-- HELP / HOW-TO -->
        <section id="page-help" class="page">
          <div class="page-header">
            <div>
              <div class="page-title">How this dashboard works</div>
              <div class="page-sub">Quick guide for brand owners using Luma Events OS.</div>
            </div>
          </div>

          <div class="card" style="margin-bottom:12px;">
            <div class="card-title">1. Status &amp; access</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.5;">
              <ul style="margin-left:16px;margin-top:4px;">
                <li><b>Pending</b>: You can set up products and staff. POS &amp; analytics are disabled until the organizer approves you.</li>
                <li><b>Approved + Active</b>: Full access — POS, orders, customers &amp; analytics are enabled.</li>
                <li><b>Suspended</b>: You can view and edit products &amp; staff, but POS and analytics are disabled.</li>
                <li><b>Rejected</b>: Dashboard is blocked. Contact the event organizer if you think this is a mistake.</li>
              </ul>
            </div>
          </div>

          <div class="card" style="margin-bottom:12px;">
            <div class="card-title">2. Products</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.5;">
              <ul style="margin-left:16px;margin-top:4px;">
                <li>Products live under <code>brands/&lt;brandId&gt;/products</code>.</li>
                <li>Each product can have a name, price, optional code, auto-generated SKU, image and variants (e.g. Size: S/M/L).</li>
                <li>When you leave SKU empty, the system generates one like <code>BRAND-YYYYMMDD-RAND</code>.</li>
                <li>Images are stored in Storage under <code>brands/&lt;brandId&gt;/products/&lt;productId&gt;/main.jpg</code>.</li>
              </ul>
            </div>
          </div>

          <div class="card" style="margin-bottom:12px;">
            <div class="card-title">3. Staff &amp; POS</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.5;">
              <ul style="margin-left:16px;margin-top:4px;">
                <li>Staff users live under <code>brands/&lt;brandId&gt;/staff</code>.</li>
                <li>For cashiers, set a <b>username</b> and <b>PIN</b>. They use the POS link in the Overview to log in.</li>
                <li>Toggle <b>Active</b> on/off to suspend a staff user from POS without deleting them.</li>
              </ul>
            </div>
          </div>

          <div class="card" style="margin-bottom:12px;">
            <div class="card-title">4. Orders &amp; Customers</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.5;">
              <ul style="margin-left:16px;margin-top:4px;">
                <li>All orders are stored in <code>brands/&lt;brandId&gt;/orders</code> — never under the event.</li>
                <li>The Overview and Orders pages only read from this path.</li>
                <li>Customers live under <code>brands/&lt;brandId&gt;/customers</code>; the dashboard calculates their total spend and order count from orders.</li>
                <li>Use the “Open order” button in the Orders tab to see full order details.</li>
              </ul>
            </div>
          </div>

          <div class="card">
            <div class="card-title">5. Settings</div>
            <div style="font-size:12px;color:var(--muted);line-height:1.5;">
              <ul style="margin-left:16px;margin-top:4px;">
                <li>Brand name, country and logo are stored in <code>brands/&lt;brandId&gt;</code>.</li>
                <li>VAT and service fee percentages are also stored on the brand and used by the POS.</li>
              </ul>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- MODALS -->
  <div id="modal-container"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, collection, addDoc, setDoc, getDoc, getDocs,
      updateDoc, query, where, limit, serverTimestamp, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    const firebaseConfig = {
      apiKey:"AIzaSyA80bAAGPuyscnTVS-zwrxE9Jp3tPiS1gM",
      authDomain:"events-339ce.firebaseapp.com",
      projectId:"events-339ce",
      storageBucket:"events-339ce.firebasestorage.app",
      messagingSenderId:"175601544315",
      appId:"1:175601544315:web:00c94b4affa972b3a286de"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    const qs = s => document.querySelector(s);
    const qsa = s => document.querySelectorAll(s);

    const urlParams = new URLSearchParams(window.location.search);
    const brandId = urlParams.get("brandId");
    const eventIdFromUrl = urlParams.get("eventId");

    if (!brandId) {
      alert("Missing brandId in URL.");
    }

    /* DOM REFS */
    const sidebarBrandLogo = qs("#sidebar-brand-logo");
    const sidebarBrandName = qs("#sidebar-brand-name");
    const sidebarEventLabel = qs("#sidebar-event-label");
    const topbarTitle = qs("#topbar-title");
    const topbarSubtitle = qs("#topbar-subtitle");
    const statusPill = qs("#status-pill");

    const statusBannerEl = qs("#status-banner");
    const statusBannerTitle = statusBannerEl.querySelector(".status-title");
    const statusBannerBody = statusBannerEl.querySelector(".status-body");
    const blockedView = qs("#blocked-view");
    const blockedMessage = qs("#blocked-message");

    const dashSalesTodayEl = qs("#dash-sales-today");
    const dashOrdersTodayEl = qs("#dash-orders-today");
    const dashOrdersReturnsTodayEl = qs("#dash-orders-returns-today");
    const dashProductsCountEl = qs("#dash-products-count");
    const recentOrdersTable = qs("#table-recent-orders");

    const productsTable = qs("#products-table");
    const staffTable = qs("#staff-table");
    const ordersTable = qs("#orders-table");
    const customersAnalyticsEl = qs("#customers-analytics");
    const customersTable = qs("#customers-table");
    const eventCardName = qs("#event-card-name");
    const eventCardMeta = qs("#event-card-meta");
    const posStatusNote = qs("#pos-status-note");

    const modalContainer = qs("#modal-container");

    /* STATE */
    let currentUser = null;
    let brandData = null;
    let vendorStatus = "pending";
    let brandStatus = "active";
    let eventId = eventIdFromUrl || null;
    let eventData = null;

    let products = [];
    let staffUsers = [];
    let ordersList = [];
    let customersList = [];

    let ordersUnsub = null;

    let canUsePOS = false;
    let canSeeAnalytics = false;

    /* MODAL HELPERS */
    function openModal(innerHtml){
      modalContainer.style.display = "flex";
      modalContainer.innerHTML = `<div class="modal">${innerHtml}</div>`;
    }
    function closeModal(){
      modalContainer.style.display = "none";
      modalContainer.innerHTML = "";
    }
    window.closeModal = closeModal;

    /* DATE HELPERS */
    function todayDate(){
      const d = new Date();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${d.getFullYear()}-${m}-${day}`;
    }
    function formatDate(d){
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${d.getFullYear()}-${m}-${day}`;
    }
    function formatDateTime(d){
      return d.toLocaleString("en-EG",{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"});
    }
    function orderDate(o){
      if (o.date) return o.date;
      if (o.createdAt && typeof o.createdAt.toDate === "function"){
        return formatDate(o.createdAt.toDate());
      }
      if (o.createdAtLocal && typeof o.createdAtLocal === "string"){
        return o.createdAtLocal.slice(0,10);
      }
      return "";
    }
    function orderDateTimeString(o){
      if (o.createdAt && typeof o.createdAt.toDate === "function"){
        return formatDateTime(o.createdAt.toDate());
      }
      if (o.createdAtLocal && typeof o.createdAtLocal === "string"){
        return o.createdAtLocal.replace("T"," ").replace("Z","");
      }
      return "—";
    }

    /* IMAGE UPLOAD */
    async function uploadImageToStorage(file, path){
      if (!file) return null;
      const storageRef = ref(storage, path);
      await uploadBytes(storageRef, file);
      return await getDownloadURL(storageRef);
    }

    /* STATUS + UI RULES */
    function applyStatusUI(){
      const statusText = `Vendor: ${vendorStatus || "unknown"} • Brand: ${brandStatus || "unknown"}`;
      statusPill.textContent = statusText;

      blockedView.style.display = "none";
      statusBannerEl.style.display = "none";
      statusBannerEl.classList.remove("pending","suspended","rejected");

      // default
      canUsePOS = (vendorStatus === "approved" && brandStatus === "active");
      canSeeAnalytics = canUsePOS;

      if (vendorStatus === "rejected"){
        blockedView.style.display = "flex";
        blockedMessage.textContent = "Your application was rejected for this event. Please contact the organizer.";
        canUsePOS = false;
        canSeeAnalytics = false;
      } else if (vendorStatus === "pending"){
        statusBannerEl.style.display = "block";
        statusBannerEl.classList.add("pending");
        statusBannerTitle.textContent = "Vendor approval pending";
        statusBannerBody.textContent = "Your vendor application is pending approval. You can prepare your products and staff while you wait. POS and analytics will be enabled after approval.";
        canUsePOS = false;
        canSeeAnalytics = false;
      } else if (vendorStatus === "suspended" || brandStatus === "suspended"){
        statusBannerEl.style.display = "block";
        statusBannerEl.classList.add("suspended");
        statusBannerTitle.textContent = "Brand suspended";
        statusBannerBody.textContent = "Your brand or vendor profile has been suspended by the organizer. POS access and analytics are disabled until this is resolved.";
        canUsePOS = false;
        canSeeAnalytics = false;
      }

      // POS card note
      if (!canUsePOS){
        posStatusNote.textContent = "POS is disabled until your brand is fully approved and active.";
      } else {
        posStatusNote.textContent = "Cashiers log in with username & PIN. Keep this link private.";
      }

      // hide analytics sections if needed
      qsa(".analytics-section").forEach(el=>{
        el.style.display = canSeeAnalytics ? "" : "none";
      });
    }

    /* LOAD BRAND + EVENT + VENDOR */
    async function loadBrandAndEvent(){
      if (!brandId) return;
      const brandRef = doc(db,"brands",brandId);
      const snap = await getDoc(brandRef);
      if (!snap.exists()) throw new Error("Brand not found");
      brandData = snap.data();

      const name = brandData.name || "Brand";
      const country = brandData.country || "";
      const logo = brandData.logoUrl || brandData.logo || null;
      brandStatus = brandData.status || "active";
      eventId = brandData.eventId || eventId || null;

      sidebarBrandName.textContent = name;
      topbarTitle.textContent = `Brand Dashboard — ${name}`;
      topbarSubtitle.textContent = eventId ? "Loading event details..." : "Event not linked.";

      if (logo){
        sidebarBrandLogo.style.backgroundImage = `url("${logo}")`;
        sidebarBrandLogo.textContent = "";
      } else {
        sidebarBrandLogo.style.backgroundImage = "none";
        sidebarBrandLogo.textContent = name[0]?.toUpperCase() || "B";
      }

      const setBrandName = qs("#set-brand-name");
      const setBrandCountry = qs("#set-brand-country");
      const setVat = qs("#set-vat");
      const setServiceFee = qs("#set-service-fee");

      if (setBrandName) setBrandName.value = name;
      if (setBrandCountry) setBrandCountry.value = country;
      if (setVat) setVat.value = brandData.vat ?? 0;
      if (setServiceFee) setServiceFee.value = brandData.serviceFee ?? 0;

      // event meta
      if (eventId){
        const evRef = doc(db,"events",eventId);
        const evSnap = await getDoc(evRef);
        if (evSnap.exists()){
          eventData = evSnap.data();
        }
      }

      const eventName = brandData.eventName || eventData?.name || eventData?.title || "Event";
      const date = eventData?.date || eventData?.startDate || "";
      const location = eventData?.location || eventData?.venue || "";

      sidebarEventLabel.textContent = eventName;
      topbarSubtitle.textContent = `Brand dashboard for "${eventName}".`;

      eventCardName.textContent = eventName;
      const metaParts = [];
      if (date) metaParts.push(date);
      if (location) metaParts.push(location);
      eventCardMeta.textContent = metaParts.join(" • ") || "Event details from organizer.";

      // vendor doc
      if (eventId){
        const vendorsRef = collection(doc(db,"events",eventId),"vendors");
        const qRef = query(vendorsRef, where("brandId","==",brandId), limit(1));
        const vSnap = await getDocs(qRef);
        if (!vSnap.empty){
          const vDoc = vSnap.docs[0].data();
          vendorStatus = vDoc.status || "pending";
        } else {
          vendorStatus = "approved"; // fallback if vendor doc not found
        }
      } else {
        vendorStatus = "approved";
      }

      applyStatusUI();
    }

    /* LOAD PRODUCTS */
    async function loadProducts(){
      if (!brandId) return;
      const colRef = collection(doc(db,"brands",brandId),"products");
      const snap = await getDocs(colRef);
      products = snap.docs.map(d=>({id:d.id,...d.data()}));
      dashProductsCountEl.textContent = String(products.length);
      renderProductsTable();
    }

    /* LOAD STAFF */
    async function loadStaff(){
      if (!brandId) return;
      const colRef = collection(doc(db,"brands",brandId),"staff");
      const snap = await getDocs(colRef);
      staffUsers = snap.docs.map(d=>({id:d.id,...d.data()}));
      renderStaffTable();
    }

    /* LOAD CUSTOMERS */
    async function loadCustomers(){
      if (!brandId) return;
      const colRef = collection(doc(db,"brands",brandId),"customers");
      const snap = await getDocs(colRef);
      customersList = snap.docs.map(d=>({id:d.id,...d.data()}));
      updateCustomersAnalyticsAndTable();
    }

    /* LOAD ORDERS (from brands/{brandId}/orders) */
    async function loadOrders(){
      if (!brandId) return;
      const colRef = collection(doc(db,"brands",brandId),"orders");
      const snap = await getDocs(colRef);
      ordersList = snap.docs.map(d=>({id:d.id,...d.data()}));

      updateDashboardFromOrders();
      renderOrdersTable();
      renderRecentOrdersTable();
      updateCustomersAnalyticsAndTable(); // recompute from orders
    }

    function listenToOrdersRealtime(){
      if (!brandId) return;
      if (ordersUnsub) ordersUnsub();

      const colRef = collection(doc(db,"brands",brandId),"orders");
      ordersUnsub = onSnapshot(colRef,snap=>{
        ordersList = snap.docs.map(d=>({id:d.id,...d.data()}));
        updateDashboardFromOrders();
        renderOrdersTable();
        renderRecentOrdersTable();
        updateCustomersAnalyticsAndTable();
      });
    }

    /* DASHBOARD METRICS FROM ORDERS */
    function updateDashboardFromOrders(){
      if (!canSeeAnalytics){
        dashSalesTodayEl.textContent = "0";
        dashOrdersTodayEl.textContent = "0";
        dashOrdersReturnsTodayEl.textContent = "0";
        return;
      }
      const todayStr = todayDate();
      let sales = 0;
      let salesCount = 0;
      let returnCount = 0;

      for (const o of ordersList){
        const d = orderDate(o);
        if (d !== todayStr) continue;

        const total = Number(o.total || 0);
        const isReturn = !!o.isReturn;

        if (isReturn){
          sales -= Math.abs(total);
          returnCount += 1;
        } else {
          sales += total;
          salesCount += 1;
        }
      }

      dashSalesTodayEl.textContent = sales.toFixed(2);
      dashOrdersTodayEl.textContent = String(salesCount);
      dashOrdersReturnsTodayEl.textContent = String(returnCount);
    }

    /* CUSTOMERS ANALYTICS FROM ORDERS */
    function buildCustomerStats(){
      const stats = {};
      for (const o of ordersList){
        const cid = o.customerId || null;
        if (!cid) continue;
        if (!stats[cid]){
          stats[cid] = {ordersCount:0,totalSpent:0};
        }
        const total = Number(o.total || 0);
        const isReturn = !!o.isReturn;
        if (isReturn){
          stats[cid].ordersCount += 1;
          stats[cid].totalSpent -= Math.abs(total);
        } else {
          stats[cid].ordersCount += 1;
          stats[cid].totalSpent += total;
        }
      }
      return stats;
    }

    function updateCustomersAnalyticsAndTable(){
      customersAnalyticsEl.innerHTML = "";
      customersTable.innerHTML = "";

      if (!canSeeAnalytics){
        customersAnalyticsEl.innerHTML = "";
        customersTable.innerHTML = `<div class="table-empty">Customer analytics are disabled in your current status.</div>`;
        return;
      }

      const stats = buildCustomerStats();
      const customersWithStats = customersList.map(c=>{
        const s = stats[c.id] || {ordersCount:0,totalSpent:0};
        return {...c,ordersCount:s.ordersCount,totalSpent:s.totalSpent};
      });

      // analytics card
      const totalCustomers = customersWithStats.length;
      let totalSpentAll = 0;
      let totalOrdersAll = 0;
      customersWithStats.forEach(c=>{
        totalSpentAll += Number(c.totalSpent || 0);
        totalOrdersAll += Number(c.ordersCount || 0);
      });

      if (totalCustomers){
        customersAnalyticsEl.innerHTML = `
          <div class="card">
            <div class="card-title">Customers</div>
            <div class="card-number">${totalCustomers}</div>
            <div class="card-note">Unique customers saved for this brand.</div>
          </div>
          <div class="card">
            <div class="card-title">Total Orders</div>
            <div class="card-number">${totalOrdersAll}</div>
            <div class="card-note">Orders linked to saved customers.</div>
          </div>
          <div class="card">
            <div class="card-title">Recorded Spend</div>
            <div class="card-number">${totalSpentAll.toFixed(2)}</div>
            <div class="card-note">Net spend (sales − returns).</div>
          </div>
        `;
      }

      renderCustomersTable(customersWithStats);
    }

    /* RENDER PRODUCTS TABLE */
    function renderProductsTable(){
      let list = products.slice();
      const searchVal = (qs("#search-products")?.value || "").toLowerCase();
      const sortVal = qs("#sort-products")?.value || "name-asc";

      if (searchVal){
        list = list.filter(p=>{
          const s = `${p.name || ""} ${p.sku || ""} ${(p.code || "")}`.toLowerCase();
          return s.includes(searchVal);
        });
      }

      list.sort((a,b)=>{
        switch(sortVal){
          case "name-desc": return (b.name || "").localeCompare(a.name || "");
          case "price-asc": return Number(a.price || 0) - Number(b.price || 0);
          case "price-desc": return Number(b.price || 0) - Number(a.price || 0);
          case "name-asc":
          default: return (a.name || "").localeCompare(b.name || "");
        }
      });

      if (!list.length){
        productsTable.innerHTML = `<div class="table-empty">No products yet. Add your first product.</div>`;
        return;
      }

      const rows = list.map(p=>{
        const name = p.name || "Unnamed";
        const sku = p.sku || "—";
        const code = p.code || "—";
        const price = Number(p.price || 0).toFixed(2);
        const imgStyle = p.imageUrl ? `style="background-image:url('${p.imageUrl}');"` : "";
        const active = p.isActive !== false;
        const variants = Array.isArray(p.variants) ? p.variants : [];
        const variantHtml = variants.map(v=>{
          const labels = Array.isArray(v.labels) ? v.labels.join(", ") : "";
          return `<span class="variant-pill">${v.name || ""}: ${labels}</span>`;
        }).join(" ");

        return `
          <tr>
            <td>
              <span class="product-img-thumb" ${imgStyle}></span>
            </td>
            <td>${name}</td>
            <td>${sku}</td>
            <td>${code}</td>
            <td>${price}</td>
            <td>${active ? '<span class="chip chip-green">Active</span>' : '<span class="chip chip-red">Inactive</span>'}</td>
            <td>${variantHtml || '<span style="font-size:10px;color:var(--muted);">—</span>'}</td>
            <td>
              <button class="btn btn-ghost btn-sm" data-action="edit-product" data-id="${p.id}">Edit</button>
              <button class="btn btn-danger btn-sm" data-action="delete-product" data-id="${p.id}">Delete</button>
            </td>
          </tr>
        `;
      }).join("");

      productsTable.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Image</th>
              <th>Name</th>
              <th>SKU</th>
              <th>Code</th>
              <th>Price</th>
              <th>Status</th>
              <th>Variants</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      productsTable.querySelectorAll("button[data-action]").forEach(btn=>{
        const id = btn.getAttribute("data-id");
        const action = btn.getAttribute("data-action");
        btn.addEventListener("click",()=>{
          const prod = products.find(p=>p.id === id);
          if (action === "edit-product" && prod){
            openProductModal(prod);
          } else if (action === "delete-product"){
            confirmDeleteProduct(id);
          }
        });
      });
    }

    /* PRODUCT MODAL WITH VARIANTS + IMAGE + AUTO SKU */
    function generateSku(name){
      const base = (name || "BRAND").split(/\s+/)[0].toUpperCase().slice(0,5);
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      const rand = Math.floor(1000 + Math.random()*9000);
      return `${base}-${y}${m}${day}-${rand}`;
    }

    function openProductModal(product){
      const isEdit = !!product;
      const title = isEdit ? "Edit Product" : "Add Product";

      openModal(`
        <div class="modal-title">${title}</div>
        <form id="product-form">
          <div class="field">
            <div class="field-label">Product Name</div>
            <input id="prod-name" class="field-input" value="${product?.name || ""}" required/>
          </div>
          <div class="field">
            <div class="field-label">SKU (auto if empty)</div>
            <input id="prod-sku" class="field-input" value="${product?.sku || ""}"/>
          </div>
          <div class="field">
            <div class="field-label">Code (optional)</div>
            <input id="prod-code" class="field-input" value="${product?.code || ""}"/>
          </div>
          <div class="field">
            <div class="field-label">Price</div>
            <input id="prod-price" type="number" step="0.01" class="field-input" value="${product?.price ?? ""}" required/>
          </div>
          <div class="field">
            <label>
              <input id="prod-active" type="checkbox" ${product?.isActive === false ? "" : "checked"}/>
              Active product
            </label>
          </div>

          <div class="field">
            <div class="field-label">Product Image</div>
            <input id="prod-image" type="file" class="field-input" accept="image/*"/>
            <div class="field-hint">Stored at <code>brands/&lt;brandId&gt;/products/&lt;productId&gt;/main.jpg</code>.</div>
          </div>

          <div class="field">
            <div class="field-label">Variants (optional)</div>
            <div class="variants-container">
              <div id="variants-list"></div>
              <button type="button" id="btn-add-variant" class="btn btn-ghost btn-sm" style="margin-top:4px;">Add variant group</button>
              <div class="field-hint">Example: group "Size" with labels "S, M, L".</div>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn btn-ghost" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      `);

      const variantsListEl = document.getElementById("variants-list");
      const existingVariants = Array.isArray(product?.variants) ? product.variants : [];

      function renderVariantRows(){
        variantsListEl.innerHTML = "";
        if (!existingVariants.length){
          return;
        }
        existingVariants.forEach((v,idx)=>{
          const labels = Array.isArray(v.labels) ? v.labels.join(", ") : "";
          const row = document.createElement("div");
          row.className = "variant-row";
          row.innerHTML = `
            <input data-role="name" data-index="${idx}" class="field-input" placeholder="Group name (e.g. Size)" value="${v.name || ""}"/>
            <input data-role="labels" data-index="${idx}" class="field-input" placeholder="Labels (comma-separated)" value="${labels}"/>
            <button type="button" class="btn btn-ghost btn-sm" data-role="remove" data-index="${idx}">X</button>
          `;
          variantsListEl.appendChild(row);
        });

        variantsListEl.querySelectorAll("button[data-role='remove']").forEach(btn=>{
          const i = Number(btn.getAttribute("data-index"));
          btn.addEventListener("click",()=>{
            existingVariants.splice(i,1);
            renderVariantRows();
          });
        });

        variantsListEl.querySelectorAll("input[data-role]").forEach(inp=>{
          inp.addEventListener("input",()=>{
            const role = inp.getAttribute("data-role");
            const i = Number(inp.getAttribute("data-index"));
            const v = existingVariants[i] || (existingVariants[i] = {name:"",labels:[]});
            if (role === "name"){
              v.name = inp.value.trim();
            } else if (role === "labels"){
              v.labels = inp.value.split(",").map(s=>s.trim()).filter(Boolean);
            }
          });
        });
      }

      renderVariantRows();

      document.getElementById("btn-add-variant").addEventListener("click",()=>{
        existingVariants.push({name:"",labels:[]});
        renderVariantRows();
      });

      document.getElementById("product-form").addEventListener("submit", async evt=>{
        evt.preventDefault();
        if (!brandId) return;

        const name = document.getElementById("prod-name").value.trim();
        let sku = document.getElementById("prod-sku").value.trim();
        const code = document.getElementById("prod-code").value.trim() || null;
        const price = Number(document.getElementById("prod-price").value || 0);
        const isActive = document.getElementById("prod-active").checked;
        const imgInput = document.getElementById("prod-image");

        if (!name){
          alert("Product name is required.");
          return;
        }
        if (!price || price < 0){
          alert("Enter a valid price.");
          return;
        }

        if (!sku){
          sku = generateSku(name);
        }

        const brandRef = doc(db,"brands",brandId);
        const colRef = collection(brandRef,"products");

        const data = {
          name,
          sku,
          code,
          price,
          isActive,
          variants: existingVariants.filter(v=>v.name && Array.isArray(v.labels) && v.labels.length),
          updatedAt: serverTimestamp()
        };

        let productId = product?.id || null;
        if (isEdit){
          productId = product.id;
          await updateDoc(doc(brandRef,"products",productId), data);
        } else {
          const newDocRef = await addDoc(colRef, {
            ...data,
            createdAt: serverTimestamp()
          });
          productId = newDocRef.id;
        }

        if (imgInput.files && imgInput.files[0]){
          const url = await uploadImageToStorage(imgInput.files[0], `brands/${brandId}/products/${productId}/main.jpg`);
          await updateDoc(doc(brandRef,"products",productId), {imageUrl:url});
        }

        closeModal();
        await loadProducts();
      });
    }

    async function confirmDeleteProduct(id){
      if (!brandId) return;
      if (!confirm("Delete this product?")) return;
      const brandRef = doc(db,"brands",brandId);
      await updateDoc(doc(brandRef,"products",id), {deleted:true,isActive:false});
      // soft-delete: keep record; you can change to deleteDoc if you want
      await loadProducts();
    }

    /* STAFF TABLE + MODAL */
    function renderStaffTable(){
      let list = staffUsers.slice();
      const searchVal = (qs("#search-staff")?.value || "").toLowerCase();
      const sortVal = qs("#sort-staff")?.value || "username-asc";

      if (searchVal){
        list = list.filter(s=>{
          const t = `${s.username || ""} ${s.name || ""}`.toLowerCase();
          return t.includes(searchVal);
        });
      }

      list.sort((a,b)=>{
        switch(sortVal){
          case "username-desc": return (b.username || "").localeCompare(a.username || "");
          case "role": return (a.role || "").localeCompare(b.role || "");
          case "active-first": return (b.isActive === false) - (a.isActive === false);
          case "username-asc":
          default: return (a.username || "").localeCompare(b.username || "");
        }
      });

      if (!list.length){
        staffTable.innerHTML = `<div class="table-empty">No staff yet. Add your first cashier or staff user.</div>`;
        return;
      }

      const rows = list.map(s=>{
        const name = s.name || "-";
        const username = s.username || "-";
        const role = s.role || "-";
        const isActive = s.isActive !== false;
        return `
          <tr>
            <td>${name}</td>
            <td>${username}</td>
            <td>${role}</td>
            <td>${isActive ? '<span class="chip chip-green">Active</span>' : '<span class="chip chip-red">Inactive</span>'}</td>
            <td>
              <button class="btn btn-ghost btn-sm" data-action="edit-staff" data-id="${s.id}">Edit</button>
              <button class="btn btn-danger btn-sm" data-action="delete-staff" data-id="${s.id}">Delete</button>
            </td>
          </tr>
        `;
      }).join("");

      staffTable.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Username</th>
              <th>Role</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      staffTable.querySelectorAll("button[data-action]").forEach(btn=>{
        const id = btn.getAttribute("data-id");
        const action = btn.getAttribute("data-action");
        btn.addEventListener("click",()=>{
          const st = staffUsers.find(s=>s.id === id);
          if (action === "edit-staff" && st) openStaffModal(st);
          else if (action === "delete-staff") confirmDeleteStaff(id);
        });
      });
    }

    function openStaffModal(staff){
      const isEdit = !!staff;
      const title = isEdit ? "Edit Staff User" : "Add Staff User";

      openModal(`
        <div class="modal-title">${title}</div>
        <form id="staff-form">
          <div class="field">
            <div class="field-label">Name</div>
            <input id="staff-name" class="field-input" value="${staff?.name || ""}" required/>
          </div>
          <div class="field">
            <div class="field-label">Username</div>
            <input id="staff-username" class="field-input" value="${staff?.username || ""}" required/>
          </div>
          <div class="field">
            <div class="field-label">PIN (POS login)</div>
            <input id="staff-pin" class="field-input" value="${staff?.pin || ""}" placeholder="e.g. 1234"/>
          </div>
          <div class="field">
            <div class="field-label">Role</div>
            <select id="staff-role" class="field-input">
              <option value="cashier" ${staff?.role === "cashier" ? "selected":""}>Cashier</option>
              <option value="staff" ${staff?.role === "staff" ? "selected":""}>Staff</option>
              <option value="brand_owner" ${staff?.role === "brand_owner" ? "selected":""}>Brand Owner</option>
            </select>
          </div>
          <div class="field">
            <label>
              <input id="staff-active" type="checkbox" ${staff?.isActive === false ? "" : "checked"}/>
              Active (can use POS)
            </label>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-ghost" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      `);

      document.getElementById("staff-form").addEventListener("submit", async evt=>{
        evt.preventDefault();
        if (!brandId) return;

        const name = document.getElementById("staff-name").value.trim();
        const username = document.getElementById("staff-username").value.trim();
        const pin = document.getElementById("staff-pin").value.trim() || null;
        const role = document.getElementById("staff-role").value || "cashier";
        const isActive = document.getElementById("staff-active").checked;

        if (!name || !username){
          alert("Name and username are required.");
          return;
        }

        const brandRef = doc(db,"brands",brandId);
        const data = {
          name,
          username,
          pin,
          role,
          isActive,
          eventId: eventId || null,
          updatedAt: serverTimestamp()
        };

        if (isEdit){
          await updateDoc(doc(brandRef,"staff",staff.id), data);
        } else {
          await addDoc(collection(brandRef,"staff"), {
            ...data,
            createdAt: serverTimestamp()
          });
        }

        closeModal();
        await loadStaff();
      });
    }

    async function confirmDeleteStaff(id){
      if (!brandId) return;
      if (!confirm("Delete this staff user?")) return;
      const brandRef = doc(db,"brands",brandId);
      await updateDoc(doc(brandRef,"staff",id), {isActive:false,deleted:true});
      await loadStaff();
    }

    /* CUSTOMERS TABLE (gets pre-enriched data) */
    function renderCustomersTable(customersWithStats){
      if (!canSeeAnalytics){
        customersTable.innerHTML = `<div class="table-empty">Customer analytics are disabled in your current status.</div>`;
        return;
      }

      const searchVal = (qs("#search-customers")?.value || "").toLowerCase();
      const sortVal = qs("#sort-customers")?.value || "name-asc";

      let list = customersWithStats.slice();

      if (searchVal){
        list = list.filter(c=>{
          const t = `${c.name || ""} ${c.phone || ""} ${c.email || ""}`.toLowerCase();
          return t.includes(searchVal);
        });
      }

      list.sort((a,b)=>{
        const nameA = (a.name || "").toLowerCase();
        const nameB = (b.name || "").toLowerCase();
        const totalA = Number(a.totalSpent || 0);
        const totalB = Number(b.totalSpent || 0);
        const ordersA = Number(a.ordersCount || 0);
        const ordersB = Number(b.ordersCount || 0);

        switch(sortVal){
          case "name-desc": return nameB.localeCompare(nameA);
          case "total-desc": return totalB - totalA;
          case "orders-desc": return ordersB - ordersA;
          case "name-asc":
          default: return nameA.localeCompare(nameB);
        }
      });

      if (!list.length){
        customersTable.innerHTML = `<div class="table-empty">No customers recorded yet.</div>`;
        return;
      }

      const rows = list.map(c=>{
        const name = c.name || "-";
        const phone = c.phone || "-";
        const email = c.email || "-";
        const total = Number(c.totalSpent || 0).toFixed(2);
        const ordersCount = c.ordersCount || 0;
        return `
          <tr>
            <td>${name}</td>
            <td>${phone}</td>
            <td>${email}</td>
            <td>${ordersCount}</td>
            <td>${total}</td>
          </tr>
        `;
      }).join("");

      customersTable.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Phone</th>
              <th>Email</th>
              <th>Orders</th>
              <th>Total Spent</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    /* ORDERS TABLE (with OPEN ORDER button) */
    function renderOrdersTable(){
      if (!canSeeAnalytics){
        ordersTable.innerHTML = `<div class="table-empty">Orders analytics are disabled in your current status.</div>`;
        return;
      }

      let list = ordersList.slice();
      const searchVal = (qs("#search-orders")?.value || "").toLowerCase();
      const sortVal = qs("#sort-orders")?.value || "date-desc";

      if (searchVal){
        list = list.filter(o=>{
          const t = `${o.orderId || o.id || ""} ${(o.customerName || o.customer?.name || "")}`.toLowerCase();
          return t.includes(searchVal);
        });
      }

      list.sort((a,b)=>{
        const dA = orderDate(a);
        const dB = orderDate(b);
        const tA = Number(a.total || 0);
        const tB = Number(b.total || 0);
        switch(sortVal){
          case "date-asc": return dA.localeCompare(dB);
          case "total-desc": return tB - tA;
          case "total-asc": return tA - tB;
          case "date-desc":
          default: return dB.localeCompare(dA);
        }
      });

      if (!list.length){
        ordersTable.innerHTML = `<div class="table-empty">No orders yet.</div>`;
        return;
      }

      const rows = list.map(o=>{
        const id = o.orderId || o.id;
        const dateStr = orderDate(o) || "—";
        const isReturn = !!o.isReturn;
        const total = Number(o.total || 0).toFixed(2);
        const customerName = o.customerName || o.customer?.name || "—";
        const paymentMethod = o.paymentMethod || "—";
        const typeLabel = isReturn ? "Return" : "Sale";
        return `
          <tr>
            <td>${id}</td>
            <td>${dateStr}</td>
            <td>${typeLabel}</td>
            <td>${total}</td>
            <td>${customerName}</td>
            <td>${paymentMethod}</td>
            <td>
              <button class="btn btn-ghost btn-sm" data-action="open-order" data-id="${o.id}">Open</button>
            </td>
          </tr>
        `;
      }).join("");

      ordersTable.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Order</th>
              <th>Date</th>
              <th>Type</th>
              <th>Total</th>
              <th>Customer</th>
              <th>Payment</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      ordersTable.querySelectorAll("button[data-action='open-order']").forEach(btn=>{
        const id = btn.getAttribute("data-id");
        btn.addEventListener("click",()=>{
          const o = ordersList.find(x=>x.id === id);
          if (o) openOrderDetailsModal(o);
        });
      });
    }

    function renderRecentOrdersTable(){
      if (!canSeeAnalytics){
        recentOrdersTable.innerHTML = `<div class="table-empty">Orders analytics are disabled in your current status.</div>`;
        return;
      }

      let list = ordersList.slice();
      list.sort((a,b)=>orderDate(b).localeCompare(orderDate(a)));
      list = list.slice(0,10);

      if (!list.length){
        recentOrdersTable.innerHTML = `<div class="table-empty">No recent orders yet.</div>`;
        return;
      }

      const rows = list.map(o=>{
        const id = o.orderId || o.id;
        const dateStr = orderDate(o) || "—";
        const isReturn = !!o.isReturn;
        const total = Number(o.total || 0).toFixed(2);
        const typeLabel = isReturn ? "Return" : "Sale";
        return `
          <tr>
            <td>${id}</td>
            <td>${dateStr}</td>
            <td>${typeLabel}</td>
            <td>${total}</td>
          </tr>
        `;
      }).join("");

      recentOrdersTable.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Order</th>
              <th>Date</th>
              <th>Type</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    function openOrderDetailsModal(o){
      const id = o.orderId || o.id;
      const typeLabel = o.isReturn ? "Return" : "Sale";
      const dt = orderDateTimeString(o);
      const pm = o.paymentMethod || "—";
      const customerName = o.customerName || o.customer?.name || "—";
      const customerEmail = o.customerEmail || o.customer?.email || "—";
      const customerPhone = o.customerPhone || o.customer?.phone || "—";

      const subtotal = Number(o.subtotal ?? 0);
      const discountAmount = Number(o.discountAmount ?? 0);
      const serviceAmount = Number(o.serviceAmount ?? 0);
      const taxAmount = Number(o.taxAmount ?? 0);
      const total = Number(o.total ?? 0);

      const items = Array.isArray(o.items) ? o.items : [];
      const itemsHtml = items.map(it=>{
        const name = it.name || "Item";
        const code = it.code || "";
        const qty = Number(it.qty || 0);
        const price = Number(it.price || 0).toFixed(2);
        const lineTotal = Number(it.lineTotal || price*qty).toFixed(2);
        const variant = it.variantKey || (Array.isArray(it.variantChoices) ? it.variantChoices.join(" / ") : "");
        return `
          <tr>
            <td>${name}${code ? ` <span style="font-size:10px;color:var(--muted);">(${code})</span>` : ""}</td>
            <td>${variant || "—"}</td>
            <td>${qty}</td>
            <td>${price}</td>
            <td>${lineTotal}</td>
          </tr>
        `;
      }).join("");

      openModal(`
        <div class="modal-title">Order ${id}</div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:8px;">
          <div>Type: <b>${typeLabel}</b></div>
          <div>Date &amp; time: ${dt}</div>
          <div>Payment method: ${pm}</div>
        </div>

        <div class="modal-section-title">Customer</div>
        <div style="font-size:12px;color:var(--muted);">
          <div>Name: ${customerName}</div>
          <div>Email: ${customerEmail}</div>
          <div>Phone: ${customerPhone}</div>
        </div>

        <div class="modal-section-title">Items</div>
        <div class="table-wrapper" style="margin-bottom:8px;">
          <table>
            <thead>
              <tr>
                <th>Item</th>
                <th>Variant</th>
                <th>Qty</th>
                <th>Price</th>
                <th>Line total</th>
              </tr>
            </thead>
            <tbody>
              ${itemsHtml || `<tr><td colspan="5" style="text-align:center;font-size:12px;color:var(--muted);">No items array on this order.</td></tr>`}
            </tbody>
          </table>
        </div>

        <div class="modal-section-title">Totals</div>
        <div style="font-size:12px;color:var(--muted);line-height:1.5;">
          <div>Subtotal: ${subtotal.toFixed(2)}</div>
          <div>Discount: −${discountAmount.toFixed(2)}</div>
          <div>Service: ${serviceAmount.toFixed(2)}</div>
          <div>Tax: ${taxAmount.toFixed(2)}</div>
          <div><b>Total: ${total.toFixed(2)}</b></div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-ghost" onclick="closeModal()">Close</button>
        </div>
      `);
    }

    /* SETTINGS SAVE */
    qs("#btn-save-brand-settings")?.addEventListener("click", async ()=>{
      if (!brandId) return;
      const nameInput = qs("#set-brand-name");
      const countryInput = qs("#set-brand-country");
      const logoInput = qs("#set-brand-logo");

      const name = nameInput?.value.trim() || "Brand";
      const country = countryInput?.value.trim() || null;
      const brandRef = doc(db,"brands",brandId);
      const updateData = {name, country};

      if (logoInput && logoInput.files && logoInput.files[0]){
        const url = await uploadImageToStorage(logoInput.files[0], `brands/${brandId}/branding/logo`);
        updateData.logoUrl = url;
      }

      await updateDoc(brandRef, updateData);
      await loadBrandAndEvent();
      alert("Brand settings saved.");
    });

    qs("#btn-save-financial-settings")?.addEventListener("click", async ()=>{
      if (!brandId) return;
      const vatVal = Number(qs("#set-vat")?.value || 0);
      const serviceVal = Number(qs("#set-service-fee")?.value || 0);
      const brandRef = doc(db,"brands",brandId);
      await updateDoc(brandRef,{vat:vatVal,serviceFee:serviceVal});
      await loadBrandAndEvent();
      alert("Financial settings saved.");
    });

    /* COPY POS LINK */
    qs("#btn-copy-pos")?.addEventListener("click",()=>{
      const link = qs("#pos-link-text").textContent.trim();
      navigator.clipboard.writeText(link).then(()=>{
        alert("POS link copied.");
      }).catch(()=>alert("Failed to copy link."));
    });

    /* SEARCH/SORT HOOKS */
    qs("#search-products")?.addEventListener("input",renderProductsTable);
    qs("#sort-products")?.addEventListener("change",renderProductsTable);

    qs("#search-staff")?.addEventListener("input",renderStaffTable);
    qs("#sort-staff")?.addEventListener("change",renderStaffTable);

    qs("#search-orders")?.addEventListener("input",renderOrdersTable);
    qs("#sort-orders")?.addEventListener("change",renderOrdersTable);

    qs("#search-customers")?.addEventListener("input",()=>updateCustomersAnalyticsAndTable());
    qs("#sort-customers")?.addEventListener("change",()=>updateCustomersAnalyticsAndTable());

    /* BUTTON HOOKS */
    qs("#btn-add-product")?.addEventListener("click",()=>openProductModal(null));
    qs("#btn-add-staff")?.addEventListener("click",()=>openStaffModal(null));

    qs("#btn-logout")?.addEventListener("click",async ()=>{
      try{ await signOut(auth); }catch(e){}
      window.location.href = "/"; // or keep same page
    });
    qs("#blocked-logout")?.addEventListener("click",async ()=>{
      try{ await signOut(auth); }catch(e){}
      window.location.href = "/";
    });

    /* NAVIGATION */
    qsa(".nav-item[data-page]").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const pageId = btn.getAttribute("data-page");
        if (!pageId) return;

        qsa(".nav-item[data-page]").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");

        qsa(".page").forEach(p=>p.classList.remove("active"));
        const pageEl = document.getElementById(pageId);
        if (pageEl) pageEl.classList.add("active");
      });
    });

    /* AUTH CHECK + INITIAL LOAD */
    onAuthStateChanged(auth, async user=>{
      currentUser = user || null;
      try{
        await loadBrandAndEvent();
        if (vendorStatus === "rejected"){
          // blocked view shows; don't load rest
          return;
        }
        await Promise.all([
          loadProducts(),
          loadStaff(),
          loadCustomers(),
          loadOrders()
        ]);
        listenToOrdersRealtime();
      }catch(err){
        console.error(err);
        alert("Error loading brand dashboard.");
      }
    });
  </script>
</body>
</html>
