<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Luma Events — Brand Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#f3f4f6;
      --panel:#ffffff;
      --panel-soft:#f9fafb;
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#2563eb;
      --accent-soft:#dbeafe;
      --accent-strong:#1d4ed8;
      --radius:16px;
      --shadow:0 18px 40px rgba(15,23,42,.12);
      --danger:#ef4444;
      --ok:#16a34a;
      --pending:#facc15;
      --suspended:#dc2626;
      --active:#16a34a;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      font-family:"Montserrat",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--ink);
    }

    /* AUTH WRAPPER */
    .auth-wrapper{
      width:100%;
      max-width:460px;
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(148,163,184,.3);
      padding:18px;
      margin:40px auto;
    }
    .auth-header{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
    }
    .auth-logo{
      width:38px;height:38px;border-radius:999px;
      background:linear-gradient(135deg,#2563eb,#a855f7);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;font-size:18px;
      overflow:hidden;
      background-size:cover;
      background-position:center;
    }
    .auth-title{font-size:17px;font-weight:700;}
    .auth-subtitle{font-size:11px;color:var(--muted);margin-top:2px;}
    .event-chip{
      font-size:10px;
      color:var(--muted);
      margin-top:2px;
    }

    .auth-tabs{
      display:flex;gap:6px;margin:10px 0 12px;
    }
    .auth-tab{
      flex:1;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--panel-soft);
      color:var(--muted);
      font-size:12px;
      cursor:pointer;
      text-align:center;
    }
    .auth-tab.active{
      background:var(--accent-soft);
      border-color:var(--accent-soft);
      color:var(--accent-strong);
      font-weight:600;
    }
    .auth-alert{
      padding:8px 10px;
      border-radius:10px;
      font-size:11px;
      margin-bottom:10px;
    }
    .auth-alert-error{background:#fef2f2;color:#b91c1c;border:1px solid #fecaca;}
    .auth-alert-info{background:#eff6ff;color:#1d4ed8;border:1px solid #bfdbfe;}

    .field{margin-bottom:10px;}
    .field-label{font-size:11px;margin-bottom:4px;color:#4b5563;}
    .field-input,.field-select,textarea.field-input{
      width:100%;padding:8px;border-radius:9px;
      border:1px solid var(--border);background:#f9fafb;font-size:12px;
    }
    .field-input:focus,.field-select:focus,textarea.field-input:focus{
      outline:none;border-color:var(--accent);box-shadow:0 0 0 1px var(--accent-soft);
    }
    .field-hint{font-size:10px;color:var(--muted);margin-top:3px;}

    .btn{
      border:none;border-radius:999px;
      padding:8px 12px;font-size:12px;font-weight:600;
      cursor:pointer;display:inline-flex;align-items:center;justify-content:center;
      gap:6px;
    }
    .btn-primary{background:var(--accent);color:#fff;}
    .btn-primary:hover{background:var(--accent-strong);}
    .btn-ghost{
      background:transparent;color:var(--accent-strong);
      border:1px solid var(--accent-soft);
    }
    .btn-ghost:hover{background:var(--accent-soft);}
    .btn-danger{background:var(--danger);color:#fff;}
    .btn-danger:hover{background:#b91c1c;}

    .auth-footer{text-align:center;margin-top:8px;font-size:10px;color:var(--muted);}

    /* APP LAYOUT */
    .app-shell{
      display:none;
      height:100vh;width:100%;
    }
    .sidebar{
      width:220px;background:var(--panel);
      border-right:1px solid var(--border);
      display:flex;flex-direction:column;
      padding:20px 12px;
    }
    .sidebar-brand{
      display:flex;align-items:center;gap:10px;margin-bottom:18px;
    }
    .sidebar-logo{
      width:36px;height:36px;border-radius:999px;
      background:linear-gradient(135deg,#2563eb,#a855f7);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;
      overflow:hidden;
      background-size:cover;
      background-position:center;
    }
    .sidebar-brand-name{font-size:15px;font-weight:700;}
    .sidebar-nav{
      display:flex;flex-direction:column;gap:6px;margin-top:10px;flex:1;
    }
    .nav-item{
      padding:9px 12px;border-radius:10px;
      cursor:pointer;font-size:13px;
      border:none;background:transparent;text-align:left;color:var(--ink);
    }
    .nav-item:hover{background:var(--panel-soft);}
    .nav-item.active{background:var(--accent-soft);color:var(--accent-strong);font-weight:600;}
    .nav-item.logout{
      margin-top:auto;
      background:#fee2e2;
      color:#b91c1c;
      border:1px solid #fecaca;
    }
    .nav-item.logout:hover{background:#fecaca;}

    .topbar{
      height:70px;background:var(--panel);
      border-bottom:1px solid var(--border);
      padding:12px 18px;
      display:flex;justify-content:space-between;align-items:center;
    }
    .topbar-title{font-size:16px;font-weight:700;}
    .topbar-sub{font-size:11px;color:var(--muted);}

    .content-area{flex:1;padding:20px;overflow-y:auto;background:var(--bg);}

    .page{display:none;}
    .page.active{display:block;}
    .page-header{
      display:flex;justify-content:space-between;
      align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:10px;
    }
    .page-title{font-size:18px;font-weight:700;}
    .page-sub{font-size:12px;color:var(--muted);}
    .page-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}

    .toolbar{
      display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;align-items:center;
      font-size:12px;
    }
    .toolbar input,
    .toolbar select{
      padding:6px 9px;border-radius:9px;
      border:1px solid var(--border);background:#fff;font-size:12px;
    }

    .cards-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:12px;margin-bottom:22px;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:18px;
      box-shadow:var(--shadow);
    }
    .card-title{font-size:13px;color:var(--muted);margin-bottom:4px;}
    .card-number{font-size:20px;font-weight:700;}
    .card-note{font-size:11px;color:var(--muted);margin-top:6px;}

    .card-disabled{
      opacity:.6;
      pointer-events:none;
    }

    .table-wrapper{
      background:#fff;border-radius:12px;border:1px solid var(--border);
      overflow-x:auto;
    }
    table{width:100%;border-collapse:collapse;font-size:12px;}
    thead{background:var(--panel-soft);}
    th,td{padding:9px 10px;border-bottom:1px solid var(--border);text-align:left;}
    th{
      font-size:11px;text-transform:uppercase;color:var(--muted);
      letter-spacing:.04em;
    }
    tbody tr:hover{background:#f9fafb;}
    .table-empty{text-align:center;padding:20px;font-size:12px;color:var(--muted);}

    .settings-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:16px;margin-top:14px;
    }
    .settings-card{
      background:var(--panel);
      border-radius:14px;
      border:1px solid var(--border);
      padding:16px;
    }
    .settings-title{font-size:14px;font-weight:600;margin-bottom:12px;}

    .low-stock{
      color:#b91c1c;
      font-weight:600;
    }
    .low-stock-badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      background:#fee2e2;
      color:#b91c1c;
      font-size:11px;
      font-weight:600;
      margin-left:4px;
    }
    #lowStockPanel{
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      background:#fef2f2;
      border:1px solid #fee2e2;
      display:none;
      font-size:12px;
    }
    #lowStockPanelTitle{
      font-weight:600;
      color:#b91c1c;
      margin-bottom:4px;
    }
    #lowStockList{
      color:#7f1d1d;
      font-size:12px;
    }

    /* STATUS BANNER */
    #status-banner{
      display:none;
      padding:8px 14px;
      font-size:12px;
      border-bottom:1px solid var(--border);
    }
    .status-pending{
      background:#fef3c7;
      color:#92400e;
      border-color:#fde68a;
    }
    .status-active{
      background:#ecfdf3;
      color:#166534;
      border-color:#bbf7d0;
    }
    .status-suspended{
      background:#fee2e2;
      color:#991b1b;
      border-color:#fecaca;
    }

    /* REJECTED FULL STATE */
    #rejected-state{
      display:none;
      flex:1;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      padding:24px;
      background:var(--bg);
    }
    .rejected-box{
      max-width:460px;
      background:var(--panel);
      border-radius:16px;
      padding:20px;
      border:1px solid #fecaca;
      box-shadow:var(--shadow);
      text-align:center;
    }
    .rejected-title{
      font-size:18px;
      font-weight:700;
      color:#b91c1c;
      margin-bottom:8px;
    }
    .rejected-text{
      font-size:12px;
      color:var(--muted);
      margin-bottom:10px;
    }
    .rejected-reason{
      margin-top:8px;
      padding:8px 10px;
      font-size:12px;
      border-radius:10px;
      background:#fef2f2;
      color:#7f1d1d;
      text-align:left;
      white-space:pre-wrap;
    }

    /* PRODUCT IMAGE THUMB */
    .product-thumb{
      width:40px;
      height:40px;
      border-radius:10px;
      object-fit:cover;
      background:#e5e7eb;
    }

    .variant-row{
      display:flex;gap:8px;margin-bottom:6px;
    }
    .variant-row input{flex:1;}

    /* MODAL */
    #modal-container{
      position:fixed;inset:0;
      display:none;justify-content:center;align-items:center;
      background:rgba(0,0,0,.35);z-index:9999;
    }
    .modal{
      background:var(--panel);
      width:100%;max-width:520px;
      border-radius:16px;
      padding:18px;
      box-shadow:var(--shadow);
      animation:fadeIn .2s ease;
    }
    .modal-title{font-size:16px;font-weight:700;margin-bottom:14px;}
    .modal-actions{margin-top:16px;display:flex;justify-content:flex-end;gap:8px;}

    @keyframes fadeIn{
      from{transform:scale(.96);opacity:0;}
      to{transform:scale(1);opacity:1;}
    }

    @media(max-width:768px){
      .app-shell{flex-direction:column;}
      .sidebar{width:100%;flex-direction:row;overflow-x:auto;height:auto;}
      .sidebar-nav{flex-direction:row;}
      .topbar{flex-direction:column;align-items:flex-start;gap:8px;height:auto;}
    }
  </style>
</head>
<body>

  <!-- AUTH VIEW -->
  <div id="auth-view" class="auth-wrapper">
    <div class="auth-header">
      <div class="auth-logo">B</div>
      <div>
        <div class="auth-title">Luma Events — Brand Portal</div>
        <div id="auth-subtitle" class="auth-subtitle">
          Sign in or create your brand to manage your event booth.
        </div>
        <div id="auth-event-chip" class="event-chip"></div>
      </div>
    </div>

    <div id="auth-alert-container"></div>

    <div class="auth-tabs">
      <button type="button" id="tab-login" class="auth-tab active">Sign in</button>
      <button type="button" id="tab-create" class="auth-tab">Create brand</button>
    </div>

    <!-- LOGIN FORM -->
    <form id="login-form">
      <div class="field">
        <div class="field-label">Email</div>
        <input id="login-email" class="field-input" type="email" placeholder="you@example.com"/>
      </div>
      <div class="field">
        <div class="field-label">Password</div>
        <input id="login-password" class="field-input" type="password" placeholder="Your password"/>
      </div>
      <button type="submit" id="login-btn" class="btn btn-primary" style="width:100%;">Sign in</button>
    </form>

    <!-- CREATE BRAND -->
    <form id="create-form" style="display:none;">
      <div class="field">
        <div class="field-label">Brand name</div>
        <input id="brand-name" class="field-input" placeholder="Example: Luma Coffee"/>
      </div>
      <div class="field">
        <div class="field-label">Country (optional)</div>
        <input id="brand-country" class="field-input" placeholder="Egypt, UAE, Germany…"/>
      </div>
      <div class="field">
        <div class="field-label">Your full name</div>
        <input id="owner-name" class="field-input" placeholder="Owner / manager name"/>
      </div>
      <div class="field">
        <div class="field-label">Email</div>
        <input id="owner-email" class="field-input" type="email" placeholder="owner@example.com"/>
      </div>
      <div class="field">
        <div class="field-label">Password</div>
        <input id="owner-password" class="field-input" type="password" placeholder="Minimum 6 characters"/>
      </div>
      <button type="submit" id="create-btn" class="btn btn-primary" style="width:100%;">Create brand for this event</button>
      <div class="field-hint">
        This will create your brand, link it to this event, and create your owner access.
      </div>
    </form>

    <div class="auth-footer">
      After login, you will access your brand dashboard and POS settings.
    </div>
  </div>

  <!-- APP VIEW -->
  <div id="app-view" class="app-shell">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-brand">
        <div id="sidebar-brand-logo" class="sidebar-logo">B</div>
        <div>
          <div id="sidebar-brand-name" class="sidebar-brand-name">Brand</div>
          <div id="sidebar-event-label" style="font-size:10px;color:var(--muted);"></div>
        </div>
      </div>
      <nav class="sidebar-nav">
        <button class="nav-item active" data-page="page-dashboard">Overview</button>
        <button class="nav-item" data-page="page-products">Products</button>
        <button class="nav-item" data-page="page-staff">Staff & POS Users</button>
        <button class="nav-item" data-page="page-customers">Customers</button>
        <button class="nav-item" data-page="page-orders">Orders</button>
        <button class="nav-item" data-page="page-help">Help & Guide</button>
        <button class="nav-item" data-page="page-settings">Settings</button>
      </nav>
      <button id="btn-logout" class="nav-item logout">Logout</button>
    </aside>

    <!-- MAIN COLUMN (STATUS + PAGES OR REJECTED STATE) -->
    <div style="flex:1;display:flex;flex-direction:column;">
      <!-- REJECTED FULL-STATE -->
      <div id="rejected-state">
        <div class="rejected-box">
          <div class="rejected-title">Access denied for this event</div>
          <div class="rejected-text">
            Your registration for this event has been rejected by the event owner.
          </div>
          <div id="rejected-reason-box" class="rejected-reason" style="display:none;"></div>
          <div style="margin-top:12px;font-size:11px;color:var(--muted);">
            If you believe this is a mistake, please contact the event organizer.
          </div>
          <div style="margin-top:14px;">
            <button id="btn-rejected-logout" class="btn btn-ghost">Sign out</button>
          </div>
        </div>
      </div>

      <!-- NORMAL APP MAIN -->
      <div id="app-main" style="flex:1;display:flex;flex-direction:column;">
        <header class="topbar">
          <div>
            <div id="topbar-brand-title" class="topbar-title">Brand Dashboard</div>
            <div class="topbar-sub" id="topbar-subtitle">
              Control center for your brand inside this event.
            </div>
          </div>
        </header>

        <div id="status-banner"></div>

        <main class="content-area">
          <!-- DASHBOARD -->
          <section id="page-dashboard" class="page active">
            <div class="page-header" style="margin-bottom:10px;">
              <div>
                <div class="page-title" style="font-size:16px;">Overview</div>
                <div class="page-sub" id="dashboard-event-subtitle">
                  High-level view of today’s performance.
                </div>
              </div>
            </div>

            <div class="cards-grid">
              <div class="card">
                <div class="card-title">Sales Today</div>
                <div id="dash-sales-today" class="card-number">0</div>
                <div class="card-note">Net of returns.</div>
              </div>
              <div class="card">
                <div class="card-title">Sales Orders Today</div>
                <div id="dash-orders-today" class="card-number">0</div>
                <div class="card-note">Number of sale orders (no returns).</div>
              </div>
              <div class="card">
                <div class="card-title">Return Orders Today</div>
                <div id="dash-orders-returns-today" class="card-number">0</div>
                <div class="card-note">Number of return orders today.</div>
              </div>
              <div class="card">
                <div class="card-title">Unique Customers (All Time)</div>
                <div id="dash-unique-customers" class="card-number">0</div>
                <div class="card-note">Distinct customers with at least one order.</div>
              </div>
            </div>

            <!-- Event info card -->
            <div class="card" id="event-info-card" style="margin-top:4px;display:none;">
              <div class="card-title">Current Event</div>
              <div id="event-card-name" class="card-number" style="font-size:14px;line-height:20px;"></div>
              <div id="event-card-meta" class="card-note"></div>
            </div>

            <!-- POS CARD -->
            <div class="card" id="pos-card" style="margin-top:10px;">
              <div class="card-title">POS Access</div>
              <div class="card-note">
                Share this POS link with your cashiers. They will log in with their username & PIN.
              </div>
              <div style="margin-top:8px;font-size:12px;word-break:break-all;">
                <span id="pos-link-text">https://luma-events.vercel.app/pos.html</span>
              </div>
              <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <button id="btn-copy-pos-link" class="btn btn-ghost">Copy POS link</button>
                <span id="pos-card-status" class="field-hint"></span>
              </div>
            </div>

            <div class="page-header" style="margin-top:18px;">
              <div>
                <div class="page-title" style="font-size:15px;">Recent Orders</div>
                <div class="page-sub">Last 10 orders.</div>
              </div>
            </div>
            <div id="table-recent-orders" class="table-wrapper"></div>
          </section>
          <!-- PRODUCTS -->
          <section id="page-products" class="page">
            <div class="page-header">
              <div>
                <div class="page-title" style="font-size:16px;">Products</div>
                <div class="page-sub">
                  Manage your products for this event. Images, prices, stock, and simple variants.
                </div>
              </div>
              <div class="page-actions">
                <button id="btn-add-product" class="btn btn-primary">Add product</button>
              </div>
            </div>

            <div class="toolbar">
              <input id="products-search" type="text" placeholder="Search products by name or SKU"/>
              <select id="products-sort">
                <option value="name-asc">Sort by name (A–Z)</option>
                <option value="name-desc">Sort by name (Z–A)</option>
                <option value="price-asc">Price (low → high)</option>
                <option value="price-desc">Price (high → low)</option>
                <option value="stock-asc">Stock (low → high)</option>
                <option value="stock-desc">Stock (high → low)</option>
              </select>
            </div>

            <div class="table-wrapper" id="products-table-wrapper">
              <!-- Filled by JS -->
            </div>

            <div id="lowStockPanel">
              <div id="lowStockPanelTitle">Low stock alerts</div>
              <div id="lowStockList"></div>
            </div>
          </section>

          <!-- STAFF & POS USERS -->
          <section id="page-staff" class="page">
            <div class="page-header">
              <div>
                <div class="page-title" style="font-size:16px;">Staff & POS Users</div>
                <div class="page-sub">
                  Create and manage cashier users who can log in to the POS for this event.
                </div>
              </div>
              <div class="page-actions">
                <button id="btn-add-staff" class="btn btn-primary">Add POS user</button>
              </div>
            </div>

            <div class="card">
              <div class="card-title">How POS users work</div>
              <div class="card-note" style="margin-top:4px;">
                Each POS user gets a username and PIN. They log in to the POS page and can only see orders for your brand.
              </div>
            </div>

            <div class="toolbar" style="margin-top:12px;">
              <input id="staff-search" type="text" placeholder="Search staff by name or username"/>
            </div>

            <div class="table-wrapper" id="staff-table-wrapper">
              <!-- Filled by JS -->
            </div>
          </section>

          <!-- CUSTOMERS -->
          <section id="page-customers" class="page">
            <div class="page-header">
              <div>
                <div class="page-title" style="font-size:16px;">Customers</div>
                <div class="page-sub">
                  Customers are calculated from your orders. Totals & spend are based on all historical orders.
                </div>
              </div>
            </div>

            <div class="cards-grid">
              <div class="card">
                <div class="card-title">Total Customers</div>
                <div id="customers-total" class="card-number">0</div>
                <div class="card-note">Distinct customers detected from your orders.</div>
              </div>
              <div class="card">
                <div class="card-title">Average Spend / Customer</div>
                <div id="customers-avg-spend" class="card-number">0</div>
                <div class="card-note">Total revenue divided by unique customers.</div>
              </div>
            </div>

            <div class="toolbar">
              <input id="customers-search" type="text" placeholder="Search by name, email, or phone"/>
              <select id="customers-sort">
                <option value="spend-desc">Sort by total spent (high → low)</option>
                <option value="spend-asc">Sort by total spent (low → high)</option>
                <option value="orders-desc">Sort by orders count (high → low)</option>
                <option value="orders-asc">Sort by orders count (low → high)</option>
                <option value="name-asc">Sort by name (A–Z)</option>
              </select>
            </div>

            <div class="table-wrapper" id="customers-table-wrapper">
              <!-- Filled by JS -->
            </div>
          </section>

          <!-- ORDERS -->
          <section id="page-orders" class="page">
            <div class="page-header">
              <div>
                <div class="page-title" style="font-size:16px;">Orders</div>
                <div class="page-sub">
                  Full list of orders for this brand. You can open any order to see its details.
                </div>
              </div>
            </div>

            <div class="cards-grid">
              <div class="card">
                <div class="card-title">Total Sales (All Time)</div>
                <div id="orders-total-sales" class="card-number">0</div>
                <div class="card-note">Net of returns.</div>
              </div>
              <div class="card">
                <div class="card-title">Orders Count</div>
                <div id="orders-total-count" class="card-number">0</div>
                <div class="card-note">Including sales & returns.</div>
              </div>
            </div>

            <div class="toolbar">
              <input id="orders-search" type="text" placeholder="Search by order ID or customer"/>
              <select id="orders-filter-type">
                <option value="all">All types</option>
                <option value="sale">Sales only</option>
                <option value="return">Returns only</option>
              </select>
              <select id="orders-filter-payment">
                <option value="all">All payment methods</option>
                <option value="cash">Cash</option>
                <option value="card">Card</option>
              </select>
              <select id="orders-sort">
                <option value="date-desc">Newest first</option>
                <option value="date-asc">Oldest first</option>
                <option value="total-desc">Total (high → low)</option>
                <option value="total-asc">Total (low → high)</option>
              </select>
            </div>

            <div class="table-wrapper" id="orders-table-wrapper">
              <!-- Table with "Open" button per order, filled by JS -->
            </div>
          </section>

          <!-- HELP & GUIDE -->
          <section id="page-help" class="page">
            <div class="page-header">
              <div>
                <div class="page-title" style="font-size:16px;">Help & Guide</div>
                <div class="page-sub">
                  Quick explanation of each page and the steps to run your booth during the event.
                </div>
              </div>
            </div>

            <div class="settings-grid">
              <div class="settings-card">
                <div class="settings-title">1. Overview</div>
                <p style="font-size:12px;color:var(--muted);">
                  Overview shows your main KPIs for this event: today’s sales, orders, returns, and unique customers.
                  You can also see your current event info and access the POS link to share with your staff.
                </p>
              </div>

              <div class="settings-card">
                <div class="settings-title">2. Products</div>
                <p style="font-size:12px;color:var(--muted);">
                  Add your products with name, price, stock, image, and simple variants (e.g. Size: S,M,L).
                  The POS will use this list. You can adjust stock at any time and upload real product images.
                </p>
              </div>

              <div class="settings-card">
                <div class="settings-title">3. Staff & POS Users</div>
                <p style="font-size:12px;color:var(--muted);">
                  Create POS users (cashiers) with username and PIN. Share the POS link from Overview,
                  and each cashier can login with these credentials. You can disable or delete users at any time.
                </p>
              </div>

              <div class="settings-card">
                <div class="settings-title">4. Customers</div>
                <p style="font-size:12px;color:var(--muted);">
                  Customers are automatically built from your orders. You can see how many orders each customer made
                  and how much they spent in total. Use this to understand your best customers.
                </p>
              </div>

              <div class="settings-card">
                <div class="settings-title">5. Orders</div>
                <p style="font-size:12px;color:var(--muted);">
                  Orders shows all sale and return orders for this event. Use the filters and search to find specific orders.
                  Click “Open” on any order to see its details, including line items and payment info.
                </p>
              </div>

              <div class="settings-card">
                <div class="settings-title">6. Approval & Status</div>
                <p style="font-size:12px;color:var(--muted);">
                  Your brand can be in pending, approved, suspended, or rejected status for this event.
                  Pending: you can see data but POS is disabled. Approved/active: full access.
                  Suspended: view-only, POS disabled. Rejected: dashboard blocked; you only see the rejection reason.
                </p>
              </div>
            </div>
          </section>

          <!-- SETTINGS -->
          <section id="page-settings" class="page">
            <div class="page-header">
              <div>
                <div class="page-title" style="font-size:16px;">Settings</div>
                <div class="page-sub">
                  Basic brand info and contact details used inside the event.
                </div>
              </div>
            </div>

            <div class="settings-grid">
              <div class="settings-card">
                <div class="settings-title">Brand Info</div>
                <div class="field">
                  <div class="field-label">Brand name</div>
                  <input id="settings-brand-name" class="field-input" placeholder="Brand name"/>
                </div>
                <div class="field">
                  <div class="field-label">Country</div>
                  <input id="settings-brand-country" class="field-input" placeholder="Country"/>
                </div>
                <div class="field">
                  <div class="field-label">Brand logo</div>
                  <input id="settings-brand-logo" class="field-input" type="file" accept="image/*"/>
                  <div class="field-hint">Upload your logo. It will show in the sidebar and POS.</div>
                </div>
                <button id="btn-save-settings" class="btn btn-primary" type="button">Save settings</button>
              </div>

              <div class="settings-card">
                <div class="settings-title">Event & POS</div>
                <p style="font-size:12px;color:var(--muted);margin-bottom:10px;">
                  This section shows how your brand is connected to the event.
                  You cannot change the event from here; contact the event owner if you need changes.
                </p>
                <div class="field">
                  <div class="field-label">Event name</div>
                  <input id="settings-event-name" class="field-input" disabled/>
                </div>
                <div class="field">
                  <div class="field-label">Current status</div>
                  <input id="settings-status" class="field-input" disabled/>
                  <div class="field-hint">
                    Status is synced with the event owner. Pending / active / suspended / rejected.
                  </div>
                </div>
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>
  </div>

  <!-- MODALS -->
  <div id="modal-container">
    <div class="modal">
      <div id="modal-body">
        <!-- Filled by JS -->
      </div>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore,
      doc,
      collection,
      addDoc,
      setDoc,
      getDoc,
      getDocs,
      updateDoc,
      serverTimestamp,
      query,
      where,
      limit
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      updateProfile,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    /* ------------------------------
       FIREBASE INIT
    ------------------------------ */
    const firebaseConfig = {
      apiKey:"AIzaSyA80bAAGPuyscnTVS-zwrxE9Jp3tPiS1gM",
      authDomain:"events-339ce.firebaseapp.com",
      projectId:"events-339ce",
      storageBucket:"events-339ce.firebasestorage.app",
      messagingSenderId:"175601544315",
      appId:"1:175601544315:web:00c94b4affa972b3a286de"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    /* ------------------------------
       DOM HELPERS
    ------------------------------ */
    const qs = sel => document.querySelector(sel);
    const qsa = sel => Array.from(document.querySelectorAll(sel));

    /* ------------------------------
       URL PARAMS (event/vendor ONLY)
       brandId always comes from userBrands/{uid}
    ------------------------------ */
    const urlParams = new URLSearchParams(window.location.search);
    const urlEventId = urlParams.get("eventId") || null;
    const urlVendorId = urlParams.get("vendorId") || null;

    /* ------------------------------
       DOM REFERENCES
    ------------------------------ */
const authView     = qs("#auth-view");
const appView      = qs("#app-view");
const rejectedView = qs("#rejected-state"); // matches your HTML
const appMain      = qs("#app-main");       // inner main app container

// auth
const authAlertBox  = qs("#auth-alert-container");


// overview recent orders
const recentOrdersWrapper = qs("#table-recent-orders");

// banner + rejected
const rejectedReasonBox   = qs("#rejected-reason-box");
// these IDs don't exist in HTML but safe to keep (guarded with if)
const rejectedEventNameEl = qs("#rejected-event-name");
const rejectedBrandNameEl = qs("#rejected-brand-name");

    const btnRejectedLogout     = qs("#btn-rejected-logout");

    // overview KPIs
    const dashSalesTodayEl   = qs("#dash-sales-today");
    const dashOrdersTodayEl  = qs("#dash-orders-today");
    const dashReturnsTodayEl = qs("#dash-returns-today");
    const dashUniqueCustEl   = qs("#dash-unique-customers");
    const overviewNoteEl     = qs("#overview-note");

    // POS card
    const posLinkUrlEl    = qs("#pos-link-url");
    const posStatusHintEl = qs("#pos-status-hint");
    const btnCopyPosLink  = qs("#btn-copy-pos-link");

    // overview recent orders
    const recentOrdersWrapper = qs("#recent-orders-table");

    // products
    const productsSearchInput = qs("#products-search");
    const productsSortSelect  = qs("#products-sort");
    const productsTableWrapper= qs("#products-table-wrapper");
    const btnAddProduct       = qs("#btn-add-product");
    const lowStockPanel       = qs("#lowStockPanel");
    const lowStockTitle       = qs("#lowStockPanelTitle");
    const lowStockList        = qs("#lowStockList");

    // staff
    const staffSearchInput    = qs("#staff-search");
    const staffTableWrapper   = qs("#staff-table-wrapper");
    const btnAddStaff         = qs("#btn-add-staff");

    // customers
    const customersTotalEl    = qs("#customers-total");
    const customersAvgSpendEl = qs("#customers-avg-spend");
    const customersSearchInput= qs("#customers-search");
    const customersSortSelect = qs("#customers-sort");
    const customersTableWrapper = qs("#customers-table-wrapper");

    // orders
    const ordersTotalSalesEl  = qs("#orders-total-sales");
    const ordersTotalCountEl  = qs("#orders-total-count");
    const ordersSearchInput   = qs("#orders-search");
    const ordersFilterTypeSel = qs("#orders-filter-type");
    const ordersFilterPaySel  = qs("#orders-filter-payment");
    const ordersSortSelect    = qs("#orders-sort");
    const ordersTableWrapper  = qs("#orders-table-wrapper");

    // settings
    const settingsBrandNameEl   = qs("#settings-brand-name");
    const settingsBrandCountryEl= qs("#settings-brand-country");
    const settingsBrandLogoEl   = qs("#settings-brand-logo");
    const settingsEventNameEl   = qs("#settings-event-name");
    const settingsStatusEl      = qs("#settings-status");
    const btnSaveSettings       = qs("#btn-save-settings");

    // nav + logout
    const navButtons = qsa(".nav-item[data-page]");
    const pages      = qsa(".page");
    const btnLogout  = qs("#btn-logout");

    // modal
    const modalContainer = qs("#modal-container");
    const modalBody      = qs("#modal-body");

    /* ------------------------------
       GLOBAL STATE
    ------------------------------ */
    let currentUser  = null;
    let brandId      = null;
    let brandData    = null;
    let vendorData   = null;
    let currentEventId   = null;
    let currentEventName = null;
    let effectiveStatus  = "pending"; // "pending" | "approved" | "suspended" | "rejected"

    let orders   = [];
    let products = [];
    let staff    = [];
    let customers = []; // derived from orders

    let isCreatingBrand = false;

    /* ------------------------------
       HELPERS
    ------------------------------ */
function showAuthView() {
  if (authView) authView.style.display = "block";
  if (appView) appView.style.display = "none";
  if (rejectedView) rejectedView.style.display = "none";
  if (appMain) appMain.style.display = "none";
}

function showAppView() {
  if (authView) authView.style.display = "none";
  if (appView) appView.style.display = "flex";
  if (rejectedView) rejectedView.style.display = "none";
  if (appMain) appMain.style.display = "flex";
}

function showRejectedView() {
  if (authView) authView.style.display = "none";
  if (appView) appView.style.display = "flex";   // keep shell (sidebar/topbar)
  if (rejectedView) rejectedView.style.display = "flex";
  if (appMain) appMain.style.display = "none";   // hide normal pages
}

 function setAuthAlert(msg, type = "error") {
  if (!authAlertBox) return;
  if (!msg) {
    authAlertBox.innerHTML = "";
    return;
  }
  const cls = type === "info" ? "auth-alert auth-alert-info" : "auth-alert auth-alert-error";
  authAlertBox.innerHTML = `<div class="${cls}">${msg}</div>`;
}

    function openModal(html) {
      modalBody.innerHTML = html;
      modalContainer.classList.add("show");
    }

    function closeModal() {
      modalContainer.classList.remove("show");
      modalBody.innerHTML = "";
    }
    window.closeModal = closeModal;

    function money(v) {
      const n = Number(v) || 0;
      return n.toFixed(2);
    }

    function getDateKeyFromDate(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function todayKey() {
      return getDateKeyFromDate(new Date());
    }

    function getOrderDateKey(order) {
      if (order.createdAtLocal) {
        const d = new Date(order.createdAtLocal);
        if (!isNaN(d.getTime())) return getDateKeyFromDate(d);
      }
      if (order.createdAt && typeof order.createdAt.toDate === "function") {
        const d = order.createdAt.toDate();
        return getDateKeyFromDate(d);
      }
      if (order.dateKey) return order.dateKey;
      return "";
    }

    function getOrderCreatedAt(order) {
      if (order.createdAtLocal) {
        const d = new Date(order.createdAtLocal);
        if (!isNaN(d.getTime())) return d;
      }
      if (order.createdAt && typeof order.createdAt.toDate === "function") {
        return order.createdAt.toDate();
      }
      return null;
    }

    function generateSku() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const datePart = `${y}${m}${day}`;
      const letters = (brandData?.name || "BRAND")
        .replace(/[^a-z0-9]/gi,"")
        .toUpperCase()
        .slice(0,3) || "BRD";
      const randomPart = Math.floor(1000 + Math.random()*9000);
      return `${letters}-${datePart}-${randomPart}`;
    }

    async function uploadFileToStorage(file, path) {
      if (!file) return null;
      const storageRef = ref(storage, path);
      await uploadBytes(storageRef, file);
      const url = await getDownloadURL(storageRef);
      return url;
    }

    function applyNav(pageId) {
      navButtons.forEach(btn => {
        const id = btn.getAttribute("data-page");
        if (id === pageId) btn.classList.add("active");
        else btn.classList.remove("active");
      });
      pages.forEach(p => {
        if (p.id === pageId) p.classList.add("active");
        else p.classList.remove("active");
      });
    }

    /* ------------------------------
       STATUS / BANNER LOGIC
    ------------------------------ */
    function applyStatusUI() {
      const brandStatus  = brandData?.status  || "pending";
      const vendorStatus = vendorData?.status || "pending";

      let mode = "pending";

      if (vendorStatus === "rejected") {
        mode = "rejected";
      } else if (vendorStatus === "suspended" || brandStatus === "suspended") {
        mode = "suspended";
      } else if (vendorStatus === "approved" && brandStatus === "active") {
        mode = "approved";
      } else {
        mode = "pending";
      }

      effectiveStatus = mode;

      // reset
      if (statusBanner) {
        statusBanner.style.display = "none";
        statusBanner.classList.remove(
          "status-banner-warning",
          "status-banner-error",
          "status-banner-success"
        );
        statusBanner.textContent = "";
      }

      // POS gating
      const posUrl = "https://luma-events.vercel.app/pos.html";
      if (posLinkUrlEl) posLinkUrlEl.textContent = posUrl;

      if (btnCopyPosLink) {
        btnCopyPosLink.disabled = false;
        btnCopyPosLink.title = "";
      }
      if (posStatusHintEl) {
        posStatusHintEl.textContent = "";
      }

      // Overlays
      if (mode === "rejected") {
        // blocked dashboard
        showRejectedView();
        if (rejectedEventNameEl) {
          rejectedEventNameEl.textContent = currentEventName || "this event";
        }
        if (rejectedBrandNameEl) {
          rejectedBrandNameEl.textContent = brandData?.name || "your brand";
        }
        if (rejectedReasonBox) {
          const reason = vendorData?.rejectionReason || vendorData?.reason || null;
          if (reason) {
            rejectedReasonBox.style.display = "block";
            rejectedReasonBox.textContent = reason;
          } else {
            rejectedReasonBox.style.display = "none";
          }
        }
        return;
      }

      // normal dashboard visible
      showAppView();

      if (!statusBanner) return;

      if (mode === "pending") {
        statusBanner.style.display = "flex";
        statusBanner.classList.add("status-banner-warning");
        statusBanner.textContent =
          "Your vendor application is pending approval. You can prepare your products and staff, but POS and analytics are not active yet.";

        if (btnCopyPosLink) {
          btnCopyPosLink.disabled = true;
          btnCopyPosLink.title = "POS will be enabled after approval.";
        }
        if (posStatusHintEl) {
          posStatusHintEl.textContent = "POS will be enabled after approval.";
        }
        if (overviewNoteEl) {
          overviewNoteEl.textContent =
            "Analytics are in preview mode. Final numbers will start counting after approval.";
        }
      } else if (mode === "suspended") {
        statusBanner.style.display = "flex";
        statusBanner.classList.add("status-banner-error");
        statusBanner.textContent =
          "Your brand has been suspended by the organizer. POS access is disabled, but you can still view data.";

        if (btnCopyPosLink) {
          btnCopyPosLink.disabled = true;
          btnCopyPosLink.title = "POS is disabled for this event.";
        }
        if (posStatusHintEl) {
          posStatusHintEl.textContent = "POS disabled for this event.";
        }
        if (overviewNoteEl) {
          overviewNoteEl.textContent =
            "Suspended mode: analytics are view-only; new orders are blocked in the POS.";
        }
      } else if (mode === "approved") {
        statusBanner.style.display = "flex";
        statusBanner.classList.add("status-banner-success");
        statusBanner.textContent =
          "You are approved for this event. POS is active and analytics are live.";

        if (posStatusHintEl) {
          posStatusHintEl.textContent = "Share this POS link with your cashiers.";
        }
        if (overviewNoteEl) {
          overviewNoteEl.textContent =
            "All analytics reflect net revenue and unique customers based on your orders.";
        }
      }
    }

    /* ------------------------------
       LOAD BRAND + EVENT + VENDOR
    ------------------------------ */
    async function loadBrandAndStatus() {
      if (!brandId) throw new Error("No brandId");

      const brandRef = doc(db, "brands", brandId);
      const snap = await getDoc(brandRef);
      if (!snap.exists()) throw new Error("Brand not found");
      brandData = snap.data();

      // brand name / logo
      const name = brandData.name || "Brand";
      sidebarBrandName.textContent = name;
      topbarTitle.textContent = `${name} — Brand Dashboard`;

      const logoUrl = brandData.logoUrl || brandData.logo || null;
      if (logoUrl) {
        sidebarLogo.style.backgroundImage = `url("${logoUrl}")`;
        sidebarLogo.textContent = "";
      } else {
        sidebarLogo.style.backgroundImage = "";
        sidebarLogo.textContent = name[0]?.toUpperCase() || "B";
      }

      // determine event
      currentEventId = urlEventId || brandData.eventId || null;
      currentEventName = brandData.eventName || null;

      if (currentEventId) {
        const evSnap = await getDoc(doc(db, "events", currentEventId));
        if (evSnap.exists()) {
          const ev = evSnap.data();
          const evName = ev.name || ev.title || currentEventName || "Event";
          currentEventName = evName;
        }
      }

      if (currentEventName) {
        if (sidebarEventLabel) sidebarEventLabel.textContent = currentEventName;
        if (topbarSub) {
          topbarSub.textContent = `Sales and POS dashboard for "${currentEventName}".`;
        }
        if (qs("#event-name-title")) {
          qs("#event-name-title").textContent = currentEventName;
        }
        if (settingsEventNameEl) {
          settingsEventNameEl.value = currentEventName;
        }
        if (authEventChip) {
          authEventChip.textContent = `You are managing: ${currentEventName}`;
        }
      }

      // settings prefill
      if (settingsBrandNameEl) settingsBrandNameEl.value = name;
      if (settingsBrandCountryEl) settingsBrandCountryEl.value = brandData.country || "";

      // vendor doc
      vendorData = null;
      if (currentEventId) {
        let vendorSnap = null;
        if (urlVendorId) {
          const vr = await getDoc(
            doc(db, "events", currentEventId, "vendors", urlVendorId)
          );
          if (vr.exists()) vendorSnap = vr;
        }
        if (!vendorSnap) {
          const qVendor = query(
            collection(db, "events", currentEventId, "vendors"),
            where("brandId", "==", brandId),
            limit(1)
          );
          const vSnap = await getDocs(qVendor);
          if (!vSnap.empty) vendorSnap = vSnap.docs[0];
        }
        if (vendorSnap && vendorSnap.exists()) {
          vendorData = { id: vendorSnap.id, ...vendorSnap.data() };
        }
      }

      if (settingsStatusEl) {
        const bStatus = brandData.status || "pending";
        const vStatus = vendorData?.status || "pending";
        settingsStatusEl.value = `Brand: ${bStatus} / Vendor: ${vStatus}`;
      }

      applyStatusUI();
    }

    /* ------------------------------
       LOAD PRODUCTS
    ------------------------------ */
    async function loadProducts() {
      products = [];
      if (!brandId) return;
      const prodsRef = collection(doc(db, "brands", brandId), "products");
      const snap = await getDocs(prodsRef);
      products = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderProducts();
      renderLowStockPanel();
    }

    function renderProducts() {
      if (!productsTableWrapper) return;

      const search = (productsSearchInput?.value || "").toLowerCase();
      const sort = productsSortSelect?.value || "name-asc";

      let list = products.slice();

      if (search) {
        list = list.filter(p => {
          const s = `${p.name || ""} ${p.sku || ""}`.toLowerCase();
          return s.includes(search);
        });
      }

      list.sort((a,b) => {
        const nameA = (a.name || "").toLowerCase();
        const nameB = (b.name || "").toLowerCase();
        const priceA = Number(a.price || 0);
        const priceB = Number(b.price || 0);
        const stockA = Number(a.stock || 0);
        const stockB = Number(b.stock || 0);

        switch (sort) {
          case "name-desc": return nameB.localeCompare(nameA);
          case "price-asc": return priceA - priceB;
          case "price-desc": return priceB - priceA;
          case "stock-asc": return stockA - stockB;
          case "stock-desc": return stockB - stockA;
          case "name-asc":
          default: return nameA.localeCompare(nameB);
        }
      });

      if (!list.length) {
        productsTableWrapper.innerHTML =
          `<div class="table-empty">No products yet. Add your first product.</div>`;
        return;
      }

      const rows = list.map(p => {
        const img = p.imageUrl
          ? `<div class="product-thumb" style="background-image:url('${p.imageUrl}')"></div>`
          : `<div class="product-thumb product-thumb-placeholder">No image</div>`;
        const variantsLabel = (Array.isArray(p.variants) && p.variants.length)
          ? p.variants.map(v => v.name).join(", ")
          : "-";
        const active = p.isActive === false ? "Inactive" : "Active";

        return `
          <tr>
            <td>${img}</td>
            <td>${p.name || "-"}</td>
            <td>${p.sku || "-"}</td>
            <td>${money(p.price)}</td>
            <td>${Number(p.stock || 0)}</td>
            <td>${variantsLabel}</td>
            <td>${active}</td>
            <td>
              <button class="btn btn-ghost btn-xs" data-action="edit-product" data-id="${p.id}">Edit</button>
              <button class="btn btn-danger btn-xs" data-action="delete-product" data-id="${p.id}">Delete</button>
            </td>
          </tr>
        `;
      }).join("");

      productsTableWrapper.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Image</th>
              <th>Name</th>
              <th>SKU</th>
              <th>Price</th>
              <th>Stock</th>
              <th>Variants</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      productsTableWrapper
        .querySelectorAll("button[data-action]")
        .forEach(btn => {
          const id = btn.getAttribute("data-id");
          const action = btn.getAttribute("data-action");
          btn.addEventListener("click", () => {
            const p = products.find(x => x.id === id);
            if (action === "edit-product") openProductModal(p);
            if (action === "delete-product") confirmDeleteProduct(id);
          });
        });
    }

    function renderLowStockPanel() {
      if (!lowStockPanel) return;
      const low = products.filter(p => {
        const stock = Number(p.stock || 0);
        const threshold = p.lowStockThreshold != null
          ? Number(p.lowStockThreshold)
          : 5;
        return stock <= threshold;
      });
      if (!low.length) {
        lowStockPanel.style.display = "none";
        return;
      }
      lowStockPanel.style.display = "block";
      lowStockTitle.textContent = `Low stock alerts (${low.length})`;
      lowStockList.innerHTML = low.map(p => {
        const s = Number(p.stock || 0);
        return `<div>• ${p.name || "Unnamed product"} — <span class="low-stock">${s}</span> left</div>`;
      }).join("");
    }

    function openProductModal(product) {
      const isEdit = !!product;
      const title = isEdit ? "Edit product" : "Add product";

      const vName  = Array.isArray(product?.variants) && product.variants[0]?.name
        ? product.variants[0].name
        : "";
      const vLabels = Array.isArray(product?.variants) && product.variants[0]?.labels
        ? product.variants[0].labels.join(", ")
        : "";

      openModal(`
        <div class="modal-title">${title}</div>
        <form id="product-form">
          <div class="field">
            <div class="field-label">Name</div>
            <input id="prod-name" class="field-input" required value="${product?.name || ""}"/>
          </div>
          <div class="field">
            <div class="field-label">Price</div>
            <input id="prod-price" class="field-input" type="number" min="0" step="0.01" required value="${product?.price ?? ""}"/>
          </div>
          <div class="field">
            <div class="field-label">Stock</div>
            <input id="prod-stock" class="field-input" type="number" min="0" step="1" required value="${product?.stock ?? 0}"/>
          </div>
          <div class="field">
            <div class="field-label">SKU (auto if left empty)</div>
            <input id="prod-sku" class="field-input" value="${product?.sku || ""}"/>
          </div>
          <div class="field">
            <div class="field-label">Code (optional)</div>
            <input id="prod-code" class="field-input" value="${product?.code || ""}"/>
          </div>
          <div class="field">
            <div class="field-label">Variants (optional)</div>
            <div class="field-hint">Example: Name = Size, Options = S,M,L</div>
            <input id="prod-variant-name" class="field-input" placeholder="Group name (e.g. Size)" value="${vName}"/>
            <input id="prod-variant-labels" class="field-input" placeholder="Comma separated options" value="${vLabels}"/>
          </div>
          <div class="field">
            <div class="field-label">Product image</div>
            <input id="prod-image" class="field-input" type="file" accept="image/*"/>
            <div class="field-hint">Will be stored under brands/${brandId || "brandId"}/products/{productId}/main.jpg</div>
          </div>
          <div class="field">
            <label style="font-size:12px;">
              <input id="prod-active" type="checkbox" ${product?.isActive === false ? "" : "checked"}/> Active
            </label>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-ghost" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">${isEdit ? "Save changes" : "Create product"}</button>
          </div>
        </form>
      `);

      const form = qs("#product-form");
      const fileInput = qs("#prod-image");

      form.addEventListener("submit", async e => {
        e.preventDefault();
        if (!brandId) return;

        const name  = qs("#prod-name").value.trim();
        const price = Number(qs("#prod-price").value || 0);
        const stock = Number(qs("#prod-stock").value || 0);
        let sku     = qs("#prod-sku").value.trim();
        const code  = qs("#prod-code").value.trim() || null;
        const vNameVal = qs("#prod-variant-name").value.trim();
        const vLabelsVal = qs("#prod-variant-labels").value.trim();
        const isActive = qs("#prod-active").checked;

        if (!name) {
          alert("Enter product name.");
          return;
        }
        if (!price && price !== 0) {
          alert("Enter product price.");
          return;
        }

        if (!sku) {
          sku = generateSku();
        }

        const variants = [];
        if (vNameVal && vLabelsVal) {
          const labelsArr = vLabelsVal
            .split(",")
            .map(x => x.trim())
            .filter(Boolean);
          if (labelsArr.length) {
            variants.push({ name: vNameVal, labels: labelsArr });
          }
        }

        const baseData = {
          name,
          price,
          stock,
          sku,
          code,
          variants,
          isActive,
          updatedAt: serverTimestamp()
        };

        const prodsRef = collection(doc(db, "brands", brandId), "products");

        try {
          if (product) {
            const prodRef = doc(prodsRef, product.id);
            await updateDoc(prodRef, baseData);

            if (fileInput && fileInput.files[0]) {
              const path = `brands/${brandId}/products/${product.id}/main.jpg`;
              const url = await uploadFileToStorage(fileInput.files[0], path);
              await updateDoc(prodRef, { imageUrl: url });
            }
          } else {
            const newRef = await addDoc(prodsRef, {
              ...baseData,
              createdAt: serverTimestamp()
            });
            if (fileInput && fileInput.files[0]) {
              const path = `brands/${brandId}/products/${newRef.id}/main.jpg`;
              const url = await uploadFileToStorage(fileInput.files[0], path);
              await updateDoc(newRef, { imageUrl: url });
            }
          }

          await loadProducts();
          closeModal();
        } catch (err) {
          console.error("Error saving product", err);
          alert("Failed to save product. Try again.");
        }
      });
    }

    async function confirmDeleteProduct(productId) {
      if (!brandId || !productId) return;
      if (!confirm("Delete this product?")) return;
      const refProd = doc(collection(doc(db, "brands", brandId), "products"), productId);
      try {
        await updateDoc(refProd, { isActive: false });
        await loadProducts();
      } catch (err) {
        console.error("Error deleting product", err);
        alert("Failed to delete product.");
      }
    }

    /* ------------------------------
       LOAD STAFF
    ------------------------------ */
    async function loadStaff() {
      staff = [];
      if (!brandId) return;
      const snap = await getDocs(collection(doc(db, "brands", brandId), "staff"));
      staff = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderStaff();
    }

    function renderStaff() {
      if (!staffTableWrapper) return;
      const search = (staffSearchInput?.value || "").toLowerCase();

      let list = staff.slice();
      if (search) {
        list = list.filter(s => {
          const sText = `${s.name || ""} ${s.username || ""}`.toLowerCase();
          return sText.includes(search);
        });
      }

      if (!list.length) {
        staffTableWrapper.innerHTML =
          `<div class="table-empty">No staff yet. Add your first POS user.</div>`;
        return;
      }

      const rows = list.map(s => {
        const role = s.role || "cashier";
        const active = s.isActive === false ? "Inactive" : "Active";
        return `
          <tr>
            <td>${s.name || "-"}</td>
            <td>${s.username || "-"}</td>
            <td>${role}</td>
            <td>${active}</td>
            <td>
              <button class="btn btn-ghost btn-xs" data-action="edit-staff" data-id="${s.id}">Edit</button>
              <button class="btn btn-danger btn-xs" data-action="delete-staff" data-id="${s.id}">Delete</button>
            </td>
          </tr>
        `;
      }).join("");

      staffTableWrapper.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Username</th>
              <th>Role</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      staffTableWrapper
        .querySelectorAll("button[data-action]")
        .forEach(btn => {
          const id = btn.getAttribute("data-id");
          const action = btn.getAttribute("data-action");
          btn.addEventListener("click", () => {
            const user = staff.find(x => x.id === id);
            if (action === "edit-staff") openStaffModal(user);
            if (action === "delete-staff") confirmDeleteStaff(id);
          });
        });
    }

    function openStaffModal(user) {
      const isEdit = !!user;
      const title = isEdit ? "Edit POS user" : "Add POS user";

      openModal(`
        <div class="modal-title">${title}</div>
        <form id="staff-form">
          <div class="field">
            <div class="field-label">Name</div>
            <input id="staff-name" class="field-input" required value="${user?.name || ""}"/>
          </div>
          <div class="field">
            <div class="field-label">Username</div>
            <input id="staff-username" class="field-input" required value="${user?.username || ""}"/>
          </div>
          <div class="field">
            <div class="field-label">PIN</div>
            <input id="staff-pin" class="field-input" placeholder="POS PIN" value="${user?.pin || ""}"/>
          </div>
          <div class="field">
            <div class="field-label">Role</div>
            <select id="staff-role" class="field-input">
              <option value="cashier" ${user?.role === "cashier" ? "selected" : ""}>Cashier</option>
              <option value="staff" ${user?.role === "staff" ? "selected" : ""}>Staff</option>
              <option value="brand_owner" ${user?.role === "brand_owner" ? "selected" : ""}>Brand owner</option>
            </select>
          </div>
          <div class="field">
            <label style="font-size:12px;">
              <input id="staff-active" type="checkbox" ${user?.isActive === false ? "" : "checked"}/> Active
            </label>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-ghost" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">${isEdit ? "Save changes" : "Create user"}</button>
          </div>
        </form>
      `);

      const form = qs("#staff-form");
      form.addEventListener("submit", async e => {
        e.preventDefault();
        if (!brandId) return;

        const name     = qs("#staff-name").value.trim();
        const username = qs("#staff-username").value.trim();
        const pin      = qs("#staff-pin").value.trim();
        const role     = qs("#staff-role").value || "cashier";
        const isActive = qs("#staff-active").checked;

        if (!name || !username) {
          alert("Enter name and username.");
          return;
        }

        const data = {
          name,
          username,
          pin: pin || null,
          role,
          isActive,
          eventId: currentEventId || null,
          updatedAt: serverTimestamp()
        };

        const staffRef = collection(doc(db, "brands", brandId), "staff");
        try {
          if (user) {
            await updateDoc(doc(staffRef, user.id), data);
          } else {
            await addDoc(staffRef, {
              ...data,
              createdAt: serverTimestamp()
            });
          }
          await loadStaff();
          closeModal();
        } catch (err) {
          console.error("Error saving staff", err);
          alert("Failed to save staff user.");
        }
      });
    }

    async function confirmDeleteStaff(id) {
      if (!brandId || !id) return;
      if (!confirm("Delete this POS user?")) return;
      const staffRef = collection(doc(db, "brands", brandId), "staff");
      try {
        await updateDoc(doc(staffRef, id), { isActive: false });
        await loadStaff();
      } catch (err) {
        console.error("Error deleting staff", err);
        alert("Failed to delete staff user.");
      }
    }

    /* ------------------------------
       LOAD ORDERS (brands/{brandId}/orders)
    ------------------------------ */
    async function loadOrders() {
      orders = [];
      if (!brandId) return;
      const ordersRef = collection(doc(db, "brands", brandId), "orders");
      const snap = await getDocs(ordersRef);
      orders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      computeAnalyticsFromOrders();
      renderOrders();
      renderRecentOrders();
      rebuildCustomersFromOrders();
      renderCustomers();
    }

    function computeAnalyticsFromOrders() {
      const today = todayKey();
      let todayNet = 0;
      let todaySalesCount = 0;
      let todayReturnsCount = 0;

      let totalNet = 0;
      let totalCount = 0;
      const uniqueCustomersSet = new Set();

      for (const o of orders) {
        const total = Number(o.total || 0);
        const isReturn = !!o.isReturn || o.type === "return";
        const dKey = getOrderDateKey(o);
        const sign = isReturn ? -1 : 1;
        const netVal = Math.abs(total) * sign;

        totalNet += netVal;
        totalCount += 1;

        if (dKey === today) {
          todayNet += netVal;
          if (isReturn) todayReturnsCount += 1;
          else todaySalesCount += 1;
        }

        const custKey =
          o.customerId ||
          o.customerEmail ||
          o.customerPhone ||
          (o.customerName && o.customerName.toLowerCase()) ||
          null;
        if (custKey) uniqueCustomersSet.add(custKey);
      }

      if (effectiveStatus !== "approved") {
        // still show numbers but they might be "preview"
      }

      if (dashSalesTodayEl)   dashSalesTodayEl.textContent   = money(todayNet);
      if (dashOrdersTodayEl)  dashOrdersTodayEl.textContent  = String(todaySalesCount);
      if (dashReturnsTodayEl) dashReturnsTodayEl.textContent = String(todayReturnsCount);
      if (dashUniqueCustEl)   dashUniqueCustEl.textContent   = String(uniqueCustomersSet.size);

      if (ordersTotalSalesEl) ordersTotalSalesEl.textContent = money(totalNet);
      if (ordersTotalCountEl) ordersTotalCountEl.textContent = String(totalCount);
    }

    function renderRecentOrders() {
      if (!recentOrdersWrapper) return;

      if (!orders.length) {
        recentOrdersWrapper.innerHTML =
          `<div class="table-empty">No orders yet.</div>`;
        return;
      }

      const list = orders.slice().sort((a,b) => {
        const da = getOrderCreatedAt(a);
        const db = getOrderCreatedAt(b);
        const ta = da ? da.getTime() : 0;
        const tb = db ? db.getTime() : 0;
        return tb - ta;
      }).slice(0, 10);

      const rows = list.map(o => {
        const d = getOrderCreatedAt(o);
        const dateStr = d ? d.toLocaleString() : getOrderDateKey(o) || "-";
        const isReturn = !!o.isReturn || o.type === "return";
        const typeLabel = isReturn ? "Return" : "Sale";
        return `
          <tr>
            <td>${o.orderId || o.id}</td>
            <td>${dateStr}</td>
            <td>${typeLabel}</td>
            <td>${money(o.total)}</td>
            <td><button class="btn btn-ghost btn-xs" data-open-order="${o.id}">Open</button></td>
          </tr>
        `;
      }).join("");

      recentOrdersWrapper.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Order</th>
              <th>Created at</th>
              <th>Type</th>
              <th>Total</th>
              <th></th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      recentOrdersWrapper
        .querySelectorAll("button[data-open-order]")
        .forEach(btn => {
          const id = btn.getAttribute("data-open-order");
          btn.addEventListener("click", () => {
            const o = orders.find(x => x.id === id);
            if (o) openOrderModal(o);
          });
        });
    }

    function renderOrders() {
      if (!ordersTableWrapper) return;

      if (!orders.length) {
        ordersTableWrapper.innerHTML =
          `<div class="table-empty">No orders yet.</div>`;
        return;
      }

      const search = (ordersSearchInput?.value || "").toLowerCase();
      const typeFilter = ordersFilterTypeSel?.value || "all";
      const payFilter  = ordersFilterPaySel?.value || "all";
      const sort       = ordersSortSelect?.value || "date-desc";

      let list = orders.slice();

      if (search) {
        list = list.filter(o => {
          const s = `${o.orderId || o.id || ""} ${o.customerName || ""}`.toLowerCase();
          return s.includes(search);
        });
      }

      if (typeFilter !== "all") {
        list = list.filter(o => {
          const isReturn = !!o.isReturn || o.type === "return";
          if (typeFilter === "sale") return !isReturn;
          if (typeFilter === "return") return isReturn;
          return true;
        });
      }

      if (payFilter !== "all") {
        list = list.filter(o => {
          const pm = (o.paymentMethod || "").toLowerCase();
          if (payFilter === "cash") return pm.includes("cash");
          if (payFilter === "card") return pm.includes("card") || pm.includes("visa") || pm.includes("master");
          return true;
        });
      }

      list.sort((a,b) => {
        const ta = getOrderCreatedAt(a)?.getTime() || 0;
        const tb = getOrderCreatedAt(b)?.getTime() || 0;
        const totalA = Number(a.total || 0);
        const totalB = Number(b.total || 0);
        switch (sort) {
          case "date-asc":   return ta - tb;
          case "total-desc": return totalB - totalA;
          case "total-asc":  return totalA - totalB;
          case "date-desc":
          default:           return tb - ta;
        }
      });

      const rows = list.map(o => {
        const d = getOrderCreatedAt(o);
        const dateStr = d ? d.toLocaleString() : getOrderDateKey(o) || "-";
        const isReturn = !!o.isReturn || o.type === "return";
        const typeLabel = isReturn ? "Return" : "Sale";
        const customerName = o.customerName || o.customer?.name || "-";
        const paymentMethod = o.paymentMethod || "-";
        return `
          <tr>
            <td>${o.orderId || o.id}</td>
            <td>${dateStr}</td>
            <td>${typeLabel}</td>
            <td>${money(o.total)}</td>
            <td>${customerName}</td>
            <td>${paymentMethod}</td>
            <td>
              <button class="btn btn-ghost btn-xs" data-open-order="${o.id}">Open</button>
            </td>
          </tr>
        `;
      }).join("");

      ordersTableWrapper.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Order</th>
              <th>Date</th>
              <th>Type</th>
              <th>Total</th>
              <th>Customer</th>
              <th>Payment</th>
              <th></th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      ordersTableWrapper
        .querySelectorAll("button[data-open-order]")
        .forEach(btn => {
          const id = btn.getAttribute("data-open-order");
          btn.addEventListener("click", () => {
            const o = orders.find(x => x.id === id);
            if (o) openOrderModal(o);
          });
        });
    }

    function openOrderModal(order) {
      const items = Array.isArray(order.items) ? order.items : [];
      const rows = items.map(it => `
        <tr>
          <td>${it.name || "-"}</td>
          <td>${it.code || it.productId || "-"}</td>
          <td>${Number(it.qty || 0)}</td>
          <td>${money(it.price)}</td>
          <td>${money(it.lineTotal)}</td>
        </tr>
      `).join("");

      const isReturn = !!order.isReturn || order.type === "return";
      const typeLabel = isReturn ? "Return" : "Sale";

      openModal(`
        <div class="modal-title">Order ${order.orderId || order.id}</div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:8px;">
          Type: ${typeLabel} • Payment: ${order.paymentMethod || "-"}
        </div>
        <table style="width:100%;border-collapse:collapse;font-size:12px;margin-bottom:8px;">
          <thead>
            <tr>
              <th style="text-align:left;padding:4px 6px;border-bottom:1px solid var(--border);">Item</th>
              <th style="text-align:left;padding:4px 6px;border-bottom:1px solid var(--border);">Code</th>
              <th style="text-align:left;padding:4px 6px;border-bottom:1px solid var(--border);">Qty</th>
              <th style="text-align:left;padding:4px 6px;border-bottom:1px solid var(--border);">Price</th>
              <th style="text-align:left;padding:4px 6px;border-bottom:1px solid var(--border);">Line total</th>
            </tr>
          </thead>
          <tbody>
            ${rows || `<tr><td colspan="5" style="padding:6px;">No line items recorded.</td></tr>`}
          </tbody>
        </table>
        <div style="font-size:12px;margin-bottom:6px;">
          Subtotal: <strong>${money(order.subtotal)}</strong><br/>
          Discount: <strong>${money(order.discountAmount)}</strong><br/>
          Service: <strong>${money(order.serviceAmount)}</strong><br/>
          Tax: <strong>${money(order.taxAmount)}</strong><br/>
          Total: <strong>${money(order.total)}</strong>
        </div>
        <div style="font-size:11px;color:var(--muted);margin-bottom:6px;">
          Customer: ${order.customerName || "-"}${order.customerEmail ? " • " + order.customerEmail : ""}${order.customerPhone ? " • " + order.customerPhone : ""}
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-ghost" onclick="closeModal()">Close</button>
        </div>
      `);
    }

    /* ------------------------------
       CUSTOMERS from ORDERS
    ------------------------------ */
    function rebuildCustomersFromOrders() {
      const map = new Map();
      for (const o of orders) {
        const key =
          o.customerId ||
          o.customerEmail ||
          o.customerPhone ||
          (o.customerName && o.customerName.toLowerCase());
        if (!key) continue;

        const isReturn = !!o.isReturn || o.type === "return";
        const total = Number(o.total || 0);
        const val = isReturn ? -Math.abs(total) : Math.abs(total);

        if (!map.has(key)) {
          map.set(key, {
            id: key,
            name: o.customerName || "-",
            email: o.customerEmail || "",
            phone: o.customerPhone || "",
            ordersCount: 0,
            totalSpent: 0
          });
        }
        const c = map.get(key);
        c.ordersCount += 1;
        c.totalSpent += val;
      }
      customers = Array.from(map.values());
    }

    function renderCustomers() {
      if (!customersTableWrapper) return;

      const totalCustomers = customers.length;
      const totalRevenue = customers.reduce((sum,c) => sum + (c.totalSpent || 0), 0);

      if (customersTotalEl) customersTotalEl.textContent = String(totalCustomers);
      if (customersAvgSpendEl) {
        const avg = totalCustomers ? totalRevenue / totalCustomers : 0;
        customersAvgSpendEl.textContent = money(avg);
      }

      const search = (customersSearchInput?.value || "").toLowerCase();
      const sort   = customersSortSelect?.value || "spend-desc";

      let list = customers.slice();

      if (search) {
        list = list.filter(c => {
          const s = `${c.name || ""} ${c.email || ""} ${c.phone || ""}`.toLowerCase();
          return s.includes(search);
        });
      }

      list.sort((a,b) => {
        const spendA = Number(a.totalSpent || 0);
        const spendB = Number(b.totalSpent || 0);
        const ordA   = Number(a.ordersCount || 0);
        const ordB   = Number(b.ordersCount || 0);
        const nameA  = (a.name || "").toLowerCase();
        const nameB  = (b.name || "").toLowerCase();

        switch (sort) {
          case "spend-asc":  return spendA - spendB;
          case "orders-desc":return ordB - ordA;
          case "orders-asc": return ordA - ordB;
          case "name-asc":   return nameA.localeCompare(nameB);
          case "spend-desc":
          default:           return spendB - spendA;
        }
      });

      if (!list.length) {
        customersTableWrapper.innerHTML =
          `<div class="table-empty">No customers detected yet.</div>`;
        return;
      }

      const rows = list.map(c => `
        <tr>
          <td>${c.name || "-"}</td>
          <td>${c.email || "-"}</td>
          <td>${c.phone || "-"}</td>
          <td>${c.ordersCount || 0}</td>
          <td>${money(c.totalSpent)}</td>
        </tr>
      `).join("");

      customersTableWrapper.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Orders</th>
              <th>Total spent</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    /* ------------------------------
       SETTINGS SAVE
    ------------------------------ */
    async function saveSettings() {
      if (!brandId) return;
      const name    = settingsBrandNameEl?.value.trim() || brandData?.name || "Brand";
      const country = settingsBrandCountryEl?.value.trim() || "";

      const upd = { name, country };
      const logoFile = settingsBrandLogoEl?.files?.[0] || null;

      const brandRef = doc(db, "brands", brandId);

      try {
        if (logoFile) {
          const path = `brands/${brandId}/branding/logo.jpg`;
          const url = await uploadFileToStorage(logoFile, path);
          upd.logoUrl = url;
        }
        await updateDoc(brandRef, upd);
        await loadBrandAndStatus();
        alert("Settings saved.");
      } catch (err) {
        console.error("Error saving settings", err);
        alert("Failed to save settings.");
      }
    }

    /* ------------------------------
       AUTH: LOGIN + CREATE BRAND
    ------------------------------ */
    function switchAuthTab(tab) {
      if (!loginForm || !createForm || !tabLogin || !tabCreate) return;
      if (tab === "login") {
        tabLogin.classList.add("active");
        tabCreate.classList.remove("active");
        loginForm.style.display  = "block";
        createForm.style.display = "none";
      } else {
        tabLogin.classList.remove("active");
        tabCreate.classList.add("active");
        loginForm.style.display  = "none";
        createForm.style.display = "block";
      }
    }

    if (tabLogin) {
      tabLogin.addEventListener("click", () => switchAuthTab("login"));
    }
    if (tabCreate) {
      tabCreate.addEventListener("click", () => switchAuthTab("create"));
    }

    if (loginForm) {
      loginForm.addEventListener("submit", async e => {
        e.preventDefault();
        setAuthAlert("");
        const email = qs("#login-email")?.value.trim();
        const pass  = qs("#login-password")?.value;
        if (!email || !pass) {
          setAuthAlert("Enter email and password.");
          return;
        }
        try {
          await signInWithEmailAndPassword(auth, email, pass);
        } catch (err) {
          console.error("Login error", err);
          let msg = "Login failed.";
          if (err.code === "auth/user-not-found") msg = "User not found.";
          if (err.code === "auth/wrong-password") msg = "Wrong password.";
          setAuthAlert(msg);
        }
      });
    }

    if (createForm) {
      createForm.addEventListener("submit", async e => {
        e.preventDefault();
        setAuthAlert("");

        const brandName   = qs("#create-brand-name")?.value.trim();
        const country     = qs("#create-brand-country")?.value.trim();
        const ownerName   = qs("#create-owner-name")?.value.trim();
        const email       = qs("#create-owner-email")?.value.trim();
        const password    = qs("#create-owner-password")?.value;

        if (!brandName || !ownerName || !email || !password) {
          setAuthAlert("Fill all required fields.");
          return;
        }
        if (password.length < 6) {
          setAuthAlert("Password must be at least 6 characters.");
          return;
        }

        try {
          isCreatingBrand = true;
          const cred = await createUserWithEmailAndPassword(auth, email, password);
          const user = cred.user;
          await updateProfile(user, { displayName: ownerName });

          // brand
          const brandRef = await addDoc(collection(db, "brands"), {
            name: brandName,
            country: country || "",
            ownerUserId: user.uid,
            ownerEmail: email,
            status: "pending",
            eventId: urlEventId || null,
            eventName: currentEventName || null,
            createdAt: serverTimestamp()
          });

          // userBrands
          await setDoc(doc(db, "userBrands", user.uid), {
            primaryBrandId: brandRef.id,
            brandIds: [brandRef.id]
          });

          // users
          await setDoc(doc(db, "users", user.uid), {
            uid: user.uid,
            name: ownerName,
            email,
            primaryBrandId: brandRef.id,
            role: "brand_owner",
            createdAt: serverTimestamp()
          });

          // vendor doc (optional, if eventId provided) -> pending
          if (urlEventId) {
            await addDoc(collection(doc(db, "events", urlEventId), "vendors"), {
              brandId: brandRef.id,
              brandName,
              status: "pending",
              ownerEmail: email,
              createdAt: serverTimestamp()
            });
          }

          // from here, auth state listener will continue
        } catch (err) {
          console.error("Create brand error", err);
          let msg = "Failed to create brand.";
          if (err.code === "auth/email-already-in-use") {
            msg = "Email already in use.";
          }
          setAuthAlert(msg);
        } finally {
          isCreatingBrand = false;
        }
      });
    }

    /* ------------------------------
       AUTH STATE
    ------------------------------ */
    onAuthStateChanged(auth, async user => {
      currentUser = user || null;

      if (!user) {
        brandId = null;
        brandData = null;
        vendorData = null;
        orders = [];
        products = [];
        staff = [];
        customers = [];
        showAuthView();
        return;
      }

      if (isCreatingBrand) {
        // let create flow finish, then this will run again
        return;
      }

      try {
        // read userBrands/{uid} to get primaryBrandId
        const ubSnap = await getDoc(doc(db, "userBrands", user.uid));
        if (!ubSnap.exists()) {
          setAuthAlert("No brand linked to this account yet. Use 'Create brand' to get started.");
          showAuthView();
          return;
        }
        const ub = ubSnap.data();
        brandId = ub.primaryBrandId || (Array.isArray(ub.brandIds) ? ub.brandIds[0] : null);
        if (!brandId) {
          setAuthAlert("No brand found for your account.");
          showAuthView();
          return;
        }

        await loadBrandAndStatus();
        await loadProducts();
        await loadStaff();
        await loadOrders();

        showAppView();
      } catch (err) {
        console.error("Error loading dashboard", err);
        setAuthAlert("Error loading your brand dashboard. Contact support.");
        showAuthView();
      }
    });

    /* ------------------------------
       NAV + FILTER HANDLERS
    ------------------------------ */
    navButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const pageId = btn.getAttribute("data-page");
        if (pageId) applyNav(pageId);
      });
    });

    if (btnLogout) {
      btnLogout.addEventListener("click", async () => {
        await signOut(auth);
      });
    }
    if (btnRejectedLogout) {
      btnRejectedLogout.addEventListener("click", async () => {
        await signOut(auth);
      });
    }

    if (btnCopyPosLink && posLinkUrlEl) {
      btnCopyPosLink.addEventListener("click", async () => {
        const text = posLinkUrlEl.textContent || "";
        try {
          await navigator.clipboard.writeText(text);
          posStatusHintEl.textContent = "POS link copied.";
        } catch {
          alert("Copy failed. You can copy the link manually.");
        }
      });
    }

    if (productsSearchInput) {
      productsSearchInput.addEventListener("input", renderProducts);
    }
    if (productsSortSelect) {
      productsSortSelect.addEventListener("change", renderProducts);
    }
    if (btnAddProduct) {
      btnAddProduct.addEventListener("click", () => openProductModal(null));
    }

    if (staffSearchInput) {
      staffSearchInput.addEventListener("input", renderStaff);
    }
    if (btnAddStaff) {
      btnAddStaff.addEventListener("click", () => openStaffModal(null));
    }

    if (customersSearchInput) {
      customersSearchInput.addEventListener("input", renderCustomers);
    }
    if (customersSortSelect) {
      customersSortSelect.addEventListener("change", renderCustomers);
    }

    if (ordersSearchInput) {
      ordersSearchInput.addEventListener("input", renderOrders);
    }
    if (ordersFilterTypeSel) {
      ordersFilterTypeSel.addEventListener("change", renderOrders);
    }
    if (ordersFilterPaySel) {
      ordersFilterPaySel.addEventListener("change", renderOrders);
    }
    if (ordersSortSelect) {
      ordersSortSelect.addEventListener("change", renderOrders);
    }

    if (btnSaveSettings) {
      btnSaveSettings.addEventListener("click", saveSettings);
    }
  </script>
</body>
</html>

