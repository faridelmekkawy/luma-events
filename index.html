<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Luma Events — Owner Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#f3f4f6;
      --panel:#ffffff;
      --panel-soft:#f9fafb;
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#2563eb;
      --accent-soft:#dbeafe;
      --accent-strong:#1d4ed8;
      --ok:#16a34a;
      --danger:#ef4444;
      --radius:16px;
      --shadow:0 18px 40px rgba(15,23,42,.12);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      font-family:"Montserrat",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--ink);
    }

    /* AUTH WRAPPER (same vibe as brand portal) */
    .auth-wrapper{
      width:100%;
      max-width:460px;
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(148,163,184,.3);
      padding:18px;
      margin:40px auto;
    }
    .auth-header{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
    }
    .auth-logo{
      width:38px;height:38px;border-radius:999px;
      background:linear-gradient(135deg,#2563eb,#a855f7);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;font-size:18px;
      overflow:hidden;
      background-size:cover;
      background-position:center;
    }
    .auth-title{font-size:17px;font-weight:700;}
    .auth-subtitle{font-size:11px;color:var(--muted);margin-top:2px;}

    .auth-tabs{
      display:flex;gap:6px;margin:10px 0 12px;
    }
    .auth-tab{
      flex:1;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--panel-soft);
      color:var(--muted);
      font-size:12px;
      cursor:pointer;
      text-align:center;
    }
    .auth-tab.active{
      background:var(--accent-soft);
      border-color:var(--accent-soft);
      color:var(--accent-strong);
      font-weight:600;
    }
    .auth-alert{
      padding:8px 10px;
      border-radius:10px;
      font-size:11px;
      margin-bottom:10px;
    }
    .auth-alert-error{background:#fef2f2;color:#b91c1c;border:1px solid #fecaca;}
    .auth-alert-info{background:#eff6ff;color:#1d4ed8;border:1px solid #bfdbfe;}

    .field{margin-bottom:10px;}
    .field-label{font-size:11px;margin-bottom:4px;color:#4b5563;}
    .field-input,.field-select{
      width:100%;padding:8px;border-radius:9px;
      border:1px solid var(--border);background:#f9fafb;font-size:12px;
    }
    .field-input:focus,.field-select:focus{
      outline:none;border-color:var(--accent);box-shadow:0 0 0 1px var(--accent-soft);
    }
    .field-hint{font-size:10px;color:var(--muted);margin-top:3px;}

    .btn{
      border:none;border-radius:999px;
      padding:8px 12px;font-size:12px;font-weight:600;
      cursor:pointer;display:inline-flex;align-items:center;justify-content:center;
      gap:6px;
    }
    .btn-primary{background:var(--accent);color:#fff;}
    .btn-primary:hover{background:var(--accent-strong);}
    .btn-ghost{
      background:transparent;color:var(--accent-strong);
      border:1px solid var(--accent-soft);
    }
    .btn-ghost:hover{background:var(--accent-soft);}
    .btn-danger{background:var(--danger);color:#fff;}
    .btn-danger:hover{background:#b91c1c;}

    .auth-footer{text-align:center;margin-top:8px;font-size:10px;color:var(--muted);}

    /* APP LAYOUT (same style as brand) */
    .app-shell{
      display:none;
      height:100vh;width:100%;
    }
    .sidebar{
      width:220px;background:var(--panel);
      border-right:1px solid var(--border);
      display:flex;flex-direction:column;
      padding:20px 12px;
    }
    .sidebar-brand{
      display:flex;align-items:center;gap:10px;margin-bottom:18px;
    }
    .sidebar-logo{
      width:36px;height:36px;border-radius:999px;
      background:linear-gradient(135deg,#2563eb,#a855f7);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;
      overflow:hidden;
      background-size:cover;
      background-position:center;
    }
    .sidebar-brand-name{font-size:15px;font-weight:700;}
    .sidebar-nav{
      display:flex;flex-direction:column;gap:6px;margin-top:10px;flex:1;
    }
    .nav-item{
      padding:9px 12px;border-radius:10px;
      cursor:pointer;font-size:13px;
      border:none;background:transparent;text-align:left;color:var(--ink);
    }
    .nav-item:hover{background:var(--panel-soft);}
    .nav-item.active{background:var(--accent-soft);color:var(--accent-strong);font-weight:600;}
    .nav-item.logout{
      margin-top:auto;
      background:#fee2e2;
      color:#b91c1c;
      border:1px solid #fecaca;
    }
    .nav-item.logout:hover{background:#fecaca;}

    .topbar{
      height:70px;background:var(--panel);
      border-bottom:1px solid var(--border);
      padding:12px 18px;
      display:flex;justify-content:space-between;align-items:center;
    }
    .topbar-title{font-size:16px;font-weight:700;}
    .topbar-sub{font-size:11px;color:var(--muted);}
    .topbar-filter{display:flex;align-items:center;gap:10px;font-size:12px;}
    .topbar-filter select{
      padding:6px 9px;border-radius:8px;
      border:1px solid var(--border);background:var(--panel-soft);
    }

    .content-area{flex:1;padding:20px;overflow-y:auto;background:var(--bg);}
    .page{display:none;}
    .page.active{display:block;}
    .page-header{
      display:flex;justify-content:space-between;
      align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:10px;
    }
    .page-title{font-size:18px;font-weight:700;}
    .page-sub{font-size:12px;color:var(--muted);}
    .page-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}

    .cards-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:12px;margin-bottom:22px;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:18px;
      box-shadow:var(--shadow);
    }
    .card-title{font-size:13px;color:var(--muted);margin-bottom:4px;}
    .card-number{font-size:20px;font-weight:700;}
    .card-note{font-size:11px;color:var(--muted);margin-top:6px;}

    .table-wrapper{
      background:#fff;border-radius:12px;border:1px solid var(--border);
      overflow-x:auto;
    }
    table{width:100%;border-collapse:collapse;font-size:12px;}
    thead{background:var(--panel-soft);}
    th,td{padding:9px 10px;border-bottom:1px solid var(--border);text-align:left;}
    th{
      font-size:11px;text-transform:uppercase;color:var(--muted);
      letter-spacing:.04em;
    }
    tbody tr:hover{background:#f9fafb;}
    .table-empty{text-align:center;padding:20px;font-size:12px;color:var(--muted);}

    /* MODAL */
    #modal-container{
      position:fixed;inset:0;
      display:none;justify-content:center;align-items:center;
      background:rgba(0,0,0,.35);z-index:9999;
    }
    .modal{
      background:var(--panel);
      width:100%;max-width:520px;
      border-radius:16px;
      padding:18px;
      box-shadow:var(--shadow);
    }
    .modal-title{font-size:16px;font-weight:700;margin-bottom:14px;}
    .modal-actions{margin-top:16px;display:flex;justify-content:flex-end;gap:8px;}

    @media(max-width:768px){
      .app-shell{flex-direction:column;}
      .sidebar{width:100%;flex-direction:row;overflow-x:auto;height:auto;}
      .sidebar-nav{flex-direction:row;}
      .topbar{flex-direction:column;align-items:flex-start;gap:8px;height:auto;}
    }
  </style>
</head>
<body>

  <!-- AUTH VIEW: Sign in / Sign up for event owner -->
  <div id="auth-view" class="auth-wrapper">
    <div class="auth-header">
      <div class="auth-logo">E</div>
      <div>
        <div class="auth-title">Luma Events — Owner Portal</div>
        <div id="auth-subtitle" class="auth-subtitle">
          Sign in to manage your events or create a new event.
        </div>
      </div>
    </div>

    <div id="auth-alert-container"></div>

    <div class="auth-tabs">
      <button type="button" id="tab-login" class="auth-tab active">Sign in</button>
      <button type="button" id="tab-signup" class="auth-tab">Create account &amp; event</button>
    </div>

    <!-- LOGIN FORM -->
    <form id="login-form">
      <div class="field">
        <div class="field-label">Email</div>
        <input id="login-email" class="field-input" type="email" placeholder="you@example.com"/>
      </div>
      <div class="field">
        <div class="field-label">Password</div>
        <input id="login-password" class="field-input" type="password" placeholder="Your password"/>
      </div>
      <button type="submit" id="login-btn" class="btn btn-primary" style="width:100%;">Sign in</button>
    </form>

    <!-- SIGNUP FORM (creates owner + first event) -->
    <form id="signup-form" style="display:none;">
      <div class="field">
        <div class="field-label">Your name</div>
        <input id="signup-name" class="field-input" placeholder="Full name"/>
      </div>
      <div class="field">
        <div class="field-label">Email</div>
        <input id="signup-email" class="field-input" type="email" placeholder="you@example.com"/>
      </div>
      <div class="field">
        <div class="field-label">Password</div>
        <input id="signup-password" class="field-input" type="password" placeholder="Minimum 6 characters"/>
      </div>

      <div class="field">
        <div class="field-label">Event name</div>
        <input id="signup-event-name" class="field-input" placeholder="Lokamania 5, Soueast Owners, ..."/>
      </div>
      <div class="field">
        <div class="field-label">Event location</div>
        <input id="signup-event-location" class="field-input" placeholder="Cairo Festival City, Dubai, ..."/>
      </div>
      <div class="field">
        <div class="field-label">Event date</div>
        <input id="signup-event-date" class="field-input" type="date"/>
      </div>

      <button type="submit" id="signup-btn" class="btn btn-primary" style="width:100%;">Create account &amp; event</button>
      <div class="field-hint" style="margin-top:6px;">
        This will create your owner account, first event document, and link everything automatically in Firestore.
      </div>
    </form>

    <div class="auth-footer">
      Once signed in, you’ll see your events dashboard, vendors, stalls & POS links.
    </div>
  </div>

  <!-- APP VIEW -->
  <div id="app-view" class="app-shell">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-brand">
        <div id="sidebar-event-logo" class="sidebar-logo">E</div>
        <div id="sidebar-event-name" class="sidebar-brand-name">Event</div>
      </div>
      <nav class="sidebar-nav">
        <button class="nav-item active" data-page="page-overview">Overview</button>
        <button class="nav-item" data-page="page-vendors">Vendors</button>
        <button class="nav-item" data-page="page-stalls">Stalls &amp; Layout</button>
        <button class="nav-item" data-page="page-orders">Sales &amp; POS</button>
        <button class="nav-item" data-page="page-settings">Event Settings</button>
      </nav>
      <button id="btn-logout" class="nav-item logout">Logout</button>
    </aside>

    <!-- MAIN -->
    <div style="flex:1;display:flex;flex-direction:column;">
      <header class="topbar">
        <div>
          <div id="topbar-title" class="topbar-title">Event Overview</div>
          <div id="topbar-sub" class="topbar-sub">Monitor vendors, stalls, and live sales</div>
        </div>
        <div class="topbar-filter">
          <span>Event:</span>
          <select id="event-select">
            <!-- filled by JS with owner’s events -->
          </select>
        </div>
      </header>

      <main class="content-area">
        <!-- OVERVIEW PAGE -->
        <section id="page-overview" class="page active">
          <div class="cards-grid">
            <div class="card">
              <div class="card-title">Vendors</div>
              <div id="kpi-vendors" class="card-number">0</div>
              <div class="card-note">Total approved vendors for this event.</div>
            </div>
            <div class="card">
              <div class="card-title">Stalls</div>
              <div id="kpi-stalls" class="card-number">0</div>
              <div class="card-note">Total stalls (assigned + empty).</div>
            </div>
            <div class="card">
              <div class="card-title">Live Sales (Today)</div>
              <div id="kpi-sales-today" class="card-number">0</div>
              <div class="card-note">Sum of all vendors’ POS totals today.</div>
            </div>
            <div class="card">
              <div class="card-title">Tickets Checked-in</div>
              <div id="kpi-checkins" class="card-number">0</div>
              <div class="card-note">QR check-ins from Luma Tickets.</div>
            </div>
          </div>

          <div class="page-header" style="margin-top:4px;">
            <div>
              <div class="page-title" style="font-size:15px;">Recent Vendor Sales</div>
              <div class="page-sub">Last 10 orders from all event vendors.</div>
            </div>
            <div class="page-actions">
              <button id="btn-copy-vendor-link" class="btn btn-ghost">Copy vendor signup link</button>
            </div>
          </div>
          <div id="table-recent-orders" class="table-wrapper"></div>
        </section>

        <!-- VENDORS PAGE -->
        <section id="page-vendors" class="page">
          <div class="page-header">
            <div>
              <div class="page-title">Vendors</div>
              <div class="page-sub">Manage vendor signup, approvals & POS access</div>
            </div>
            <div class="page-actions">
              <button id="btn-open-manual-vendor" class="btn btn-primary">Add vendor manually</button>
              <button id="btn-copy-vendor-link-2" class="btn btn-ghost">Copy vendor signup link</button>
            </div>
          </div>
          <div id="vendors-analytics" class="cards-grid" style="margin-top:4px;"></div>
          <div class="table-wrapper" id="vendors-table"></div>
        </section>

        <!-- STALLS PAGE -->
        <section id="page-stalls" class="page">
          <div class="page-header">
            <div>
              <div class="page-title">Stalls &amp; Layout</div>
              <div class="page-sub">Assign stalls to vendors and track occupancy</div>
            </div>
            <div class="page-actions">
              <button id="btn-add-stall" class="btn btn-primary">Add stall</button>
            </div>
          </div>
          <div id="stalls-analytics" class="cards-grid" style="margin-top:4px;"></div>
          <div class="table-wrapper" id="stalls-table"></div>
        </section>

        <!-- ORDERS / SALES -->
        <section id="page-orders" class="page">
          <div class="page-header">
            <div>
              <div class="page-title">Sales &amp; POS</div>
              <div class="page-sub">Track per-vendor POS sales for this event</div>
            </div>
            <div class="page-actions">
              <button id="btn-export-orders" class="btn btn-ghost">Export CSV</button>
            </div>
          </div>
          <div id="orders-analytics" class="cards-grid" style="margin-top:4px;"></div>
          <div class="table-wrapper" id="orders-table"></div>
        </section>

        <!-- SETTINGS -->
        <section id="page-settings" class="page">
          <div class="page-header">
            <div>
              <div class="page-title">Event Settings</div>
              <div class="page-sub">Edit event name, dates & basic settings</div>
            </div>
          </div>
          <div class="cards-grid">
            <div class="card">
              <div class="field">
                <div class="field-label">Event name</div>
                <input id="set-event-name" class="field-input"/>
              </div>
              <div class="field">
                <div class="field-label">Location</div>
                <input id="set-event-location" class="field-input"/>
              </div>
              <div class="field">
                <div class="field-label">Date</div>
                <input id="set-event-date" class="field-input" type="date"/>
              </div>
              <button id="btn-save-event" class="btn btn-primary" style="margin-top:6px;">Save</button>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- MODALS -->
  <div id="modal-container"></div>

  <!-- JS (Firebase + logic) will go here in Part 2 -->
<script type="module">
  // -----------------------------
  // FIREBASE IMPORTS + CONFIG
  // -----------------------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore,
    doc,
    collection,
    addDoc,
    setDoc,
    getDoc,
    getDocs,
    updateDoc,
    deleteDoc,
    query,
    where,
    orderBy,
    limit,
    serverTimestamp,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  import {
    getAuth,
    onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    updateProfile,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA80bAAGPuyscnTVS-zwrxE9Jp3tPiS1gM",
    authDomain: "events-339ce.firebaseapp.com",
    projectId: "events-339ce",
    storageBucket: "events-339ce.firebasestorage.app",
    messagingSenderId: "175601544315",
    appId: "1:175601544315:web:00c94b4affa972b3a286de"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // -----------------------------
  // CONFIG — CHANGE ONLY THIS
  // -----------------------------
  const VENDOR_SIGNUP_BASE_URL = window.location.origin + "/vendor.html";

  // -----------------------------
  // DOM HELPERS
  // -----------------------------
  const qs = (s) => document.querySelector(s);
  const qsa = (s) => document.querySelectorAll(s);

  function show(el) {
    if (!el) return;
    el.style.display = "";
  }
  function hide(el) {
    if (!el) return;
    el.style.display = "none";
  }

  // -----------------------------
  // AUTH DOM
  // -----------------------------
  const authView = qs("#auth-view");
  const appView = qs("#app-view");

  const tabLogin = qs("#tab-login");
  const tabSignup = qs("#tab-signup");
  const loginForm = qs("#login-form");
  const signupForm = qs("#signup-form");
  const authAlertContainer = qs("#auth-alert-container");
  const authSubtitle = qs("#auth-subtitle");

  const loginEmailEl = qs("#login-email");
  const loginPasswordEl = qs("#login-password");

  const signupNameEl = qs("#signup-name");
  const signupEmailEl = qs("#signup-email");
  const signupPasswordEl = qs("#signup-password");
  const signupEventNameEl = qs("#signup-event-name");
  const signupEventDateEl = qs("#signup-event-date");
  const signupEventLocationEl = qs("#signup-event-location");

  // -----------------------------
  // APP DOM (matching your HTML)
  // -----------------------------
  const sidebarEventLogoEl = qs("#sidebar-event-logo");
  const sidebarEventNameEl = qs("#sidebar-event-name");
  const topbarTitleEl = qs("#topbar-title");
  const topbarSubtitleEl = qs("#topbar-sub");
  const eventSelectEl = qs("#event-select");

  // KPIs (Overview cards)
  const kpiVendorsEl = qs("#kpi-vendors");
  const kpiStallsEl = qs("#kpi-stalls");
  const kpiSalesTodayEl = qs("#kpi-sales-today");
  const kpiCheckinsEl = qs("#kpi-checkins"); // will stay 0 until we hook tickets

  // Tables / wrappers
  const recentOrdersWrapperEl = qs("#table-recent-orders");
  const vendorsTableEl = qs("#vendors-table");
  const stallsTableEl = qs("#stalls-table");
  const ordersTableEl = qs("#orders-table");

  // Buttons
  const btnCopyVendorLink = qs("#btn-copy-vendor-link");
  const btnCopyVendorLink2 = qs("#btn-copy-vendor-link-2");
  const btnExportOrders = qs("#btn-export-orders");
  const logoutBtn = qs("#btn-logout");

  // Settings
  const setEventNameEl = qs("#set-event-name");
  const setEventLocationEl = qs("#set-event-location");
  const setEventDateEl = qs("#set-event-date");
  // Optional notes (not in HTML now, safe to stay null)
  const setEventNotesEl = null;
  const btnSaveEventSettings = qs("#btn-save-event");
  // No delete-event button in this HTML, so we skip that part entirely

  // Pages
  const navItems = qsa(".nav-item[data-page]");
  const pages = qsa(".page");

  // Modals
  const modalContainer = qs("#modal-container");

  // -----------------------------
  // STATE
  // -----------------------------
  let currentUser = null;
  let ownerProfile = null;

  let eventsList = [];
  let currentEventId = null;
  let currentEventData = null;

  let vendors = [];
  let stalls = [];
  let orders = [];

  let unsubVendors = null;
  let unsubStalls = null;
  let unsubOrders = null;

  let isSignupFlowInProgress = false;

  // -----------------------------
  // ALERTS & MODALS
  // -----------------------------
  function showAuthAlert(message, type = "error") {
    const cls = type === "error" ? "auth-alert-error" : "auth-alert-info";
    authAlertContainer.innerHTML = `
      <div class="auth-alert ${cls}">
        ${message}
      </div>
    `;
  }

  function clearAuthAlert() {
    authAlertContainer.innerHTML = "";
  }

  function openModal(innerHtml) {
    if (!modalContainer) return;
    modalContainer.style.display = "flex";
    modalContainer.innerHTML = `
      <div class="modal">
        ${innerHtml}
      </div>
    `;
  }

  function closeModal() {
    if (!modalContainer) return;
    modalContainer.style.display = "none";
    modalContainer.innerHTML = "";
  }
  window.closeModal = closeModal;

  // -----------------------------
  // AUTH VIEW TOGGLING
  // -----------------------------
  function showAuthView() {
    show(authView);
    hide(appView);
  }

  function showAppView() {
    hide(authView);
    show(appView);
  }

  tabLogin?.addEventListener("click", () => {
    tabLogin.classList.add("active");
    tabSignup.classList.remove("active");
    show(loginForm);
    hide(signupForm);
    authSubtitle.textContent = "Sign in to manage your events";
  });

  tabSignup?.addEventListener("click", () => {
    tabSignup.classList.add("active");
    tabLogin.classList.remove("active");
    hide(loginForm);
    show(signupForm);
    authSubtitle.textContent = "Create your first event and dashboard";
  });

  // -----------------------------
  // SMALL HELPERS
  // -----------------------------
  function formatCurrency(num) {
    const v = Number(num) || 0;
    return v.toFixed(2);
  }

  function randomToken(len = 10) {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    let out = "";
    for (let i = 0; i < len; i++) {
      out += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return out;
  }

  function copyToClipboard(text) {
    if (!navigator.clipboard) {
      const textarea = document.createElement("textarea");
      textarea.value = text;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand("copy");
      document.body.removeChild(textarea);
      return;
    }
    navigator.clipboard.writeText(text).catch(() => {});
  }

  // -----------------------------
  // AUTH: LOGIN
  // -----------------------------
  loginForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    clearAuthAlert();

    const email = loginEmailEl?.value.trim();
    const pw = loginPasswordEl?.value;

    if (!email || !pw) {
      showAuthAlert("Enter email and password.");
      return;
    }

    try {
      await signInWithEmailAndPassword(auth, email, pw);
      // onAuthStateChanged will show the app
    } catch (err) {
      console.error("Login error:", err);
      let msg = "Login failed.";
      if (err.code === "auth/user-not-found") msg = "User not found.";
      if (err.code === "auth/wrong-password") msg = "Wrong password.";
      showAuthAlert(msg);
    }
  });

  // -----------------------------
  // AUTH: SIGNUP (CREATE OWNER + EVENT)
  // -----------------------------
  signupForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    clearAuthAlert();

    const fullName = signupNameEl?.value.trim();
    const email = signupEmailEl?.value.trim();
    const pw = signupPasswordEl?.value;
    const eventName = signupEventNameEl?.value.trim();
    const eventDate = signupEventDateEl?.value.trim();
    const eventLocation = signupEventLocationEl?.value.trim();

    if (!fullName || !email || !pw || !eventName) {
      showAuthAlert("Fill all required fields (name, email, password, event name).");
      return;
    }
    if (pw.length < 6) {
      showAuthAlert("Password must be at least 6 characters.");
      return;
    }

    try {
      isSignupFlowInProgress = true;

      // 1) Create auth user
      const cred = await createUserWithEmailAndPassword(auth, email, pw);
      const user = cred.user;
      await updateProfile(user, { displayName: fullName });

      // 2) Create owner profile
      const ownerRef = doc(db, "eventOwners", user.uid);
      await setDoc(ownerRef, {
        uid: user.uid,
        name: fullName,
        email,
        createdAt: serverTimestamp()
      });

      // 3) Create first event
      const vendorToken = randomToken(8);
      const eventRef = await addDoc(collection(db, "events"), {
        name: eventName,
        date: eventDate || null,
        location: eventLocation || null,
        ownerUserId: user.uid,
        status: "active",
        vendorSignupToken: vendorToken,
        createdAt: serverTimestamp()
      });

      const eventId = eventRef.id;

      // 4) Link owner -> events
      const ownerEventsRef = doc(db, "ownerEvents", user.uid);
      await setDoc(
        ownerEventsRef,
        {
          primaryEventId: eventId,
          eventIds: [eventId]
        },
        { merge: true }
      );

      // onAuthStateChanged will pick up and continue
    } catch (err) {
      console.error("Signup error:", err);
      let msg = "Signup failed.";
      if (err.code === "auth/email-already-in-use") msg = "Email already in use.";
      showAuthAlert(msg);
      isSignupFlowInProgress = false;
    }
  });

  // -----------------------------
  // LOAD EVENTS FOR OWNER
  // -----------------------------
  async function loadEventsForOwner(uid) {
    eventsList = [];
    const qEvents = query(
      collection(db, "events"),
      where("ownerUserId", "==", uid),
      orderBy("createdAt", "desc")
    );
    const snap = await getDocs(qEvents);
    snap.forEach((d) => {
      eventsList.push({ id: d.id, ...d.data() });
    });
  }

  // -----------------------------
  // EVENT SWITCHER
  // -----------------------------
  function renderEventSwitcher() {
    if (!eventSelectEl) return;
    eventSelectEl.innerHTML = "";

    eventsList.forEach((ev) => {
      const opt = document.createElement("option");
      opt.value = ev.id;
      opt.textContent = ev.name || "Untitled event";
      eventSelectEl.appendChild(opt);
    });

    if (currentEventId) {
      eventSelectEl.value = currentEventId;
    }

    // Avoid stacking multiple listeners
    eventSelectEl.onchange = async () => {
      const val = eventSelectEl.value;
      if (!val) return;
      currentEventId = val;

      if (currentUser) {
        const ownerEventsRef = doc(db, "ownerEvents", currentUser.uid);
        const existingSnap = await getDoc(ownerEventsRef);
        const existing = existingSnap.exists() ? existingSnap.data() : {};
        const ids = Array.isArray(existing.eventIds) ? existing.eventIds : [];
        if (!ids.includes(val)) ids.push(val);

        await setDoc(
          ownerEventsRef,
          {
            primaryEventId: val,
            eventIds: ids
          },
          { merge: true }
        );
      }

      await selectEvent(val);
    };
  }

  // -----------------------------
  // SELECT EVENT + LOAD DATA
  // -----------------------------
  async function selectEvent(eventId) {
    if (!eventId) return;

    if (unsubVendors) { unsubVendors(); unsubVendors = null; }
    if (unsubOrders) { unsubOrders(); unsubOrders = null; }
    if (unsubStalls) { unsubStalls(); unsubStalls = null; }

    const evSnap = await getDoc(doc(db, "events", eventId));
    if (!evSnap.exists()) {
      console.warn("Event not found:", eventId);
      return;
    }
    currentEventData = { id: eventId, ...evSnap.data() };
    currentEventId = eventId;

    const name = currentEventData.name || "Event";
    const date = currentEventData.date || "";
    const location = currentEventData.location || "";

    if (topbarTitleEl) topbarTitleEl.textContent = "Event Overview";
    if (topbarSubtitleEl) {
      const subtitle = [name, date, location].filter(Boolean).join(" • ") || "Monitor vendors, stalls, and live sales";
      topbarSubtitleEl.textContent = subtitle;
    }
    if (sidebarEventNameEl) sidebarEventNameEl.textContent = name;
    if (sidebarEventLogoEl) {
      const initial = name?.[0]?.toUpperCase() || "E";
      sidebarEventLogoEl.textContent = initial;
    }

    if (setEventNameEl) setEventNameEl.value = name;
    if (setEventDateEl) setEventDateEl.value = date;
    if (setEventLocationEl) setEventLocationEl.value = location;

    updateVendorSignupLinkDisplay();

    // Listen to vendors
    const vendorsRef = collection(db, "events", eventId, "vendors");
    const qVendors = query(vendorsRef, orderBy("createdAt", "desc"));
    unsubVendors = onSnapshot(qVendors, (snap) => {
      vendors = [];
      snap.forEach((d) => vendors.push({ id: d.id, ...d.data() }));
      renderVendorsTable();
      updateOverviewMetrics();
    });

    // Listen to stalls
    const stallsRef = collection(db, "events", eventId, "stalls");
    unsubStalls = onSnapshot(stallsRef, (snap) => {
      stalls = [];
      snap.forEach((d) => stalls.push({ id: d.id, ...d.data() }));
      renderStallsTable();
      updateOverviewMetrics();
    });

    // Listen to orders
    const ordersRef = collection(db, "events", eventId, "orders");
    const qOrders = query(ordersRef, orderBy("createdAt", "desc"), limit(200));
    unsubOrders = onSnapshot(
      qOrders,
      (snap) => {
        orders = [];
        snap.forEach((d) => orders.push({ id: d.id, ...d.data() }));
        renderOrdersTable();
        renderRecentOrdersTable();
        updateOverviewMetrics();
      },
      (err) => {
        console.error("Orders listener error:", err);
      }
    );
  }

  // -----------------------------
  // VENDOR SIGNUP LINK
  // -----------------------------
  function buildVendorSignupUrl() {
    if (!currentEventData) return "";
    const eid = currentEventData.id;
    const token = currentEventData.vendorSignupToken || "";
    const url = new URL(VENDOR_SIGNUP_BASE_URL);
    url.searchParams.set("eventId", eid);
    if (token) url.searchParams.set("token", token);
    return url.toString();
  }

  function updateVendorSignupLinkDisplay() {
    // Right now we only copy via button; if you later add a <div> to show it, wire it here.
  }

  function handleCopyVendorLink() {
    const url = buildVendorSignupUrl();
    if (!url) {
      alert("No event selected.");
      return;
    }
    copyToClipboard(url);
    alert("Vendor signup link copied.");
  }

  btnCopyVendorLink?.addEventListener("click", handleCopyVendorLink);
  btnCopyVendorLink2?.addEventListener("click", handleCopyVendorLink);

  // -----------------------------
  // OVERVIEW METRICS
  // -----------------------------
  function updateOverviewMetrics() {
    const totalVendors = vendors.length;
    const stallsCount = stalls.length;

    const today = new Date();
    const isSameDay = (d1, d2) =>
      d1.getFullYear() === d2.getFullYear() &&
      d1.getMonth() === d2.getMonth() &&
      d1.getDate() === d2.getDate();

    let salesToday = 0;
    orders.forEach((o) => {
      const createdAt = o.createdAt && typeof o.createdAt.toDate === "function"
        ? o.createdAt.toDate()
        : null;
      if (createdAt && isSameDay(createdAt, today)) {
        salesToday += Number(o.total) || 0;
      }
    });

    if (kpiVendorsEl) kpiVendorsEl.textContent = String(totalVendors);
    if (kpiStallsEl) kpiStallsEl.textContent = String(stallsCount);
    if (kpiSalesTodayEl) kpiSalesTodayEl.textContent = formatCurrency(salesToday);
    if (kpiCheckinsEl) kpiCheckinsEl.textContent = "0"; // integrate tickets later
  }

  // -----------------------------
  // VENDORS TABLE
  // -----------------------------
  function renderVendorsTable() {
    if (!vendorsTableEl) return;

    if (!vendors.length) {
      vendorsTableEl.innerHTML = `
        <div class="table-empty">No vendors yet. Send the signup link to brands.</div>
      `;
      return;
    }

    let html = `
      <table>
        <thead>
          <tr>
            <th>Brand</th>
            <th>Contact</th>
            <th>Phone</th>
            <th>Email</th>
            <th>Category</th>
            <th>Status</th>
            <th>Stall</th>
            <th>POS Linked?</th>
          </tr>
        </thead>
        <tbody>
    `;

    vendors.forEach((v) => {
      const status = v.status || "pending";
      const posLinked = v.posBrandId ? "Yes" : "No";

      html += `
        <tr>
          <td>${v.brandName || v.vendorName || "Vendor"}</td>
          <td>${v.contactName || ""}</td>
          <td>${v.phone || ""}</td>
          <td>${v.email || ""}</td>
          <td>${v.category || v.segment || ""}</td>
          <td>${status}</td>
          <td>${v.stallCode || v.stallName || "—"}</td>
          <td>${posLinked}</td>
        </tr>
      `;
    });

    html += `</tbody></table>`;
    vendorsTableEl.innerHTML = html;
  }

  // -----------------------------
  // STALLS TABLE
  // -----------------------------
  function renderStallsTable() {
    if (!stallsTableEl) return;

    if (!stalls.length) {
      stallsTableEl.innerHTML = `<div class="table-empty">No stalls defined yet.</div>`;
      return;
    }

    let html = `
      <table>
        <thead>
          <tr>
            <th>Stall Code</th>
            <th>Zone</th>
            <th>Size</th>
            <th>Price</th>
            <th>Vendor</th>
          </tr>
        </thead>
        <tbody>
    `;

    stalls.forEach((s) => {
      const vendorName =
        s.vendorBrandName ||
        (s.vendorId && (vendors.find((v) => v.id === s.vendorId)?.brandName || "")) ||
        "—";

      html += `
        <tr>
          <td>${s.code || s.name || ""}</td>
          <td>${s.zone || ""}</td>
          <td>${s.size || ""}</td>
          <td>${formatCurrency(s.price)}</td>
          <td>${vendorName}</td>
        </tr>
      `;
    });

    html += `</tbody></table>`;
    stallsTableEl.innerHTML = html;
  }

  // -----------------------------
  // ORDERS TABLE (Sales page)
  // -----------------------------
  function renderOrdersTable() {
    if (!ordersTableEl) return;

    if (!orders.length) {
      ordersTableEl.innerHTML = `<div class="table-empty">No orders yet for this event.</div>`;
      return;
    }

    let html = `
      <table>
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Vendor</th>
            <th>Total</th>
            <th>Payment</th>
            <th>Type</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
    `;

    orders.forEach((o) => {
      const vendorName =
        o.vendorBrandName ||
        (o.vendorId && (vendors.find((v) => v.id === o.vendorId)?.brandName || "")) ||
        "—";
      const createdAt = o.createdAt && typeof o.createdAt.toDate === "function"
        ? o.createdAt.toDate()
        : null;
      const dateStr = createdAt
        ? createdAt.toLocaleString("en-EG", { timeZone: "Africa/Cairo" })
        : "";

      html += `
        <tr>
          <td>${o.orderId || o.id}</td>
          <td>${vendorName}</td>
          <td>${formatCurrency(o.total)}</td>
          <td>${o.paymentMethod || ""}</td>
          <td>${o.type || "sale"}</td>
          <td>${dateStr}</td>
        </tr>
      `;
    });

    html += `</tbody></table>`;
    ordersTableEl.innerHTML = html;
  }

  // -----------------------------
  // RECENT ORDERS (Overview block)
  // -----------------------------
  function renderRecentOrdersTable() {
    if (!recentOrdersWrapperEl) return;

    if (!orders.length) {
      recentOrdersWrapperEl.innerHTML = `<div class="table-empty">No orders yet.</div>`;
      return;
    }

    const recent = orders.slice(0, 10);

    let html = `
      <table>
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Vendor</th>
            <th>Total</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
    `;

    recent.forEach((o) => {
      const vendorName =
        o.vendorBrandName ||
        (o.vendorId && (vendors.find((v) => v.id === o.vendorId)?.brandName || "")) ||
        "—";
      const createdAt = o.createdAt && typeof o.createdAt.toDate === "function"
        ? o.createdAt.toDate()
        : null;
      const dateStr = createdAt
        ? createdAt.toLocaleString("en-EG", { timeZone: "Africa/Cairo" })
        : "";

      html += `
        <tr>
          <td>${o.orderId || o.id}</td>
          <td>${vendorName}</td>
          <td>${formatCurrency(o.total)}</td>
          <td>${dateStr}</td>
        </tr>
      `;
    });

    html += `</tbody></table>`;
    recentOrdersWrapperEl.innerHTML = html;
  }

  // -----------------------------
  // SETTINGS SAVE
  // -----------------------------
  btnSaveEventSettings?.addEventListener("click", async () => {
    if (!currentEventId) {
      alert("No event selected.");
      return;
    }

    const name = setEventNameEl ? setEventNameEl.value.trim() : "";
    const date = setEventDateEl ? setEventDateEl.value.trim() : "";
    const location = setEventLocationEl ? setEventLocationEl.value.trim() : "";
    const notes = setEventNotesEl ? setEventNotesEl.value.trim() : "";

    const updates = {
      name: name || null,
      date: date || null,
      location: location || null
    };
    if (notes) updates.notes = notes;

    await updateDoc(doc(db, "events", currentEventId), updates);
    alert("Event settings saved.");
  });

  // -----------------------------
  // EXPORT ORDERS CSV
  // -----------------------------
  function downloadCsv(filename, rows) {
    const escapeVal = (v) => {
      if (v === null || v === undefined) return "";
      const s = String(v).replace(/"/g, '""');
      if (/[" ,\n]/.test(s)) return `"${s}"`;
      return s;
    };
    const csv = rows.map((r) => r.map(escapeVal).join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  btnExportOrders?.addEventListener("click", () => {
    if (!orders.length) {
      alert("No orders to export.");
      return;
    }
    const rows = [["orderId", "vendor", "total", "paymentMethod", "type", "createdAt"]];
    orders.forEach((o) => {
      const vendorName =
        o.vendorBrandName ||
        (o.vendorId && (vendors.find((v) => v.id === o.vendorId)?.brandName || "")) ||
        "";
      const createdAt = o.createdAt && typeof o.createdAt.toDate === "function"
        ? o.createdAt.toDate().toISOString()
        : "";
      rows.push([
        o.orderId || o.id,
        vendorName,
        o.total || 0,
        o.paymentMethod || "",
        o.type || "sale",
        createdAt
      ]);
    });
    downloadCsv("event_orders.csv", rows);
  });

  // -----------------------------
  // NAVIGATION (SIDEBAR)
  // -----------------------------
  navItems.forEach((btn) => {
    btn.addEventListener("click", () => {
      const pageId = btn.dataset.page;
      if (!pageId) return;

      navItems.forEach((b) => b.classList.remove("active"));
      pages.forEach((p) => p.classList.remove("active"));

      btn.classList.add("active");
      const pageEl = qs("#" + pageId);
      if (pageEl) pageEl.classList.add("active");
    });
  });

  // -----------------------------
  // LOGOUT
  // -----------------------------
  logoutBtn?.addEventListener("click", async () => {
    if (unsubVendors) unsubVendors();
    if (unsubOrders) unsubOrders();
    if (unsubStalls) unsubStalls();
    unsubVendors = unsubOrders = unsubStalls = null;

    await signOut(auth);
    showAuthView();
  });

  // -----------------------------
  // AUTH STATE HANDLER (FIXED)
  // -----------------------------
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      currentUser = null;
      ownerProfile = null;
      eventsList = [];
      currentEventId = null;
      currentEventData = null;

      if (unsubVendors) unsubVendors();
      if (unsubOrders) unsubOrders();
      if (unsubStalls) unsubStalls();
      unsubVendors = unsubOrders = unsubStalls = null;

      showAuthView();
      return;
    }

    currentUser = user;
    showAppView();

    // Load owner profile (optional)
    const ownerRef = doc(db, "eventOwners", user.uid);
    const ownerSnap = await getDoc(ownerRef);
    ownerProfile = ownerSnap.exists() ? ownerSnap.data() : null;

    // Sidebar avatar/name already using event name, so nothing extra needed

    // Load events
    await loadEventsForOwner(user.uid);

    // Decide which event to open
    const ownerEventsRef = doc(db, "ownerEvents", user.uid);
    const ownSnap = await getDoc(ownerEventsRef);
    if (ownSnap.exists()) {
      const data = ownSnap.data();
      if (data.primaryEventId) currentEventId = data.primaryEventId;
    }
    if (!currentEventId && eventsList.length) {
      currentEventId = eventsList[0].id;
    }

    renderEventSwitcher();
    if (currentEventId) {
      await selectEvent(currentEventId);
    }
  });

  // Start on auth view by default
  showAuthView();
</script>
</body>
</html>
