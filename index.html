<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Luma Events — Owner Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#f3f4f6;
      --panel:#ffffff;
      --panel-soft:#f9fafb;
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#2563eb;
      --accent-soft:#dbeafe;
      --accent-strong:#1d4ed8;
      --ok:#16a34a;
      --danger:#ef4444;
      --radius:16px;
      --shadow:0 18px 40px rgba(15,23,42,.12);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      font-family:"Montserrat",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--ink);
    }

    /* AUTH WRAPPER (same vibe as brand portal) */
    .auth-wrapper{
      width:100%;
      max-width:460px;
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(148,163,184,.3);
      padding:18px;
      margin:40px auto;
    }
    .auth-header{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
    }
    .auth-logo{
      width:38px;height:38px;border-radius:999px;
      background:linear-gradient(135deg,#2563eb,#a855f7);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;font-size:18px;
      overflow:hidden;
      background-size:cover;
      background-position:center;
    }
    .auth-title{font-size:17px;font-weight:700;}
    .auth-subtitle{font-size:11px;color:var(--muted);margin-top:2px;}

    .auth-tabs{
      display:flex;gap:6px;margin:10px 0 12px;
    }
    .auth-tab{
      flex:1;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--panel-soft);
      color:var(--muted);
      font-size:12px;
      cursor:pointer;
      text-align:center;
    }
    .auth-tab.active{
      background:var(--accent-soft);
      border-color:var(--accent-soft);
      color:var(--accent-strong);
      font-weight:600;
    }
    .auth-alert{
      padding:8px 10px;
      border-radius:10px;
      font-size:11px;
      margin-bottom:10px;
    }
    .auth-alert-error{background:#fef2f2;color:#b91c1c;border:1px solid #fecaca;}
    .auth-alert-info{background:#eff6ff;color:#1d4ed8;border:1px solid #bfdbfe;}

    .field{margin-bottom:10px;}
    .field-label{font-size:11px;margin-bottom:4px;color:#4b5563;}
    .field-input,.field-select{
      width:100%;padding:8px;border-radius:9px;
      border:1px solid var(--border);background:#f9fafb;font-size:12px;
    }
    .field-input:focus,.field-select:focus{
      outline:none;border-color:var(--accent);box-shadow:0 0 0 1px var(--accent-soft);
    }
    .field-hint{font-size:10px;color:var(--muted);margin-top:3px;}

    .btn{
      border:none;border-radius:999px;
      padding:8px 12px;font-size:12px;font-weight:600;
      cursor:pointer;display:inline-flex;align-items:center;justify-content:center;
      gap:6px;
    }
    .btn-primary{background:var(--accent);color:#fff;}
    .btn-primary:hover{background:var(--accent-strong);}
    .btn-ghost{
      background:transparent;color:var(--accent-strong);
      border:1px solid var(--accent-soft);
    }
    .btn-ghost:hover{background:var(--accent-soft);}
    .btn-danger{background:var(--danger);color:#fff;}
    .btn-danger:hover{background:#b91c1c;}

    .auth-footer{text-align:center;margin-top:8px;font-size:10px;color:var(--muted);}

    /* APP LAYOUT (same style as brand) */
    .app-shell{
      display:none;
      height:100vh;width:100%;
    }
    .sidebar{
      width:220px;background:var(--panel);
      border-right:1px solid var(--border);
      display:flex;flex-direction:column;
      padding:20px 12px;
    }
    .sidebar-brand{
      display:flex;align-items:center;gap:10px;margin-bottom:18px;
    }
    .sidebar-logo{
      width:36px;height:36px;border-radius:999px;
      background:linear-gradient(135deg,#2563eb,#a855f7);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;
      overflow:hidden;
      background-size:cover;
      background-position:center;
    }
    .sidebar-brand-name{font-size:15px;font-weight:700;}
    .sidebar-nav{
      display:flex;flex-direction:column;gap:6px;margin-top:10px;flex:1;
    }
    .nav-item{
      padding:9px 12px;border-radius:10px;
      cursor:pointer;font-size:13px;
      border:none;background:transparent;text-align:left;color:var(--ink);
    }
    .nav-item:hover{background:var(--panel-soft);}
    .nav-item.active{background:var(--accent-soft);color:var(--accent-strong);font-weight:600;}
    .nav-item.logout{
      margin-top:auto;
      background:#fee2e2;
      color:#b91c1c;
      border:1px solid #fecaca;
    }
    .nav-item.logout:hover{background:#fecaca;}

    .topbar{
      height:70px;background:var(--panel);
      border-bottom:1px solid var(--border);
      padding:12px 18px;
      display:flex;justify-content:space-between;align-items:center;
    }
    .topbar-title{font-size:16px;font-weight:700;}
    .topbar-sub{font-size:11px;color:var(--muted);}
    .topbar-filter{display:flex;align-items:center;gap:10px;font-size:12px;}
    .topbar-filter select{
      padding:6px 9px;border-radius:8px;
      border:1px solid var(--border);background:var(--panel-soft);
    }

    .content-area{flex:1;padding:20px;overflow-y:auto;background:var(--bg);}
    .page{display:none;}
    .page.active{display:block;}
    .page-header{
      display:flex;justify-content:space-between;
      align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:10px;
    }
    .page-title{font-size:18px;font-weight:700;}
    .page-sub{font-size:12px;color:var(--muted);}
    .page-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}

    .cards-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:12px;margin-bottom:22px;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:18px;
      box-shadow:var(--shadow);
    }
    .card-title{font-size:13px;color:var(--muted);margin-bottom:4px;}
    .card-number{font-size:20px;font-weight:700;}
    .card-note{font-size:11px;color:var(--muted);margin-top:6px;}

    .table-wrapper{
      background:#fff;border-radius:12px;border:1px solid var(--border);
      overflow-x:auto;
    }
    table{width:100%;border-collapse:collapse;font-size:12px;}
    thead{background:var(--panel-soft);}
    th,td{padding:9px 10px;border-bottom:1px solid var(--border);text-align:left;}
    th{
      font-size:11px;text-transform:uppercase;color:var(--muted);
      letter-spacing:.04em;
    }
    tbody tr:hover{background:#f9fafb;}
    .table-empty{text-align:center;padding:20px;font-size:12px;color:var(--muted);}

    /* MODAL */
    #modal-container{
      position:fixed;inset:0;
      display:none;justify-content:center;align-items:center;
      background:rgba(0,0,0,.35);z-index:9999;
    }
    .modal{
      background:var(--panel);
      width:100%;max-width:520px;
      border-radius:16px;
      padding:18px;
      box-shadow:var(--shadow);
    }
    .modal-title{font-size:16px;font-weight:700;margin-bottom:14px;}
    .modal-actions{margin-top:16px;display:flex;justify-content:flex-end;gap:8px;}

    @media(max-width:768px){
      .app-shell{flex-direction:column;}
      .sidebar{width:100%;flex-direction:row;overflow-x:auto;height:auto;}
      .sidebar-nav{flex-direction:row;}
      .topbar{flex-direction:column;align-items:flex-start;gap:8px;height:auto;}
    }
  </style>
</head>
<body>

  <!-- AUTH VIEW: Sign in / Sign up for event owner -->
  <div id="auth-view" class="auth-wrapper">
    <div class="auth-header">
      <div class="auth-logo">E</div>
      <div>
        <div class="auth-title">Luma Events — Owner Portal</div>
        <div id="auth-subtitle" class="auth-subtitle">
          Sign in to manage your events or create a new event.
        </div>
      </div>
    </div>

    <div id="auth-alert-container"></div>

    <div class="auth-tabs">
      <button type="button" id="tab-login" class="auth-tab active">Sign in</button>
      <button type="button" id="tab-signup" class="auth-tab">Create account &amp; event</button>
    </div>

    <!-- LOGIN FORM -->
    <form id="login-form">
      <div class="field">
        <div class="field-label">Email</div>
        <input id="login-email" class="field-input" type="email" placeholder="you@example.com"/>
      </div>
      <div class="field">
        <div class="field-label">Password</div>
        <input id="login-password" class="field-input" type="password" placeholder="Your password"/>
      </div>
      <button type="submit" id="login-btn" class="btn btn-primary" style="width:100%;">Sign in</button>
    </form>

    <!-- SIGNUP FORM (creates owner + first event) -->
    <form id="signup-form" style="display:none;">
      <div class="field">
        <div class="field-label">Your name</div>
        <input id="signup-name" class="field-input" placeholder="Full name"/>
      </div>
      <div class="field">
        <div class="field-label">Email</div>
        <input id="signup-email" class="field-input" type="email" placeholder="you@example.com"/>
      </div>
      <div class="field">
        <div class="field-label">Password</div>
        <input id="signup-password" class="field-input" type="password" placeholder="Minimum 6 characters"/>
      </div>

      <div class="field">
        <div class="field-label">Event name</div>
        <input id="signup-event-name" class="field-input" placeholder="Lokamania 5, Soueast Owners, ..."/>
      </div>
      <div class="field">
        <div class="field-label">Event location</div>
        <input id="signup-event-location" class="field-input" placeholder="Cairo Festival City, Dubai, ..."/>
      </div>
      <div class="field">
        <div class="field-label">Event date</div>
        <input id="signup-event-date" class="field-input" type="date"/>
      </div>

      <button type="submit" id="signup-btn" class="btn btn-primary" style="width:100%;">Create account &amp; event</button>
      <div class="field-hint" style="margin-top:6px;">
        This will create your owner account, first event document, and link everything automatically in Firestore.
      </div>
    </form>

    <div class="auth-footer">
      Once signed in, you’ll see your events dashboard, vendors, stalls & POS links.
    </div>
  </div>

  <!-- APP VIEW -->
  <div id="app-view" class="app-shell">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-brand">
        <div id="sidebar-event-logo" class="sidebar-logo">E</div>
        <div id="sidebar-event-name" class="sidebar-brand-name">Event</div>
      </div>
      <nav class="sidebar-nav">
        <button class="nav-item active" data-page="page-overview">Overview</button>
        <button class="nav-item" data-page="page-vendors">Vendors</button>
        <button class="nav-item" data-page="page-stalls">Stalls &amp; Layout</button>
        <button class="nav-item" data-page="page-orders">Sales &amp; POS</button>
        <button class="nav-item" data-page="page-settings">Event Settings</button>
      </nav>
      <button id="btn-logout" class="nav-item logout">Logout</button>
    </aside>

    <!-- MAIN -->
    <div style="flex:1;display:flex;flex-direction:column;">
      <header class="topbar">
        <div>
          <div id="topbar-title" class="topbar-title">Event Overview</div>
          <div id="topbar-sub" class="topbar-sub">Monitor vendors, stalls, and live sales</div>
        </div>
        <div class="topbar-filter">
          <span>Event:</span>
          <select id="event-select">
            <!-- filled by JS with owner’s events -->
          </select>
        </div>
      </header>

      <main class="content-area">
        <!-- OVERVIEW PAGE -->
        <section id="page-overview" class="page active">
          <div class="cards-grid">
            <div class="card">
              <div class="card-title">Vendors</div>
              <div id="kpi-vendors" class="card-number">0</div>
              <div class="card-note">Total approved vendors for this event.</div>
            </div>
            <div class="card">
              <div class="card-title">Stalls</div>
              <div id="kpi-stalls" class="card-number">0</div>
              <div class="card-note">Total stalls (assigned + empty).</div>
            </div>
            <div class="card">
              <div class="card-title">Live Sales (Today)</div>
              <div id="kpi-sales-today" class="card-number">0</div>
              <div class="card-note">Sum of all vendors’ POS totals today.</div>
            </div>
            <div class="card">
              <div class="card-title">Tickets Checked-in</div>
              <div id="kpi-checkins" class="card-number">0</div>
              <div class="card-note">QR check-ins from Luma Tickets.</div>
            </div>
          </div>

          <div class="page-header" style="margin-top:4px;">
            <div>
              <div class="page-title" style="font-size:15px;">Recent Vendor Sales</div>
              <div class="page-sub">Last 10 orders from all event vendors.</div>
            </div>
            <div class="page-actions">
              <button id="btn-copy-vendor-link" class="btn btn-ghost">Copy vendor signup link</button>
            </div>
          </div>
          <div id="table-recent-orders" class="table-wrapper"></div>
        </section>

        <!-- VENDORS PAGE -->
        <section id="page-vendors" class="page">
          <div class="page-header">
            <div>
              <div class="page-title">Vendors</div>
              <div class="page-sub">Manage vendor signup, approvals & POS access</div>
            </div>
            <div class="page-actions">
              <button id="btn-open-manual-vendor" class="btn btn-primary">Add vendor manually</button>
              <button id="btn-copy-vendor-link-2" class="btn btn-ghost">Copy vendor signup link</button>
            </div>
          </div>
          <div id="vendors-analytics" class="cards-grid" style="margin-top:4px;"></div>
          <div class="table-wrapper" id="vendors-table"></div>
        </section>

        <!-- STALLS PAGE -->
        <section id="page-stalls" class="page">
          <div class="page-header">
            <div>
              <div class="page-title">Stalls &amp; Layout</div>
              <div class="page-sub">Assign stalls to vendors and track occupancy</div>
            </div>
            <div class="page-actions">
              <button id="btn-add-stall" class="btn btn-primary">Add stall</button>
            </div>
          </div>
          <div id="stalls-analytics" class="cards-grid" style="margin-top:4px;"></div>
          <div class="table-wrapper" id="stalls-table"></div>
        </section>

        <!-- ORDERS / SALES -->
        <section id="page-orders" class="page">
          <div class="page-header">
            <div>
              <div class="page-title">Sales &amp; POS</div>
              <div class="page-sub">Track per-vendor POS sales for this event</div>
            </div>
            <div class="page-actions">
              <button id="btn-export-orders" class="btn btn-ghost">Export CSV</button>
            </div>
          </div>
          <div id="orders-analytics" class="cards-grid" style="margin-top:4px;"></div>
          <div class="table-wrapper" id="orders-table"></div>
        </section>

        <!-- SETTINGS -->
        <section id="page-settings" class="page">
          <div class="page-header">
            <div>
              <div class="page-title">Event Settings</div>
              <div class="page-sub">Edit event name, dates & basic settings</div>
            </div>
          </div>
          <div class="cards-grid">
            <div class="card">
              <div class="field">
                <div class="field-label">Event name</div>
                <input id="set-event-name" class="field-input"/>
              </div>
              <div class="field">
                <div class="field-label">Location</div>
                <input id="set-event-location" class="field-input"/>
              </div>
              <div class="field">
                <div class="field-label">Date</div>
                <input id="set-event-date" class="field-input" type="date"/>
              </div>
              <button id="btn-save-event" class="btn btn-primary" style="margin-top:6px;">Save</button>
          </div>
        </div>

        <div class="panel panel-soft">
          <div class="panel-header">
            <div>
              <div class="panel-title">
                <span class="dot"></span>
                Vendor Linking
              </div>
              <div class="panel-subtitle">
                Make sure each vendor is linked to its brand (Store OS) and branches.
              </div>
            </div>
          </div>
          <p class="panel-subtitle" style="margin-bottom:8px;">
            When a vendor is linked to a brand, their POS and products are automatically connected to this event.
            Orders will carry both <strong>eventId</strong> and <strong>brandId</strong> so you can see everything here.
          </p>
          <ul style="font-size:11px;color:var(--muted);padding-left:16px;list-style:disc;">
            <li>Use <strong>“Add Vendor”</strong> in the Vendors tab to link an existing brand to this event.</li>
            <li>Each vendor can have one or more <strong>branches/booths</strong> inside the event.</li>
            <li>Click <strong>“Open Vendor Dashboard”</strong> to jump to the vendor’s own brand.html (POS dashboard).</li>
          </ul>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- MODAL ROOT -->
<div id="modalBackdrop" class="modal-backdrop">
  <div id="modalContent" class="modal"></div>
</div>

<!-- GLOBAL ALERT -->
<div id="globalAlert" class="global-alert">
  <span class="dot"></span>
  <span id="globalAlertText">Saved.</span>
</div>

<!-- LOADING OVERLAY -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="spinner"></div>
</div>

<script type="module">
  // =========================
  // FIREBASE INIT
  // =========================
  const firebaseConfig = {
    // TODO: fill with your existing events project config
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
  };

  const app = firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // =========================
  // DOM HELPERS
  // =========================
  const qs = (s) => document.querySelector(s);
  const qsa = (s) => Array.from(document.querySelectorAll(s));

  const authView = qs("#authView");
  const appShell = qs("#appShell");
  const loadingOverlay = qs("#loadingOverlay");
  const globalAlertEl = qs("#globalAlert");
  const globalAlertText = qs("#globalAlertText");

  // Event meta elements
  const sidebarEventLogo = qs("#sidebarEventLogo");
  const sidebarEventName = qs("#sidebarEventName");
  const sidebarEventVenue = qs("#sidebarEventVenue");
  const authEventLogo = qs("#authEventLogo");
  const authEventName = qs("#auth-event-name");
  const topbarTitleEl = qs("#topbarTitle");
  const topbarSubtitleEl = qs("#topbarSubtitle");
  const topbarEventShortEl = qs("#topbarEventShort");
  const topbarDateRangeEl = qs("#topbarDateRange");
  const topbarUserAvatarEl = qs("#topbarUserAvatar");
  const topbarUserNameEl = qs("#topbarUserName");

  // KPIs
  const kpiSalesTodayEl = qs("#kpiSalesToday");
  const kpiSalesTodayNoteEl = qs("#kpiSalesTodayNote");
  const kpiOrdersTodayEl = qs("#kpiOrdersToday");
  const kpiReturnsTodayEl = qs("#kpiReturnsToday");
  const kpiActiveVendorsEl = qs("#kpiActiveVendors");
  const kpiTotalVendorsNoteEl = qs("#kpiTotalVendorsNote");
  const kpiActiveBoothsEl = qs("#kpiActiveBooths");
  const kpiTotalBoothsNoteEl = qs("#kpiTotalBoothsNote");
  const kpiPaymentSplitEl = qs("#kpiPaymentSplit");

  // Sidebar counters
  const sidebarVendorsCountEl = qs("#sidebarVendorsCount");
  const sidebarBoothsCountEl = qs("#sidebarBoothsCount");
  const sidebarOrdersCountEl = qs("#sidebarOrdersCount");
  const sidebarCustomersCountEl = qs("#sidebarCustomersCount");

  // Tables
  const topVendorsTableEl = qs("#topVendorsTable");
  const recentOrdersTableEl = qs("#recentOrdersTable");
  const vendorsTableEl = qs("#vendorsTable");
  const boothsTableEl = qs("#boothsTable");
  const ordersTableEl = qs("#ordersTable");
  const customersTableEl = qs("#customersTable");

  // Settings inputs
  const setEventNameInput = qs("#set-event-name");
  const setEventVenueInput = qs("#set-event-venue");
  const setEventDatesInput = qs("#set-event-dates");
  const setEventLogoInput = qs("#set-event-logo");

  // Auth
  const authForm = qs("#authForm");
  const authEmailInput = qs("#authEmail");
  const authPasswordInput = qs("#authPassword");
  const authAlert = qs("#authAlert");
  const logoutBtn = qs("#btn-logout");

  // Modal
  const modalBackdrop = qs("#modalBackdrop");
  const modalContent = qs("#modalContent");

  // Filters/search
  const searchVendorsInput = qs("#search-vendors");
  const filterVendorStatusSelect = qs("#filter-vendor-status");
  const sortVendorsSelect = qs("#sort-vendors");

  const searchBoothsInput = qs("#search-booths");
  const sortBoothsSelect = qs("#sort-booths");

  const searchOrdersInput = qs("#search-orders");
  const filterOrderTypeSelect = qs("#filter-order-type");
  const sortOrdersSelect = qs("#sort-orders");

  const searchCustomersInput = qs("#search-customers");
  const sortCustomersSelect = qs("#sort-customers");

  // Charts
  let salesTimelineChart = null;
  let paymentSplitChart = null;

  // Data state
  let currentUser = null;
  let eventId = null;
  let eventData = null;

  let eventVendors = [];   // from /events/{eventId}/vendors (linked to brandId)
  let eventBooths = [];    // aggregated from brand branches that match event
  let eventOrders = [];    // from /orders with eventId
  let eventCustomers = []; // aggregated customers

  // =========================
  // UTIL
  // =========================
  function showLoading(on){
    if(on){
      loadingOverlay.classList.add("visible");
    }else{
      loadingOverlay.classList.remove("visible");
    }
  }

  function showAlert(msg, type="ok"){
    globalAlertText.textContent = msg;
    globalAlertEl.classList.toggle("error", type === "error");
    globalAlertEl.classList.add("visible");
    setTimeout(() => {
      globalAlertEl.classList.remove("visible");
    }, 2300);
  }

  function openModal(innerHtml){
    modalContent.innerHTML = innerHtml;
    modalBackdrop.classList.add("visible");
  }

  function closeModal(){
    modalBackdrop.classList.remove("visible");
    modalContent.innerHTML = "";
  }

  modalBackdrop.addEventListener("click", e => {
    if(e.target === modalBackdrop){
      closeModal();
    }
  });

  function getTodayString(){
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,"0");
    const d = String(now.getDate()).padStart(2,"0");
    return `${y}-${m}-${d}`;
  }

  function money(v){
    const n = Number(v) || 0;
    return n.toFixed(2);
  }

  function orderDateString(o){
    if(o.createdAt && o.createdAt.toDate){
      const d = o.createdAt.toDate();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }
    const fallback = o.createdAt || o.date || null;
    if(!fallback) return getTodayString();
    try{
      const d = new Date(fallback);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }catch(e){
      return getTodayString();
    }
  }

  async function uploadImageToStorage(file, path){
    const ref = storage.ref().child(path + "/" + file.name);
    await ref.put(file);
    return ref.getDownloadURL();
  }

  // =========================
  // EVENT ID FROM URL
  // =========================
  const urlParams = new URLSearchParams(window.location.search);
  eventId = urlParams.get("eventId") || null;
  // If we want a fallback for testing
  // if(!eventId) eventId = "lokamania5";

   // =========================
  // AUTH HANDLERS
  // (Link event owner login to this dashboard)
  // =========================

  function showAuthError(msg){
    authAlert.textContent = msg;
    authAlert.style.display = "block";
  }
  function clearAuthError(){
    authAlert.textContent = "";
    authAlert.style.display = "none";
  }

  authForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    clearAuthError();
    const email = authEmailInput.value.trim();
    const password = authPasswordInput.value.trim();
    if(!email || !password){
      showAuthError("Please enter email and password.");
      return;
    }
    try{
      showLoading(true);
      await auth.signInWithEmailAndPassword(email, password);
    }catch(err){
      console.error("Sign-in error", err);
      showAuthError(err.message || "Could not sign in. Check credentials.");
      showLoading(false);
    }
  });

  logoutBtn.addEventListener("click", async () => {
    try{
      await auth.signOut();
    }catch(e){
      console.error("Logout error", e);
    }
  });

  auth.onAuthStateChanged(async (user) => {
    if(!eventId){
      // No eventId in URL → force auth screen with message
      authView.style.display = "flex";
      appShell.style.display = "none";
      showAuthError("Missing ?eventId= in the URL. Add eventId to open this dashboard.");
      return;
    }

    if(user){
      currentUser = user;
      clearAuthError();
      authView.style.display = "none";
      appShell.style.display = "flex";
      showLoading(true);
      try{
        await initForUser(user);
      }catch(e){
        console.error("Init error", e);
        showAuthError("Could not load event data. Check event permissions.");
      }finally{
        showLoading(false);
      }
    }else{
      currentUser = null;
      appShell.style.display = "none";
      authView.style.display = "flex";
      showLoading(false);
    }
  });

  // =========================
  // LOAD EVENT & DATA
  // =========================

  async function loadEventMeta(){
    if(!eventId) return;
    const ref = db.collection("events").doc(eventId);
    const snap = await ref.get();
    if(!snap.exists){
      throw new Error("Event not found: " + eventId);
    }
    eventData = snap.data() || {};

    const name = eventData.name || "Event";
    const venue = eventData.venue || "";
    const dates = eventData.dateRange || "";
    const shortName = eventData.shortName || (name.length > 16 ? name.slice(0,16)+"…" : name);

    sidebarEventName.textContent = name;
    sidebarEventVenue.textContent = venue && dates ? `${venue} • ${dates}` : (venue || dates || "Event venue & dates");
    authEventName.textContent = name;
    topbarEventShortEl.textContent = shortName;
    topbarDateRangeEl.textContent = dates || "Event dates";
    topbarSubtitleEl.textContent = `Today’s performance for ${name}.`;
    
    // Avatar / logo letter
    const letter = name.charAt(0)?.toUpperCase() || "E";
    sidebarEventLogo.textContent = letter;
    authEventLogo.textContent = letter;

    // If logoUrl exists, show image circle
    if(eventData.logoUrl){
      const logoHtml = `<img src="${eventData.logoUrl}" alt="${name} logo"/>`;
      sidebarEventLogo.innerHTML = logoHtml;
      authEventLogo.innerHTML = logoHtml;
    }

    // Settings form
    setEventNameInput.value = name;
    setEventVenueInput.value = venue;
    setEventDatesInput.value = dates;
  }

  async function loadVendors(){
    eventVendors = [];
    try{
      const ref = db.collection("events").doc(eventId).collection("vendors");
      const snap = await ref.get();
      eventVendors = snap.docs.map(d => ({
        _id: d.id,
        ...d.data()
      }));
    }catch(e){
      console.error("Error loading event vendors", e);
      eventVendors = [];
    }
  }

  async function loadOrders(){
    eventOrders = [];
    try{
      let query = db.collection("orders").where("eventId","==",eventId);
      // try orderBy(createdAt) if index exists
      try{
        query = query.orderBy("createdAt","desc").limit(400);
        const snap = await query.get();
        eventOrders = snap.docs.map(d => ({ _id: d.id, ...d.data() }));
      }catch(inner){
        console.warn("orders orderBy index missing, fallback without orderBy", inner);
        const snap = await db.collection("orders").where("eventId","==",eventId).get();
        eventOrders = snap.docs.map(d => ({ _id: d.id, ...d.data() }));
      }
    }catch(e){
      console.error("Error loading orders", e);
      eventOrders = [];
    }
  }

  async function deriveCustomersFromOrders(){
    const map = new Map();
    for(const o of eventOrders){
      const customer = o.customer || {};
      const phone = (customer.phone || customer.mobile || "").trim();
      const email = (customer.email || "").trim().toLowerCase();
      let key = phone || email;
      if(!key){
        key = o.customerId || o._id; // fallback
      }
      if(!key) continue;

      const total = Number(o.total || 0);
      const isReturn = o.isReturn === true;

      if(!map.has(key)){
        map.set(key,{
          key,
          name: customer.name || "Customer",
          phone: phone || "-",
          email: email || "",
          ordersCount: 0,
          totalSpent: 0
        });
      }
      const item = map.get(key);
      item.ordersCount += 1;
      // Returns reduce spent
      item.totalSpent += isReturn ? -Math.abs(total) : Math.abs(total);
      map.set(key,item);
    }
    eventCustomers = Array.from(map.values());
  }

  function deriveBoothsFromVendors(){
    const booths = [];
    for(const v of eventVendors){
      const vendorName = v.name || v.vendorName || "Vendor";
      const vendorId = v._id;
      const boothLabel = v.boothLabel || v.booth || "";
      const brandId = v.brandId || null;

      // Many events: 1 vendor = 1 booth (or multiple branches). We support:
      // - v.branchIds: array of branchId
      // - v.branches: array of {branchId, boothLabel}
      if(Array.isArray(v.branchIds) && v.branchIds.length){
        for(const bId of v.branchIds){
          booths.push({
            vendorId,
            vendorName,
            brandId,
            branchId: bId,
            boothLabel: boothLabel || bId
          });
        }
      }else if(Array.isArray(v.branches) && v.branches.length){
        for(const b of v.branches){
          booths.push({
            vendorId,
            vendorName,
            brandId,
            branchId: b.branchId || b.id,
            boothLabel: b.boothLabel || boothLabel || (b.branchId || b.id || "Booth")
          });
        }
      }else{
        booths.push({
          vendorId,
          vendorName,
          brandId,
          branchId: null,
          boothLabel: boothLabel || "Booth"
        });
      }
    }
    eventBooths = booths;
  }

  async function initForUser(user){
    // Optionally: check that user is allowed on this event
    // e.g., events/{eventId}.ownerUids includes user.uid
    try{
      await loadEventMeta();
    }catch(e){
      console.error("loadEventMeta failed", e);
      throw e;
    }

    // Set owner avatar/name
    const email = user.email || "";
    const name = email.split("@")[0] || "Event Owner";
    topbarUserNameEl.textContent = name;
    topbarUserAvatarEl.textContent = (name.charAt(0) || "E").toUpperCase();

    // Load all event-related collections
    await Promise.all([
      loadVendors(),
      loadOrders()
    ]);

    await deriveCustomersFromOrders();
    deriveBoothsFromVendors();
    computeAnalyticsAndRender();
  }

  // =========================
  // ANALYTICS
  // =========================

  function computeAnalyticsAndRender(){
    const todayStr = getTodayString();

    let netSalesToday = 0;
    let ordersTodayCount = 0;
    let returnsTodayCount = 0;

    const paymentBuckets = {
      cash: 0,
      card: 0,
      other: 0
    };

    // For ranking vendors and booths
    const vendorStats = new Map(); // vendorId -> {sales, orders}
    const boothStats = new Map();  // branchId or boothLabel

    // For sales curve: group by hour
    const hourBuckets = {};
    for(let h=0;h<24;h++){
      const label = `${String(h).padStart(2,"0")}:00`;
      hourBuckets[label] = 0;
    }

    for(const o of eventOrders){
      const dStr = orderDateString(o);
      const isReturn = o.isReturn === true;
      const total = Math.abs(Number(o.total || 0));

      // Payment method from multiple possible fields:
      const p = o.payment || {};
      const pm = (o.paymentMethod || p.method || p.type || "").toLowerCase();
      let pmKey = "other";
      if(pm.includes("cash")) pmKey = "cash";
      else if(pm.includes("card") || pm.includes("visa") || pm.includes("master")) pmKey = "card";

      // Vendor link: we assume your POS writes vendorId on order, fallback to brandId
      const vendorId = o.vendorId || o.vendorRef || o.brandId || "unknown";
      const branchId = o.branchId || o.boothId || null;

      if(dStr === todayStr){
        // Sales metrics
        const signed = isReturn ? -total : total;
        netSalesToday += signed;

        if(isReturn) returnsTodayCount += 1;
        else ordersTodayCount += 1;

        paymentBuckets[pmKey] += signed;

        // Hour bucket if createdAt exists
        let hourLabel = null;
        if(o.createdAt && o.createdAt.toDate){
          const d = o.createdAt.toDate();
          const h = d.getHours();
          hourLabel = `${String(h).padStart(2,"0")}:00`;
        }
        if(hourLabel && hourBuckets.hasOwnProperty(hourLabel)){
          hourBuckets[hourLabel] += signed;
        }
      }

      // Vendor stats (whole event, not just today)
      if(!vendorStats.has(vendorId)){
        vendorStats.set(vendorId,{sales:0,orders:0});
      }
      const vItem = vendorStats.get(vendorId);
      vItem.sales += isReturn ? -total : total;
      vItem.orders += 1;
      vendorStats.set(vendorId,vItem);

      // Booth stats
      if(branchId){
        if(!boothStats.has(branchId)){
          boothStats.set(branchId,{sales:0,orders:0});
        }
        const bItem = boothStats.get(branchId);
        bItem.sales += isReturn ? -total : total;
        bItem.orders += 1;
        boothStats.set(branchId,bItem);
      }
    }

    // Save stats to global so renderers can use them
    window.__eventVendorStats = vendorStats;
    window.__eventBoothStats = boothStats;

    // KPIs
    kpiSalesTodayEl.textContent = money(netSalesToday);
    const salesNote = ordersTodayCount > 0
      ? `${ordersTodayCount} orders · ${returnsTodayCount} returns`
      : "No orders yet today.";
    kpiSalesTodayNoteEl.textContent = salesNote;
    kpiOrdersTodayEl.textContent = ordersTodayCount;
    kpiReturnsTodayEl.textContent = returnsTodayCount;

    const activeVendorIdsToday = new Set();
    for(const [vendorId, stats] of vendorStats.entries()){
      if(stats.orders > 0){
        activeVendorIdsToday.add(vendorId);
      }
    }
    kpiActiveVendorsEl.textContent = activeVendorIdsToday.size;
    kpiTotalVendorsNoteEl.textContent = `${eventVendors.length} total vendors in event.`;
    sidebarVendorsCountEl.textContent = String(eventVendors.length);

    // Booth metrics
    const activeBoothIds = new Set();
    for(const [bId, stats] of boothStats.entries()){
      if(stats.orders > 0){
        activeBoothIds.add(bId);
      }
    }
    kpiActiveBoothsEl.textContent = activeBoothIds.size;
    kpiTotalBoothsNoteEl.textContent = `${eventBooths.length} booths configured.`;
    sidebarBoothsCountEl.textContent = String(eventBooths.length);

    // Orders & customers counts in sidebar
    sidebarOrdersCountEl.textContent = String(eventOrders.length);
    sidebarCustomersCountEl.textContent = String(eventCustomers.length);

    // Payment split label
    const cash = paymentBuckets.cash;
    const card = paymentBuckets.card;
    const other = paymentBuckets.other;
    const totalSplit = cash + card + other;
    if(totalSplit > 0){
      const pct = (v) => Math.round((v/totalSplit)*100);
      kpiPaymentSplitEl.textContent = `Cash ${pct(cash)}% • Card ${pct(card)}% • Other ${pct(other)}%`;
    }else{
      kpiPaymentSplitEl.textContent = "No payments yet today.";
    }

    // Render tables & charts
    renderTopVendorsTable();
    renderRecentOrdersTable();
    renderVendorsTable();
    renderBoothsTable();
    renderOrdersTable();
    renderCustomersTable();
    renderSalesTimelineChart(hourBuckets);
    renderPaymentSplitChart(paymentBuckets);
  }

  // =========================
  // RENDERERS
  // =========================

  function renderTopVendorsTable(){
    const vendorStats = window.__eventVendorStats || new Map();
    if(!eventVendors.length || vendorStats.size === 0){
      topVendorsTableEl.innerHTML = `<div class="table-empty">No vendor sales yet today.</div>`;
      return;
    }

    const rows = eventVendors.map(v => {
      const id = v._id;
      const stats = vendorStats.get(id) || {sales:0,orders:0};
      return {
        vendor: v,
        sales: stats.sales,
        orders: stats.orders
      };
    }).sort((a,b) => b.sales - a.sales).slice(0,5);

    if(!rows.length || rows.every(r => r.sales === 0 && r.orders === 0)){
      topVendorsTableEl.innerHTML = `<div class="table-empty">No vendor sales yet today.</div>`;
      return;
    }

    let html = `<table><thead>
      <tr>
        <th>Vendor</th>
        <th>Booth</th>
        <th>Brand</th>
        <th>Orders</th>
        <th>Sales</th>
      </tr>
    </thead><tbody>`;

    for(const r of rows){
      const v = r.vendor;
      const name = v.name || v.vendorName || "Vendor";
      const booth = v.boothLabel || v.booth || "-";
      const brand = v.brandName || v.brandId || "-";
      html += `<tr>
        <td>${name}</td>
        <td>${booth}</td>
        <td>${brand}</td>
        <td>${r.orders}</td>
        <td>${money(r.sales)}</td>
      </tr>`;
    }

    html += `</tbody></table>`;
    topVendorsTableEl.innerHTML = html;
  }

  function renderRecentOrdersTable(){
    if(!eventOrders.length){
      recentOrdersTableEl.innerHTML = `<div class="table-empty">No orders yet.</div>`;
      return;
    }
    const sorted = [...eventOrders].sort((a,b) => {
      const da = a.createdAt && a.createdAt.toDate ? a.createdAt.toDate().getTime() : 0;
      const db = b.createdAt && b.createdAt.toDate ? b.createdAt.toDate().getTime() : 0;
      return db - da;
    }).slice(0,10);

    let html = `<table><thead>
      <tr>
        <th>Time</th>
        <th>Order</th>
        <th>Vendor</th>
        <th>Booth</th>
        <th>Type</th>
        <th>Total</th>
      </tr>
    </thead><tbody>`;

    for(const o of sorted){
      let timeStr = "-";
      if(o.createdAt && o.createdAt.toDate){
        const d = o.createdAt.toDate();
        timeStr = d.toLocaleTimeString("en-EG",{hour:"2-digit",minute:"2-digit"});
      }
      const isReturn = o.isReturn === true;
      const vendor = o.vendorName || o.vendor || o.brandName || o.brandId || "-";
      const booth = o.boothLabel || o.branchName || o.branchId || "-";
      const typePill = isReturn
        ? `<span class="pill pill-danger">Return</span>`
        : `<span class="pill pill-success">Sale</span>`;
      html += `<tr>
        <td>${timeStr}</td>
        <td>#${o.orderNumber || o._id}</td>
        <td>${vendor}</td>
        <td>${booth}</td>
        <td>${typePill}</td>
        <td>${money(o.total)}</td>
      </tr>`;
    }

    html += `</tbody></table>`;
    recentOrdersTableEl.innerHTML = html;
  }

  function renderVendorsTable(){
    if(!eventVendors.length){
      vendorsTableEl.innerHTML = `<div class="table-empty">No vendors added yet.</div>`;
      return;
    }

    const vendorStats = window.__eventVendorStats || new Map();
    const search = (searchVendorsInput.value || "").toLowerCase();
    const statusFilter = filterVendorStatusSelect.value;

    let rows = eventVendors.map(v => {
      const stats = vendorStats.get(v._id) || {sales:0,orders:0};
      return { vendor: v, sales: stats.sales, orders: stats.orders };
    });

    if(search){
      rows = rows.filter(r => {
        const v = r.vendor;
        const name = (v.name || v.vendorName || "").toLowerCase();
        const brand = (v.brandName || v.brandId || "").toLowerCase();
        const booth = (v.boothLabel || v.booth || "").toLowerCase();
        return name.includes(search) || brand.includes(search) || booth.includes(search);
      });
    }

    if(statusFilter !== "all"){
      rows = rows.filter(r => {
        const v = r.vendor;
        const st = (v.status || "").toLowerCase();
        if(statusFilter === "active") return st === "active";
        if(statusFilter === "inactive") return st && st !== "active";
        return true;
      });
    }

    const sortValue = sortVendorsSelect.value;
    rows.sort((a,b) => {
      const vA = a.vendor;
      const vB = b.vendor;
      if(sortValue === "name-asc"){
        return (vA.name || vA.vendorName || "").localeCompare(vB.name || vB.vendorName || "");
      }
      if(sortValue === "name-desc"){
        return (vB.name || vB.vendorName || "").localeCompare(vA.name || vA.vendorName || "");
      }
      if(sortValue === "sales-desc"){
        return b.sales - a.sales;
      }
      if(sortValue === "sales-asc"){
        return a.sales - b.sales;
      }
      return 0;
    });

    if(!rows.length){
      vendorsTableEl.innerHTML = `<div class="table-empty">No vendors match your filters.</div>`;
      return;
    }

    let html = `<table><thead>
      <tr>
        <th>Vendor</th>
        <th>Booth</th>
        <th>Brand</th>
        <th>Status</th>
        <th>Orders</th>
        <th>Sales</th>
        <th>Dashboard</th>
      </tr>
    </thead><tbody>`;

    for(const r of rows){
      const v = r.vendor;
      const name = v.name || v.vendorName || "Vendor";
      const booth = v.boothLabel || v.booth || "-";
      const brand = v.brandName || v.brandId || "-";
      const st = (v.status || "active").toLowerCase();
      const pillClass = st === "active" ? "pill-success" : "pill";
      const statusLabel = st === "active" ? "Active" : "Inactive";
      const brandId = v.brandId || "";
      const vendorId = v._id;

      html += `<tr>
        <td>${name}</td>
        <td>${booth}</td>
        <td>${brand}</td>
        <td><span class="pill ${pillClass}">${statusLabel}</span></td>
        <td>${r.orders}</td>
        <td>${money(r.sales)}</td>
        <td>
          ${brandId ? `<button class="btn btn-ghost" data-act="open-vendor" data-brand-id="${brandId}" data-vendor-id="${vendorId}" style="font-size:11px;padding:4px 8px;">Open Vendor</button>` : `<span class="panel-subtitle">Not linked</span>`}
        </td>
      </tr>`;
    }

    html += `</tbody></table>`;
    vendorsTableEl.innerHTML = html;
  }

  function renderBoothsTable(){
    if(!eventBooths.length){
      boothsTableEl.innerHTML = `<div class="table-empty">No booths found for this event.</div>`;
      return;
    }
    const search = (searchBoothsInput.value || "").toLowerCase();
    const sortValue = sortBoothsSelect.value;

    let rows = [...eventBooths];

    if(search){
      rows = rows.filter(b => {
        const booth = (b.boothLabel || "").toLowerCase();
        const vendor = (b.vendorName || "").toLowerCase();
        const id = (b.branchId || "").toLowerCase();
        return booth.includes(search) || vendor.includes(search) || id.includes(search);
      });
    }

    const vendorStats = window.__eventVendorStats || new Map();
    const boothStats = window.__eventBoothStats || new Map();

    rows.sort((a,b) => {
      if(sortValue === "name-asc"){
        return (a.boothLabel || "").localeCompare(b.boothLabel || "");
      }
      if(sortValue === "name-desc"){
        return (b.boothLabel || "").localeCompare(a.boothLabel || "");
      }
      if(sortValue === "vendor-asc"){
        return (a.vendorName || "").localeCompare(b.vendorName || "");
      }
      return 0;
    });

    let html = `<table><thead>
      <tr>
        <th>Booth</th>
        <th>Vendor</th>
        <th>Branch ID</th>
        <th>Orders</th>
        <th>Sales</th>
      </tr>
    </thead><tbody>`;

    for(const b of rows){
      const stats = b.branchId ? (boothStats.get(b.branchId) || {sales:0,orders:0}) : {sales:0,orders:0};
      html += `<tr>
        <td>${b.boothLabel || "-"}</td>
        <td>${b.vendorName || "-"}</td>
        <td>${b.branchId || "-"}</td>
        <td>${stats.orders}</td>
        <td>${money(stats.sales)}</td>
      </tr>`;
    }

    html += `</tbody></table>`;
    boothsTableEl.innerHTML = html;
  }

  function renderOrdersTable(){
    if(!eventOrders.length){
      ordersTableEl.innerHTML = `<div class="table-empty">No orders yet.</div>`;
      return;
    }

    const search = (searchOrdersInput.value || "").toLowerCase();
    const typeFilter = filterOrderTypeSelect.value;
    const sortValue = sortOrdersSelect.value;

    let rows = [...eventOrders];

    if(search){
      rows = rows.filter(o => {
        const id = (o.orderNumber || o._id || "").toString().toLowerCase();
        const vendor = (o.vendorName || o.vendor || o.brandName || o.brandId || "").toLowerCase();
        const customer = ((o.customer && o.customer.name) || "").toLowerCase();
        return id.includes(search) || vendor.includes(search) || customer.includes(search);
      });
    }

    if(typeFilter !== "all"){
      rows = rows.filter(o => {
        const isReturn = o.isReturn === true;
        if(typeFilter === "sale") return !isReturn;
        if(typeFilter === "return") return isReturn;
        return true;
      });
    }

    rows.sort((a,b) => {
      if(sortValue === "date-desc"){
        const da = a.createdAt && a.createdAt.toDate ? a.createdAt.toDate().getTime() : 0;
        const db = b.createdAt && b.createdAt.toDate ? b.createdAt.toDate().getTime() : 0;
        return db - da;
      }
      if(sortValue === "date-asc"){
        const da = a.createdAt && a.createdAt.toDate ? a.createdAt.toDate().getTime() : 0;
        const db = b.createdAt && b.createdAt.toDate ? b.createdAt.toDate().getTime() : 0;
        return da - db;
      }
      if(sortValue === "total-desc"){
        return (Number(b.total || 0) - Number(a.total || 0));
      }
      if(sortValue === "total-asc"){
        return (Number(a.total || 0) - Number(b.total || 0));
      }
      return 0;
    });

    if(!rows.length){
      ordersTableEl.innerHTML = `<div class="table-empty">No orders match your filters.</div>`;
      return;
    }

    let html = `<table><thead>
      <tr>
        <th>Date</th>
        <th>Order</th>
        <th>Vendor</th>
        <th>Booth</th>
        <th>Type</th>
        <th>Total</th>
        <th>Payment</th>
      </tr>
    </thead><tbody>`;

    for(const o of rows){
      let dateStr = "-";
      if(o.createdAt && o.createdAt.toDate){
        const d = o.createdAt.toDate();
        dateStr = d.toLocaleString("en-EG",{month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"});
      }else{
        dateStr = orderDateString(o);
      }
      const isReturn = o.isReturn === true;
      const vendor = o.vendorName || o.vendor || o.brandName || o.brandId || "-";
      const booth = o.boothLabel || o.branchName || o.branchId || "-";
      const typePill = isReturn
        ? `<span class="pill pill-danger">Return</span>`
        : `<span class="pill pill-success">Sale</span>`;
      const p = o.payment || {};
      const pm = o.paymentMethod || p.method || p.type || "-";
      html += `<tr>
        <td>${dateStr}</td>
        <td>#${o.orderNumber || o._id}</td>
        <td>${vendor}</td>
        <td>${booth}</td>
        <td>${typePill}</td>
        <td>${money(o.total)}</td>
        <td>${pm}</td>
      </tr>`;
    }

    html += `</tbody></table>`;
    ordersTableEl.innerHTML = html;
  }

  function renderCustomersTable(){
    if(!eventCustomers.length){
      customersTableEl.innerHTML = `<div class="table-empty">No customers yet.</div>`;
      return;
    }

    const search = (searchCustomersInput.value || "").toLowerCase();
    const sortValue = sortCustomersSelect.value;

    let rows = [...eventCustomers];

    if(search){
      rows = rows.filter(c => {
        return (
          (c.name || "").toLowerCase().includes(search) ||
          (c.phone || "").toLowerCase().includes(search) ||
          (c.email || "").toLowerCase().includes(search)
        );
      });
    }

    rows.sort((a,b) => {
      if(sortValue === "name-asc"){
        return (a.name || "").localeCompare(b.name || "");
      }
      if(sortValue === "name-desc"){
        return (b.name || "").localeCompare(a.name || "");
      }
      if(sortValue === "total-desc"){
        return b.totalSpent - a.totalSpent;
      }
      if(sortValue === "orders-desc"){
        return b.ordersCount - a.ordersCount;
      }
      return 0;
    });

    if(!rows.length){
      customersTableEl.innerHTML = `<div class="table-empty">No customers match your filters.</div>`;
      return;
    }

    let html = `<table><thead>
      <tr>
        <th>Name</th>
        <th>Phone</th>
        <th>Email</th>
        <th>Orders</th>
        <th>Total spent</th>
      </tr>
    </thead><tbody>`;

    for(const c of rows){
      html += `<tr>
        <td>${c.name}</td>
        <td>${c.phone}</td>
        <td>${c.email || "-"}</td>
        <td>${c.ordersCount}</td>
        <td>${money(c.totalSpent)}</td>
      </tr>`;
    }

    html += `</tbody></table>`;
    customersTableEl.innerHTML = html;
  }

  // =========================
  // CHARTS
  // =========================

  function renderSalesTimelineChart(hourBuckets){
    const ctx = document.getElementById("chartSalesTimeline");
    if(!ctx) return;

    const labels = Object.keys(hourBuckets);
    const values = labels.map(l => hourBuckets[l]);

    if(salesTimelineChart){
      salesTimelineChart.destroy();
    }
    salesTimelineChart = new Chart(ctx,{
      type:"line",
      data:{
        labels,
        datasets:[{
          label:"Sales (today)",
          data:values,
          borderWidth:2,
          fill:false,
          tension:0.25
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{display:false}
        },
        scales:{
          x:{grid:{display:false}},
          y:{grid:{color:"#e5e7eb"}}
        }
      }
    });
  }

  function renderPaymentSplitChart(paymentBuckets){
    const ctx = document.getElementById("chartPaymentSplit");
    if(!ctx) return;

    const labels = ["Cash","Card","Other"];
    const values = [
      paymentBuckets.cash || 0,
      paymentBuckets.card || 0,
      paymentBuckets.other || 0
    ];

    if(paymentSplitChart){
      paymentSplitChart.destroy();
    }
    paymentSplitChart = new Chart(ctx,{
      type:"doughnut",
      data:{
        labels,
        datasets:[{
          data:values
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{position:"bottom"}
        },
        cutout:"60%"
      }
    });
  }

  // =========================
  // NAVIGATION
  // =========================

  const pages = qsa(".page");
  const navItems = qsa(".nav-item");
  const goVendorsBtn = qs("#btn-go-vendors");

  function setActivePage(pageId){
    pages.forEach(p => {
      p.classList.toggle("active", p.id === pageId);
    });
    navItems.forEach(n => {
      n.classList.toggle("active", n.dataset.page === pageId);
    });

    if(pageId === "page-overview"){
      topbarTitleEl.textContent = "Live Overview";
      topbarSubtitleEl.textContent = `Today’s performance for ${eventData?.name || "the event"}.`;
    }else if(pageId === "page-vendors"){
      topbarTitleEl.textContent = "Vendors";
      topbarSubtitleEl.textContent = "Manage vendors linked to this event and open their dashboards.";
    }else if(pageId === "page-booths"){
      topbarTitleEl.textContent = "Booths / Branches";
      topbarSubtitleEl.textContent = "All booths inside the event mapped to vendor branches.";
    }else if(pageId === "page-orders"){
      topbarTitleEl.textContent = "Orders";
      topbarSubtitleEl.textContent = "All sales and returns made inside this event.";
    }else if(pageId === "page-customers"){
      topbarTitleEl.textContent = "Customers";
      topbarSubtitleEl.textContent = "Customers who bought from any vendor in this event.";
    }else if(pageId === "page-settings"){
      topbarTitleEl.textContent = "Event Settings";
      topbarSubtitleEl.textContent = "Edit event details and understand vendor linking.";
    }
  }

  navItems.forEach(item => {
    item.addEventListener("click", () => {
      const pageId = item.dataset.page;
      if(!pageId) return;
      setActivePage(pageId);
    });
  });

  if(goVendorsBtn){
    goVendorsBtn.addEventListener("click", () => {
      setActivePage("page-vendors");
    });
  }

  // =========================
  // MODALS (ADD VENDOR etc.)
  // =========================

  const addVendorBtn = qs("#btn-add-vendor");
  const exportVendorsBtn = qs("#btn-export-vendors");
  const exportBoothsBtn = qs("#btn-export-booths");
  const exportOrdersBtn = qs("#btn-export-orders");
  const exportCustomersBtn = qs("#btn-export-customers");

  if(addVendorBtn){
    addVendorBtn.addEventListener("click", () => {
      const html = `
        <div class="modal-title">Add Vendor to Event</div>
        <div class="modal-subtitle">
          Link a vendor to this event. This will create a record under
          <strong>/events/${eventId}/vendors</strong> and connect it to its brand in Store OS.
        </div>
        <form id="addVendorForm">
          <div class="field">
            <div class="field-label">Vendor Name</div>
            <input id="vendorName" class="field-input" placeholder="Oudies, Nizu, ..." required/>
          </div>
          <div class="field">
            <div class="field-label">Brand ID (Store OS)</div>
            <input id="brandId" class="field-input" placeholder="brands/{brandId}" required/>
            <div class="field-hint">Use the brandId from the Luma Store OS Brand Dashboard.</div>
          </div>
          <div class="field">
            <div class="field-label">Brand Name (optional)</div>
            <input id="brandName" class="field-input" placeholder="If different from vendor name"/>
          </div>
          <div class="field">
            <div class="field-label">Booth Label</div>
            <input id="boothLabel" class="field-input" placeholder="Booth A12, Tent C3, ..." />
          </div>
          <div class="field">
            <div class="field-label">Branch IDs (optional)</div>
            <input id="branchIds" class="field-input" placeholder="branch1, branch2, ..." />
            <div class="field-hint">
              If you use multiple branches for the same vendor, enter the branch IDs (comma separated).
            </div>
          </div>
          <div class="field">
            <div class="field-label">Status</div>
            <select id="vendorStatus" class="field-input">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
          <div class="field">
            <div class="field-label">Contact Phone (optional)</div>
            <input id="vendorPhone" class="field-input" placeholder="+20..." />
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-ghost" id="btnCancelAddVendor">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Vendor</button>
          </div>
        </form>
      `;
      openModal(html);

      const form = modalContent.querySelector("#addVendorForm");
      const cancelBtn = modalContent.querySelector("#btnCancelAddVendor");

      cancelBtn.addEventListener("click", () => closeModal());

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = form.querySelector("#vendorName").value.trim();
        const brandId = form.querySelector("#brandId").value.trim();
        const brandName = form.querySelector("#brandName").value.trim();
        const boothLabel = form.querySelector("#boothLabel").value.trim();
        const branchIdsRaw = form.querySelector("#branchIds").value.trim();
        const status = form.querySelector("#vendorStatus").value;
        const phone = form.querySelector("#vendorPhone").value.trim();

        if(!name || !brandId){
          showAlert("Vendor name and brand ID are required.","error");
          return;
        }

        const branchIds = branchIdsRaw
          ? branchIdsRaw.split(",").map(s => s.trim()).filter(Boolean)
          : [];

        try{
          showLoading(true);
          const ref = db.collection("events").doc(eventId).collection("vendors");
          await ref.add({
            name,
            brandId,
            brandName: brandName || name,
            boothLabel: boothLabel || "",
            branchIds,
            status,
            phone,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          showAlert("Vendor added & linked to event.");
          closeModal();
          await loadVendors();
          deriveBoothsFromVendors();
          computeAnalyticsAndRender();
          setActivePage("page-vendors");
        }catch(e){
          console.error("Error adding vendor", e);
          showAlert("Could not add vendor. Check console.","error");
        }finally{
          showLoading(false);
        }
      });
    });
  }

  // Export helpers
  function exportToXlsx(filename, rows, headers){
    if(!rows || !rows.length){
      showAlert("Nothing to export.","error");
      return;
    }
    const sheetData = [headers.map(h => h.label)];
    for(const r of rows){
      sheetData.push(headers.map(h => (r[h.key] ?? "")));
    }
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(sheetData);
    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    XLSX.writeFile(wb, filename);
  }

  if(exportVendorsBtn){
    exportVendorsBtn.addEventListener("click", () => {
      const vendorStats = window.__eventVendorStats || new Map();
      const rows = eventVendors.map(v => {
        const stats = vendorStats.get(v._id) || {sales:0,orders:0};
        return {
          name: v.name || v.vendorName || "",
          brandId: v.brandId || "",
          brandName: v.brandName || "",
          boothLabel: v.boothLabel || v.booth || "",
          status: v.status || "active",
          phone: v.phone || "",
          orders: stats.orders,
          sales: stats.sales
        };
      });
      exportToXlsx("event-vendors.xlsx", rows, [
        {key:"name",label:"Vendor Name"},
        {key:"brandId",label:"Brand ID"},
        {key:"brandName",label:"Brand Name"},
        {key:"boothLabel",label:"Booth"},
        {key:"status",label:"Status"},
        {key:"phone",label:"Phone"},
        {key:"orders",label:"Orders"},
        {key:"sales",label:"Sales"}
      ]);
    });
  }

  if(exportBoothsBtn){
    exportBoothsBtn.addEventListener("click", () => {
      const boothStats = window.__eventBoothStats || new Map();
      const rows = eventBooths.map(b => {
        const stats = b.branchId ? (boothStats.get(b.branchId) || {sales:0,orders:0}) : {sales:0,orders:0};
        return {
          booth: b.boothLabel || "",
          vendor: b.vendorName || "",
          branchId: b.branchId || "",
          sales: stats.sales,
          orders: stats.orders
        };
      });
      exportToXlsx("event-booths.xlsx", rows, [
        {key:"booth",label:"Booth"},
        {key:"vendor",label:"Vendor"},
        {key:"branchId",label:"Branch ID"},
        {key:"orders",label:"Orders"},
        {key:"sales",label:"Sales"}
      ]);
    });
  }

  if(exportOrdersBtn){
    exportOrdersBtn.addEventListener("click", () => {
      const rows = eventOrders.map(o => {
        let dateStr = "-";
        if(o.createdAt && o.createdAt.toDate){
          const d = o.createdAt.toDate();
          dateStr = d.toISOString();
        }else{
          dateStr = orderDateString(o);
        }
        const isReturn = o.isReturn === true;
        const p = o.payment || {};
        const pm = o.paymentMethod || p.method || p.type || "";
        return {
          id: o._id,
          orderNumber: o.orderNumber || "",
          date: dateStr,
          vendor: o.vendorName || o.vendor || o.brandName || o.brandId || "",
          booth: o.boothLabel || o.branchName || o.branchId || "",
          type: isReturn ? "Return" : "Sale",
          total: o.total || 0,
          paymentMethod: pm
        };
      });
      exportToXlsx("event-orders.xlsx", rows, [
        {key:"date",label:"Date"},
        {key:"orderNumber",label:"Order #"},
        {key:"vendor",label:"Vendor"},
        {key:"booth",label:"Booth"},
        {key:"type",label:"Type"},
        {key:"total",label:"Total"},
        {key:"paymentMethod",label:"Payment Method"},
        {key:"id",label:"Order ID"}
      ]);
    });
  }

  if(exportCustomersBtn){
    exportCustomersBtn.addEventListener("click", () => {
      const rows = eventCustomers.map(c => ({
        name: c.name,
        phone: c.phone,
        email: c.email,
        orders: c.ordersCount,
        totalSpent: c.totalSpent
      }));
      exportToXlsx("event-customers.xlsx", rows, [
        {key:"name",label:"Name"},
        {key:"phone",label:"Phone"},
        {key:"email",label:"Email"},
        {key:"orders",label:"Orders"},
        {key:"totalSpent",label:"Total Spent"}
      ]);
    });
  }

  // Link "Open Vendor" button → brand dashboard (THIS LINKS TO CURRENT VENDOR)
  vendorsTableEl.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-act='open-vendor']");
    if(!btn) return;
    const brandId = btn.dataset.brandId;
    const vendorId = btn.dataset.vendorId;
    if(!brandId){
      showAlert("This vendor is not linked to a brand yet.","error");
      return;
    }

    // TODO: change this URL to your actual brand dashboard path (e.g. /brand.html)
    const url = `/brand.html?brandId=${encodeURIComponent(brandId)}&eventId=${encodeURIComponent(eventId)}&vendorId=${encodeURIComponent(vendorId)}`;
    window.open(url,"_blank");
  });

  // =========================
  // SETTINGS SAVE
  // =========================

  const saveEventSettingsBtn = qs("#btn-save-event-settings");
  if(saveEventSettingsBtn){
    saveEventSettingsBtn.addEventListener("click", async () => {
      if(!eventId) return;
      const name = setEventNameInput.value.trim();
      const venue = setEventVenueInput.value.trim();
      const dates = setEventDatesInput.value.trim();
      const file = setEventLogoInput.files?.[0];

      try{
        showLoading(true);
        const ref = db.collection("events").doc(eventId);
        const update = {
          name,
          venue,
          dateRange: dates
        };
        if(file){
          const url = await uploadImageToStorage(file, `events/${eventId}/logo`);
          update.logoUrl = url;
        }
        await ref.set(update,{merge:true});
        showAlert("Event settings saved.");
        await loadEventMeta();
      }catch(e){
        console.error("Save event settings error", e);
        showAlert("Could not save event settings.","error");
      }finally{
        showLoading(false);
      }
    });
  }

  // =========================
  // FILTER HANDLERS
  // =========================

  if(searchVendorsInput) searchVendorsInput.addEventListener("input", () => renderVendorsTable());
  if(filterVendorStatusSelect) filterVendorStatusSelect.addEventListener("change", () => renderVendorsTable());
  if(sortVendorsSelect) sortVendorsSelect.addEventListener("change", () => renderVendorsTable());

  if(searchBoothsInput) searchBoothsInput.addEventListener("input", () => renderBoothsTable());
  if(sortBoothsSelect) sortBoothsSelect.addEventListener("change", () => renderBoothsTable());

  if(searchOrdersInput) searchOrdersInput.addEventListener("input", () => renderOrdersTable());
  if(filterOrderTypeSelect) filterOrderTypeSelect.addEventListener("change", () => renderOrdersTable());
  if(sortOrdersSelect) sortOrdersSelect.addEventListener("change", () => renderOrdersTable());

  if(searchCustomersInput) searchCustomersInput.addEventListener("input", () => renderCustomersTable());
  if(sortCustomersSelect) sortCustomersSelect.addEventListener("change", () => renderCustomersTable());

  // Initial page
  setActivePage("page-overview");

</script>
</body>
</html>
