<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Luma Events — Owner Analytics OS</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- Chart.js (for all charts) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#f3f4f6;
      --panel:#ffffff;
      --panel-soft:#f9fafb;
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#2563eb;
      --accent-soft:#dbeafe;
      --accent-strong:#1d4ed8;
      --ok:#16a34a;
      --danger:#ef4444;
      --radius:16px;
      --shadow:0 18px 40px rgba(15,23,42,.12);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      font-family:"Montserrat",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--ink);
    }

    /* AUTH WRAPPER */
    .auth-wrapper{
      width:100%;
      max-width:460px;
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(148,163,184,.3);
      padding:18px;
      margin:40px auto;
    }
    .auth-header{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
    }
    .auth-logo{
      width:38px;height:38px;border-radius:999px;
      background:linear-gradient(135deg,#2563eb,#a855f7);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;font-size:18px;
      overflow:hidden;
      background-size:cover;
      background-position:center;
    }
    .auth-title{font-size:17px;font-weight:700;}
    .auth-subtitle{font-size:11px;color:var(--muted);margin-top:2px;}

    .auth-tabs{
      display:flex;gap:6px;margin:10px 0 12px;
    }
    .auth-tab{
      flex:1;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--panel-soft);
      color:var(--muted);
      font-size:12px;
      cursor:pointer;
      text-align:center;
    }
    .auth-tab.active{
      background:var(--accent-soft);
      border-color:var(--accent-soft);
      color:var(--accent-strong);
      font-weight:600;
    }
    .auth-alert{
      padding:8px 10px;
      border-radius:10px;
      font-size:11px;
      margin-bottom:10px;
    }
    .auth-alert-error{background:#fef2f2;color:#b91c1c;border:1px solid #fecaca;}
    .auth-alert-info{background:#eff6ff;color:#1d4ed8;border:1px solid #bfdbfe;}

    .field{margin-bottom:10px;}
    .field-label{font-size:11px;margin-bottom:4px;color:#4b5563;}
    .field-input,.field-select{
      width:100%;padding:8px;border-radius:9px;
      border:1px solid var(--border);background:#f9fafb;font-size:12px;
    }
    .field-input:focus,.field-select:focus{
      outline:none;border-color:var(--accent);box-shadow:0 0 0 1px var(--accent-soft);
    }
    .field-hint{font-size:10px;color:var(--muted);margin-top:3px;}

    .btn{
      border:none;border-radius:999px;
      padding:8px 12px;font-size:12px;font-weight:600;
      cursor:pointer;display:inline-flex;align-items:center;justify-content:center;
      gap:6px;
    }
    .btn:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    .btn-primary{background:var(--accent);color:#fff;}
    .btn-primary:hover{background:var(--accent-strong);}
    .btn-ghost{
      background:transparent;color:var(--accent-strong);
      border:1px solid var(--accent-soft);
    }
    .btn-ghost:hover{background:var(--accent-soft);}
    .btn-danger{background:var(--danger);color:#fff;}
    .btn-danger:hover{background:#b91c1c;}

    .auth-footer{text-align:center;margin-top:8px;font-size:10px;color:var(--muted);}

    /* APP LAYOUT */
    .app-shell{
      height:100vh;
      width:100%;
      display:flex;
    }

    .sidebar{
      width:220px;background:var(--panel);
      border-right:1px solid var(--border);
      display:flex;flex-direction:column;
      padding:20px 12px;
    }
    .sidebar-brand{
      display:flex;align-items:center;gap:10px;margin-bottom:18px;
    }
    .sidebar-logo{
      width:36px;height:36px;border-radius:999px;
      background:linear-gradient(135deg,#2563eb,#a855f7);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;
      overflow:hidden;
      background-size:cover;
      background-position:center;
    }
    .sidebar-brand-name{font-size:15px;font-weight:700;}
    .sidebar-nav{
      display:flex;flex-direction:column;gap:6px;margin-top:10px;flex:1;
    }
    .nav-item{
      padding:9px 12px;border-radius:10px;
      cursor:pointer;font-size:13px;
      border:none;background:transparent;text-align:left;color:var(--ink);
    }
    .nav-item:hover{background:var(--panel-soft);}
    .nav-item.active{background:var(--accent-soft);color:var(--accent-strong);font-weight:600;}
    .nav-item.logout{
      margin-top:auto;
      background:#fee2e2;
      color:#b91c1c;
      border:1px solid #fecaca;
    }
    .nav-item.logout:hover{background:#fecaca;}

    .topbar{
      height:78px;background:var(--panel);
      border-bottom:1px solid var(--border);
      padding:12px 18px;
      display:flex;justify-content:space-between;align-items:center;
      gap:12px;
    }
    .topbar-left{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .topbar-title{font-size:16px;font-weight:700;}
    .topbar-sub{font-size:11px;color:var(--muted);}
    .topbar-right{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      font-size:12px;
    }
    .topbar-select{
      padding:6px 9px;border-radius:8px;
      border:1px solid var(--border);background:var(--panel-soft);
      font-size:12px;
    }

    .date-filter{
      display:inline-flex;
      gap:6px;
      background:var(--panel-soft);
      border-radius:999px;
      padding:3px;
      border:1px solid var(--border);
    }
    .date-chip{
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      border:none;
      background:transparent;
      cursor:pointer;
      color:var(--muted);
    }
    .date-chip.active{
      background:var(--accent-soft);
      color:var(--accent-strong);
      font-weight:600;
    }

    .content-area{
      flex:1;
      padding:18px;
      overflow-y:auto;
      background:var(--bg);
    }
    .page{display:none;}
    .page.active{display:block;}

    .page-header{
      display:flex;justify-content:space-between;
      align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:10px;
    }
    .page-title{font-size:18px;font-weight:700;}
    .page-sub{font-size:12px;color:var(--muted);}
    .page-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}

    .cards-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:12px;margin-bottom:18px;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px 18px;
      box-shadow:var(--shadow);
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:6px;
      margin-bottom:4px;
    }
    .card-title{font-size:13px;color:var(--muted);}
    .card-number{font-size:20px;font-weight:700;}
    .card-note{font-size:11px;color:var(--muted);margin-top:6px;}
    .badge{
      display:inline-flex;
      align-items:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:10px;
      background:var(--accent-soft);
      color:var(--accent-strong);
      font-weight:600;
      white-space:nowrap;
    }
    .badge-danger{
      background:#fee2e2;
      color:#b91c1c;
    }
    .badge-warning{
      background:#fef3c7;
      color:#92400e;
    }
    .readiness-list{
      list-style:none;
      margin-top:10px;
      display:grid;
      gap:8px;
      font-size:12px;
    }
    .readiness-item{
      display:flex;
      align-items:flex-start;
      gap:8px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel-soft);
    }
    .readiness-item p{margin:0;color:var(--muted);}
    .status-pill{
      display:inline-flex;
      align-items:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:10px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.04em;
    }
    .status-blocked{
      background:#fee2e2;
      color:#b91c1c;
    }
    .status-inprogress{
      background:#fef3c7;
      color:#92400e;
    }
    .status-ready{
      background:#dcfce7;
      color:#166534;
    }
    .system-banner{
      margin-top:8px;
      margin-bottom:10px;
    }
    .system-controls{
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:12px;
    }
    .system-controls label{
      display:flex;
      gap:8px;
      align-items:flex-start;
    }
    .admin-card{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .admin-metric{
      font-size:20px;
      font-weight:700;
    }

    .split-grid-2{
      display:grid;
      grid-template-columns:minmax(0,2fr) minmax(0,1.3fr);
      gap:12px;
      margin-bottom:18px;
    }
    .section-title-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:6px;
    }
    .section-title{
      font-size:14px;
      font-weight:600;
    }
    .section-sub{
      font-size:11px;
      color:var(--muted);
    }

    .chart-container{
      position:relative;
      height:220px;
      width:100%;
    }

    .table-wrapper{
      background:#fff;border-radius:12px;border:1px solid var(--border);
      overflow-x:auto;
    }
    table{width:100%;border-collapse:collapse;font-size:12px;}
    thead{background:var(--panel-soft);}
    th,td{padding:9px 10px;border-bottom:1px solid var(--border);text-align:left;}
    th{
      font-size:11px;text-transform:uppercase;color:var(--muted);
      letter-spacing:.04em;
    }
    tbody tr:hover{background:#f9fafb;}
    .table-empty{text-align:center;padding:20px;font-size:12px;color:var(--muted);}

    .pill-filters{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .pill{
      border-radius:999px;
      border:1px solid var(--border);
      padding:4px 10px;
      font-size:11px;
      background:var(--panel-soft);
      cursor:pointer;
      color:var(--muted);
    }
    .pill.active{
      background:var(--accent-soft);
      border-color:var(--accent-soft);
      color:var(--accent-strong);
      font-weight:600;
    }

    .search-input{
      padding:6px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#f9fafb;
      font-size:12px;
      min-width:180px;
    }

    .live-feed{
      display:flex;
      flex-direction:column;
      gap:6px;
      max-height:260px;
      overflow-y:auto;
      padding-top:4px;
    }
    .feed-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      padding:6px 0;
      border-bottom:1px dashed rgba(148,163,184,.4);
      font-size:11px;
    }
    .feed-main{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .feed-top-row{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .feed-brand{
      font-weight:600;
      font-size:11px;
    }
    .feed-time{
      font-size:10px;
      color:var(--muted);
    }
    .feed-right{
      text-align:right;
    }
    .feed-amount{
      font-weight:600;
      font-size:12px;
    }
    .feed-tags{
      display:flex;
      gap:4px;
      justify-content:flex-end;
      margin-top:2px;
    }

    .label{
      display:inline-flex;
      border-radius:6px;
      padding:3px 6px;
      font-size:10px;
      background:var(--panel-soft);
      color:var(--muted);
    }

    @media(max-width:1024px){
      .split-grid-2{
        grid-template-columns:minmax(0,1fr);
      }
    }
    @media(max-width:768px){
      .app-shell{flex-direction:column;}
      .sidebar{width:100%;flex-direction:row;overflow-x:auto;height:auto;}
      .sidebar-nav{flex-direction:row;}
      .topbar{flex-direction:column;align-items:flex-start;gap:6px;height:auto;}
      .topbar-right{justify-content:flex-start;}
    }
  </style>
</head>
<body>

  <!-- AUTH VIEW -->
  <div id="auth-view" class="auth-wrapper">
    <div class="auth-header">
      <div class="auth-logo">E</div>
      <div>
        <div class="auth-title">Luma Events — Owner OS</div>
        <div id="auth-subtitle" class="auth-subtitle">
          Sign in to manage your events and analytics.
        </div>
      </div>
    </div>

    <div id="auth-alert-container" aria-live="polite"></div>
    <div id="system-status-banner" class="auth-alert auth-alert-info system-banner" style="display:none;" aria-live="polite"></div>

    <div class="auth-tabs">
      <button type="button" id="tab-login" class="auth-tab active">Sign in</button>
      <button type="button" id="tab-signup" class="auth-tab">Create account &amp; event</button>
    </div>

    <!-- LOGIN FORM -->
    <form id="login-form">
      <div class="field">
        <div class="field-label">Email</div>
        <input id="login-email" class="field-input" type="email" placeholder="you@example.com" autocomplete="email" required/>
      </div>
      <div class="field">
        <div class="field-label">Password</div>
        <input id="login-password" class="field-input" type="password" placeholder="Your password" autocomplete="current-password" required/>
      </div>
      <button type="submit" id="login-btn" class="btn btn-primary" style="width:100%;">Sign in</button>
    </form>

    <!-- SIGNUP FORM -->
    <form id="signup-form" style="display:none;">
      <div class="field">
        <div class="field-label">Your name</div>
        <input id="signup-name" class="field-input" placeholder="Full name" autocomplete="name" required/>
      </div>
      <div class="field">
        <div class="field-label">Email</div>
        <input id="signup-email" class="field-input" type="email" placeholder="you@example.com" autocomplete="email" required/>
      </div>
      <div class="field">
        <div class="field-label">Password</div>
        <input id="signup-password" class="field-input" type="password" placeholder="Minimum 6 characters" minlength="6" autocomplete="new-password" required/>
      </div>

      <div class="field">
        <div class="field-label">Event name</div>
        <input id="signup-event-name" class="field-input" placeholder="Lokamania 5, Soueast Owners, ..." required/>
      </div>
      <div class="field">
        <div class="field-label">Event location</div>
        <input id="signup-event-location" class="field-input" placeholder="Cairo Festival City, Dubai, ..." autocomplete="address-level2"/>
      </div>
      <div class="field">
        <div class="field-label">Event start date</div>
        <input id="signup-event-start" class="field-input" type="date"/>
      </div>
      <div class="field">
        <div class="field-label">Event end date</div>
        <input id="signup-event-end" class="field-input" type="date"/>
      </div>

      <button type="submit" id="signup-btn" class="btn btn-primary" style="width:100%;">Create account &amp; event</button>
      <div class="field-hint" style="margin-top:6px;">
        This will create your owner account, first event document, and link everything automatically in Firestore.
      </div>
    </form>

    <div class="auth-footer">
      Once signed in, you’ll see your full analytics dashboard, vendor control, customers and more.
    </div>
  </div>

  <!-- APP VIEW -->
  <div id="app-view" class="app-shell" style="display:none;">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-brand">
        <div id="sidebar-event-logo" class="sidebar-logo">E</div>
        <div id="sidebar-event-name" class="sidebar-brand-name">Event</div>
      </div>
      <nav class="sidebar-nav">
        <button class="nav-item active" data-page="page-overview">Overview</button>
        <button class="nav-item" data-page="page-vendors">Vendors</button>
        <button class="nav-item" data-page="page-products">Products &amp; Returns</button>
        <button class="nav-item" data-page="page-customers">Customers</button>
        <button class="nav-item" data-page="page-sales">Sales &amp; POS</button>
        <button id="nav-admin" class="nav-item" data-page="page-admin" style="display:none;">Super Admin</button>
        <button class="nav-item" data-page="page-settings">Event Settings</button>
      </nav>
      <button id="btn-logout" class="nav-item logout">Logout</button>
    </aside>

    <!-- MAIN -->
    <div style="flex:1;display:flex;flex-direction:column;">
      <header class="topbar">
        <div class="topbar-left">
          <div id="topbar-title" class="topbar-title">Event Overview</div>
          <div id="topbar-sub" class="topbar-sub">Monitor vendors, customers, products and live sales</div>
        </div>
        <div class="topbar-right">
          <span id="role-badge" class="badge badge-warning" style="display:none;">Super Admin</span>
          <div>
            <span style="font-size:11px;color:var(--muted);margin-right:4px;">Event:</span>
            <select id="event-select" class="topbar-select">
              <!-- filled by JS -->
            </select>
          </div>
          <div>
            <span style="font-size:11px;color:var(--muted);margin-right:4px;">View:</span>
            <div id="date-filter" class="date-filter">
              <!-- chips injected by JS: General + per-day -->
            </div>
          </div>
        </div>
      </header>

      <main class="content-area">
        <!-- ================= OVERVIEW PAGE ================ -->
        <section id="page-overview" class="page active">
          <!-- Row 1: Hero KPIs -->
          <div class="cards-grid">
            <div class="card">
              <div class="card-header">
                <div class="card-title">Total POS Revenue</div>
                <span id="badge-peak-hour" class="badge" style="display:none;"></span>
              </div>
              <div id="kpi-total-revenue" class="card-number">0.00</div>
              <div class="card-note">All POS sales for this event (current filter).</div>
            </div>
            <div class="card">
              <div class="card-title">Total Orders</div>
              <div id="kpi-total-orders" class="card-number">0</div>
              <div class="card-note">Number of orders across all brands.</div>
            </div>
            <div class="card">
              <div class="card-title">Total Items Sold</div>
              <div id="kpi-items-sold" class="card-number">0</div>
              <div class="card-note">Sum of all item quantities.</div>
            </div>
            <div class="card">
              <div class="card-title">Average Order Value</div>
              <div id="kpi-aov" class="card-number">0.00</div>
              <div class="card-note">Total revenue / number of orders.</div>
            </div>
            <div class="card">
              <div class="card-title">Total Returns</div>
              <div id="kpi-returns" class="card-number">0.00</div>
              <div class="card-note">Refunds and returned orders.</div>
            </div>
            <div class="card">
              <div class="card-title">Net Revenue</div>
              <div id="kpi-net-revenue" class="card-number">0.00</div>
              <div class="card-note">Revenue minus returns.</div>
            </div>
            <div class="card">
              <div class="card-title">Active Brands</div>
              <div id="kpi-active-brands" class="card-number">0</div>
              <div class="card-note">Brands with at least one order.</div>
            </div>
          </div>

          <!-- Row 2: Timeline + Peak Hour -->
          <div class="split-grid-2">
            <div class="card">
              <div class="section-title-row">
                <div>
                  <div class="section-title">Revenue Timeline</div>
                  <div class="section-sub" id="timeline-subtitle">Revenue across event days.</div>
                </div>
                <div class="pill-filters">
                  <button class="pill active" data-timeline-mode="auto" id="btn-timeline-auto">Auto</button>
                  <button class="pill" data-timeline-mode="day" id="btn-timeline-day">By day</button>
                  <button class="pill" data-timeline-mode="hour" id="btn-timeline-hour">By hour</button>
                </div>
              </div>
              <div class="chart-container">
                <canvas id="chart-revenue-timeline"></canvas>
              </div>
            </div>

            <div class="card">
              <div class="section-title-row">
                <div>
                  <div class="section-title">Peak Hour</div>
                  <div class="section-sub">Most intense hour for this view.</div>
                </div>
              </div>
              <div style="margin-top:6px;">
                <div class="card-note">Hour window</div>
                <div id="peak-hour-window" class="card-number" style="font-size:18px;margin-bottom:4px;">—</div>
                <div class="card-note">Revenue in that hour</div>
                <div id="peak-hour-revenue" style="font-weight:600;font-size:14px;margin-bottom:6px;">0.00</div>
                <div class="card-note">Orders in that hour</div>
                <div id="peak-hour-orders" style="font-weight:600;font-size:14px;">0</div>
              </div>
              <div style="margin-top:10px;">
                <div class="section-sub" style="margin-bottom:4px;">Orders by hour (mini)</div>
                <div class="chart-container" style="height:120px;">
                  <canvas id="chart-peak-sparkline"></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- Row 3: Top Vendors snippet -->
          <div class="split-grid-2">
            <div class="card">
              <div class="section-title-row">
                <div>
                  <div class="section-title">Top Vendors</div>
                  <div class="section-sub">Top 3 brands by revenue (current filter).</div>
                </div>
              </div>
              <div id="overview-top-vendors" class="cards-grid" style="margin-top:4px;"></div>
            </div>

            <div class="card">
              <div class="section-title-row">
                <div>
                  <div class="section-title">Payment Mix</div>
                  <div class="section-sub">Cash, card, wallet and others.</div>
                </div>
              </div>
              <div class="chart-container">
                <canvas id="chart-payment-mix"></canvas>
              </div>
              <div id="payment-mini-stats" style="margin-top:8px;font-size:11px;color:var(--muted);display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:4px;"></div>
            </div>
          </div>

          <!-- Row 4: Live feed snippet -->
          <div class="card">
            <div class="section-title-row">
              <div>
                <div class="section-title">Live Activity</div>
                <div class="section-sub">Last 10 orders for this view.</div>
              </div>
            </div>
            <div id="overview-live-feed" class="live-feed">
              <!-- filled by JS -->
            </div>
          </div>
        </section>

        <!-- ================= VENDORS CONTROL PAGE ================ -->
        <section id="page-vendors" class="page">
          <div class="page-header">
            <div>
              <div class="page-title">Vendors</div>
              <div class="page-sub">Approve, reject, suspend and manage vendor POS access.</div>
            </div>
            <div class="page-actions">
              <button id="btn-open-manual-vendor" class="btn btn-primary">Add vendor manually</button>
              <button id="btn-copy-vendor-link" class="btn btn-ghost">Copy vendor signup link</button>
            </div>
          </div>

          <div class="cards-grid" id="vendors-kpis">
            <!-- we can add small kpis here later if needed -->
          </div>

          <div class="page-header" style="margin-top:4px;">
            <div class="pill-filters" id="vendor-status-filters">
              <button class="pill active" data-status="all">All</button>
              <button class="pill" data-status="pending">Pending</button>
              <button class="pill" data-status="approved">Approved</button>
              <button class="pill" data-status="rejected">Rejected</button>
              <button class="pill" data-status="suspended">Suspended</button>
            </div>
            <div class="page-actions">
              <input id="vendor-search" class="search-input" placeholder="Search by brand or owner"/>
              <button id="btn-export-vendors" class="btn btn-ghost">Export vendors CSV</button>
            </div>
          </div>

          <div id="vendors-table-wrapper" class="table-wrapper">
            <!-- vendors table injected here -->
          </div>
        </section>

        <!-- ================= PRODUCTS & RETURNS PAGE ================ -->
        <section id="page-products" class="page">
          <div class="page-header">
            <div>
              <div class="page-title">Products &amp; Returns</div>
              <div class="page-sub">Top-selling products and problem items with high returns.</div>
            </div>
          </div>

          <div class="split-grid-2">
            <div class="card">
              <div class="section-title-row">
                <div>
                  <div class="section-title">Top Products by Revenue</div>
                  <div class="section-sub">Top 5–8 products by total revenue.</div>
                </div>
              </div>
              <div class="chart-container">
                <canvas id="chart-top-products"></canvas>
              </div>
            </div>

            <div class="card">
              <div class="section-title-row">
                <div>
                  <div class="section-title">Problem Products</div>
                  <div class="section-sub">Products with the highest return rates.</div>
                </div>
              </div>
              <div id="problem-products-table-wrapper" class="table-wrapper" style="margin-top:6px;">
                <!-- table injected: Product | Brand | Returns | Return % -->
              </div>
            </div>
          </div>
        </section>

        <!-- ================= CUSTOMERS PAGE ================ -->
        <section id="page-customers" class="page">
          <div class="page-header">
            <div>
              <div class="page-title">Customers</div>
              <div class="page-sub">Top customers by sales and full customer list for this event.</div>
            </div>
            <div class="page-actions">
              <input id="customer-search" class="search-input" placeholder="Search by name, phone or email"/>
              <button id="btn-export-customers" class="btn btn-ghost">Export customers CSV</button>
            </div>
          </div>

          <!-- Top customers cards -->
          <div id="customers-kpis" class="cards-grid">
            <!-- top 3 customers cards -->
          </div>

          <!-- All customers table -->
          <div id="customers-table-wrapper" class="table-wrapper">
            <!-- customers table injected -->
          </div>
        </section>

        <!-- ================= SALES / ORDERS PAGE ================ -->
        <section id="page-sales" class="page">
          <div class="page-header">
            <div>
              <div class="page-title">Sales &amp; POS</div>
              <div class="page-sub">Raw order list across all brands for this event (respecting date filter).</div>
            </div>
            <div class="page-actions">
              <button id="btn-export-orders" class="btn btn-ghost">Export orders CSV</button>
            </div>
          </div>

          <div id="orders-table-wrapper" class="table-wrapper">
            <!-- orders table injected -->
          </div>
        </section>

        <!-- ================= SUPER ADMIN PAGE ================ -->
        <section id="page-admin" class="page">
          <div class="page-header">
            <div>
              <div class="page-title">Super Admin Control Center</div>
              <div class="page-sub">Monitor all events and apply overrides for Luma staff.</div>
            </div>
          </div>

          <div class="cards-grid">
            <div class="card admin-card">
              <div class="card-title">Total Events</div>
              <div id="admin-total-events" class="admin-metric">0</div>
              <div class="card-note">Live count across all events.</div>
            </div>
            <div class="card admin-card">
              <div class="card-title">Total Vendors</div>
              <div id="admin-total-vendors" class="admin-metric">0</div>
              <div class="card-note">All vendors linked to events.</div>
            </div>
            <div class="card admin-card">
              <div class="card-title">Total Orders</div>
              <div id="admin-total-orders" class="admin-metric">0</div>
              <div class="card-note">Orders across all brands and events.</div>
            </div>
            <div class="card admin-card">
              <div class="card-title">Total Revenue</div>
              <div id="admin-total-revenue" class="admin-metric">0.00</div>
              <div class="card-note">Gross revenue across all events.</div>
            </div>
          </div>

          <div class="split-grid-2">
            <div class="card">
              <div class="section-title-row">
                <div>
                  <div class="section-title">Event Oversight</div>
                  <div class="section-sub">Status overrides and high-level ownership data.</div>
                </div>
              </div>
              <div id="admin-events-table-wrapper" class="table-wrapper" style="margin-top:6px;">
                <!-- admin events table injected -->
              </div>
            </div>
            <div class="card">
              <div class="section-title-row">
                <div>
                  <div class="section-title">Global vendor status</div>
                  <div class="section-sub">Pending approvals and override actions.</div>
                </div>
              </div>
              <div id="admin-vendor-summary" style="margin-top:10px;font-size:12px;color:var(--muted);"></div>
            </div>
          </div>
          <div class="cards-grid">
            <div class="card">
              <div class="section-title-row">
                <div>
                  <div class="section-title">System Controls</div>
                  <div class="section-sub">Production toggles stored in Firestore.</div>
                </div>
              </div>
              <div class="system-controls">
                <label>
                  <input id="sys-maintenance-toggle" type="checkbox"/>
                  <span>Maintenance mode (lock non-admin access)</span>
                </label>
                <label>
                  <input id="sys-owner-signup-toggle" type="checkbox"/>
                  <span>Disable owner signups</span>
                </label>
                <label>
                  <input id="sys-brand-signup-toggle" type="checkbox"/>
                  <span>Disable brand signups</span>
                </label>
                <label>
                  <input id="sys-vendor-signup-toggle" type="checkbox"/>
                  <span>Disable vendor signups</span>
                </label>
                <label>
                  <input id="sys-pos-login-toggle" type="checkbox"/>
                  <span>Disable POS logins</span>
                </label>
                <div class="field">
                  <div class="field-label">Maintenance message</div>
                  <textarea id="sys-maintenance-message" class="field-input" rows="2" placeholder="Message shown to staff and vendors."></textarea>
                </div>
                <button id="btn-save-system-settings" class="btn btn-primary" style="align-self:flex-start;">Save system settings</button>
              </div>
            </div>
          </div>
        </section>

        <!-- ================= EVENT SETTINGS PAGE ================ -->
        <section id="page-settings" class="page">
          <div class="page-header">
            <div>
              <div class="page-title">Event Settings</div>
              <div class="page-sub">Edit event name, dates &amp; basic settings.</div>
            </div>
            <div class="page-actions">
              <button id="btn-create-event" class="btn btn-primary">Create new event</button>
            </div>
          </div>
          <div class="cards-grid">
            <div class="card">
              <div class="field">
                <div class="field-label">Event name</div>
                <input id="set-event-name" class="field-input" autocomplete="organization"/>
              </div>
              <div class="field">
                <div class="field-label">Location</div>
                <input id="set-event-location" class="field-input" autocomplete="address-level2"/>
              </div>
              <div class="field">
                <div class="field-label">Start date</div>
                <input id="set-event-start" class="field-input" type="date"/>
              </div>
              <div class="field">
                <div class="field-label">End date</div>
                <input id="set-event-end" class="field-input" type="date"/>
              </div>
              <button id="btn-save-event" class="btn btn-primary" style="margin-top:6px;">Save settings</button>
            </div>
            <div class="card">
              <div class="section-title-row">
                <div>
                  <div class="section-title">Production readiness checklist</div>
                  <div class="section-sub">Track launch blockers before going live.</div>
                </div>
              </div>
              <ul class="readiness-list">
                <li class="readiness-item">
                  <span class="status-pill status-blocked">Blocked</span>
                  <div>
                    <strong>Server-side validation &amp; rate limits</strong>
                    <p>Protect write endpoints against abuse and enforce schema validation.</p>
                  </div>
                </li>
                <li class="readiness-item">
                  <span class="status-pill status-inprogress">In progress</span>
                  <div>
                    <strong>Audit logging &amp; export retention</strong>
                    <p>Capture admin actions and define data retention policies for exports.</p>
                  </div>
                </li>
                <li class="readiness-item">
                  <span class="status-pill status-blocked">Blocked</span>
                  <div>
                    <strong>Security rules review</strong>
                    <p>Verify Firestore rules and role-based access for owners, brands, and POS.</p>
                  </div>
                </li>
                <li class="readiness-item">
                  <span class="status-pill status-inprogress">In progress</span>
                  <div>
                    <strong>Monitoring &amp; alerting</strong>
                    <p>Set up uptime checks, error monitoring, and SLA response workflows.</p>
                  </div>
                </li>
                <li class="readiness-item">
                  <span class="status-pill status-ready">Ready</span>
                  <div>
                    <strong>Operational runbook</strong>
                    <p>Escalation contacts and incident response playbooks documented.</p>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- MODALS -->
  <div id="modal-container" style="position:fixed;inset:0;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,.35);z-index:9999;"></div>

   <script type="module">
  // -----------------------------
  // FIREBASE IMPORTS + CONFIG
  // -----------------------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore,
    doc,
    collection,
    collectionGroup,
    addDoc,
    setDoc,
    getDoc,
    getDocs,
    updateDoc,
    query,
    where,
    orderBy,
    serverTimestamp,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  import {
    getAuth,
    onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    updateProfile,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA80bAAGPuyscnTVS-zwrxE9Jp3tPiS1gM",
    authDomain: "events-339ce.firebaseapp.com",
    projectId: "events-339ce",
    storageBucket: "events-339ce.firebasestorage.app",
    messagingSenderId: "175601544315",
    appId: "1:175601544315:web:00c94b4affa972b3a286de"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const API_BASE = window.location.origin;

  const VENDOR_SIGNUP_BASE_URL = window.location.origin + "/vendor-signup.html";

  // -----------------------------
  // DOM HELPERS
  // -----------------------------
  const qs = (s) => document.querySelector(s);
  const qsa = (s) => document.querySelectorAll(s);

  const authView = qs("#auth-view");
  const appView = qs("#app-view");

  function showAuthView() {
    if (authView) authView.style.display = "block";
    if (appView) appView.style.display = "none";
  }
  function showAppView() {
    if (authView) authView.style.display = "none";
    if (appView) appView.style.display = "flex";
  }

  function formatCurrency(num) {
    const v = Number(num) || 0;
    return v.toFixed(2);
  }

  function copyToClipboard(text) {
    if (!navigator.clipboard) {
      const textarea = document.createElement("textarea");
      textarea.value = text;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand("copy");
      document.body.removeChild(textarea);
      return;
    }
    navigator.clipboard.writeText(text).catch(() => {});
  }

  async function getAuthToken() {
    if (!auth.currentUser) return null;
    return auth.currentUser.getIdToken();
  }

  async function apiRequest(path, options = {}) {
    const token = await getAuthToken();
    const headers = {
      "Content-Type": "application/json",
      ...(options.headers || {})
    };
    if (token) headers.Authorization = `Bearer ${token}`;
    const res = await fetch(`${API_BASE}${path}`, {
      ...options,
      headers
    });
    if (!res.ok) {
      const message = await res.text();
      const err = new Error(message || `Request failed (${res.status})`);
      err.status = res.status;
      throw err;
    }
    return res.json();
  }

  function parseLocalDate(dateStr) {
    if (!dateStr) return null;
    // Expecting YYYY-MM-DD
    const [y, m, d] = dateStr.split("-").map((n) => parseInt(n, 10));
    if (!y || !m || !d) return null;
    return new Date(y, m - 1, d);
  }

  function formatDateKey(date) {
    // YYYY-MM-DD
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  function addDays(date, d) {
    const n = new Date(date);
    n.setDate(n.getDate() + d);
    return n;
  }

  function parseOrderDate(order) {
    // priority: createdAtLocal (string) -> createdAt (Timestamp) -> now
    if (order.createdAtLocal) {
      // try parse as ISO or "YYYY-MM-DD HH:mm"
      const s = order.createdAtLocal;
      const tryDate = new Date(s);
      if (!isNaN(tryDate.getTime())) return tryDate;

      // fallback simple split
      const [datePart, timePart] = s.split(" ");
      const [y, m, d] = datePart.split("-").map((n) => parseInt(n, 10));
      let hour = 0, min = 0;
      if (timePart) {
        const [h, mm] = timePart.split(":").map((n) => parseInt(n, 10));
        hour = h || 0;
        min = mm || 0;
      }
      return new Date(y, (m || 1) - 1, d || 1, hour, min);
    }
    if (order.createdAt && typeof order.createdAt.toDate === "function") {
      return order.createdAt.toDate();
    }
    return new Date();
  }

  function getEventIdFromRef(ref) {
    return ref?.parent?.parent?.id || null;
  }

  function getEventNameById(id) {
    const ev = eventsList.find((e) => e.id === id);
    return ev?.name || "Event";
  }

  // -----------------------------
  // AUTH DOM
  // -----------------------------
  const tabLogin = qs("#tab-login");
  const tabSignup = qs("#tab-signup");
  const loginForm = qs("#login-form");
  const signupForm = qs("#signup-form");
  const authAlertContainer = qs("#auth-alert-container");
  const authSubtitle = qs("#auth-subtitle");
  const systemStatusBannerEl = qs("#system-status-banner");

  const loginEmailEl = qs("#login-email");
  const loginPasswordEl = qs("#login-password");
  const loginBtn = qs("#login-btn");

  const signupNameEl = qs("#signup-name");
  const signupEmailEl = qs("#signup-email");
  const signupPasswordEl = qs("#signup-password");
  const signupEventNameEl = qs("#signup-event-name");
  const signupEventLocationEl = qs("#signup-event-location");
  const signupEventStartEl = qs("#signup-event-start");
  const signupEventEndEl = qs("#signup-event-end");
  const signupBtn = qs("#signup-btn");

  // -----------------------------
  // APP DOM
  // -----------------------------
  const sidebarEventLogoEl = qs("#sidebar-event-logo");
  const sidebarEventNameEl = qs("#sidebar-event-name");
  const topbarTitleEl = qs("#topbar-title");
  const topbarSubtitleEl = qs("#topbar-sub");
  const eventSelectEl = qs("#event-select");
  const dateFilterContainer = qs("#date-filter");
  const roleBadgeEl = qs("#role-badge");
  const navAdminEl = qs("#nav-admin");

  // Overview KPIs
  const kpiTotalRevenueEl = qs("#kpi-total-revenue");
  const kpiTotalOrdersEl = qs("#kpi-total-orders");
  const kpiItemsSoldEl = qs("#kpi-items-sold");
  const kpiAovEl = qs("#kpi-aov");
  const kpiReturnsEl = qs("#kpi-returns");
  const kpiNetRevenueEl = qs("#kpi-net-revenue");
  const kpiActiveBrandsEl = qs("#kpi-active-brands");
  const badgePeakHourEl = qs("#badge-peak-hour");
  const timelineSubtitleEl = qs("#timeline-subtitle");

  const peakHourWindowEl = qs("#peak-hour-window");
  const peakHourRevenueEl = qs("#peak-hour-revenue");
  const peakHourOrdersEl = qs("#peak-hour-orders");
  const overviewTopVendorsEl = qs("#overview-top-vendors");
  const overviewLiveFeedEl = qs("#overview-live-feed");
  const paymentMiniStatsEl = qs("#payment-mini-stats");

  // Timeline mode pills
  const btnTimelineAuto = qs("#btn-timeline-auto");
  const btnTimelineDay = qs("#btn-timeline-day");
  const btnTimelineHour = qs("#btn-timeline-hour");

  // Vendors page
  const vendorsKpisEl = qs("#vendors-kpis");
  const vendorStatusFiltersEl = qs("#vendor-status-filters");
  const vendorSearchEl = qs("#vendor-search");
  const vendorsTableWrapperEl = qs("#vendors-table-wrapper");
  const btnManualVendor = qs("#btn-open-manual-vendor");
  const btnCopyVendorLink = qs("#btn-copy-vendor-link");
  const btnExportVendors = qs("#btn-export-vendors");

  // Products page
  const problemProductsWrapperEl = qs("#problem-products-table-wrapper");

  // Customers page
  const customersKpisEl = qs("#customers-kpis");
  const customersTableWrapperEl = qs("#customers-table-wrapper");
  const customerSearchEl = qs("#customer-search");
  const btnExportCustomers = qs("#btn-export-customers");

  // Sales page
  const ordersTableWrapperEl = qs("#orders-table-wrapper");
  const btnExportOrders = qs("#btn-export-orders");

  // Super admin
  const adminTotalEventsEl = qs("#admin-total-events");
  const adminTotalVendorsEl = qs("#admin-total-vendors");
  const adminTotalOrdersEl = qs("#admin-total-orders");
  const adminTotalRevenueEl = qs("#admin-total-revenue");
  const adminEventsTableWrapperEl = qs("#admin-events-table-wrapper");
  const adminVendorSummaryEl = qs("#admin-vendor-summary");
  const sysMaintenanceToggleEl = qs("#sys-maintenance-toggle");
  const sysOwnerSignupToggleEl = qs("#sys-owner-signup-toggle");
  const sysBrandSignupToggleEl = qs("#sys-brand-signup-toggle");
  const sysVendorSignupToggleEl = qs("#sys-vendor-signup-toggle");
  const sysPosLoginToggleEl = qs("#sys-pos-login-toggle");
  const sysMaintenanceMessageEl = qs("#sys-maintenance-message");
  const btnSaveSystemSettings = qs("#btn-save-system-settings");

  // Settings
  const setEventNameEl = qs("#set-event-name");
  const setEventLocationEl = qs("#set-event-location");
  const setEventStartEl = qs("#set-event-start");
  const setEventEndEl = qs("#set-event-end");
  const btnSaveEventSettings = qs("#btn-save-event");
  const btnCreateEvent = qs("#btn-create-event");

  // Nav
  const navItems = qsa(".nav-item[data-page]");
  const pages = qsa(".page");

  // Modal
  const modalContainer = qs("#modal-container");

  const logoutBtn = qs("#btn-logout");

  // -----------------------------
  // STATE
  // -----------------------------
  let currentUser = null;
  let ownerProfile = null;
  let superAdminProfile = null;
  let isSuperAdmin = false;
  let systemStatus = {};

  let eventsList = [];
  let currentEventId = null;
  let currentEventData = null;

  let vendors = [];
  let ordersAll = []; // all orders for eventId
  let brandMap = {};  // brandId -> brand data (logo, status, etc.)

  let adminVendorsAll = [];
  let adminOrdersAll = [];

  let vendorStatusFilter = "all";
  let vendorSearchTerm = "";

  let customerSearchTerm = "";

  let dateFilterMode = "general"; // "general" or "YYYY-MM-DD"
  let timelineMode = "auto";      // "auto" | "day" | "hour"

  let unsubVendors = null;
  let unsubOrders = null;
  let unsubAdminVendors = null;
  let unsubAdminOrders = null;
  let unsubSystemSettings = null;

  // Chart instances
  let chartRevenueTimeline = null;
  let chartPeakSparkline = null;
  let chartPaymentMix = null;
  let chartTopProducts = null;

  // -----------------------------
  // AUTH ALERTS
  // -----------------------------
  function showAuthAlert(message, type = "error") {
    const cls = type === "error" ? "auth-alert-error" : "auth-alert-info";
    authAlertContainer.innerHTML = `
      <div class="auth-alert ${cls}">
        ${message}
      </div>
    `;
  }
  function clearAuthAlert() {
    authAlertContainer.innerHTML = "";
  }

  // -----------------------------
  // SYSTEM SETTINGS
  // -----------------------------
  function applySystemStatus() {
    const maintenanceMode = !!systemStatus.maintenanceMode;
    const maintenanceMessage = systemStatus.maintenanceMessage || "Maintenance in progress. Please check back soon.";
    const ownerSignupDisabled = !!systemStatus.ownerSignupDisabled;

    if (systemStatusBannerEl) {
      if (maintenanceMode) {
        systemStatusBannerEl.style.display = "block";
        systemStatusBannerEl.textContent = maintenanceMessage;
      } else {
        systemStatusBannerEl.style.display = "none";
        systemStatusBannerEl.textContent = "";
      }
    }

    if (signupBtn) signupBtn.disabled = maintenanceMode || ownerSignupDisabled;
    if (signupForm && loginForm && tabSignup && tabLogin && authSubtitle && (maintenanceMode || ownerSignupDisabled)) {
      signupForm.style.display = "none";
      tabSignup.classList.remove("active");
      tabLogin.classList.add("active");
      loginForm.style.display = "";
      authSubtitle.textContent = maintenanceMode
        ? "Sign in to manage events. Signups are temporarily unavailable."
        : "Sign in to manage your events and analytics.";
    }

    if (sysMaintenanceToggleEl) sysMaintenanceToggleEl.checked = maintenanceMode;
    if (sysOwnerSignupToggleEl) sysOwnerSignupToggleEl.checked = ownerSignupDisabled;
    if (sysBrandSignupToggleEl) sysBrandSignupToggleEl.checked = !!systemStatus.brandSignupDisabled;
    if (sysVendorSignupToggleEl) sysVendorSignupToggleEl.checked = !!systemStatus.vendorSignupDisabled;
    if (sysPosLoginToggleEl) sysPosLoginToggleEl.checked = !!systemStatus.posLoginDisabled;
    if (sysMaintenanceMessageEl && document.activeElement !== sysMaintenanceMessageEl) {
      sysMaintenanceMessageEl.value = systemStatus.maintenanceMessage || "";
    }

    if (maintenanceMode && currentUser && !isSuperAdmin) {
      showAuthAlert(maintenanceMessage, "info");
      signOut(auth).catch(() => {});
    }
  }

  function startSystemSettingsListener() {
    if (unsubSystemSettings) unsubSystemSettings();
    unsubSystemSettings = onSnapshot(doc(db, "systemSettings", "production"), (snap) => {
      systemStatus = snap.exists() ? snap.data() : {};
      applySystemStatus();
    });
  }

  // -----------------------------
  // MODAL HELPERS
  // -----------------------------
  function openModal(innerHtml) {
    if (!modalContainer) return;
    modalContainer.style.display = "flex";
    modalContainer.innerHTML = `
      <div class="modal" style="
        background:#fff;
        border-radius:16px;
        max-width:520px;
        width:100%;
        padding:18px;
        box-shadow:0 18px 40px rgba(15,23,42,.2);
      ">
        ${innerHtml}
      </div>
    `;
  }

  function closeModal() {
    if (!modalContainer) return;
    modalContainer.style.display = "none";
    modalContainer.innerHTML = "";
  }
  window.closeModal = closeModal;

  // -----------------------------
  // AUTH VIEW TOGGLING
  // -----------------------------
  tabLogin?.addEventListener("click", () => {
    tabLogin.classList.add("active");
    tabSignup.classList.remove("active");
    if (loginForm) loginForm.style.display = "";
    if (signupForm) signupForm.style.display = "none";
    authSubtitle.textContent = "Sign in to manage your events and analytics.";
  });

  tabSignup?.addEventListener("click", () => {
    tabSignup.classList.add("active");
    tabLogin.classList.remove("active");
    if (signupForm) signupForm.style.display = "";
    if (loginForm) loginForm.style.display = "none";
    authSubtitle.textContent = "Create your first event and dashboard.";
  });

  // -----------------------------
  // AUTH: LOGIN
  // -----------------------------
  loginForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    clearAuthAlert();

    const email = loginEmailEl?.value.trim();
    const pw = loginPasswordEl?.value;

    if (!email || !pw) {
      showAuthAlert("Enter email and password.");
      return;
    }

    try {
      await signInWithEmailAndPassword(auth, email, pw);
    } catch (err) {
      console.error("Login error:", err);
      let msg = "Login failed.";
      if (err.code === "auth/user-not-found") msg = "User not found.";
      if (err.code === "auth/wrong-password") msg = "Wrong password.";
      showAuthAlert(msg);
    }
  });

  // -----------------------------
  // AUTH: SIGNUP
  // -----------------------------
  signupForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    clearAuthAlert();

    const name = signupNameEl?.value.trim();
    const email = signupEmailEl?.value.trim();
    const pw = signupPasswordEl?.value;
    const eventName = signupEventNameEl?.value.trim();
    const eventLocation = signupEventLocationEl?.value.trim();
    const startDate = signupEventStartEl?.value.trim();
    const endDate = signupEventEndEl?.value.trim();

    if (!name || !email || !pw || !eventName) {
      showAuthAlert("Fill all required fields (name, email, password, event name).");
      return;
    }
    if (pw.length < 6) {
      showAuthAlert("Password must be at least 6 characters.");
      return;
    }

    try {
      const cred = await createUserWithEmailAndPassword(auth, email, pw);
      const user = cred.user;
      await updateProfile(user, { displayName: name });

      // owner profile
      await setDoc(doc(db, "eventOwners", user.uid), {
        uid: user.uid,
        name,
        email,
        createdAt: serverTimestamp()
      });

      // create first event
      const vendorToken = Math.random().toString(36).substring(2, 10).toUpperCase();
      const evRef = await addDoc(collection(db, "events"), {
        name: eventName,
        location: eventLocation || null,
        startDate: startDate || null,
        endDate: endDate || null,
        ownerUserId: user.uid,
        status: "active",
        vendorSignupToken: vendorToken,
        createdAt: serverTimestamp()
      });

      const eventId = evRef.id;

      await setDoc(
        doc(db, "ownerEvents", user.uid),
        {
          primaryEventId: eventId,
          eventIds: [eventId]
        },
        { merge: true }
      );
    } catch (err) {
      console.error("Signup error:", err);
      let msg = "Signup failed.";
      if (err.code === "auth/email-already-in-use") msg = "Email already in use.";
      showAuthAlert(msg);
    }
  });

  // -----------------------------
  // LOAD EVENTS
  // -----------------------------
  async function loadEventsForUser(uid) {
    const qEv = isSuperAdmin
      ? query(collection(db, "events"))
      : query(collection(db, "events"), where("ownerUserId", "==", uid));

    const snap = await getDocs(qEv);
    eventsList = [];
    snap.forEach((d) => {
      eventsList.push({ id: d.id, ...d.data() });
    });
  }

  function renderEventSwitcher() {
    if (!eventSelectEl) return;
    eventSelectEl.innerHTML = "";
    if (isSuperAdmin) {
      const opt = document.createElement("option");
      opt.value = "all";
      opt.textContent = "All events";
      eventSelectEl.appendChild(opt);
    }
    eventsList.forEach((ev) => {
      const opt = document.createElement("option");
      opt.value = ev.id;
      opt.textContent = ev.name || "Untitled event";
      eventSelectEl.appendChild(opt);
    });
    if (currentEventId) {
      eventSelectEl.value = currentEventId;
    }

    eventSelectEl.onchange = async () => {
      const val = eventSelectEl.value;
      if (!val) return;
      currentEventId = val;

      if (currentUser && !isSuperAdmin) {
        const ownerEventsRef = doc(db, "ownerEvents", currentUser.uid);
        const existingSnap = await getDoc(ownerEventsRef);
        const existing = existingSnap.exists() ? existingSnap.data() : {};
        const ids = Array.isArray(existing.eventIds) ? existing.eventIds : [];
        if (!ids.includes(val)) ids.push(val);

        await setDoc(
          ownerEventsRef,
          {
            primaryEventId: val,
            eventIds: ids
          },
          { merge: true }
        );
      }

      await selectEvent(val);
    };
  }

  // -----------------------------
  // DATE FILTER CHIPS
  // -----------------------------
  function buildDateFilterChips() {
    if (!dateFilterContainer) return;
    dateFilterContainer.innerHTML = "";

    const btnGeneral = document.createElement("button");
    btnGeneral.className = "date-chip";
    btnGeneral.dataset.date = "general";
    btnGeneral.textContent = "General";
    dateFilterContainer.appendChild(btnGeneral);

    let start = null;
    let end = null;
    if (currentEventData?.startDate) {
      start = parseLocalDate(currentEventData.startDate);
    }
    if (currentEventData?.endDate) {
      end = parseLocalDate(currentEventData.endDate);
    }

    if (start && end && end >= start) {
      let d = new Date(start);
      while (d <= end) {
        const key = formatDateKey(d);
        const b = document.createElement("button");
        b.className = "date-chip";
        b.dataset.date = key;
        b.textContent = key;
        dateFilterContainer.appendChild(b);
        d = addDays(d, 1);
      }
    }

    function updateActiveChip() {
      const chips = dateFilterContainer.querySelectorAll(".date-chip");
      chips.forEach((c) => {
        if (c.dataset.date === dateFilterMode) {
          c.classList.add("active");
        } else {
          c.classList.remove("active");
        }
      });
    }

    dateFilterContainer.addEventListener("click", (e) => {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;
      if (!target.classList.contains("date-chip")) return;
      const val = target.dataset.date || "general";
      dateFilterMode = val;
      updateActiveChip();
      recomputeAllAnalytics();
    });

    // default
    dateFilterMode = "general";
    updateActiveChip();
  }

  function applyEventContext(eventData, eventId) {
    const isAllEvents = eventId === "all";
    const name = isAllEvents ? "All Events" : eventData?.name || "Event";
    const location = isAllEvents ? "" : eventData?.location || "";
    const startDate = isAllEvents ? "" : eventData?.startDate || "";
    const endDate = isAllEvents ? "" : eventData?.endDate || "";

    if (sidebarEventNameEl) sidebarEventNameEl.textContent = name;
    if (sidebarEventLogoEl) {
      sidebarEventLogoEl.textContent = (name[0] || "E").toUpperCase();
    }

    if (topbarTitleEl) topbarTitleEl.textContent = "Event Overview";
    if (topbarSubtitleEl) {
      if (isAllEvents) {
        topbarSubtitleEl.textContent = "Global view across every event.";
      } else {
        const parts = [name];
        if (startDate && endDate) parts.push(`${startDate} → ${endDate}`);
        if (location) parts.push(location);
        topbarSubtitleEl.textContent = parts.filter(Boolean).join(" • ");
      }
    }

    if (setEventNameEl) setEventNameEl.value = name;
    if (setEventLocationEl) setEventLocationEl.value = location;
    if (setEventStartEl) setEventStartEl.value = startDate || "";
    if (setEventEndEl) setEventEndEl.value = endDate || "";

    const disableSettings = isAllEvents;
    [setEventNameEl, setEventLocationEl, setEventStartEl, setEventEndEl].forEach((el) => {
      if (el) el.disabled = disableSettings;
    });
    if (btnSaveEventSettings) btnSaveEventSettings.disabled = disableSettings;

    if (btnManualVendor) btnManualVendor.disabled = isAllEvents;
    if (btnCopyVendorLink) btnCopyVendorLink.disabled = isAllEvents;

    buildDateFilterChips();
  }

  // -----------------------------
  // SELECT EVENT
  // -----------------------------
  async function selectEvent(eventId) {
    if (!eventId) return;

    currentEventId = eventId;

    if (isSuperAdmin) {
      currentEventData = eventId === "all" ? null : eventsList.find((ev) => ev.id === eventId) || null;
      if (eventId !== "all" && !currentEventData) {
        const evSnap = await getDoc(doc(db, "events", eventId));
        if (evSnap.exists()) currentEventData = { id: eventId, ...evSnap.data() };
      }
      applyEventContext(currentEventData, eventId);
      applySuperAdminFilters();
      return;
    }

    if (unsubVendors) unsubVendors();
    if (unsubOrders) unsubOrders();
    unsubVendors = unsubOrders = null;

    currentEventData = null;
    vendors = [];
    ordersAll = [];
    brandMap = {};

    const evSnap = await getDoc(doc(db, "events", eventId));
    if (!evSnap.exists()) return;
    currentEventData = { id: eventId, ...evSnap.data() };

    applyEventContext(currentEventData, eventId);

    // vendors listener
    const vendorsRef = collection(db, "events", eventId, "vendors");
    const qVendors = query(vendorsRef);
    unsubVendors = onSnapshot(qVendors, async (snap) => {
      vendors = [];
      snap.forEach((d) => vendors.push({ id: d.id, eventId, ...d.data() }));
      await ensureBrandDocsLoaded();
      renderVendorsSection();
      recomputeAllAnalytics(); // active brands etc depend on vendors + orders
    });

    // orders listener: collectionGroup on "orders" filtered by eventId
    const qOrders = query(
      collectionGroup(db, "orders"),
      where("eventId", "==", eventId)
    );
    unsubOrders = onSnapshot(
      qOrders,
      async (snap) => {
        ordersAll = [];
        snap.forEach((d) => ordersAll.push({ id: d.id, eventId, ...d.data() }));
        await ensureBrandDocsLoaded();
        recomputeAllAnalytics();
      },
      (err) => {
        console.error("Orders listener error:", err);
      }
    );
  }

  async function applySuperAdminFilters() {
    const isAllEvents = currentEventId === "all";
    vendors = isAllEvents
      ? [...adminVendorsAll]
      : adminVendorsAll.filter((v) => v.eventId === currentEventId);
    ordersAll = isAllEvents
      ? [...adminOrdersAll]
      : adminOrdersAll.filter((o) => o.eventId === currentEventId);

    await ensureBrandDocsLoaded();
    renderVendorsSection();
    recomputeAllAnalytics();
    renderAdminDashboard();
  }

  function startSuperAdminListeners() {
    if (unsubAdminVendors) unsubAdminVendors();
    if (unsubAdminOrders) unsubAdminOrders();
    unsubAdminVendors = null;
    unsubAdminOrders = null;

    unsubAdminVendors = onSnapshot(collectionGroup(db, "vendors"), async (snap) => {
      adminVendorsAll = [];
      snap.forEach((d) => {
        const eventId = getEventIdFromRef(d.ref);
        adminVendorsAll.push({ id: d.id, eventId, ...d.data() });
      });
      await applySuperAdminFilters();
    });

    unsubAdminOrders = onSnapshot(
      collectionGroup(db, "orders"),
      async (snap) => {
        adminOrdersAll = [];
        snap.forEach((d) => {
          const data = d.data();
          const eventId = data.eventId || getEventIdFromRef(d.ref);
          adminOrdersAll.push({ id: d.id, eventId, ...data });
        });
        await applySuperAdminFilters();
      },
      (err) => {
        console.error("Admin orders listener error:", err);
      }
    );
  }

  function renderAdminDashboard() {
    if (!isSuperAdmin) return;

    if (adminTotalEventsEl) adminTotalEventsEl.textContent = String(eventsList.length || 0);
    if (adminTotalVendorsEl) adminTotalVendorsEl.textContent = String(adminVendorsAll.length || 0);
    if (adminTotalOrdersEl) adminTotalOrdersEl.textContent = String(adminOrdersAll.length || 0);

    const totalRevenue = adminOrdersAll.reduce((sum, o) => {
      const total = Number(o.total) || 0;
      return o.isReturn ? sum - Math.abs(total) : sum + total;
    }, 0);
    if (adminTotalRevenueEl) adminTotalRevenueEl.textContent = formatCurrency(totalRevenue);

    if (adminVendorSummaryEl) {
      const pending = adminVendorsAll.filter((v) => (v.status || "pending") === "pending").length;
      const suspended = adminVendorsAll.filter((v) => (v.status || "pending") === "suspended").length;
      const rejected = adminVendorsAll.filter((v) => (v.status || "pending") === "rejected").length;
      adminVendorSummaryEl.innerHTML = `
        <div><strong>Pending:</strong> ${pending}</div>
        <div><strong>Suspended:</strong> ${suspended}</div>
        <div><strong>Rejected:</strong> ${rejected}</div>
      `;
    }

    if (!adminEventsTableWrapperEl) return;
    if (!eventsList.length) {
      adminEventsTableWrapperEl.innerHTML = `<div class="table-empty">No events found.</div>`;
      return;
    }

    const orderTotalsByEvent = {};
    adminOrdersAll.forEach((o) => {
      if (!o.eventId) return;
      const total = Number(o.total) || 0;
      const value = o.isReturn ? -Math.abs(total) : total;
      orderTotalsByEvent[o.eventId] = (orderTotalsByEvent[o.eventId] || 0) + value;
    });

    let html = `
      <table>
        <thead>
          <tr>
            <th>Event</th>
            <th>Status</th>
            <th>Owner</th>
            <th>Dates</th>
            <th>Revenue</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
    `;

    eventsList.forEach((ev) => {
      const status = ev.status || "active";
      const ownerId = ev.ownerUserId || "—";
      const start = ev.startDate || "";
      const end = ev.endDate || "";
      const revenue = orderTotalsByEvent[ev.id] || 0;
      const actionLabel = status === "active" ? "Suspend" : "Activate";

      html += `
        <tr data-event-id="${ev.id}">
          <td>${ev.name || "Untitled event"}</td>
          <td>${status}</td>
          <td>${ownerId}</td>
          <td>${start && end ? `${start} → ${end}` : "—"}</td>
          <td>${formatCurrency(revenue)}</td>
          <td>
            <button class="btn btn-ghost" data-action="toggle-status" data-id="${ev.id}" style="padding:4px 8px;font-size:10px;">
              ${actionLabel}
            </button>
          </td>
        </tr>
      `;
    });

    html += `</tbody></table>`;
    adminEventsTableWrapperEl.innerHTML = html;

    adminEventsTableWrapperEl.querySelectorAll("button[data-action='toggle-status']").forEach((btn) => {
      btn.addEventListener("click", async (e) => {
        e.stopPropagation();
        const id = btn.getAttribute("data-id");
        const ev = eventsList.find((item) => item.id === id);
        if (!ev) return;
        const nextStatus = (ev.status || "active") === "active" ? "suspended" : "active";
        try {
          await apiRequest("/api/admin/event-status", {
            method: "PUT",
            body: JSON.stringify({ eventId: id, status: nextStatus })
          });
        } catch (err) {
          console.error("Failed to update event status:", err);
          alert("Failed to update event status.");
        }
      });
    });
  }

  btnSaveSystemSettings?.addEventListener("click", async () => {
    if (!isSuperAdmin) {
      alert("Super admin access required.");
      return;
    }
    try {
      await apiRequest("/api/system-settings", {
        method: "PUT",
        body: JSON.stringify({
          maintenanceMode: !!sysMaintenanceToggleEl?.checked,
          maintenanceMessage: sysMaintenanceMessageEl?.value.trim() || "",
          ownerSignupDisabled: !!sysOwnerSignupToggleEl?.checked,
          brandSignupDisabled: !!sysBrandSignupToggleEl?.checked,
          vendorSignupDisabled: !!sysVendorSignupToggleEl?.checked,
          posLoginDisabled: !!sysPosLoginToggleEl?.checked
        })
      });
      alert("System settings saved.");
    } catch (err) {
      console.error("Failed to save system settings:", err);
      alert("Failed to save system settings.");
    }
  });

  async function ensureBrandDocsLoaded() {
    // gather all brandIds from vendors + orders
    const neededIds = new Set();
    vendors.forEach((v) => {
      if (v.brandId) neededIds.add(v.brandId);
    });
    ordersAll.forEach((o) => {
      if (o.brandId) neededIds.add(o.brandId);
    });

    const toFetch = [];
    neededIds.forEach((id) => {
      if (!brandMap[id]) toFetch.push(id);
    });
    if (!toFetch.length) return;

    await Promise.all(
      toFetch.map(async (id) => {
        const snap = await getDoc(doc(db, "brands", id));
        if (snap.exists()) {
          brandMap[id] = { id, ...snap.data() };
        } else {
          brandMap[id] = { id };
        }
      })
    );
  }

  // -----------------------------
  // FILTER ORDERS BY CURRENT DATE FILTER
  // -----------------------------
  function getFilteredOrders() {
    if (!ordersAll.length) return [];
    if (dateFilterMode === "general") return [...ordersAll];

    // specific day: match YYYY-MM-DD
    const target = dateFilterMode;
    return ordersAll.filter((o) => {
      const d = parseOrderDate(o);
      const key = formatDateKey(d);
      return key === target;
    });
  }

  // -----------------------------
  // AGGREGATIONS & ANALYTICS
  // -----------------------------
  function recomputeAllAnalytics() {
    const filteredOrders = getFilteredOrders();
    computeAndRenderOverview(filteredOrders);
    computeAndRenderProducts(filteredOrders);
    computeAndRenderCustomers(filteredOrders);
    renderOrdersTable(filteredOrders);
    renderVendorsSection(); // vendor revenue % etc
  }

  function computeAndRenderOverview(filteredOrders) {
    let totalRevenue = 0;
    let totalOrders = 0;
    let itemsSold = 0;
    let returnsAmount = 0;

    const brandStats = {}; // brandId -> { revenue, orders }
    const paymentStats = {}; // method -> { amount, count }

    const hourlyBuckets = {}; // "YYYY-MM-DD HH" -> { revenue, orders }
    const dailyBuckets = {};  // "YYYY-MM-DD" -> { revenue }

    const liveOrders = [...filteredOrders].sort((a,b) => {
      const da = parseOrderDate(a).getTime();
      const db = parseOrderDate(b).getTime();
      return db - da;
    }).slice(0, 10);

    filteredOrders.forEach((o) => {
      const isReturn = !!o.isReturn;
      const total = Number(o.total) || 0;
      const absTotal = Math.abs(total);
      const sign = isReturn ? -1 : 1;

      const d = parseOrderDate(o);
      const dayKey = formatDateKey(d);
      const hourKey = `${dayKey} ${String(d.getHours()).padStart(2,"0")}:00`;

      if (!isReturn) {
        totalRevenue += total;
      } else {
        returnsAmount += absTotal;
      }

      if (!isReturn) {
        totalOrders += 1;
      }

      const items = Array.isArray(o.items) ? o.items : [];
      items.forEach((it) => {
        const q = Number(it.qty) || 0;
        if (!isReturn) itemsSold += q;
      });

      const brandId = o.brandId || null;
      if (brandId) {
        if (!brandStats[brandId]) brandStats[brandId] = { revenue:0, orders:0 };
        if (!isReturn) {
          brandStats[brandId].revenue += total;
          brandStats[brandId].orders += 1;
        } else {
          brandStats[brandId].revenue -= total; // or ignore returns here; we keep it simple
        }
      }

      const pmRaw = (o.paymentMethod || "").toString().toLowerCase();
      let pm = "other";
      if (pmRaw.includes("cash")) pm = "cash";
      else if (pmRaw.includes("card")) pm = "card";
      else if (pmRaw.includes("wallet") || pmRaw.includes("mada") || pmRaw.includes("stc")) pm = "wallet";
      if (!paymentStats[pm]) paymentStats[pm] = { amount:0, count:0 };
      paymentStats[pm].amount += sign * absTotal;
      paymentStats[pm].count += 1;

      if (!isReturn) {
        if (!dailyBuckets[dayKey]) dailyBuckets[dayKey] = { revenue:0 };
        dailyBuckets[dayKey].revenue += total;

        if (!hourlyBuckets[hourKey]) hourlyBuckets[hourKey] = { revenue:0, orders:0 };
        hourlyBuckets[hourKey].revenue += total;
        hourlyBuckets[hourKey].orders += 1;
      }
    });

    const netRevenue = totalRevenue - returnsAmount;
    const aov = totalOrders > 0 ? totalRevenue / totalOrders : 0;

    const activeBrandCount = Object.values(brandStats).filter(b => b.revenue > 0).length;

    if (kpiTotalRevenueEl) kpiTotalRevenueEl.textContent = formatCurrency(totalRevenue);
    if (kpiTotalOrdersEl) kpiTotalOrdersEl.textContent = String(totalOrders);
    if (kpiItemsSoldEl) kpiItemsSoldEl.textContent = String(itemsSold);
    if (kpiAovEl) kpiAovEl.textContent = formatCurrency(aov);
    if (kpiReturnsEl) kpiReturnsEl.textContent = formatCurrency(returnsAmount);
    if (kpiNetRevenueEl) kpiNetRevenueEl.textContent = formatCurrency(netRevenue);
    if (kpiActiveBrandsEl) kpiActiveBrandsEl.textContent = String(activeBrandCount);

    // timeline mode: auto
    let mode = timelineMode;
    if (mode === "auto") {
      // if filter is specific day -> hour, else day
      mode = dateFilterMode === "general" ? "day" : "hour";
    }

    if (timelineSubtitleEl) {
      if (mode === "day") timelineSubtitleEl.textContent = "Revenue aggregated by day.";
      else if (mode === "hour") timelineSubtitleEl.textContent = "Revenue aggregated by hour.";
    }

    if (mode === "day") {
      const labels = Object.keys(dailyBuckets).sort();
      const data = labels.map((k) => dailyBuckets[k].revenue);
      updateLineChart(chartRevenueTimeline, "chart-revenue-timeline", labels, data, "Revenue");
    } else {
      const labels = Object.keys(hourlyBuckets).sort();
      const data = labels.map((k) => hourlyBuckets[k].revenue);
      updateLineChart(chartRevenueTimeline, "chart-revenue-timeline", labels, data, "Revenue");
    }

    // peak hour (from hourlyBuckets)
    let peakKey = null;
    let peakRev = 0;
    let peakOrders = 0;
    Object.entries(hourlyBuckets).forEach(([key, val]) => {
      if (val.revenue > peakRev) {
        peakRev = val.revenue;
        peakOrders = val.orders;
        peakKey = key;
      }
    });

    if (peakKey) {
      const [day, hourStr] = peakKey.split(" ");
      const hour = parseInt(hourStr, 10);
      const endHour = (hour + 1) % 24;
      const windowStr = `${hourStr}-${String(endHour).padStart(2,"0")}:00 (${day})`;
      if (peakHourWindowEl) peakHourWindowEl.textContent = windowStr;
      if (peakHourRevenueEl) peakHourRevenueEl.textContent = formatCurrency(peakRev);
      if (peakHourOrdersEl) peakHourOrdersEl.textContent = String(peakOrders);
      if (badgePeakHourEl) {
        badgePeakHourEl.style.display = "";
        badgePeakHourEl.textContent = `Peak: ${hourStr}`;
      }
    } else {
      if (peakHourWindowEl) peakHourWindowEl.textContent = "—";
      if (peakHourRevenueEl) peakHourRevenueEl.textContent = "0.00";
      if (peakHourOrdersEl) peakHourOrdersEl.textContent = "0";
      if (badgePeakHourEl) badgePeakHourEl.style.display = "none";
    }

    // peak sparkline
    const sparkLabels = Object.keys(hourlyBuckets).sort();
    const sparkData = sparkLabels.map((k) => hourlyBuckets[k].orders);
    updateLineChart(chartPeakSparkline, "chart-peak-sparkline", sparkLabels, sparkData, "Orders");

    // payment mix chart
    const paymentLabels = ["Cash","Card","Wallet","Other"];
    const paymentKeys = ["cash","card","wallet","other"];
    const paymentData = paymentKeys.map((k) => paymentStats[k]?.amount || 0);
    updateDoughnutChart(chartPaymentMix, "chart-payment-mix", paymentLabels, paymentData);

    // payment mini stats
    if (paymentMiniStatsEl) {
      paymentMiniStatsEl.innerHTML = "";
      paymentKeys.forEach((k, i) => {
        const label = paymentLabels[i];
        const stat = paymentStats[k] || { amount:0, count:0 };
        const div = document.createElement("div");
        div.innerHTML = `
          <strong>${label}</strong><br/>
          ${formatCurrency(stat.amount)} EGP • ${stat.count} orders
        `;
        paymentMiniStatsEl.appendChild(div);
      });
    }

    // top vendors snippet on overview (top 3)
    if (overviewTopVendorsEl) {
      const entries = Object.entries(brandStats).sort((a,b) => b[1].revenue - a[1].revenue);
      const totalRevForPercent = totalRevenue || 1;
      overviewTopVendorsEl.innerHTML = "";
      entries.slice(0,3).forEach(([brandId, stats]) => {
        const b = brandMap[brandId] || {};
        const name = b.name || b.brandName || stats.brandName || "Brand";
        const pct = (stats.revenue / totalRevForPercent) * 100;
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="card-header">
            <div>
              <div class="card-title">${name}</div>
              <div style="font-size:11px;color:var(--muted);">${stats.orders} orders</div>
            </div>
          </div>
          <div class="card-number">${formatCurrency(stats.revenue)}</div>
          <div class="card-note">${pct.toFixed(1)}% of event revenue</div>
        `;
        overviewTopVendorsEl.appendChild(card);
      });
      if (!entries.length) {
        overviewTopVendorsEl.innerHTML = `<div class="card-note">No vendor sales yet for this view.</div>`;
      }
    }

    // live feed
    if (overviewLiveFeedEl) {
      overviewLiveFeedEl.innerHTML = "";
      liveOrders.forEach((o) => {
        const d = parseOrderDate(o);
        const timeStr = d.toLocaleTimeString("en-EG", { hour:"2-digit", minute:"2-digit" });
        const brandName = o.brandName || (brandMap[o.brandId]?.name) || "Brand";
        const isReturn = !!o.isReturn;
        const amt = Number(o.total) || 0;
        const pmRaw = (o.paymentMethod || "").toLowerCase();
        let icon = "💸";
        if (pmRaw.includes("card")) icon = "💳";
        else if (pmRaw.includes("wallet")) icon = "📱";
        else if (pmRaw.includes("cash")) icon = "💵";

        const highValue = Math.abs(amt) >= 2000; // arbitrary threshold

        const item = document.createElement("div");
        item.className = "feed-item";
        item.innerHTML = `
          <div class="feed-main">
            <div class="feed-top-row">
              <span class="feed-brand">${brandName}</span>
              <span class="feed-time">${timeStr}</span>
            </div>
            <div style="font-size:11px;color:var(--muted);">
              ${icon} ${pmRaw || "other"}
            </div>
          </div>
          <div class="feed-right">
            <div class="feed-amount">${formatCurrency(amt)}</div>
            <div class="feed-tags">
              ${isReturn ? '<span class="badge badge-danger">Refund</span>' : ""}
              ${highValue && !isReturn ? '<span class="badge">High value</span>' : ""}
            </div>
          </div>
        `;
        overviewLiveFeedEl.appendChild(item);
      });
      if (!liveOrders.length) {
        overviewLiveFeedEl.innerHTML = `<div class="table-empty">No orders yet for this view.</div>`;
      }
    }
  }

  // -----------------------------
  // PRODUCTS & RETURNS
  // -----------------------------
  function computeAndRenderProducts(filteredOrders) {
    const prodMap = {}; // key = brandId + "::" + name
    filteredOrders.forEach((o) => {
      const isReturn = !!o.isReturn;
      const items = Array.isArray(o.items) ? o.items : [];
      const brandId = o.brandId || null;
      const brandName = o.brandName || (brandMap[brandId]?.name) || "Brand";
      items.forEach((it) => {
        const name = it.name || "Product";
        const productLabel = `${brandName} — ${name}`;
        const qty = Number(it.qty) || 0;
        const lineTotal = Number(it.lineTotal) || 0;
        const key = `${brandId || "none"}::${name}`;
        if (!prodMap[key]) {
          prodMap[key] = {
            productName: name,
            productLabel,
            brandId,
            brandName,
            qtySold: 0,
            revenue: 0,
            returnsQty: 0,
            returnsRevenue: 0
          };
        }
        const p = prodMap[key];
        if (!isReturn) {
          p.qtySold += qty;
          p.revenue += lineTotal;
        } else {
          p.returnsQty += qty;
          p.returnsRevenue += Math.abs(lineTotal);
        }
      });
    });

    const allProducts = Object.values(prodMap);

    // top products chart
    const topByRevenue = [...allProducts].sort((a,b) => b.revenue - a.revenue).slice(0, 8);
    const labels = topByRevenue.map((p) => p.productLabel || p.productName);
    const data = topByRevenue.map((p) => p.revenue);
    updateBarChart(chartTopProducts, "chart-top-products", labels, data, "Revenue");

    // problem products table
    if (problemProductsWrapperEl) {
      if (!allProducts.length) {
        problemProductsWrapperEl.innerHTML = `<div class="table-empty">No product data for this view.</div>`;
        return;
      }
      const withSold = allProducts.filter((p) => p.qtySold > 0 && p.returnsQty > 0);
      const ranked = withSold.map((p) => {
        const retPct = p.returnsQty / p.qtySold;
        return { ...p, returnPct: retPct };
      }).sort((a,b) => b.returnPct - a.returnPct).slice(0, 10);

      if (!ranked.length) {
        problemProductsWrapperEl.innerHTML = `<div class="table-empty">No problematic products for this view.</div>`;
        return;
      }

      let html = `
        <table>
          <thead>
            <tr>
              <th>Brand &amp; Product</th>
              <th>Returns</th>
              <th>Return %</th>
            </tr>
          </thead>
          <tbody>
      `;
      ranked.forEach((p) => {
        const pctStr = (p.returnPct * 100).toFixed(1) + "%";
        html += `
          <tr>
            <td>${p.productLabel || `${p.brandName} — ${p.productName}`}</td>
            <td>${p.returnsQty}</td>
            <td style="color:#b91c1c;font-weight:600;">${pctStr}</td>
          </tr>
        `;
      });
      html += `</tbody></table>`;
      problemProductsWrapperEl.innerHTML = html;
    }
  }

  // -----------------------------
  // CUSTOMERS
  // -----------------------------
  function computeAndRenderCustomers(filteredOrders) {
    const custMap = {}; // key -> aggregated

    filteredOrders.forEach((o) => {
      let cust = o.customer || {};
      // fallback if you store directly on order
      const name = cust.name || o.customerName || "";
      const phone = cust.phone || o.customerPhone || "";
      const email = cust.email || o.customerEmail || "";
      const key = phone || email || name || "anonymous";

      const total = Number(o.total) || 0;
      const isReturn = !!o.isReturn;

      const d = parseOrderDate(o);

      if (!custMap[key]) {
        custMap[key] = {
          key,
          name: name || "Customer",
          phone: phone || "",
          email: email || "",
          orders: 0,
          totalSpent: 0,
          lastOrderAt: d
        };
      }
      const c = custMap[key];
      if (!isReturn) {
        c.orders += 1;
        c.totalSpent += total;
      } else {
        c.totalSpent -= Math.abs(total);
      }
      if (!c.lastOrderAt || d > c.lastOrderAt) c.lastOrderAt = d;
    });

    let customersArr = Object.values(custMap).filter((c) => c.orders > 0 || c.totalSpent !== 0);

    // search filter
    if (customerSearchTerm) {
      const q = customerSearchTerm.toLowerCase();
      customersArr = customersArr.filter((c) => {
        return (
          (c.name || "").toLowerCase().includes(q) ||
          (c.phone || "").toLowerCase().includes(q) ||
          (c.email || "").toLowerCase().includes(q)
        );
      });
    }

    const topCustomers = [...customersArr].sort((a,b) => b.totalSpent - a.totalSpent).slice(0,3);

    // top customers cards
    if (customersKpisEl) {
      customersKpisEl.innerHTML = "";
      topCustomers.forEach((c) => {
        const highValue = c.totalSpent >= 5000;
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="card-header">
            <div>
              <div class="card-title">${c.name}</div>
              <div class="card-note">${c.orders} orders</div>
            </div>
            ${highValue ? '<span class="badge">High value</span>' : ""}
          </div>
          <div class="card-number">${formatCurrency(c.totalSpent)}</div>
          <div class="card-note">Avg ${c.orders ? formatCurrency(c.totalSpent / c.orders) : "0.00"} per order</div>
        `;
        customersKpisEl.appendChild(card);
      });
      if (!topCustomers.length) {
        customersKpisEl.innerHTML = `<div class="card-note">No customers yet for this view.</div>`;
      }
    }

    // customers table
    if (customersTableWrapperEl) {
      if (!customersArr.length) {
        customersTableWrapperEl.innerHTML = `<div class="table-empty">No customers yet for this view.</div>`;
        return;
      }

      customersArr.sort((a,b) => b.totalSpent - a.totalSpent);

      let html = `
        <table>
          <thead>
            <tr>
              <th>Customer</th>
              <th>Phone</th>
              <th>Email</th>
              <th>Orders</th>
              <th>Total Spent</th>
              <th>Avg Order</th>
              <th>Last Order</th>
            </tr>
          </thead>
          <tbody>
      `;
      customersArr.forEach((c) => {
        const last = c.lastOrderAt
          ? c.lastOrderAt.toLocaleString("en-EG", { day:"2-digit", month:"short", hour:"2-digit", minute:"2-digit" })
          : "";
        html += `
          <tr>
            <td>${c.name}</td>
            <td>${c.phone || "—"}</td>
            <td>${c.email || "—"}</td>
            <td>${c.orders}</td>
            <td>${formatCurrency(c.totalSpent)}</td>
            <td>${c.orders ? formatCurrency(c.totalSpent / c.orders) : "0.00"}</td>
            <td>${last}</td>
          </tr>
        `;
      });

      html += `</tbody></table>`;
      customersTableWrapperEl.innerHTML = html;
    }

    // store global customers for export
    window.__customersForExport = customersArr;
  }

  // -----------------------------
  // VENDORS SECTION
  // -----------------------------
  function renderVendorsSection() {
    if (!vendorsTableWrapperEl) return;

    let list = [...vendors];
    const showEventColumn = isSuperAdmin || currentEventId === "all";

    // filter by status pill
    if (vendorStatusFilter !== "all") {
      list = list.filter((v) => (v.status || "pending") === vendorStatusFilter);
    }

    // search
    if (vendorSearchTerm) {
      const q = vendorSearchTerm.toLowerCase();
      list = list.filter((v) => {
        const brandName = (v.brandName || v.vendorName || "").toLowerCase();
        const ownerName = (v.ownerName || v.contactName || "").toLowerCase();
        return brandName.includes(q) || ownerName.includes(q);
      });
    }

    // simple sort: by brand name
    list.sort((a,b) => {
      const an = (a.brandName || a.vendorName || "").toLowerCase();
      const bn = (b.brandName || b.vendorName || "").toLowerCase();
      if (an < bn) return -1;
      if (an > bn) return 1;
      return 0;
    });

    if (!list.length) {
      vendorsTableWrapperEl.innerHTML = `<div class="table-empty">No vendors match this filter.</div>`;
      return;
    }

    let html = `
      <table>
        <thead>
          <tr>
            <th>Brand Name</th>
            ${showEventColumn ? "<th>Event</th>" : ""}
            <th>Owner Name</th>
            <th>Phone</th>
            <th>Email</th>
            <th>Category</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
    `;

    list.forEach((v) => {
      const status = v.status || "pending";
      const brandName = v.brandName || v.vendorName || "Vendor";
      const eventLabel = v.eventId ? getEventNameById(v.eventId) : currentEventData?.name || "Event";
      const ownerName = v.ownerName || v.contactName || "";
      const phone = v.phone || "";
      const email = v.email || "";
      const category = v.category || v.segment || "";

      const actions = [];

      if (status === "pending") {
        actions.push(`<button data-action="approve" data-id="${v.id}" class="btn btn-primary" style="padding:4px 8px;font-size:10px;">Approve</button>`);
        actions.push(`<button data-action="reject" data-id="${v.id}" class="btn btn-danger" style="padding:4px 8px;font-size:10px;">Reject</button>`);
      } else if (status === "approved") {
        actions.push(`<button data-action="suspend" data-id="${v.id}" class="btn btn-danger" style="padding:4px 8px;font-size:10px;">Suspend</button>`);
      } else if (status === "rejected" || status === "suspended") {
        actions.push(`<button data-action="reactivate" data-id="${v.id}" class="btn btn-primary" style="padding:4px 8px;font-size:10px;">Re-Activate</button>`);
      }

      actions.push(`<button data-action="open-pos" data-id="${v.id}" class="btn btn-ghost" style="padding:4px 8px;font-size:10px;">Open POS</button>`);

      html += `
        <tr data-vendor-id="${v.id}">
          <td>${brandName}</td>
          ${showEventColumn ? `<td>${eventLabel}</td>` : ""}
          <td>${ownerName}</td>
          <td>${phone}</td>
          <td>${email}</td>
          <td>${category}</td>
          <td>${status}</td>
          <td style="display:flex;flex-wrap:wrap;gap:4px;">${actions.join("")}</td>
        </tr>
      `;
    });

    html += `</tbody></table>`;
    vendorsTableWrapperEl.innerHTML = html;

    // attach actions
    vendorsTableWrapperEl.querySelectorAll("button[data-action]").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const action = btn.getAttribute("data-action");
        const id = btn.getAttribute("data-id");
        const vendor = vendors.find((v) => v.id === id);
        if (!vendor) return;

        if (action === "approve") {
          updateVendorStatus(vendor, "approved");
        } else if (action === "reject") {
          openRejectModal(vendor);
        } else if (action === "suspend") {
          updateVendorStatus(vendor, "suspended");
        } else if (action === "reactivate") {
          updateVendorStatus(vendor, "approved");
        } else if (action === "open-pos") {
          openVendorPOS(vendor);
        }
      });
    });

    // row click -> details modal
    vendorsTableWrapperEl.querySelectorAll("tr[data-vendor-id]").forEach((row) => {
      row.addEventListener("click", (e) => {
        // ignore clicks on buttons
        if (e.target instanceof HTMLButtonElement) return;
        const id = row.getAttribute("data-vendor-id");
        const vendor = vendors.find((v) => v.id === id);
        if (!vendor) return;
        openVendorDetailsModal(vendor);
      });
    });
  }

  async function updateVendorStatus(vendor, status, rejectionReason = null) {
    const eventId = vendor.eventId || currentEventId;
    if (!eventId) return;
    try {
      const updates = { status };
      if (status === "rejected") {
        updates.rejectionReason = rejectionReason || "No reason provided";
      }
      await apiRequest("/api/admin/vendor-status", {
        method: "PUT",
        body: JSON.stringify({
          eventId,
          vendorId: vendor.id,
          status,
          rejectionReason
        })
      });
    } catch (err) {
      console.error("Error updating vendor status:", err);
      if (err?.status === 404) {
        alert("Vendor status API not found. Ensure the server is running and /api routes are configured.");
      } else {
        alert("Failed to update vendor status.");
      }
    }
  }

  function openRejectModal(vendor) {
    openModal(`
      <div class="modal-title" style="font-weight:700;margin-bottom:8px;font-size:16px;">Reject Vendor</div>
      <div style="font-size:13px;margin-bottom:10px;">
        Brand: <strong>${vendor.brandName || vendor.vendorName || "Vendor"}</strong>
      </div>
      <div class="field">
        <div class="field-label">Rejection reason</div>
        <textarea id="reject-reason" class="field-input" style="min-height:70px;"></textarea>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
        <button onclick="closeModal()" class="btn btn-ghost">Cancel</button>
        <button id="btn-confirm-reject" class="btn btn-danger">Reject vendor</button>
      </div>
    `);

    const btnConfirm = qs("#btn-confirm-reject");
    const reasonEl = qs("#reject-reason");
    btnConfirm?.addEventListener("click", async () => {
      const reason = reasonEl?.value.trim() || "No reason provided";
      await updateVendorStatus(vendor, "rejected", reason);
      closeModal();
    });
  }

  function openVendorDetailsModal(vendor) {
    const status = vendor.status || "pending";
    const brandName = vendor.brandName || vendor.vendorName || "Vendor";
    const eventLabel = vendor.eventId ? getEventNameById(vendor.eventId) : currentEventData?.name || "Event";
    const ownerName = vendor.ownerName || vendor.contactName || "";
    const phone = vendor.phone || "";
    const email = vendor.email || "";
    const category = vendor.category || vendor.segment || "";
    const notes = vendor.notes || "";

    openModal(`
      <div class="modal-title" style="font-weight:700;margin-bottom:6px;font-size:16px;">Vendor Details</div>
      <div style="font-size:13px;margin-bottom:8px;">
        <strong>${brandName}</strong>
      </div>
      <div style="font-size:12px;margin-bottom:10px;">
        ${(isSuperAdmin || currentEventId === "all") ? `<div><strong>Event:</strong> ${eventLabel}</div>` : ""}
        <div><strong>Owner:</strong> ${ownerName || "—"}</div>
        <div><strong>Phone:</strong> ${phone || "—"}</div>
        <div><strong>Email:</strong> ${email || "—"}</div>
        <div><strong>Category:</strong> ${category || "—"}</div>
        <div><strong>Status:</strong> ${status}</div>
        <div><strong>Notes:</strong> ${notes || "—"}</div>
        ${vendor.rejectionReason ? `<div style="margin-top:4px;color:#b91c1c;"><strong>Rejection reason:</strong> ${vendor.rejectionReason}</div>` : ""}
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;justify-content:flex-end;">
        <button onclick="closeModal()" class="btn btn-ghost">Close</button>
        ${status !== "approved" ? `<button id="btn-vendor-approve" class="btn btn-primary">Approve</button>` : ""}
        ${status === "approved" ? `<button id="btn-vendor-suspend" class="btn btn-danger">Suspend</button>` : ""}
        ${(status === "rejected" || status === "suspended") ? `<button id="btn-vendor-reactivate" class="btn btn-primary">Re-Activate</button>` : ""}
        <button id="btn-vendor-open-pos" class="btn btn-ghost">Open POS</button>
      </div>
    `);

    const btnApprove = qs("#btn-vendor-approve");
    const btnSuspend = qs("#btn-vendor-suspend");
    const btnReactivate = qs("#btn-vendor-reactivate");
    const btnOpenPOS = qs("#btn-vendor-open-pos");

    btnApprove?.addEventListener("click", async () => {
      await updateVendorStatus(vendor, "approved");
      closeModal();
    });
    btnSuspend?.addEventListener("click", async () => {
      await updateVendorStatus(vendor, "suspended");
      closeModal();
    });
    btnReactivate?.addEventListener("click", async () => {
      await updateVendorStatus(vendor, "approved");
      closeModal();
    });
    btnOpenPOS?.addEventListener("click", () => {
      openVendorPOS(vendor);
    });
  }

  function openVendorPOS(vendor) {
    const eventId = vendor.eventId || currentEventId;
    if (!eventId) return;
    const brandId = vendor.brandId;
    const branchId = vendor.branchId || "";
    if (!brandId) {
      alert("No brand linked for this vendor.");
      return;
    }
    const url = new URL(window.location.origin + "/pos.html");
    url.searchParams.set("brandId", brandId);
    if (branchId) url.searchParams.set("branchId", branchId);
    url.searchParams.set("eventId", eventId);
    window.open(url.toString(), "_blank");
  }

  btnManualVendor?.addEventListener("click", () => {
    if (!currentEventId) {
      alert("No event selected.");
      return;
    }
    if (currentEventId === "all") {
      alert("Select a specific event before adding a vendor.");
      return;
    }
    openModal(`
      <div class="modal-title" style="font-weight:700;margin-bottom:8px;font-size:16px;">Add Vendor Manually</div>
      <div class="field">
        <div class="field-label">Brand name</div>
        <input id="mv-brand-name" class="field-input" placeholder="Brand name"/>
      </div>
      <div class="field">
        <div class="field-label">Owner name</div>
        <input id="mv-owner-name" class="field-input" placeholder="Owner full name"/>
      </div>
      <div class="field">
        <div class="field-label">Phone</div>
        <input id="mv-phone" class="field-input" placeholder="Phone"/>
      </div>
      <div class="field">
        <div class="field-label">Email</div>
        <input id="mv-email" class="field-input" placeholder="Email"/>
      </div>
      <div class="field">
        <div class="field-label">Category</div>
        <input id="mv-category" class="field-input" placeholder="Food, Fashion, etc."/>
      </div>
      <div class="field">
        <div class="field-label">Notes (optional)</div>
        <textarea id="mv-notes" class="field-input" style="min-height:60px;"></textarea>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px;">
        <button onclick="closeModal()" class="btn btn-ghost">Cancel</button>
        <button id="mv-submit" class="btn btn-primary">Create vendor</button>
      </div>
    `);

    const btnSubmit = qs("#mv-submit");
    btnSubmit?.addEventListener("click", async () => {
      const brandName = qs("#mv-brand-name")?.value.trim();
      const ownerName = qs("#mv-owner-name")?.value.trim();
      const phone = qs("#mv-phone")?.value.trim();
      const email = qs("#mv-email")?.value.trim();
      const category = qs("#mv-category")?.value.trim();
      const notes = qs("#mv-notes")?.value.trim();

      if (!brandName) {
        alert("Brand name is required.");
        return;
      }

      try {
        // brand
        const brandRef = await addDoc(collection(db, "brands"), {
          name: brandName,
          ownerName: ownerName || null,
          phone: phone || null,
          email: email || null,
          category: category || null,
          status: "active",
          createdAt: serverTimestamp()
        });
        const brandId = brandRef.id;

        // branch
        const branchRef = await addDoc(collection(db, "brands", brandId, "branches"), {
          name: "Main",
          status: "active",
          createdAt: serverTimestamp()
        });
        const branchId = branchRef.id;

        // staff owner (placeholder)
        await addDoc(collection(db, "brands", brandId, "staff"), {
          name: ownerName || "Owner",
          phone: phone || null,
          email: email || null,
          role: "owner",
          createdAt: serverTimestamp()
        });

        // vendor doc under event
        await addDoc(collection(db, "events", currentEventId, "vendors"), {
          brandId,
          branchId,
          brandName,
          ownerName: ownerName || null,
          phone: phone || null,
          email: email || null,
          category: category || null,
          notes: notes || null,
          status: "approved",
          createdAt: serverTimestamp()
        });

        alert("Vendor created and approved.");
        closeModal();
      } catch (err) {
        console.error("Error creating manual vendor:", err);
        alert("Failed to create vendor.");
      }
    });
  });

  function buildVendorSignupUrl() {
    if (!currentEventData || currentEventId === "all") return "";
    const eid = currentEventData.id;
    const token = currentEventData.vendorSignupToken || "";
    const url = new URL(VENDOR_SIGNUP_BASE_URL);
    url.searchParams.set("eventId", eid);
    if (token) url.searchParams.set("token", token);
    return url.toString();
  }

  btnCopyVendorLink?.addEventListener("click", () => {
    const url = buildVendorSignupUrl();
    if (!url) {
      alert("No event selected or vendor token missing.");
      return;
    }
    copyToClipboard(url);
    alert("Vendor signup link copied.");
  });

  // vendor filters / search
  vendorStatusFiltersEl?.addEventListener("click", (e) => {
    const t = e.target;
    if (!(t instanceof HTMLElement)) return;
    if (!t.dataset.status) return;
    vendorStatusFilter = t.dataset.status;
    vendorStatusFiltersEl.querySelectorAll(".pill").forEach((p) => p.classList.remove("active"));
    t.classList.add("active");
    renderVendorsSection();
  });

  vendorSearchEl?.addEventListener("input", () => {
    vendorSearchTerm = vendorSearchEl.value.trim();
    renderVendorsSection();
  });

  // export vendors
  function downloadCsv(filename, rows) {
    const escapeVal = (v) => {
      if (v === null || v === undefined) return "";
      const s = String(v).replace(/"/g, '""');
      if (/[" ,\n]/.test(s)) return `"${s}"`;
      return s;
    };
    const csv = rows.map((r) => r.map(escapeVal).join(",")).join("\n");
    const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  btnExportVendors?.addEventListener("click", () => {
    if (!vendors.length) {
      alert("No vendors to export.");
      return;
    }
    const includeEvent = isSuperAdmin || currentEventId === "all";
    const rows = [includeEvent
      ? ["eventId","eventName","brandName","ownerName","phone","email","category","status"]
      : ["brandName","ownerName","phone","email","category","status"]
    ];
    vendors.forEach((v) => {
      const row = [
        v.brandName || v.vendorName || "",
        v.ownerName || v.contactName || "",
        v.phone || "",
        v.email || "",
        v.category || v.segment || "",
        v.status || "pending"
      ];
      if (includeEvent) {
        const eventName = v.eventId ? getEventNameById(v.eventId) : "";
        row.unshift(v.eventId || "", eventName);
      }
      rows.push(row);
    });
    downloadCsv("vendors.csv", rows);
  });

  // -----------------------------
  // ORDERS TABLE & EXPORT
  // -----------------------------
  function renderOrdersTable(filteredOrders) {
    if (!ordersTableWrapperEl) return;
    if (!filteredOrders.length) {
      ordersTableWrapperEl.innerHTML = `<div class="table-empty">No orders yet for this view.</div>`;
      return;
    }

    const list = [...filteredOrders].sort((a,b) => parseOrderDate(b) - parseOrderDate(a));
    const showEventColumn = isSuperAdmin || currentEventId === "all";

    let html = `
      <table>
        <thead>
          <tr>
            ${showEventColumn ? "<th>Event</th>" : ""}
            <th>Order ID</th>
            <th>Brand</th>
            <th>Total</th>
            <th>Payment</th>
            <th>Type</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
    `;
    list.forEach((o) => {
      const d = parseOrderDate(o);
      const dateStr = d.toLocaleString("en-EG", { day:"2-digit", month:"short", hour:"2-digit", minute:"2-digit" });
      const brandName = o.brandName || (brandMap[o.brandId]?.name) || "Brand";
      const isReturn = !!o.isReturn;
      const eventLabel = o.eventId ? getEventNameById(o.eventId) : currentEventData?.name || "Event";
      html += `
        <tr>
          ${showEventColumn ? `<td>${eventLabel}</td>` : ""}
          <td>${o.orderId || o.id}</td>
          <td>${brandName}</td>
          <td>${formatCurrency(o.total)}</td>
          <td>${o.paymentMethod || ""}</td>
          <td>${isReturn ? "refund" : "sale"}</td>
          <td>${dateStr}</td>
        </tr>
      `;
    });
    html += `</tbody></table>`;
    ordersTableWrapperEl.innerHTML = html;

    window.__ordersForExport = list;
  }

  btnExportOrders?.addEventListener("click", () => {
    const list = window.__ordersForExport || [];
    if (!list.length) {
      alert("No orders to export.");
      return;
    }
    const includeEvent = isSuperAdmin || currentEventId === "all";
    const rows = [includeEvent
      ? ["eventId","eventName","orderId","brand","total","paymentMethod","type","createdAt"]
      : ["orderId","brand","total","paymentMethod","type","createdAt"]
    ];
    list.forEach((o) => {
      const d = parseOrderDate(o);
      const row = [
        o.orderId || o.id,
        o.brandName || (brandMap[o.brandId]?.name) || "",
        o.total || 0,
        o.paymentMethod || "",
        o.isReturn ? "refund" : "sale",
        d.toISOString()
      ];
      if (includeEvent) {
        const eventName = o.eventId ? getEventNameById(o.eventId) : "";
        row.unshift(o.eventId || "", eventName);
      }
      rows.push(row);
    });
    downloadCsv("event_orders.csv", rows);
  });

  // -----------------------------
  // CUSTOMERS EXPORT
  // -----------------------------
  btnExportCustomers?.addEventListener("click", () => {
    const list = window.__customersForExport || [];
    if (!list.length) {
      alert("No customers to export.");
      return;
    }
    const rows = [["name","phone","email","orders","totalSpent","avgOrder","lastOrder"]];
    list.forEach((c) => {
      rows.push([
        c.name,
        c.phone || "",
        c.email || "",
        c.orders,
        c.totalSpent,
        c.orders ? c.totalSpent / c.orders : 0,
        c.lastOrderAt ? c.lastOrderAt.toISOString() : ""
      ]);
    });
    downloadCsv("customers.csv", rows);
  });

  customerSearchEl?.addEventListener("input", () => {
    customerSearchTerm = customerSearchEl.value.trim();
    recomputeAllAnalytics();
  });

  // -----------------------------
  // SETTINGS SAVE
  // -----------------------------
  btnSaveEventSettings?.addEventListener("click", async () => {
    if (!currentEventId) {
      alert("No event selected.");
      return;
    }
    if (currentEventId === "all") {
      alert("Select a specific event before editing settings.");
      return;
    }
    const name = setEventNameEl?.value.trim() || null;
    const location = setEventLocationEl?.value.trim() || null;
    const startDate = setEventStartEl?.value.trim() || null;
    const endDate = setEventEndEl?.value.trim() || null;

    try {
      await updateDoc(doc(db, "events", currentEventId), {
        name,
        location,
        startDate,
        endDate
      });
      alert("Event settings saved.");
      // refresh event data
      await selectEvent(currentEventId);
    } catch (err) {
      console.error("Error saving settings:", err);
      alert("Failed to save event settings.");
    }
  });

  btnCreateEvent?.addEventListener("click", () => {
    if (!currentUser) {
      alert("Sign in to create an event.");
      return;
    }
    if (isSuperAdmin) {
      alert("Super admins cannot create events here.");
      return;
    }
    openModal(`
      <div class="modal-title" style="font-weight:700;margin-bottom:8px;font-size:16px;">Create new event</div>
      <div class="field">
        <div class="field-label">Event name</div>
        <input id="new-event-name" class="field-input" placeholder="Event name"/>
      </div>
      <div class="field">
        <div class="field-label">Location</div>
        <input id="new-event-location" class="field-input" placeholder="City, venue"/>
      </div>
      <div class="field">
        <div class="field-label">Start date</div>
        <input id="new-event-start" class="field-input" type="date"/>
      </div>
      <div class="field">
        <div class="field-label">End date</div>
        <input id="new-event-end" class="field-input" type="date"/>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
        <button onclick="closeModal()" class="btn btn-ghost">Cancel</button>
        <button id="btn-confirm-create-event" class="btn btn-primary">Create event</button>
      </div>
    `);

    const btnConfirm = qs("#btn-confirm-create-event");
    btnConfirm?.addEventListener("click", async () => {
      const name = qs("#new-event-name")?.value.trim();
      const location = qs("#new-event-location")?.value.trim() || null;
      const startDate = qs("#new-event-start")?.value.trim() || null;
      const endDate = qs("#new-event-end")?.value.trim() || null;
      if (!name) {
        alert("Event name is required.");
        return;
      }
      try {
        const vendorToken = Math.random().toString(36).substring(2, 10).toUpperCase();
        const evRef = await addDoc(collection(db, "events"), {
          name,
          location,
          startDate,
          endDate,
          ownerUserId: currentUser.uid,
          status: "active",
          vendorSignupToken: vendorToken,
          createdAt: serverTimestamp()
        });
        const eventId = evRef.id;
        const ownerEventsRef = doc(db, "ownerEvents", currentUser.uid);
        const existingSnap = await getDoc(ownerEventsRef);
        const existing = existingSnap.exists() ? existingSnap.data() : {};
        const ids = Array.isArray(existing.eventIds) ? existing.eventIds : [];
        if (!ids.includes(eventId)) ids.push(eventId);
        await setDoc(
          ownerEventsRef,
          {
            primaryEventId: eventId,
            eventIds: ids
          },
          { merge: true }
        );
        await loadEventsForUser(currentUser.uid);
        currentEventId = eventId;
        renderEventSwitcher();
        await selectEvent(eventId);
        closeModal();
        alert("Event created.");
      } catch (err) {
        console.error("Failed to create event:", err);
        alert("Failed to create event.");
      }
    });
  });

  // -----------------------------
  // CHART HELPERS
  // -----------------------------
  function updateLineChart(instance, canvasId, labels, data, label) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    if (instance) instance.destroy();
    if (!labels.length) {
      // create empty chart with no data
      instance = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [{
            label,
            data: []
          }]
        }
      });
      return;
    }
    instance = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label,
          data,
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { autoSkip: true, maxTicksLimit: 6 } },
          y: { beginAtZero: true }
        }
      }
    });
    if (canvasId === "chart-revenue-timeline") chartRevenueTimeline = instance;
    if (canvasId === "chart-peak-sparkline") chartPeakSparkline = instance;
  }

  function updateDoughnutChart(instance, canvasId, labels, data) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    if (instance) instance.destroy();
    instance = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels,
        datasets: [{
          data
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: "bottom" }
        },
        cutout: "60%"
      }
    });
    if (canvasId === "chart-payment-mix") chartPaymentMix = instance;
  }

  function updateBarChart(instance, canvasId, labels, data, label) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    if (instance) instance.destroy();
    if (!labels.length) {
      instance = new Chart(ctx, {
        type: "bar",
        data: { labels: [], datasets:[{ label, data:[] }] }
      });
      return;
    }
    instance = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label,
          data
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display:false } },
        scales: {
          x: { ticks: { autoSkip:true, maxTicksLimit:6 } },
          y: { beginAtZero:true }
        }
      }
    });
    if (canvasId === "chart-top-products") chartTopProducts = instance;
  }

  // -----------------------------
  // NAVIGATION
  // -----------------------------
  navItems.forEach((btn) => {
    btn.addEventListener("click", () => {
      const pageId = btn.dataset.page;
      if (!pageId) return;
      navItems.forEach((b) => b.classList.remove("active"));
      pages.forEach((p) => p.classList.remove("active"));
      btn.classList.add("active");
      const pageEl = qs("#" + pageId);
      if (pageEl) pageEl.classList.add("active");

      if (pageId === "page-overview" && topbarTitleEl) topbarTitleEl.textContent = "Event Overview";
      if (pageId === "page-vendors" && topbarTitleEl) topbarTitleEl.textContent = "Vendors";
      if (pageId === "page-products" && topbarTitleEl) topbarTitleEl.textContent = "Products & Returns";
      if (pageId === "page-customers" && topbarTitleEl) topbarTitleEl.textContent = "Customers";
      if (pageId === "page-sales" && topbarTitleEl) topbarTitleEl.textContent = "Sales & POS";
      if (pageId === "page-admin" && topbarTitleEl) topbarTitleEl.textContent = "Super Admin";
      if (pageId === "page-settings" && topbarTitleEl) topbarTitleEl.textContent = "Event Settings";
    });
  });

  // timeline mode pills
  function setTimelineMode(mode) {
    timelineMode = mode;
    [btnTimelineAuto, btnTimelineDay, btnTimelineHour].forEach((btn) => {
      if (!btn) return;
      const m = btn.dataset.timelineMode;
      if (m === mode) btn.classList.add("active");
      else btn.classList.remove("active");
    });
    recomputeAllAnalytics();
  }

  btnTimelineAuto?.addEventListener("click", () => setTimelineMode("auto"));
  btnTimelineDay?.addEventListener("click", () => setTimelineMode("day"));
  btnTimelineHour?.addEventListener("click", () => setTimelineMode("hour"));

  // -----------------------------
  // LOGOUT
  // -----------------------------
  logoutBtn?.addEventListener("click", async () => {
    if (unsubVendors) unsubVendors();
    if (unsubOrders) unsubOrders();
    unsubVendors = unsubOrders = null;
    if (unsubAdminVendors) unsubAdminVendors();
    if (unsubAdminOrders) unsubAdminOrders();
    unsubAdminVendors = unsubAdminOrders = null;
    await signOut(auth);
    showAuthView();
  });

  // -----------------------------
  // AUTH STATE
  // -----------------------------
  startSystemSettingsListener();
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      currentUser = null;
      ownerProfile = null;
      superAdminProfile = null;
      isSuperAdmin = false;
      eventsList = [];
      currentEventId = null;
      currentEventData = null;
      vendors = [];
      ordersAll = [];
      brandMap = {};
      adminVendorsAll = [];
      adminOrdersAll = [];
      if (unsubVendors) unsubVendors();
      if (unsubOrders) unsubOrders();
      unsubVendors = unsubOrders = null;
      if (unsubAdminVendors) unsubAdminVendors();
      if (unsubAdminOrders) unsubAdminOrders();
      unsubAdminVendors = unsubAdminOrders = null;
      if (roleBadgeEl) roleBadgeEl.style.display = "none";
      if (navAdminEl) navAdminEl.style.display = "none";
      showAuthView();
      return;
    }

    currentUser = user;
    showAppView();

    // owner profile (optional)
    const ownerRef = doc(db, "eventOwners", user.uid);
    const ownerSnap = await getDoc(ownerRef);
    ownerProfile = ownerSnap.exists() ? ownerSnap.data() : null;

    // super admin profile (optional)
    const adminRef = doc(db, "lumaAdmins", user.uid);
    const adminSnap = await getDoc(adminRef);
    superAdminProfile = adminSnap.exists() ? adminSnap.data() : null;
    isSuperAdmin = !!(superAdminProfile && (superAdminProfile.role === "super_admin" || superAdminProfile.isSuperAdmin));

    if (roleBadgeEl) roleBadgeEl.style.display = isSuperAdmin ? "inline-flex" : "none";
    if (navAdminEl) navAdminEl.style.display = isSuperAdmin ? "block" : "none";

    if (isSuperAdmin) {
      startSuperAdminListeners();
    }

    await loadEventsForUser(user.uid);

    if (isSuperAdmin) {
      currentEventId = "all";
    } else {
      // pick primary event
      const ownerEventsRef = doc(db, "ownerEvents", user.uid);
      const ownSnap = await getDoc(ownerEventsRef);
      if (ownSnap.exists()) {
        const data = ownSnap.data();
        if (data.primaryEventId) currentEventId = data.primaryEventId;
      }
      if (!currentEventId && eventsList.length) {
        currentEventId = eventsList[0].id;
      }
    }

    renderEventSwitcher();
    if (currentEventId) {
      await selectEvent(currentEventId);
    }
    if (isSuperAdmin) renderAdminDashboard();
  });

  // start on auth
  showAuthView();
</script>
</body>
</html>
