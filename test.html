<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Luma Events â€” Brand Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#f3f4f6;
      --panel:#ffffff;
      --panel-soft:#f9fafb;
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#2563eb;
      --accent-soft:#dbeafe;
      --accent-strong:#1d4ed8;
      --radius:16px;
      --shadow:0 18px 40px rgba(15,23,42,.12);
      --danger:#ef4444;
      --ok:#16a34a;
      --pending:#facc15;
      --suspended:#dc2626;
      --active:#16a34a;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{min-height:100%;font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    button,input,select,textarea{font-family:inherit}
    .hidden{display:none!important}

    /* Layout */
    .app-shell{display:flex;min-height:100vh}
    .sidebar{
      width:260px;background:linear-gradient(180deg,#0f172a 0%,#111827 100%);
      color:#fff;padding:18px;border-right:1px solid rgba(255,255,255,.08);
      position:sticky;top:0;height:100vh;display:flex;flex-direction:column;gap:14px;
    }
    .brand-block{display:flex;gap:12px;align-items:center}
    .brand-logo{
      width:44px;height:44px;border-radius:14px;background:rgba(255,255,255,.1);
      border:1px solid rgba(255,255,255,.18);background-size:cover;background-position:center;
      box-shadow:0 12px 24px rgba(0,0,0,.22);
    }
    .sidebar-brand-name{font-weight:700;font-size:13px;line-height:1.2}
    .sidebar-nav{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    .nav-item{
      width:100%;text-align:left;border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);color:#fff;padding:10px 12px;border-radius:12px;
      cursor:pointer;font-size:12px;display:flex;gap:10px;align-items:center;
      transition:.12s ease;
    }
    .nav-item:hover{background:rgba(255,255,255,.10)}
    .nav-item.active{background:rgba(37,99,235,.22);border-color:rgba(37,99,235,.42)}
    .nav-item.logout{margin-top:auto;background:rgba(239,68,68,.14);border-color:rgba(239,68,68,.28)}
    .nav-item.logout:hover{background:rgba(239,68,68,.22)}

    .main{flex:1;display:flex;flex-direction:column}
    .topbar{
      position:sticky;top:0;background:rgba(243,244,246,.88);
      backdrop-filter:blur(10px);border-bottom:1px solid var(--border);
      padding:14px 18px;display:flex;justify-content:space-between;align-items:center;gap:10px;z-index:10;
    }
    .topbar-title{font-size:13px;font-weight:700}
    .topbar-sub{font-size:11px;color:var(--muted)}
    .content-area{padding:18px;display:block}

    /* Common UI */
    .card{
      background:var(--panel);border:1px solid var(--border);border-radius:18px;
      box-shadow:var(--shadow);padding:14px;
    }
    .cards-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    @media(max-width:1100px){.cards-grid{grid-template-columns:repeat(2,minmax(0,1fr));}}
    @media(max-width:720px){
      .app-shell{flex-direction:column}
      .sidebar{width:100%;height:auto;position:relative}
      .cards-grid{grid-template-columns:1fr}
    }
    .card-title{font-size:11px;color:var(--muted);font-weight:600}
    .card-number{font-size:22px;font-weight:800;margin-top:8px}
    .card-note{font-size:11px;color:var(--muted);margin-top:6px}

    .page{display:none}
    .page.active{display:block}
    .page-header{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;margin-bottom:12px}
    .page-title{font-weight:800}
    .page-sub{font-size:12px;color:var(--muted);margin-top:4px}
    .page-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    .btn{
      border:1px solid var(--border);background:var(--panel);color:var(--ink);
      padding:10px 12px;border-radius:12px;cursor:pointer;font-size:12px;
      display:inline-flex;gap:8px;align-items:center;justify-content:center;
      transition:.12s ease;user-select:none;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn-primary:hover{background:var(--accent-strong)}
    .btn-ghost{background:var(--panel-soft)}
    .muted{color:var(--muted)}

    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0 12px;}
    .field-input, .field-select, .field-textarea, input[type="text"], input[type="email"], input[type="password"], input[type="number"], select{
      padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--panel);
      font-size:12px;outline:none;min-width:180px;
    }
    .field-input:focus, select:focus, input:focus, textarea:focus{border-color:rgba(37,99,235,.55);box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    .table-wrapper{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;border-bottom:1px solid var(--border);font-size:12px;text-align:left;vertical-align:top}
    th{background:var(--panel-soft);font-weight:700;color:#334155}
    tr:hover td{background:#fbfdff}

    /* Status pills */
    .pill{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:6px 10px;font-size:11px;border:1px solid var(--border);background:var(--panel-soft);color:var(--muted)}
    .pill.ok{background:#ecfdf5;border-color:#bbf7d0;color:#166534}
    .pill.warn{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
    .pill.bad{background:#fef2f2;border-color:#fecaca;color:#991b1b}

    /* Modal */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(15,23,42,.55);
      display:none;align-items:center;justify-content:center;padding:16px;z-index:999;
    }
    .modal{
      width:min(760px,96vw);background:var(--panel);border:1px solid var(--border);
      border-radius:18px;box-shadow:0 24px 60px rgba(0,0,0,.25);overflow:hidden;
    }
    .modal-head{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border);background:var(--panel-soft)}
    .modal-title{font-weight:800;font-size:13px}
    .modal-close{border:1px solid var(--border);background:var(--panel);border-radius:10px;padding:8px 10px;cursor:pointer}
    .modal-content{padding:16px}
    .field{margin-bottom:12px}
    .field-label{font-size:11px;font-weight:700;margin-bottom:6px;color:#334155}
    .field-hint{font-size:11px;color:var(--muted);margin-top:6px}

    /* Auth */
    .auth-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
    .auth-card{width:min(520px,96vw);background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:16px}
    .auth-tabs{display:flex;gap:6px;margin:10px 0 12px;}
    .auth-tab{
      flex:1;border:1px solid var(--border);background:var(--panel-soft);
      padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:700;font-size:12px;
    }
    .auth-tab.active{background:rgba(37,99,235,.12);border-color:rgba(37,99,235,.30);color:#1d4ed8}
    .auth-title{font-weight:900;font-size:14px}
    .auth-sub{font-size:12px;color:var(--muted);margin-top:6px}
    .auth-alert{margin-top:10px;font-size:12px;border-radius:12px;padding:10px;border:1px solid var(--border);background:var(--panel-soft);display:none}
    .auth-alert.error{border-color:#fecaca;background:#fef2f2;color:#991b1b;display:block}
    .auth-alert.success{border-color:#bbf7d0;background:#ecfdf5;color:#166534;display:block}

    /* Low stock panel */
    #lowStockPanel{margin-top:12px;border:1px dashed rgba(239,68,68,.35);background:#fff7f7;border-radius:16px;padding:12px;display:none}
    #lowStockPanelTitle{font-weight:900;font-size:12px;color:#991b1b;margin-bottom:8px}
    #lowStockList{font-size:12px;color:#7f1d1d}

    /* Settings */
    .settings-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media(max-width:980px){.settings-grid{grid-template-columns:1fr}}
    .settings-card{background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:14px}
    .settings-title{font-weight:900;font-size:12px;margin-bottom:10px}
    .settings-row{display:flex;gap:10px;flex-wrap:wrap}

    /* ------------------------------
       SHOPIFY (UI)
    ------------------------------ */
    .shopify-badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;
      border:1px solid var(--border);
      background:var(--panel-soft);
      font-size:11px;color:var(--muted);
    }
    .shopify-badge.ok{background:#ecfdf5;border-color:#bbf7d0;color:#166534;}
    .shopify-badge.warn{background:#fff7ed;border-color:#fed7aa;color:#9a3412;}
    .shopify-inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .shopify-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:12px;}
    .shopify-card{
      border:1px solid var(--border);border-radius:14px;background:var(--panel);
      box-shadow:var(--shadow);padding:12px;
    }
    .shopify-card-top{display:flex;gap:10px;align-items:flex-start;}
    .shopify-thumb{
      width:46px;height:46px;border-radius:12px;
      background:#f3f4f6;background-size:cover;background-position:center;
      border:1px solid rgba(148,163,184,.35);
      flex:0 0 auto;
    }
    .shopify-title{font-size:12px;font-weight:700;line-height:1.2;}
    .shopify-meta{font-size:10px;color:var(--muted);margin-top:3px;}
    .shopify-variants{margin-top:10px;border-top:1px dashed rgba(148,163,184,.5);padding-top:10px;}
    .shopify-variant{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:6px;}
    .shopify-variant label{display:flex;gap:8px;align-items:center;font-size:11px;color:var(--ink);}
    .shopify-variant .vmeta{font-size:10px;color:var(--muted);}
    .shopify-toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px;}
    .shopify-toolbar input{flex:1;min-width:220px;}
    @media(max-width:900px){
      .shopify-grid{grid-template-columns:1fr;}
    }
  </style>
</head>

<body>

  <!-- AUTH VIEW -->
  <div id="authView" class="auth-wrap">
    <div class="auth-card">
      <div class="auth-title">Luma Events â€” Brand Portal</div>
      <div class="auth-sub">Login to your brand dashboard or create a brand account.</div>

      <div class="auth-tabs">
        <button id="tab-login" class="auth-tab active" type="button">Login</button>
        <button id="tab-register" class="auth-tab" type="button">Create brand</button>
      </div>

      <div id="authAlert" class="auth-alert"></div>

      <!-- LOGIN -->
      <div id="loginForm">
        <div class="field">
          <div class="field-label">Email</div>
          <input id="loginEmail" class="field-input" type="email" placeholder="you@brand.com"/>
        </div>
        <div class="field">
          <div class="field-label">Password</div>
          <input id="loginPass" class="field-input" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
        </div>
        <button id="btn-login" class="btn btn-primary" style="width:100%;" type="button">Login</button>
      </div>

      <!-- REGISTER -->
      <div id="registerForm" class="hidden">
        <div class="field">
          <div class="field-label">Brand name</div>
          <input id="regBrandName" class="field-input" placeholder="Your brand name"/>
        </div>
        <div class="field">
          <div class="field-label">Email</div>
          <input id="regEmail" class="field-input" type="email" placeholder="you@brand.com"/>
        </div>
        <div class="field">
          <div class="field-label">Password</div>
          <input id="regPass" class="field-input" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
        </div>
        <div class="field">
          <div class="field-label">Phone</div>
          <input id="regPhone" class="field-input" placeholder="+20 01x xxx xxxx"/>
          <div class="field-hint">Optional â€” used for contact inside the event.</div>
        </div>
        <button id="btn-register" class="btn btn-primary" style="width:100%;" type="button">Create brand</button>
      </div>
    </div>
  </div>

  <!-- APP VIEW -->
  <div id="appView" class="app-shell hidden">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand-block">
        <div id="sidebar-logo" class="brand-logo"></div>
        <div>
          <div id="sidebar-brand-name" class="sidebar-brand-name">Brand</div>
          <div id="sidebar-event-label" style="font-size:10px;color:var(--muted);"></div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <button class="nav-item active" data-page="page-dashboard">Overview</button>
        <button class="nav-item" data-page="page-products">Products</button>
        <button class="nav-item" data-page="page-staff">Staff & POS Users</button>
        <button class="nav-item" data-page="page-customers">Customers</button>
        <button class="nav-item" data-page="page-orders">Orders</button>
        <button class="nav-item" data-page="page-help">Help & Guide</button>
        <button class="nav-item" data-page="page-settings">Settings</button>
      </nav>

      <button id="btn-logout" class="nav-item logout" type="button">Logout</button>
    </aside>

    <!-- MAIN -->
    <div class="main">

      <div class="topbar">
        <div>
          <div id="topbar-title" class="topbar-title">Brand â€” Dashboard</div>
          <div id="topbar-sub" class="topbar-sub">Connected to event.</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <span id="statusPill" class="pill warn">Status: Pending</span>
        </div>
      </div>

      <div class="content-area">

        <!-- OVERVIEW -->
        <section id="page-dashboard" class="page active">
          <div class="page-header">
            <div>
              <div class="page-title" style="font-size:16px;">Overview</div>
              <div class="page-sub">High-level view of todayâ€™s performance.</div>
            </div>
          </div>

          <div class="cards-grid">
            <div class="card">
              <div class="card-title">Sales Today</div>
              <div id="dash-sales-today" class="card-number">0</div>
              <div class="card-note">Net of returns.</div>
            </div>
            <div class="card">
              <div class="card-title">Sales Orders Today</div>
              <div id="dash-orders-today" class="card-number">0</div>
              <div class="card-note">Number of sale orders (no returns-only).</div>
            </div>
            <div class="card">
              <div class="card-title">Returns Today</div>
              <div id="dash-returns-today" class="card-number">0</div>
              <div class="card-note">Total returned value.</div>
            </div>
            <div class="card">
              <div class="card-title">Low Stock Items</div>
              <div id="dash-lowstock" class="card-number">0</div>
              <div class="card-note">Items below threshold.</div>
            </div>
          </div>

          <div style="margin-top:12px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;">
            <div class="card">
              <div class="card-title">Top Products (Today)</div>
              <div id="dash-top-products" class="muted" style="font-size:12px;margin-top:10px;">â€”</div>
            </div>
            <div class="card">
              <div class="card-title">Peak Hour (Today)</div>
              <div id="dash-peak-hour" class="muted" style="font-size:12px;margin-top:10px;">â€”</div>
            </div>
          </div>
        </section>

        <!-- PRODUCTS -->
        <section id="page-products" class="page">
          <div class="page-header">
            <div>
              <div class="page-title" style="font-size:16px;">Products</div>
              <div class="page-sub">Manage your products for this event. Images, prices, stock, and simple variants.</div>
            </div>

            <div class="page-actions shopify-inline">
              <span id="shopify-status" class="shopify-badge warn">Shopify: Not connected</span>
              <span id="shopify-store" class="muted" style="font-size:11px;"></span>
              <button id="btn-shopify-connect" class="btn btn-ghost" type="button">Connect Shopify</button>
              <button id="btn-shopify-disconnect" class="btn btn-ghost" type="button" style="display:none;">Disconnect</button>
              <button id="btn-shopify-import" class="btn btn-ghost" type="button" style="display:none;">Import from Shopify</button>
              <button id="btn-add-product" class="btn btn-primary" type="button">Add product</button>
            </div>
          </div>

          <div class="toolbar">
            <input id="products-search" type="text" placeholder="Search products by name or SKU"/>
            <select id="products-sort">
              <option value="name-asc">Name (A â†’ Z)</option>
              <option value="name-desc">Name (Z â†’ A)</option>
              <option value="price-asc">Price (low â†’ high)</option>
              <option value="price-desc">Price (high â†’ low)</option>
              <option value="stock-asc">Stock (low â†’ high)</option>
              <option value="stock-desc">Stock (high â†’ low)</option>
            </select>
          </div>

          <div class="table-wrapper" id="products-table-wrapper"><!-- Filled by JS --></div>

          <div id="lowStockPanel">
            <div id="lowStockPanelTitle">Low stock alerts</div>
            <div id="lowStockList"></div>
          </div>
        </section>

        <!-- STAFF -->
        <section id="page-staff" class="page">
          <div class="page-header">
            <div>
              <div class="page-title" style="font-size:16px;">Staff & POS Users</div>
              <div class="page-sub">Create cashiers / POS users under this brand. These live in <b>brands/{brandId}/staff</b>.</div>
            </div>
            <div class="page-actions">
              <button id="btn-add-staff" class="btn btn-primary" type="button">Add staff</button>
            </div>
          </div>

          <div class="toolbar">
            <input id="staff-search" type="text" placeholder="Search staff by name or username"/>
          </div>

          <div class="table-wrapper" id="staff-table-wrapper"><!-- Filled by JS --></div>
        </section>

        <!-- CUSTOMERS -->
        <section id="page-customers" class="page">
          <div class="page-header">
            <div>
              <div class="page-title" style="font-size:16px;">Customers</div>
              <div class="page-sub">Customers are optional (but required if you want to send receipts).</div>
            </div>
          </div>

          <div class="toolbar">
            <input id="customers-search" type="text" placeholder="Search by name, phone, or email"/>
          </div>

          <div class="table-wrapper" id="customers-table-wrapper"><!-- Filled by JS --></div>
        </section>

        <!-- ORDERS -->
        <section id="page-orders" class="page">
          <div class="page-header">
            <div>
              <div class="page-title" style="font-size:16px;">Orders</div>
              <div class="page-sub">Your sales and returns for this event.</div>
            </div>
          </div>

          <div class="toolbar">
            <input id="orders-search" type="text" placeholder="Search orders by customer, id, or cashier"/>
            <select id="orders-filter">
              <option value="all">All</option>
              <option value="sale">Sales only</option>
              <option value="return">Returns only</option>
            </select>
          </div>

          <div class="table-wrapper" id="orders-table-wrapper"><!-- Filled by JS --></div>
        </section>

        <!-- HELP -->
        <section id="page-help" class="page">
          <div class="page-header">
            <div>
              <div class="page-title" style="font-size:16px;">Help & Guide</div>
              <div class="page-sub">How to use the brand dashboard.</div>
            </div>
          </div>

          <div class="card">
            <div style="font-weight:900;font-size:13px;margin-bottom:10px;">Quick guide</div>
            <ol style="padding-left:18px;font-size:12px;color:var(--muted);line-height:1.8;">
              <li>Add products (or import from Shopify)</li>
              <li>Create staff (cashiers/POS users)</li>
              <li>Track orders and returns</li>
              <li>Update your brand info in Settings</li>
            </ol>
          </div>
        </section>

        <!-- SETTINGS -->
        <section id="page-settings" class="page">
          <div class="page-header">
            <div>
              <div class="page-title" style="font-size:16px;">Settings</div>
              <div class="page-sub">Basic brand info and contact details used inside the event.</div>
            </div>
          </div>

          <div class="settings-grid">
            <div class="settings-card">
              <div class="settings-title">Brand Info</div>
              <div class="field">
                <div class="field-label">Brand name</div>
                <input id="settings-brand-name" class="field-input" placeholder="Brand name"/>
              </div>
              <div class="field">
                <div class="field-label">Phone</div>
                <input id="settings-phone" class="field-input" placeholder="+20 01x xxx xxxx"/>
              </div>
              <div class="field">
                <div class="field-label">Email</div>
                <input id="settings-email" class="field-input" placeholder="you@brand.com"/>
              </div>

              <div class="field">
                <div class="field-label">Brand logo</div>
                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                  <div id="settings-logo-preview" class="brand-logo" style="width:54px;height:54px;border-radius:16px;background:#f3f4f6;"></div>
                  <input id="settings-logo-file" type="file" accept="image/*"/>
                  <button id="btn-upload-logo" class="btn btn-ghost" type="button">Upload</button>
                </div>
                <div class="field-hint">Uploads to Firebase Storage and saves the URL on your brand document.</div>
              </div>

              <button id="btn-save-settings" class="btn btn-primary" type="button">Save settings</button>
            </div>

            <div class="settings-card">
              <div class="settings-title">Event & Status</div>
              <p style="font-size:12px;color:var(--muted);margin-bottom:10px;">
                This section shows how your brand is connected to the event.
                If your brand is rejected/suspended, access will be limited.
              </p>
              <div class="field">
                <div class="field-label">Event name</div>
                <input id="settings-event-name" class="field-input" disabled/>
              </div>
              <div class="field">
                <div class="field-label">Event ID</div>
                <input id="settings-event-id" class="field-input" disabled/>
              </div>
              <div class="field">
                <div class="field-label">Status</div>
                <input id="settings-status" class="field-input" disabled/>
              </div>
              <div class="field">
                <div class="field-label">Notes</div>
                <textarea id="settings-notes" class="field-textarea" rows="4" placeholder="Optional internal notes..."></textarea>
              </div>
            </div>

            <div class="settings-card">
              <div class="settings-title">Shopify</div>
              <p style="font-size:12px;color:var(--muted);margin-bottom:10px;">
                Connect your Shopify store to import products and sync inventory <b>Shopify â†’ Luma</b> only.
                Sales & receipts stay in Luma.
              </p>

              <div class="card" style="margin-bottom:10px;">
                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                  <span id="settings-shopify-status" class="shopify-badge warn">Shopify: Not connected</span>
                  <span id="settings-shopify-store" class="muted" style="font-size:12px;"></span>
                </div>
              </div>

              <div class="field">
                <div class="field-label">Shopify OAuth start URL (n8n webhook)</div>
                <input id="shopify-oauth-url" class="field-input" placeholder="https://automation.evu.business/webhook/...."/>
                <div class="field-hint">Your n8n webhook that starts OAuth. We will redirect the browser to it with brandId + eventId + shop.</div>
              </div>

              <div class="field">
                <div class="field-label">Shopify Products List URL (n8n webhook)</div>
                <input id="shopify-list-url" class="field-input" placeholder="https://automation.evu.business/webhook/...."/>
                <div class="field-hint">Should return: { products:[{id,title,image,variants:[{id,title,sku,price,inventory_item_id}]}] }</div>
              </div>

              <div class="field">
                <div class="field-label">Shopify Import URL (n8n webhook)</div>
                <input id="shopify-import-url" class="field-input" placeholder="https://automation.evu.business/webhook/...."/>
                <div class="field-hint">We will POST selected products to this webhook.</div>
              </div>

              <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button id="btn-shopify-settings-connect" class="btn btn-primary" type="button">Connect Shopify</button>
                <button id="btn-shopify-settings-disconnect" class="btn btn-ghost" type="button" style="display:none;">Disconnect</button>
                <button id="btn-shopify-settings-refresh" class="btn btn-ghost" type="button">Refresh status</button>
              </div>
            </div>
          </div>
        </section>

      </div>
    </div>
  </div>

  <!-- REJECTED OVERLAY -->
  <div id="rejectedOverlay" class="modal-backdrop">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title">Access limited</div>
        <button id="btnRejectedLogout" class="modal-close" type="button">Logout</button>
      </div>
      <div class="modal-content">
        <div class="pill bad">Your brand is not approved / suspended.</div>
        <div class="muted" style="margin-top:10px;font-size:12px;line-height:1.7;">
          Please contact the event owner. You can still view limited info depending on your status.
        </div>
      </div>
    </div>
  </div>

  <!-- GLOBAL MODAL -->
  <div id="modalContainer" class="modal-backdrop">
    <div class="modal">
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- GLOBAL ALERT -->
  <div id="globalAlert" class="auth-alert" style="position:fixed;right:16px;bottom:16px;max-width:360px;z-index:9999;display:none;"></div>
  <script type="module">
  /***********************
   * 0) QUICK HELPERS
   ***********************/
  const qs  = (s, r=document)=>r.querySelector(s);
  const qsa = (s, r=document)=>Array.from(r.querySelectorAll(s));

  const authView  = qs("#authView");
  const appView   = qs("#appView");

  const tabLogin    = qs("#tab-login");
  const tabRegister = qs("#tab-register");
  const loginForm   = qs("#loginForm");
  const registerForm= qs("#registerForm");

  const loginEmail  = qs("#loginEmail");
  const loginPass   = qs("#loginPass");
  const btnLogin    = qs("#btn-login");

  const regBrandName= qs("#regBrandName");
  const regEmail    = qs("#regEmail");
  const regPass     = qs("#regPass");
  const regPhone    = qs("#regPhone");
  const btnRegister = qs("#btn-register");

  const authAlert   = qs("#authAlert");
  const globalAlert = qs("#globalAlert");

  const navItems = qsa(".nav-item[data-page]");
  const pages    = qsa(".page");

  const topbarTitle = qs("#topbar-title");
  const topbarSub   = qs("#topbar-sub");

  const sidebarLogo = qs("#sidebar-logo");
  const sidebarBrandName = qs("#sidebar-brand-name");
  const sidebarEventLabel = qs("#sidebar-event-label");

  const statusPill = qs("#statusPill");
  const rejectedOverlay = qs("#rejectedOverlay");
  const btnRejectedLogout = qs("#btnRejectedLogout");

  const modalContainer = qs("#modalContainer");
  const modalBody = qs("#modalBody");

  function showAuthAlert(msg, kind="error"){
    authAlert.className = "auth-alert " + (kind==="success" ? "success" : "error");
    authAlert.textContent = msg;
    authAlert.style.display = "block";
  }
  function hideAuthAlert(){
    authAlert.style.display = "none";
    authAlert.textContent = "";
  }
  function toast(msg, kind="success"){
    globalAlert.className = "auth-alert " + (kind==="success" ? "success" : "error");
    globalAlert.textContent = msg;
    globalAlert.style.display = "block";
    clearTimeout(window.__toastT);
    window.__toastT = setTimeout(()=>{ globalAlert.style.display="none"; }, 3200);
  }
  function escapeHtml(str=""){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function openModal(innerHtml){
    modalBody.innerHTML = `
      <div class="modal-head">
        <div class="modal-title">Action</div>
        <button class="modal-close" type="button" id="modalCloseBtn">Close</button>
      </div>
      <div class="modal-content">${innerHtml}</div>
    `;
    modalContainer.style.display = "flex";
    qs("#modalCloseBtn").addEventListener("click", closeModal);
  }
  function closeModal(){
    modalContainer.style.display = "none";
    modalBody.innerHTML = "";
  }
  modalContainer.addEventListener("click", (e)=>{
    if(e.target === modalContainer) closeModal();
  });

  function setActivePage(id){
    pages.forEach(p=>p.classList.remove("active"));
    qs("#"+id)?.classList.add("active");
    navItems.forEach(n=>n.classList.toggle("active", n.dataset.page===id));
    const labelMap = {
      "page-dashboard":"Brand â€” Overview",
      "page-products":"Brand â€” Products",
      "page-staff":"Brand â€” Staff",
      "page-customers":"Brand â€” Customers",
      "page-orders":"Brand â€” Orders",
      "page-help":"Brand â€” Help",
      "page-settings":"Brand â€” Settings"
    };
    topbarTitle.textContent = labelMap[id] || "Brand â€” Dashboard";
  }

  tabLogin.addEventListener("click", ()=>{
    tabLogin.classList.add("active");
    tabRegister.classList.remove("active");
    loginForm.classList.remove("hidden");
    registerForm.classList.add("hidden");
    hideAuthAlert();
  });
  tabRegister.addEventListener("click", ()=>{
    tabRegister.classList.add("active");
    tabLogin.classList.remove("active");
    loginForm.classList.add("hidden");
    registerForm.classList.remove("hidden");
    hideAuthAlert();
  });

  navItems.forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const pageId = btn.dataset.page;
      setActivePage(pageId);
      if(pageId==="page-dashboard") await loadDashboard();
      if(pageId==="page-products")  await loadProducts();
      if(pageId==="page-staff")     await loadStaff();
      if(pageId==="page-customers")await loadCustomers();
      if(pageId==="page-orders")   await loadOrders();
      if(pageId==="page-settings") await loadSettings();
    });
  });

  /***********************
   * 1) FIREBASE (placeholders)
   ***********************/
    async function reloadBrand(){
  if(!brandId) throw new Error("brandId is missing (userBrands mapping not found).");
  const bSnap = await getDoc(doc(db, "brands", brandId));
}

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, getDocs, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import {
    getStorage, ref as sRef, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

  // ðŸ”§ EDIT: Put your Firebase config here
  const firebaseConfig = {
   apiKey:"AIzaSyA80bAAGPuyscnTVS-zwrxE9Jp3tPiS1gM",
    authDomain:"events-339ce.firebaseapp.com",
    databaseURL:"https://events-339ce-default-rtdb.europe-west1.firebasedatabase.app",
    projectId:"events-339ce",
    storageBucket:"events-339ce.firebasestorage.app",
    messagingSenderId:"175601544315",
    appId:"1:175601544315:web:00c94b4affa972b3a286de"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  /***********************
   * 2) STATE
   ***********************/
  let uid = null;
  let brandId = null;
  let brandDoc = null;

  let currentEventId = null;

  let products = [];
  let staff = [];
  let orders = [];
  let customers = [];

  // Shopify runtime
  let shopifyConnected = false;
  let shopifyShop = null;

  // UI refs for pages
  const btnLogout = qs("#btn-logout");

  // dashboard KPI els
  const dashSalesToday = qs("#dash-sales-today");
  const dashOrdersToday = qs("#dash-orders-today");
  const dashReturnsToday = qs("#dash-returns-today");
  const dashLowstock = qs("#dash-lowstock");
  const dashTopProducts = qs("#dash-top-products");
  const dashPeakHour = qs("#dash-peak-hour");

  // products page els
  const productsTableWrapper = qs("#products-table-wrapper");
  const productsSearch = qs("#products-search");
  const productsSort = qs("#products-sort");
  const btnAddProduct = qs("#btn-add-product");

  const lowStockPanel = qs("#lowStockPanel");
  const lowStockPanelTitle = qs("#lowStockPanelTitle");
  const lowStockList = qs("#lowStockList");

  // staff page els
  const staffTableWrapper = qs("#staff-table-wrapper");
  const staffSearch = qs("#staff-search");
  const btnAddStaff = qs("#btn-add-staff");

  // customers
  const customersTableWrapper = qs("#customers-table-wrapper");
  const customersSearch = qs("#customers-search");

  // orders
  const ordersTableWrapper = qs("#orders-table-wrapper");
  const ordersSearch = qs("#orders-search");
  const ordersFilter = qs("#orders-filter");

  // settings els
  const settingsBrandName = qs("#settings-brand-name");
  const settingsPhone = qs("#settings-phone");
  const settingsEmail = qs("#settings-email");
  const settingsLogoPreview = qs("#settings-logo-preview");
  const settingsLogoFile = qs("#settings-logo-file");
  const btnUploadLogo = qs("#btn-upload-logo");
  const btnSaveSettings = qs("#btn-save-settings");

  const settingsEventName = qs("#settings-event-name");
  const settingsEventId = qs("#settings-event-id");
  const settingsStatus = qs("#settings-status");
  const settingsNotes = qs("#settings-notes");

  // Shopify controls
  const shopifyStatusEl = qs("#shopify-status");
  const shopifyStoreEl = qs("#shopify-store");
  const btnShopifyConnect = qs("#btn-shopify-connect");
  const btnShopifyDisconnect = qs("#btn-shopify-disconnect");
  const btnShopifyImport = qs("#btn-shopify-import");

  const settingsShopifyStatus = qs("#settings-shopify-status");
  const settingsShopifyStore = qs("#settings-shopify-store");

  const shopifyOauthUrl = qs("#shopify-oauth-url");
  const shopifyListUrl = qs("#shopify-list-url");
  const shopifyImportUrl = qs("#shopify-import-url");

  const btnShopifySettingsConnect = qs("#btn-shopify-settings-connect");
  const btnShopifySettingsDisconnect = qs("#btn-shopify-settings-disconnect");
  const btnShopifySettingsRefresh = qs("#btn-shopify-settings-refresh");

  /***********************
   * 3) AUTH: LOGIN / REGISTER (FIXED)
   ***********************/
  btnLogin.addEventListener("click", async ()=>{
    hideAuthAlert();
    const email = loginEmail.value.trim();
    const pass = loginPass.value;
    if(!email || !pass) return showAuthAlert("Please enter email and password.", "error");
    try{
      await signInWithEmailAndPassword(auth, email, pass);
    }catch(err){
      console.error(err);
      showAuthAlert(err.message || "Login failed.", "error");
    }
  });

  btnRegister.addEventListener("click", async ()=>{
    hideAuthAlert();
    const bname = regBrandName.value.trim();
    const email = regEmail.value.trim();
    const pass  = regPass.value;
    const phone = regPhone.value.trim() || null;

    if(!bname || !email || !pass) return showAuthAlert("Please fill all required fields.", "error");

    try{
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      await updateProfile(cred.user, { displayName: bname });

      // create brand doc (pending)
      const newBrandRef = doc(collection(db, "brands"));
      await setDoc(newBrandRef, {
        name: bname,
        ownerUid: cred.user.uid,
        status: "pending",
        phone,
        email,
        notes: "",
        logoUrl: null,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        shopify: {
          connected: false,
          shop: null,
          oauthUrl: "",
          listUrl: "",
          importUrl: ""
        }
      });

      // link user -> brand
      await setDoc(doc(db, "userBrands", cred.user.uid), {
        brandId: newBrandRef.id,
        createdAt: serverTimestamp()
      });

      showAuthAlert("Brand created. Pending approval by event owner.", "success");
    } catch(err){
      console.error(err);
      showAuthAlert(err.message || "Registration failed.", "error");
    }
  });

  btnLogout.addEventListener("click", async ()=>{ await signOut(auth); });
  btnRejectedLogout.addEventListener("click", async ()=>{ await signOut(auth); });

  /***********************
   * 4) BRAND LOAD + STATUS GATE
   ***********************/
  function setStatusUI(status){
    const s = (status || "pending").toLowerCase();
    statusPill.textContent = `Status: ${s[0].toUpperCase()+s.slice(1)}`;

    statusPill.className = "pill";
    if(s==="active") statusPill.classList.add("ok");
    else if(s==="pending") statusPill.classList.add("warn");
    else statusPill.classList.add("bad");
  }

  function applyGate(){
    const s = (brandDoc?.status || "pending").toLowerCase();
    setStatusUI(s);

    // overlay for rejected/suspended
    if(s==="rejected" || s==="suspended"){
      rejectedOverlay.style.display = "flex";
    } else {
      rejectedOverlay.style.display = "none";
    }

    // disable destructive actions when not active
    const blocked = (s!=="active");
    const disableIds = [
      "btn-add-product",
      "btn-add-staff",
      "btn-save-settings",
      "btn-upload-logo",
      "btn-shopify-connect",
      "btn-shopify-disconnect",
      "btn-shopify-import",
      "btn-shopify-settings-connect",
      "btn-shopify-settings-disconnect"
    ];
    disableIds.forEach(id=>{
      const el = qs("#"+id);
      if(!el) return;
      el.disabled = blocked;
      el.style.opacity = blocked ? "0.6" : "1";
      el.style.pointerEvents = blocked ? "none" : "auto";
    });
  }

  async function reloadBrand(){
    const bSnap = await getDoc(doc(db, "brands", brandId));
    if(!bSnap.exists()) throw new Error("Brand doc not found");
    brandDoc = bSnap.data();

    sidebarBrandName.textContent = brandDoc?.name || "Brand";
    setStatusUI(brandDoc?.status || "pending");

    // logo
    if(brandDoc?.logoUrl){
      sidebarLogo.style.backgroundImage = `url('${brandDoc.logoUrl}')`;
      settingsLogoPreview.style.backgroundImage = `url('${brandDoc.logoUrl}')`;
    } else {
      sidebarLogo.style.backgroundImage = "";
      settingsLogoPreview.style.backgroundImage = "";
    }

    // Shopify saved endpoints + state
    shopifyConnected = !!brandDoc?.shopify?.connected;
    shopifyShop = brandDoc?.shopify?.shop || null;

    shopifyOauthUrl.value = brandDoc?.shopify?.oauthUrl || "https://automation.evu.business/webhook/1a214893-b73b-4cfd-8776-6a7709a37082";
    shopifyListUrl.value  = brandDoc?.shopify?.listUrl  || "";
    shopifyImportUrl.value= brandDoc?.shopify?.importUrl|| "";
  }

  /***********************
   * 5) SHOPIFY UI STATUS
   ***********************/
  function setShopifyUI(connected, shop=null){
    const on = !!connected;
    const shopText = shop || "";

    // products page top controls
    shopifyStatusEl.textContent = on ? "Shopify: Connected" : "Shopify: Not connected";
    shopifyStatusEl.classList.toggle("ok", on);
    shopifyStatusEl.classList.toggle("warn", !on);
    shopifyStoreEl.textContent = on && shopText ? `Store: ${shopText}` : "";

    btnShopifyConnect.style.display = on ? "none" : "inline-flex";
    btnShopifyDisconnect.style.display = on ? "inline-flex" : "none";
    btnShopifyImport.style.display = on ? "inline-flex" : "none";

    // settings page
    settingsShopifyStatus.textContent = on ? "Shopify: Connected" : "Shopify: Not connected";
    settingsShopifyStatus.classList.toggle("ok", on);
    settingsShopifyStatus.classList.toggle("warn", !on);
    settingsShopifyStore.textContent = on && shopText ? `Store: ${shopText}` : "";

    btnShopifySettingsConnect.style.display = on ? "none" : "inline-flex";
    btnShopifySettingsDisconnect.style.display = on ? "inline-flex" : "none";
  }

  function getShopifyConfig(){
    const oauth = (shopifyOauthUrl.value || "").trim();
    const list  = (shopifyListUrl.value  || "").trim();
    const imp   = (shopifyImportUrl.value|| "").trim();
    return { oauth, list, imp };
  }

  async function saveShopifyConfigPartial(patch){
    // patch only inside brand.shopify
    await updateDoc(doc(db,"brands",brandId), {
      shopify: { ...(brandDoc?.shopify || {}), ...patch, updatedAt: new Date().toISOString() }
    });
    await reloadBrand();
  }

  /***********************
   * 6) SHOPIFY CALLS
   ***********************/
  async function shopifyListProducts(){
    const { list } = getShopifyConfig();
    if(!list) throw new Error("Missing Shopify products list URL in Settings.");

    const res = await fetch(list, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({
        brandId,
        eventId: currentEventId,
        // optional: allow backend to infer from stored token
        request: "listProducts"
      })
    });
    const data = await res.json().catch(()=> ({}));
    if(!res.ok || data.success === false) throw new Error(data.message || "List products failed");
    // expected: { success:true, shop:"xxx", products:[...] }
    return data;
  }

  async function shopifyImportSelected(selectedProducts){
    const { imp } = getShopifyConfig();
    if(!imp) throw new Error("Missing Shopify import URL in Settings.");

    const res = await fetch(imp, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({
        brandId,
        eventId: currentEventId,
        selectedProducts
      })
    });
    const data = await res.json().catch(()=> ({}));
    if(!res.ok || data.success === false) throw new Error(data.message || "Import failed");
    return data;
  }

  async function shopifyDisconnect(){
    // If you donâ€™t have a disconnect endpoint yet, we just clear Firestore state.
    await saveShopifyConfigPartial({ connected:false, shop:null });
    setShopifyUI(false, null);
    toast("Shopify disconnected.", "success");
  }

  function startShopifyConnect(){
    const { oauth } = getShopifyConfig();
    if(!oauth) return toast("Missing Shopify OAuth URL in Settings.", "error");

    // Save config first (so backend can read)
    saveShopifyConfigPartial({ oauthUrl: oauth, listUrl: shopifyListUrl.value.trim(), importUrl: shopifyImportUrl.value.trim() })
      .catch(()=>{});

    // Redirect user to OAuth flow
    const returnUrl = window.location.href.split("#")[0];
    const url = new URL(oauth);
    url.searchParams.set("brandId", brandId);
    if(currentEventId) url.searchParams.set("eventId", currentEventId);
    url.searchParams.set("returnUrl", returnUrl);

    window.location.href = url.toString();
  }

  /***********************
   * 7) SHOPIFY IMPORT MODAL
   ***********************/
  function openShopifyImportModal(productsList){
    const modalHtml = `
      <div class="modal-title">Import from Shopify</div>
      <div class="field-hint" style="margin-top:6px;">
        Select products (optionally specific variants). Inventory is Shopify â†’ Luma only.
      </div>

      <div class="shopify-toolbar">
        <input data-s-search class="field-input" placeholder="Search Shopify products..."/>
        <button data-s-all class="btn btn-ghost" type="button">Select all</button>
        <button data-s-clear class="btn btn-ghost" type="button">Clear</button>
      </div>

      <div data-s-list class="shopify-grid"></div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:14px;">
        <button class="btn btn-ghost" type="button" onclick="(${closeModal.toString()})()">Cancel</button>
        <button data-s-import class="btn btn-primary" type="button">Import selected</button>
      </div>
    `;
    openModal(modalHtml);

    const listEl = modalBody.querySelector("[data-s-list]");
    const searchEl = modalBody.querySelector("[data-s-search]");
    const btnAll = modalBody.querySelector("[data-s-all]");
    const btnClear = modalBody.querySelector("[data-s-clear]");
    const btnImport = modalBody.querySelector("[data-s-import]");

    // selected map
    const selected = new Map(); // pid => { all:true } OR { all:false, variants:Set }

    function setAll(pid, on){
      const k = String(pid);
      if(on) selected.set(k, { all:true, variants:new Set() });
      else selected.delete(k);
    }
    function setVariant(pid, vid, on){
      const k = String(pid);
      if(!selected.has(k)) selected.set(k, { all:false, variants:new Set() });
      const e = selected.get(k);
      e.all = false;
      if(on) e.variants.add(String(vid));
      else e.variants.delete(String(vid));
      if(!e.all && e.variants.size === 0) selected.delete(k);
    }

    function render(){
      const q = (searchEl.value||"").toLowerCase().trim();
      const rows = !q ? productsList : productsList.filter(p => (p.title||"").toLowerCase().includes(q));

      if(!rows.length){
        listEl.innerHTML = `<div class="muted" style="padding:10px;">No matching products.</div>`;
        return;
      }

      listEl.innerHTML = rows.map(p=>{
        const pid = String(p.id);
        const imgStyle = p.image ? `style="background-image:url('${p.image}')"` : "";
        const entry = selected.get(pid);
        const checked = entry ? "checked" : "";
        const mode = entry?.all ? "All variants" : (entry ? `${entry.variants.size} variant(s)` : "Not selected");

        const variants = Array.isArray(p.variants) ? p.variants : [];
        const vHtml = variants.length ? `
          <div class="shopify-variants">
            ${variants.map(v=>{
              const vChecked = entry?.all ? "checked" : (entry?.variants?.has(String(v.id)) ? "checked" : "");
              return `
                <div class="shopify-variant">
                  <label>
                    <input type="checkbox" class="sv" data-pid="${pid}" data-vid="${v.id}" ${vChecked}/>
                    ${escapeHtml(v.title || "Variant")}
                  </label>
                  <div class="vmeta">SKU: ${escapeHtml(v.sku||"-")} Â· ${escapeHtml(String(v.price ?? "-"))}</div>
                </div>
              `;
            }).join("")}
            <div class="muted" style="font-size:11px;margin-top:6px;">Tip: Check product to import all variants.</div>
          </div>
        ` : "";

        return `
          <div class="shopify-card">
            <div class="shopify-card-top">
              <input type="checkbox" class="sp" data-pid="${pid}" ${checked} style="margin-top:4px;"/>
              <div class="shopify-thumb" ${imgStyle}></div>
              <div style="flex:1;">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                  <div class="shopify-title">${escapeHtml(p.title||"Untitled")}</div>
                  <span class="pill">${escapeHtml(mode)}</span>
                </div>
                <div class="shopify-meta">Variants: ${variants.length} Â· Status: ${escapeHtml(p.status||"-")}</div>
                ${vHtml}
              </div>
            </div>
          </div>
        `;
      }).join("");

      // product check => all variants
      qsa(".sp", listEl).forEach(cb=>{
        cb.addEventListener("change", ()=>{
          const pid = cb.getAttribute("data-pid");
          setAll(pid, cb.checked);
          render();
        });
      });

      // variant check
      qsa(".sv", listEl).forEach(cb=>{
        cb.addEventListener("change", ()=>{
          const pid = cb.getAttribute("data-pid");
          const vid = cb.getAttribute("data-vid");
          setVariant(pid, vid, cb.checked);
          render();
        });
      });
    }

    searchEl.addEventListener("input", render);

    btnAll.addEventListener("click", ()=>{
      const q = (searchEl.value||"").toLowerCase().trim();
      const rows = !q ? productsList : productsList.filter(p => (p.title||"").toLowerCase().includes(q));
      rows.forEach(p=>setAll(p.id,true));
      render();
    });

    btnClear.addEventListener("click", ()=>{
      selected.clear();
      render();
    });

    btnImport.addEventListener("click", async ()=>{
      try{
        if(selected.size===0) return toast("Select at least 1 product.", "error");

        btnImport.disabled = true;
        btnImport.textContent = "Importing...";

        const selectedProducts = [];
        for(const [pid, entry] of selected.entries()){
          if(entry.all){
            selectedProducts.push({ productId: Number(pid) });
          } else {
            selectedProducts.push({ productId: Number(pid), variantIds: Array.from(entry.variants).map(Number) });
          }
        }

        const out = await shopifyImportSelected(selectedProducts);
        toast(`Imported ${out.importedProducts ?? selectedProducts.length} product(s).`, "success");
        closeModal();
        await loadProducts();
      } catch(err){
        console.error(err);
        toast(err.message || "Import failed.", "error");
      } finally{
        btnImport.disabled = false;
        btnImport.textContent = "Import selected";
      }
    });

    render();
  }

  /***********************
   * 8) SHOPIFY BUTTONS
   ***********************/
  btnShopifyConnect.addEventListener("click", startShopifyConnect);
  btnShopifySettingsConnect.addEventListener("click", startShopifyConnect);

  btnShopifyDisconnect.addEventListener("click", shopifyDisconnect);
  btnShopifySettingsDisconnect.addEventListener("click", shopifyDisconnect);

  btnShopifySettingsRefresh.addEventListener("click", async ()=>{
    await reloadBrand();
    setShopifyUI(shopifyConnected, shopifyShop);
    toast("Shopify status refreshed.", "success");
  });

  btnShopifyImport.addEventListener("click", async ()=>{
    try{
      const out = await shopifyListProducts();
      if(out.shop){
        await saveShopifyConfigPartial({ connected:true, shop: out.shop, listUrl: shopifyListUrl.value.trim(), importUrl: shopifyImportUrl.value.trim() });
      }
      setShopifyUI(true, out.shop || shopifyShop);

      const list = out.products || [];
      openShopifyImportModal(list);
    } catch(err){
      console.error(err);
      toast(err.message || "Shopify not connected.", "error");
    }
  });

  /***********************
   * 9) SETTINGS SAVE + LOGO UPLOAD
   ***********************/
  btnUploadLogo.addEventListener("click", async ()=>{
    try{
      const file = settingsLogoFile.files?.[0];
      if(!file) return toast("Choose a logo image first.", "error");
      const path = `brands/${brandId}/logo_${Date.now()}_${file.name}`;
      const r = sRef(storage, path);
      await uploadBytes(r, file);
      const url = await getDownloadURL(r);
      await updateDoc(doc(db,"brands",brandId), { logoUrl:url, updatedAt: serverTimestamp() });
      await reloadBrand();
      toast("Logo uploaded.", "success");
    } catch(err){
      console.error(err);
      toast("Logo upload failed.", "error");
    }
  });

  btnSaveSettings.addEventListener("click", async ()=>{
    try{
      const name = settingsBrandName.value.trim();
      const phone = settingsPhone.value.trim() || null;
      const email = settingsEmail.value.trim() || null;
      const notes = settingsNotes.value || "";

      const { oauth, list, imp } = getShopifyConfig();

      if(!name) return toast("Brand name is required.", "error");

      await updateDoc(doc(db,"brands",brandId), {
        name, phone, email, notes,
        shopify: {
          ...(brandDoc?.shopify || {}),
          oauthUrl: oauth,
          listUrl: list,
          importUrl: imp
        },
        updatedAt: serverTimestamp()
      });

      await reloadBrand();
      toast("Settings saved.", "success");
      setShopifyUI(!!brandDoc?.shopify?.connected, brandDoc?.shopify?.shop);
    } catch(err){
      console.error(err);
      toast(err.message || "Save failed.", "error");
    }
  });

  /***********************
   * 10) SEARCH LISTENERS (light)
   ***********************/
  productsSearch.addEventListener("input", ()=>renderProducts());
  productsSort.addEventListener("change", ()=>renderProducts());
  staffSearch.addEventListener("input", ()=>renderStaff());
  customersSearch.addEventListener("input", ()=>renderCustomers());
  ordersSearch.addEventListener("input", ()=>renderOrders());
  ordersFilter.addEventListener("change", ()=>renderOrders());

  /***********************
   * NEXT: Part 3/3 has:
   * - onAuthStateChanged bootstrap
   * - Products CRUD (with safe numeric inputs)
   * - Staff add
   * - Orders/customers load & dashboard KPIs
   ***********************/
      /***********************
   * BOOTSTRAP: AUTH STATE
   ***********************/
  function getUrlParam(k){
    try{ return new URL(window.location.href).searchParams.get(k); }catch{ return null; }
  }
  currentEventId = getUrlParam("eventId");

    async function resolveBrandIdForUser(userUid){
  const ub = await getDoc(doc(db, "userBrands", userUid));
  if(!ub.exists()) throw new Error("No brand linked to this user (userBrands missing).");

  const data = ub.data() || {};
  // support BOTH schemas
  return data.brandId || data.primaryBrandId || (Array.isArray(data.brandIds) ? data.brandIds[0] : null);
}


  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      uid = null;
      brandId = null;
      brandDoc = null;

      authView.classList.remove("hidden");
      appView.classList.add("hidden");
      rejectedOverlay.style.display = "none";
      return;
    }

    uid = user.uid;

    try{
      brandId = await resolveBrandIdForUser(uid);
      await reloadBrand();

      // event label
      sidebarEventLabel.textContent = currentEventId ? `Event: ${currentEventId}` : "Event: (not set)";
      topbarSub.textContent = currentEventId ? `Connected Â· Event ${currentEventId}` : "Connected";

      // settings panel values
      settingsBrandName.value = brandDoc?.name || "";
      settingsPhone.value = brandDoc?.phone || "";
      settingsEmail.value = brandDoc?.email || user.email || "";
      settingsNotes.value = brandDoc?.notes || "";
      settingsEventId.value = currentEventId || "";
      settingsEventName.value = brandDoc?.eventName || ""; // optional if you store it
      settingsStatus.value = brandDoc?.status || "pending";

      // Shopify UI
      setShopifyUI(!!brandDoc?.shopify?.connected, brandDoc?.shopify?.shop);

      // Gate
      applyGate();

      // show app
      authView.classList.add("hidden");
      appView.classList.remove("hidden");

      // Load initial
      setActivePage("page-dashboard");
      await loadDashboard();
    }catch(err){
      console.error(err);
      showAuthAlert(err.message || "Failed to load brand.", "error");
      await signOut(auth);
    }
  });

  /***********************
   * DATA LOADERS
   ***********************/
  async function loadProducts(){
    const snap = await getDocs(collection(db, "brands", brandId, "products"));
    products = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    renderProducts();
    renderLowStock();
  }

  async function loadStaff(){
    const snap = await getDocs(collection(db, "brands", brandId, "staff"));
    staff = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    renderStaff();
  }

  async function loadOrders(){
    const snap = await getDocs(collection(db, "brands", brandId, "orders"));
    orders = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    renderOrders();
  }

  async function loadCustomers(){
    // derived from orders
    if(!orders.length) await loadOrders();
    const map = new Map();
    for(const o of orders){
      const key = (o.customerPhone || o.customerEmail || o.customerName || "").trim().toLowerCase();
      if(!key) continue;
      const prev = map.get(key) || { name:o.customerName||"", phone:o.customerPhone||"", email:o.customerEmail||"", orders:0, spend:0 };
      prev.orders += 1;
      prev.spend += Number(o.total||0);
      if(!prev.name && o.customerName) prev.name = o.customerName;
      if(!prev.phone && o.customerPhone) prev.phone = o.customerPhone;
      if(!prev.email && o.customerEmail) prev.email = o.customerEmail;
      map.set(key, prev);
    }
    customers = Array.from(map.values());
    renderCustomers();
  }

  async function loadSettings(){
    await reloadBrand();
    settingsBrandName.value = brandDoc?.name || "";
    settingsPhone.value = brandDoc?.phone || "";
    settingsEmail.value = brandDoc?.email || "";
    settingsNotes.value = brandDoc?.notes || "";
    settingsEventId.value = currentEventId || "";
    settingsStatus.value = brandDoc?.status || "pending";

    setShopifyUI(!!brandDoc?.shopify?.connected, brandDoc?.shopify?.shop);
    applyGate();
  }

  /***********************
   * DASHBOARD KPIs
   ***********************/
  function dayKey(d=new Date()){
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }
  function money(v){
    const n = Number(v||0);
    return n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  }

  async function loadDashboard(){
    await loadProducts();
    await loadOrders();

    const today = dayKey(new Date());
    const todays = orders.filter(o=>{
      const ts = o.createdAt?.toDate ? o.createdAt.toDate() : null;
      return ts ? dayKey(ts) === today : false;
    });

    // Sales / returns: assume order.type = "sale" or "return"
    let sales = 0;
    let salesOrders = 0;
    let returns = 0;

    const hourBuckets = new Array(24).fill(0);
    const prodAgg = new Map();

    for(const o of todays){
      const t = (o.type || "sale").toLowerCase();
      const total = Number(o.total||0);

      const ts = o.createdAt?.toDate ? o.createdAt.toDate() : null;
      if(ts) hourBuckets[ts.getHours()] += total;

      if(t === "return"){
        returns += Math.abs(total);
      } else {
        sales += total;
        salesOrders += 1;
      }

      const items = Array.isArray(o.items) ? o.items : [];
      for(const it of items){
        const name = it.name || it.title || it.sku || "Item";
        const prev = prodAgg.get(name) || { name, qty:0, sales:0 };
        const qty = Number(it.qty || it.quantity || 1);
        const line = Number(it.total || 0) || (Number(it.price||0) * qty);
        prev.qty += qty;
        prev.sales += line;
        prodAgg.set(name, prev);
      }
    }

    dashSalesToday.textContent = money(sales);
    dashOrdersToday.textContent = String(salesOrders);
    dashReturnsToday.textContent = money(returns);

    // low stock KPI
    const threshold = Number(brandDoc?.lowStockThreshold ?? 5);
    const lowCount = products.filter(p => Number(p.stock||0) <= threshold).length;
    dashLowstock.textContent = String(lowCount);

    // top products
    const top = Array.from(prodAgg.values()).sort((a,b)=>b.sales-a.sales).slice(0,5);
    dashTopProducts.innerHTML = top.length ? `
      <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px;">
        ${top.map(t=>`
          <div style="display:flex;justify-content:space-between;gap:10px;">
            <div style="font-weight:700;font-size:12px;">${escapeHtml(t.name)}</div>
            <div class="muted" style="font-size:12px;">${money(t.sales)}</div>
          </div>
        `).join("")}
      </div>
    ` : `<div class="muted" style="margin-top:10px;">No sales yet today.</div>`;

    // peak hour
    let peakHour = 0, peakVal = 0;
    hourBuckets.forEach((v,h)=>{ if(v > peakVal){ peakVal=v; peakHour=h; } });
    dashPeakHour.textContent = peakVal ? `${String(peakHour).padStart(2,"0")}:00 â€” ${money(peakVal)}` : "â€”";
  }

  /***********************
   * PRODUCTS: RENDER + CRUD
   ***********************/
  function getFilteredSortedProducts(){
    const q = (productsSearch.value||"").toLowerCase().trim();
    let rows = products.slice();

    if(q){
      rows = rows.filter(p=>{
        const name = String(p.name||"").toLowerCase();
        const sku  = String(p.sku||"").toLowerCase();
        return name.includes(q) || sku.includes(q);
      });
    }

    const sort = productsSort.value;
    rows.sort((a,b)=>{
      const na = String(a.name||"").toLowerCase();
      const nb = String(b.name||"").toLowerCase();
      const pa = Number(a.price||0), pb = Number(b.price||0);
      const sa = Number(a.stock||0), sb = Number(b.stock||0);

      if(sort==="name-asc") return na.localeCompare(nb);
      if(sort==="name-desc") return nb.localeCompare(na);
      if(sort==="price-asc") return pa-pb;
      if(sort==="price-desc") return pb-pa;
      if(sort==="stock-asc") return sa-sb;
      if(sort==="stock-desc") return sb-sa;
      return 0;
    });

    return rows;
  }

  function renderProducts(){
    const rows = getFilteredSortedProducts();

    if(!rows.length){
      productsTableWrapper.innerHTML = `<div class="card muted" style="box-shadow:none;">No products yet.</div>`;
      return;
    }

    productsTableWrapper.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Image</th>
            <th>Name</th>
            <th>SKU</th>
            <th>Price</th>
            <th>Stock</th>
            <th>Source</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(p=>{
            const img = p.imageUrl
              ? `<div style="width:34px;height:34px;border-radius:10px;border:1px solid var(--border);background:center/cover no-repeat;background-image:url('${p.imageUrl}')"></div>`
              : `<div style="width:34px;height:34px;border-radius:10px;border:1px solid var(--border);background:var(--panel-soft);display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:11px;">No</div>`;
            const source = p.shopifyProductId ? `<span class="pill ok">Shopify</span>` : `<span class="pill warn">Manual</span>`;
            return `
              <tr>
                <td>${img}</td>
                <td>${escapeHtml(p.name||"")}</td>
                <td>${escapeHtml(p.sku||"-")}</td>
                <td>${money(p.price||0)}</td>
                <td>${Number(p.stock||0)}</td>
                <td>${source}</td>
                <td style="text-align:right;">
                  <button class="btn btn-ghost" data-edit-prod="${p.id}" type="button">Edit</button>
                </td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    `;

    qsa("[data-edit-prod]", productsTableWrapper).forEach(btn=>{
      btn.addEventListener("click", ()=>openEditProduct(btn.getAttribute("data-edit-prod")));
    });
  }

  function renderLowStock(){
    const threshold = Number(brandDoc?.lowStockThreshold ?? 5);
    const lows = products.filter(p=>Number(p.stock||0) <= threshold);

    if(!lows.length){
      lowStockPanel.style.display="none";
      return;
    }
    lowStockPanel.style.display="block";
    lowStockPanelTitle.textContent = `Low stock alerts (â‰¤ ${threshold})`;
    lowStockList.innerHTML = lows.map(p=>`
      <div style="display:flex;justify-content:space-between;gap:10px;padding:8px 0;border-bottom:1px solid rgba(239,68,68,.18);">
        <div>
          <div style="font-weight:700;font-size:12px;">${escapeHtml(p.name||"")}</div>
          <div class="muted" style="font-size:11px;">SKU: ${escapeHtml(p.sku||"-")}</div>
        </div>
        <div class="pill bad">${Number(p.stock||0)}</div>
      </div>
    `).join("");
  }

  // SAFE MODALS (NO ${Number()} inside input value)
  btnAddProduct.addEventListener("click", openAddProduct);

  function openAddProduct(){
    openModal(`
      <div class="modal-title">Add product</div>

      <div class="field" style="margin-top:10px;">
        <div class="field-label">Name</div>
        <input data-p-name class="field-input" placeholder="Product name"/>
      </div>
      <div class="field">
        <div class="field-label">SKU</div>
        <input data-p-sku class="field-input" placeholder="Optional SKU"/>
      </div>
      <div class="field">
        <div class="field-label">Price</div>
        <input data-p-price class="field-input" type="number" step="0.01" placeholder="0.00"/>
      </div>
      <div class="field">
        <div class="field-label">Stock</div>
        <input data-p-stock class="field-input" type="number" step="1" placeholder="0"/>
      </div>
      <div class="field">
        <div class="field-label">Image</div>
        <input data-p-img class="field-input" type="file" accept="image/*"/>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:14px;">
        <button class="btn btn-ghost" type="button" onclick="(${closeModal.toString()})()">Cancel</button>
        <button data-p-save class="btn btn-primary" type="button">Save</button>
      </div>
    `);

    const nameEl  = modalBody.querySelector("[data-p-name]");
    const skuEl   = modalBody.querySelector("[data-p-sku]");
    const priceEl = modalBody.querySelector("[data-p-price]");
    const stockEl = modalBody.querySelector("[data-p-stock]");
    const imgEl   = modalBody.querySelector("[data-p-img]");
    const saveBtn = modalBody.querySelector("[data-p-save]");

    saveBtn.addEventListener("click", async ()=>{
      try{
        const name = nameEl.value.trim();
        const sku  = skuEl.value.trim() || null;
        const price= Number(priceEl.value || 0);
        const stock= Number(stockEl.value || 0);
        const file = imgEl.files?.[0] || null;

        if(!name) return toast("Name required.", "error");

        let imageUrl = null;
        if(file){
          const path = `brands/${brandId}/products/${Date.now()}_${file.name}`;
          const r = sRef(storage, path);
          await uploadBytes(r, file);
          imageUrl = await getDownloadURL(r);
        }

        await addDoc(collection(db,"brands",brandId,"products"),{
          name, sku, price, stock,
          imageUrl,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          eventId: currentEventId || null
        });

        closeModal();
        await loadProducts();
        toast("Product added.", "success");
      }catch(err){
        console.error(err);
        toast(err.message || "Save failed.", "error");
      }
    });
  }

  function openEditProduct(prodId){
    const p = products.find(x=>x.id===prodId);
    if(!p) return;

    openModal(`
      <div class="modal-title">Edit product</div>

      <div class="field" style="margin-top:10px;">
        <div class="field-label">Name</div>
        <input data-p-name class="field-input" value="${escapeHtml(p.name||"")}"/>
      </div>
      <div class="field">
        <div class="field-label">SKU</div>
        <input data-p-sku class="field-input" value="${escapeHtml(p.sku||"")}"/>
      </div>
      <div class="field">
        <div class="field-label">Price</div>
        <input data-p-price class="field-input" type="number" step="0.01"/>
      </div>
      <div class="field">
        <div class="field-label">Stock</div>
        <input data-p-stock class="field-input" type="number" step="1"/>
      </div>
      <div class="field">
        <div class="field-label">Replace image</div>
        <input data-p-img class="field-input" type="file" accept="image/*"/>
        <div class="field-hint">Leave empty to keep existing image.</div>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:14px;">
        <button class="btn btn-ghost" type="button" onclick="(${closeModal.toString()})()">Cancel</button>
        <button data-p-save class="btn btn-primary" type="button">Save</button>
      </div>
    `);

    const nameEl  = modalBody.querySelector("[data-p-name]");
    const skuEl   = modalBody.querySelector("[data-p-sku]");
    const priceEl = modalBody.querySelector("[data-p-price]");
    const stockEl = modalBody.querySelector("[data-p-stock]");
    const imgEl   = modalBody.querySelector("[data-p-img]");
    const saveBtn = modalBody.querySelector("[data-p-save]");

    // set numeric values safely (no interpolation in value="")
    priceEl.value = Number(p.price || 0);
    stockEl.value = Number(p.stock || 0);

    saveBtn.addEventListener("click", async ()=>{
      try{
        const name = nameEl.value.trim();
        const sku  = skuEl.value.trim() || null;
        const price= Number(priceEl.value || 0);
        const stock= Number(stockEl.value || 0);
        const file = imgEl.files?.[0] || null;

        if(!name) return toast("Name required.", "error");

        let imageUrl = p.imageUrl || null;
        if(file){
          const path = `brands/${brandId}/products/${prodId}_${Date.now()}_${file.name}`;
          const r = sRef(storage, path);
          await uploadBytes(r, file);
          imageUrl = await getDownloadURL(r);
        }

        await updateDoc(doc(db,"brands",brandId,"products",prodId),{
          name, sku, price, stock, imageUrl,
          updatedAt: serverTimestamp()
        });

        closeModal();
        await loadProducts();
        toast("Product updated.", "success");
      }catch(err){
        console.error(err);
        toast(err.message || "Update failed.", "error");
      }
    });
  }

  /***********************
   * STAFF: RENDER + ADD
   ***********************/
  function renderStaff(){
    const q = (staffSearch.value||"").toLowerCase().trim();
    let rows = staff.slice();
    if(q){
      rows = rows.filter(s =>
        String(s.name||"").toLowerCase().includes(q) ||
        String(s.username||"").toLowerCase().includes(q)
      );
    }

    staffTableWrapper.innerHTML = rows.length ? `
      <table>
        <thead><tr><th>Name</th><th>Username</th><th>Role</th><th>Status</th></tr></thead>
        <tbody>
          ${rows.map(s=>`
            <tr>
              <td>${escapeHtml(s.name||"")}</td>
              <td>${escapeHtml(s.username||"-")}</td>
              <td>${escapeHtml(s.role||"cashier")}</td>
              <td>${s.active===false ? `<span class="pill bad">Inactive</span>` : `<span class="pill ok">Active</span>`}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    ` : `<div class="card muted" style="box-shadow:none;">No staff yet.</div>`;
  }

  btnAddStaff.addEventListener("click", ()=>{
    openModal(`
      <div class="modal-title">Add POS user</div>

      <div class="field" style="margin-top:10px;">
        <div class="field-label">Name</div>
        <input data-s-name class="field-input" placeholder="Cashier name"/>
      </div>
      <div class="field">
        <div class="field-label">Username</div>
        <input data-s-user class="field-input" placeholder="e.g. cashier1"/>
      </div>
      <div class="field">
        <div class="field-label">PIN</div>
        <input data-s-pin class="field-input" placeholder="4-6 digits"/>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:14px;">
        <button class="btn btn-ghost" type="button" onclick="(${closeModal.toString()})()">Cancel</button>
        <button data-s-save class="btn btn-primary" type="button">Save</button>
      </div>
    `);

    const nameEl = modalBody.querySelector("[data-s-name]");
    const userEl = modalBody.querySelector("[data-s-user]");
    const pinEl  = modalBody.querySelector("[data-s-pin]");
    const saveBtn= modalBody.querySelector("[data-s-save]");

    saveBtn.addEventListener("click", async ()=>{
      const name = nameEl.value.trim();
      const username = userEl.value.trim();
      const pin = pinEl.value.trim();
      if(!name || !username || !pin) return toast("Fill all fields.", "error");

      await addDoc(collection(db,"brands",brandId,"staff"),{
        name, username, pin,
        role:"cashier",
        active:true,
        eventId: currentEventId || null,
        createdAt: serverTimestamp()
      });

      closeModal();
      await loadStaff();
      toast("Staff added.", "success");
    });
  });

  /***********************
   * ORDERS + CUSTOMERS: RENDER
   ***********************/
  function renderOrders(){
    const q = (ordersSearch.value||"").toLowerCase().trim();
    const f = ordersFilter.value;

    let rows = orders.slice();
    if(f==="sale") rows = rows.filter(o => (o.type||"sale").toLowerCase() !== "return");
    if(f==="return") rows = rows.filter(o => (o.type||"sale").toLowerCase() === "return");

    if(q){
      rows = rows.filter(o=>{
        return String(o.id||"").toLowerCase().includes(q) ||
               String(o.customerName||"").toLowerCase().includes(q) ||
               String(o.customerPhone||"").toLowerCase().includes(q) ||
               String(o.cashierName||"").toLowerCase().includes(q);
      });
    }

    rows.sort((a,b)=> (b.createdAt?.toMillis?.()||0) - (a.createdAt?.toMillis?.()||0));

    ordersTableWrapper.innerHTML = rows.length ? `
      <table>
        <thead><tr><th>Time</th><th>Type</th><th>Customer</th><th>Cashier</th><th>Total</th></tr></thead>
        <tbody>
          ${rows.map(o=>{
            const ts = o.createdAt?.toDate ? o.createdAt.toDate() : null;
            const t = ts ? ts.toLocaleString() : "-";
            const type = (o.type||"sale").toLowerCase();
            const cust = o.customerName || o.customerPhone || o.customerEmail || "Walk-in";
            return `
              <tr>
                <td>${escapeHtml(t)}</td>
                <td>${type==="return" ? `<span class="pill bad">Return</span>` : `<span class="pill ok">Sale</span>`}</td>
                <td>${escapeHtml(String(cust))}</td>
                <td>${escapeHtml(o.cashierName || "-")}</td>
                <td>${money(o.total||0)}</td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    ` : `<div class="card muted" style="box-shadow:none;">No orders yet.</div>`;
  }

  function renderCustomers(){
    const q = (customersSearch.value||"").toLowerCase().trim();
    let rows = customers.slice();
    if(q){
      rows = rows.filter(c =>
        String(c.name||"").toLowerCase().includes(q) ||
        String(c.phone||"").toLowerCase().includes(q) ||
        String(c.email||"").toLowerCase().includes(q)
      );
    }

    rows.sort((a,b)=> Number(b.spend||0) - Number(a.spend||0));

    customersTableWrapper.innerHTML = rows.length ? `
      <table>
        <thead><tr><th>Name</th><th>Phone</th><th>Email</th><th>Orders</th><th>Spend</th></tr></thead>
        <tbody>
          ${rows.map(c=>`
            <tr>
              <td>${escapeHtml(c.name||"-")}</td>
              <td>${escapeHtml(c.phone||"-")}</td>
              <td>${escapeHtml(c.email||"-")}</td>
              <td>${Number(c.orders||0)}</td>
              <td>${money(c.spend||0)}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    ` : `<div class="card muted" style="box-shadow:none;">No customers yet.</div>`;
  }
</script>
</body>
</html>
